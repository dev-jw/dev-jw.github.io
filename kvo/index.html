<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-KVO | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="KVOï¼Œå…¨ç§°ä¸º Key-Value observingï¼ˆé”®å€¼è§‚å¯Ÿï¼‰æœ¬æ–‡å°†å¯¹å…¶åŸç†è¿›è¡Œåˆ†æ åŒæ ·çš„ï¼Œå‡ ä¸ªé—®é¢˜â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/kvo/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-10-28T14:35:29+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/kvo/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-KVO","description":"KVOï¼Œå…¨ç§°ä¸º Key-Value observingï¼ˆé”®å€¼è§‚å¯Ÿï¼‰æœ¬æ–‡å°†å¯¹å…¶åŸç†è¿›è¡Œåˆ†æ åŒæ ·çš„ï¼Œå‡ ä¸ªé—®é¢˜â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-KVO"><meta property="og:description" content="KVOï¼Œå…¨ç§°ä¸º Key-Value observingï¼ˆé”®å€¼è§‚å¯Ÿï¼‰æœ¬æ–‡å°†å¯¹å…¶åŸç†è¿›è¡Œåˆ†æ åŒæ ·çš„ï¼Œå‡ ä¸ªé—®é¢˜â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/kvo/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-KVO</h1><div class=post-meta><time datetime=2020-10-28T14:35:29+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-10-28</time></div><div class="post-body e-content"><p><strong>KVO</strong>ï¼Œå…¨ç§°ä¸º <strong>Key-Value observing</strong>ï¼ˆé”®å€¼è§‚å¯Ÿï¼‰æœ¬æ–‡å°†å¯¹å…¶åŸç†è¿›è¡Œåˆ†æ</p><p>åŒæ ·çš„ï¼Œå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>KVO ä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹</li><li>KVO åŸç†</li></ul><h3 id=kvoç®€è¿°><a href=#kvoç®€è¿° class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>KVOç®€è¿°</h3><p>KVO æ˜¯è‹¹æœæä¾›çš„ä¸€å¥—äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶å…è®¸å°†å…¶ä»–å¯¹è±¡çš„ç‰¹å®šå±æ€§çš„å˜åŒ–é€šçŸ¥ç»™å¯¹è±¡</p><p>iOSå¼€å‘è€…å¯ä»¥ç”¨ KVO æ¥ç›‘æµ‹å¯¹è±¡å±æ€§çš„å˜åŒ–å¹¶ä½œå‡ºå“åº”ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¼€å‘å¼ºäº¤äº’ã€å“åº”å¼åº”ç”¨ä»¥åŠå®ç°è§†å›¾å’Œæ¨¡å‹çš„åŒå‘ç»‘å®šæ—¶æä¾›å¤§é‡çš„å¸®åŠ©</p><p><code>KVO</code> ä¸ <code>NSNotificatioCenter</code> éƒ½æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°ï¼Œè€ŒåŒºåˆ«åœ¨äºï¼š</p><ul><li>ç›¸å¯¹äºè¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ä¹‹é—´çš„å…³ç³»ï¼Œ<code>KVO</code> æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œ<code>NSNotificatioCenter</code> æ˜¯ä¸€å¯¹å¤šçš„</li><li><code>KVO</code> å¯¹è¢«ç›‘å¬å¯¹è±¡æ— ä¾µå…¥æ€§ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶ä»–å†…éƒ¨ä»£ç å³å¯å®ç°ç›‘å¬</li></ul><h3 id=kvoä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹><a href=#kvoä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>KVOä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹</h3><h4 id=åŸºæœ¬ä½¿ç”¨><a href=#åŸºæœ¬ä½¿ç”¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åŸºæœ¬ä½¿ç”¨</h4><p><strong>æ³¨å†Œè§‚å¯Ÿè€…</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span> <span class=o>|</span> <span class=n>NSKeyValueObservingOptionOld</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=nb>NULL</span><span class=p>];</span>
</code></pre></div><p><strong>å®ç°å›è°ƒ</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>observeValueForKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>ofObject:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>object</span> <span class=nf>change:</span><span class=p>(</span><span class=n>NSDictionary</span><span class=o>&lt;</span><span class=n>NSKeyValueChangeKey</span><span class=p>,</span><span class=kt>id</span><span class=o>&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>change</span> <span class=nf>context:</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=nv>context</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>keyPath</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;name&#34;</span><span class=p>])</span> <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>change</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p><strong>ç§»é™¤è§‚å¯Ÿè€…</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>removeObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span><span class=p>];</span>
</code></pre></div><h4 id=contextçš„ä½¿ç”¨><a href=#contextçš„ä½¿ç”¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>contextçš„ä½¿ç”¨</h4><p>å…³äº <code>context</code> åœ¨å®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„</p><p><img src=https://w-md.imzsy.design/image-20201217151140699.png alt=image-20201217151140699></p><p>å¤§è‡´å«ä¹‰å°±æ˜¯ï¼š<code>addObserverï¼šforKeyPathï¼šoptionsï¼šcontextï¼š</code>æ–¹æ³•ä¸­çš„<code>ä¸Šä¸‹æ–‡context</code>æŒ‡é’ˆåŒ…å«ä»»æ„æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†åœ¨ç›¸åº”çš„æ›´æ”¹é€šçŸ¥ä¸­ä¼ é€’å›è§‚å¯Ÿè€…ã€‚</p><p>å¯ä»¥é€šè¿‡<code>æŒ‡å®šcontextä¸ºNULL</code>ï¼Œä»è€Œ<code>ä¾é keyPath</code>å³<code>é”®è·¯å¾„å­—ç¬¦ä¸²</code>ä¼ æ¥ç¡®å®šæ›´æ”¹é€šçŸ¥çš„æ¥æºï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡çš„çˆ¶ç±»ç”±äºä¸åŒçš„åŸå› ä¹Ÿè§‚å¯Ÿåˆ°ç›¸åŒçš„é”®è·¯å¾„è€Œå¯¼è‡´é—®é¢˜ã€‚</p><p>æ‰€ä»¥å¯ä»¥ä¸ºæ¯ä¸ªè§‚å¯Ÿåˆ°çš„<code>keyPath</code>åˆ›å»ºä¸€ä¸ªä¸åŒçš„<code>context</code>ï¼Œä»è€Œ<code>å®Œå…¨ä¸éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒ</code>ï¼Œä»è€Œå¯ä»¥æ›´æœ‰æ•ˆåœ°è¿›è¡Œé€šçŸ¥è§£æ</p><p>é€šä¿—çš„è®²ï¼Œcontextä¸Šä¸‹æ–‡ä¸»è¦æ˜¯ç”¨äº<code>åŒºåˆ†ä¸åŒå¯¹è±¡çš„åŒåå±æ€§</code>ï¼Œä»è€Œåœ¨KVOå›è°ƒæ–¹æ³•ä¸­å¯ä»¥<code>ç›´æ¥ä½¿ç”¨contextè¿›è¡ŒåŒºåˆ†ï¼Œå¯ä»¥å¤§å¤§æå‡æ€§èƒ½ï¼Œä»¥åŠä»£ç çš„å¯è¯»æ€§</code></p><p><code>context</code>ä½¿ç”¨æ€»ç»“</p><ul><li><p>ä¸ä½¿ç”¨<code>context</code>ä½œä¸ºè§‚å¯Ÿå€¼</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=nb>NULL</span><span class=p>];</span>
</code></pre></div></li><li><p>ä½¿ç”¨<code>context</code>ä¼ é€’ä¿¡æ¯</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=n>PersonNameContext</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>PersonNameContext</span><span class=p>;</span>
<span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=n>ChildNameContext</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>ChildNameContext</span><span class=p>;</span>
  
<span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=n>PersonNameContext</span><span class=p>];</span>
<span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>child</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=n>ChildNameContext</span><span class=p>];</span>
  
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>observeValueForKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>ofObject:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>object</span> <span class=nf>change:</span><span class=p>(</span><span class=n>NSDictionary</span><span class=o>&lt;</span><span class=n>NSKeyValueChangeKey</span><span class=p>,</span><span class=kt>id</span><span class=o>&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>change</span> <span class=nf>context:</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=nv>context</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=n>PersonNameContext</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>change</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=n>ChildNameContext</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>change</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li></ul><h4 id=ç§»é™¤é€šçŸ¥çš„å¿…è¦æ€§><a href=#ç§»é™¤é€šçŸ¥çš„å¿…è¦æ€§ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç§»é™¤é€šçŸ¥çš„å¿…è¦æ€§</h4><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œé’ˆå¯¹<code>KVOçš„ç§»é™¤</code>æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜</p><p><img src=https://w-md.imzsy.design/image-20201217151202375.png alt=image-20201217151202375></p><p>åˆ é™¤è§‚å¯Ÿè€…æ—¶ï¼Œè¯·è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>è¦æ±‚è¢«ç§»é™¤ä¸ºè§‚å¯Ÿè€…ï¼ˆå¦‚æœå°šæœªæ³¨å†Œä¸ºè§‚å¯Ÿè€…ï¼‰ä¼šå¯¼è‡´<code>NSRangeException</code>ã€‚æ‚¨å¯ä»¥å¯¹<code>removeObserverï¼šforKeyPathï¼šcontextï¼š</code>è¿›è¡Œä¸€æ¬¡è°ƒç”¨ï¼Œä»¥å¯¹åº”å¯¹<code>addObserverï¼šforKeyPathï¼šoptionsï¼šcontextï¼š</code>çš„è°ƒç”¨ï¼Œæˆ–è€…ï¼Œå¦‚æœåœ¨æ‚¨çš„åº”ç”¨ä¸­ä¸å¯è¡Œï¼Œåˆ™å°†<code>removeObserverï¼šforKeyPathï¼šcontextï¼š</code>è°ƒç”¨åœ¨<code>try / catchå—</code>å†…å¤„ç†æ½œåœ¨çš„å¼‚å¸¸</li><li><code>é‡Šæ”¾åï¼Œè§‚å¯Ÿè€…ä¸ä¼šè‡ªåŠ¨å°†å…¶è‡ªèº«ç§»é™¤</code>ã€‚è¢«è§‚å¯Ÿå¯¹è±¡ç»§ç»­å‘é€é€šçŸ¥ï¼Œè€Œå¿½ç•¥äº†è§‚å¯Ÿè€…çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œä¸å‘é€åˆ°å·²é‡Šæ”¾å¯¹è±¡çš„ä»»ä½•å…¶ä»–æ¶ˆæ¯ä¸€æ ·ï¼Œæ›´æ”¹é€šçŸ¥ä¼šè§¦å‘å†…å­˜è®¿é—®å¼‚å¸¸ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥<code>ç¡®ä¿è§‚å¯Ÿè€…åœ¨ä»å†…å­˜ä¸­æ¶ˆå¤±ä¹‹å‰å°†è‡ªå·±åˆ é™¤</code></li><li>è¯¥åè®®æ— æ³•è¯¢é—®å¯¹è±¡æ˜¯è§‚å¯Ÿè€…è¿˜æ˜¯è¢«è§‚å¯Ÿè€…ã€‚æ„é€ ä»£ç ä»¥é¿å…å‘å¸ƒç›¸å…³çš„é”™è¯¯ã€‚ä¸€ç§å…¸å‹çš„æ¨¡å¼æ˜¯åœ¨è§‚å¯Ÿè€…åˆå§‹åŒ–æœŸé—´ï¼ˆä¾‹å¦‚ï¼Œ<code>åœ¨initæˆ–viewDidLoadä¸­ï¼‰æ³¨å†Œä¸ºè§‚å¯Ÿè€…</code>ï¼Œå¹¶åœ¨é‡Šæ”¾è¿‡ç¨‹ä¸­ï¼ˆé€šå¸¸<code>åœ¨deallocä¸­ï¼‰æ³¨é”€</code>ï¼Œä»¥<code>ç¡®ä¿æˆå¯¹å’Œæœ‰åºåœ°æ·»åŠ å’Œåˆ é™¤æ¶ˆæ¯</code>ï¼Œå¹¶ç¡®<code>ä¿è§‚å¯Ÿè€…åœ¨æ³¨å†Œä¹‹å‰è¢«å–æ¶ˆæ³¨å†Œï¼Œä»å†…å­˜ä¸­é‡Šæ”¾å‡ºæ¥</code></li></ul><p>æ€»å¾—æ¥è¯´ï¼ŒKVOæ³¨å†Œè§‚å¯Ÿè€…å’Œç§»é™¤è§‚å¯Ÿè€…å¿…é¡»æ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œå¦åˆ™ä¼šå‡ºç°ç±»ä¼¼é‡æŒ‡é’ˆé—®é¢˜</p><p>ä¾‹å¦‚ï¼šå¯¹å•ä¾‹å¯¹è±¡æ·»åŠ è§‚å¯Ÿè€…ï¼Œç”±äºå•ä¾‹å¯¹è±¡æ˜¯è·Ÿéšåº”ç”¨å¸¸é©»çš„ï¼Œå› ä¸ºæ²¡æœ‰ç§»é™¤è§‚å¯Ÿï¼Œå°±ä¼šå‡ºç°é‡å¤æ³¨å†Œè§‚å¯Ÿï¼Œä»è€Œé€ æˆç±»ä¼¼é‡æŒ‡é’ˆçš„å´©æºƒ</p><blockquote><p>è‹¹æœå®˜æ–¹æ¨èçš„æ–¹å¼æ˜¯â€”â€”åœ¨<code>init</code>çš„æ—¶å€™è¿›è¡Œ<code>addObserver</code>ï¼Œåœ¨<code>dealloc</code>æ—¶<code>removeObserver</code>ï¼Œè¿™æ ·å¯ä»¥ä¿è¯<code>add</code>å’Œ<code>remove</code>æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„ä½¿ç”¨æ–¹å¼</p></blockquote><h4 id=kvoçš„è‡ªåŠ¨è§¦å‘ä¸æ‰‹åŠ¨è§¦å‘><a href=#kvoçš„è‡ªåŠ¨è§¦å‘ä¸æ‰‹åŠ¨è§¦å‘ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>KVOçš„è‡ªåŠ¨è§¦å‘ä¸æ‰‹åŠ¨è§¦å‘</h4><p><code>automaticallyNotifiesObserversForKey</code>è¿”å›ç»“æœè¡¨ç¤º KVO æ˜¯è‡ªåŠ¨è§¦å‘è¿˜æ˜¯æ‰‹åŠ¨è§¦å‘</p><p>è¿”å› YESï¼Œå°±æ˜¯è‡ªåŠ¨è§¦å‘</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>+</span> <span class=p>(</span><span class=kt>BOOL</span><span class=p>)</span><span class=nf>automaticallyNotifiesObserversForKey:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>key</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nb>YES</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>è¿”å› NOï¼Œæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œéœ€è¦é€šè¿‡æ‰‹åŠ¨ç›‘å¬</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>setName:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>name</span><span class=p>{</span>
    <span class=c1>//æ‰‹åŠ¨å¼€å…³
</span><span class=c1></span>    <span class=p>[</span><span class=nb>self</span> <span class=nl>willChangeValueForKey</span><span class=p>:</span><span class=s>@&#34;name&#34;</span><span class=p>];</span>
    <span class=n>_name</span> <span class=o>=</span> <span class=n>name</span><span class=p>;</span>
    <span class=p>[</span><span class=nb>self</span> <span class=nl>didChangeValueForKey</span><span class=p>:</span><span class=s>@&#34;name&#34;</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><h4 id=é”®å€¼è§‚å¯Ÿä¸€å¯¹å¤š><a href=#é”®å€¼è§‚å¯Ÿä¸€å¯¹å¤š class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é”®å€¼è§‚å¯Ÿä¸€å¯¹å¤š</h4><p>KVOè§‚å¯Ÿä¸­çš„<code>ä¸€å¯¹å¤š</code>ï¼Œæ„æ€æ˜¯é€šè¿‡<code>æ³¨å†Œä¸€ä¸ªKVOè§‚å¯Ÿè€…ï¼Œå¯ä»¥ç›‘å¬å¤šä¸ªå±æ€§çš„å˜åŒ–</code></p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªä¸‹è½½ä»»åŠ¡çš„éœ€æ±‚ï¼Œæ ¹æ®<code>æ€»ä¸‹è½½é‡Total</code>å’Œ<code>å½“å‰å·²ä¸‹è½½é‡Current</code>æ¥å¾—åˆ°<code>å½“å‰ä¸‹è½½è¿›åº¦Process</code>ï¼Œè¿™ä¸ªéœ€æ±‚å°±æœ‰ä¸¤ç§å®ç°ï¼š</p><ul><li>åˆ†åˆ«è§‚å¯Ÿ<code>æ€»ä¸‹è½½é‡Total</code>å’Œ<code>å½“å‰å·²ä¸‹è½½é‡Current</code>ä¸¤ä¸ªå±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶è®¡ç®—æ±‚å€¼<code>å½“å‰ä¸‹è½½è¿›åº¦Process</code></li><li>å®ç°<code>keyPathsForValuesAffectingValueForKey</code>æ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿ<code>process</code>å±æ€§</li></ul><p>åªè¦<code>æ€»ä¸‹è½½é‡Total</code>æˆ–<code>å½“å‰å·²ä¸‹è½½é‡Current</code>ä»»æ„å‘ç”Ÿå˜åŒ–ï¼Œ<code>keyPaths=process</code>å°±èƒ½æ”¶åˆ°ç›‘å¬å›è°ƒ</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>+</span> <span class=p>(</span><span class=n>NSSet</span><span class=o>&lt;</span><span class=n>NSString</span> <span class=o>*&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nf>keyPathsForValuesAffectingValueForKey:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>key</span> <span class=p>{</span>
    <span class=n>NSSet</span> <span class=o>*</span><span class=n>keyPaths</span> <span class=o>=</span> <span class=p>[</span><span class=nb>super</span> <span class=nl>keyPathsForValuesAffectingValueForKey</span><span class=p>:</span><span class=n>key</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>key</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;process&#34;</span><span class=p>])</span> <span class=p>{</span>
        <span class=n>NSArray</span> <span class=o>*</span><span class=n>affectingKeys</span> <span class=o>=</span> <span class=l>@[</span><span class=s>@&#34;total&#34;</span><span class=p>,</span> <span class=s>@&#34;current&#34;</span><span class=l>]</span><span class=p>;</span>
        <span class=n>keyPaths</span> <span class=o>=</span> <span class=p>[</span><span class=n>keyPaths</span> <span class=nl>setByAddingObjectsFromArray</span><span class=p>:</span><span class=n>affectingKeys</span><span class=p>];</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>keyPaths</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h4 id=å¯å˜æ•°ç»„><a href=#å¯å˜æ•°ç»„ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å¯å˜æ•°ç»„</h4><p>ä¸‹é¢çš„ä»£ç ï¼Œç‚¹å‡»å±å¹•æ—¶å¹¶ä¸ä¼šè¾“å‡ºchange</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>viewDidLoad</span> <span class=p>{</span>
    <span class=p>[</span><span class=nb>super</span> <span class=n>viewDidLoad</span><span class=p>];</span>
    
    <span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=o>=</span> <span class=p>[</span><span class=n>Person</span> <span class=n>new</span><span class=p>];</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;dataArray&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=nb>NULL</span><span class=p>];</span>
  
    <span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>.</span><span class=n>dateArray</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSMutableArray</span> <span class=nl>arrayWithCapacity</span><span class=p>:</span><span class=mi>1</span><span class=p>];</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>observeValueForKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>ofObject:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>object</span> <span class=nf>change:</span><span class=p>(</span><span class=n>NSDictionary</span><span class=o>&lt;</span><span class=n>NSKeyValueChangeKey</span><span class=p>,</span><span class=kt>id</span><span class=o>&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>change</span> <span class=nf>context:</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=nv>context</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>keyPath</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;dataArray&#34;</span><span class=p>])</span> <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>change</span><span class=p>);</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>touchesBegan:</span><span class=p>(</span><span class=n>NSSet</span><span class=o>&lt;</span><span class=n>UITouch</span> <span class=o>*&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>touches</span> <span class=nf>withEvent:</span><span class=p>(</span><span class=n>UIEvent</span> <span class=o>*</span><span class=p>)</span><span class=nv>event</span> <span class=p>{</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>.</span><span class=n>dataArray</span> <span class=nl>addObject</span><span class=p>:</span><span class=s>@&#34;1&#34;</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p><strong>åˆ†æ</strong></p><p>ç”±äº KVO æ˜¯å»ºç«‹åœ¨ KVC çš„åŸºç¡€ä¸Šçš„ï¼Œè€Œå¯å˜æ•°ç»„å¦‚æœç›´æ¥æ·»åŠ æ•°æ®ï¼Œæ˜¯ä¸ä¼šè°ƒç”¨ <code>Setter</code> æ–¹æ³•</p><p><strong>è§£å†³</strong></p><p>åœ¨KVCå®˜æ–¹æ–‡æ¡£ä¸­ï¼Œé’ˆå¯¹<code>å¯å˜æ•°ç»„çš„é›†åˆ</code>ç±»å‹ï¼Œæœ‰å¦‚ä¸‹è¯´æ˜ï¼Œå³è®¿é—®é›†åˆå¯¹è±¡éœ€è¦éœ€è¦é€šè¿‡<code>mutableArrayValueForKey</code>æ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½<code>å°†å…ƒç´ æ·»åŠ åˆ°å¯å˜æ•°ç»„</code>ä¸­</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>[[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>mutableArrayValueForKey</span><span class=p>:</span><span class=s>@&#34;dateArray&#34;</span><span class=p>]</span> <span class=nl>addObject</span><span class=p>:</span><span class=s>@&#34;1&#34;</span><span class=p>];</span>
</code></pre></div><p>ä¸€èˆ¬å±æ€§ä¸é›†åˆçš„ KVO è§‚å¯Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå…¶å›è°ƒå‚æ•° <code>change</code> ä¸­çš„ <code>kind</code> æ˜¯ä¸åŒçš„</p><ul><li>å±æ€§ä¸€èˆ¬æ˜¯è®¾å€¼ï¼Œå³<code>NSKeyValueChangeSetting</code></li><li>é›†åˆä¸€æŠŠæ˜¯æ’å…¥ï¼Œå³<code>NSKeyValueChangeInsertion</code></li></ul><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>typedef</span> <span class=nf>NS_ENUM</span><span class=p>(</span><span class=n>NSUInteger</span><span class=p>,</span> <span class=n>NSKeyValueChange</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>NSKeyValueChangeSetting</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1>//è®¾å€¼
</span><span class=c1></span>    <span class=n>NSKeyValueChangeInsertion</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span><span class=c1>//æ’å…¥
</span><span class=c1></span>    <span class=n>NSKeyValueChangeRemoval</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span>  <span class=c1>//ç§»é™¤
</span><span class=c1></span>    <span class=n>NSKeyValueChangeReplacement</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span><span class=c1>//æ›¿æ¢
</span><span class=c1></span><span class=p>};</span>
</code></pre></div><h3 id=kvoåŸç†><a href=#kvoåŸç† class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>KVOåŸç†</h3><p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå¯¹äº KVO çš„å®ç°æœ‰è¿™æ ·çš„æè¿°</p><p><img src=https://w-md.imzsy.design/image-20201217154018571.png alt=image-20201217154018571></p><ul><li>KVOæ˜¯ä½¿ç”¨ <code>isa-swizzling</code> æŠ€æœ¯å®ç°çš„</li><li>isa æŒ‡é’ˆæŒ‡å‘ç»´æŠ¤åˆ†é…è¡¨çš„å¯¹è±¡çš„ç±»ï¼Œè¯¥åˆ†æ´¾è¡¨å®è´¨ä¸ŠåŒ…å«è¯¥ç±»å®ç°çš„æ–¹æ³•çš„æŒ‡é’ˆåŠå…¶ä»–æ•°æ®</li><li>å½“å¯¹è±¡çš„å±æ€§æ³¨å†Œè§‚å¯Ÿæ—¶ï¼Œå°†ä¿®æ”¹è§‚å¯Ÿå¯¹è±¡çš„ isa æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­é—´ç±»è€Œä¸æ˜¯çœŸå®ç±»ã€‚isa æŒ‡é’ˆçš„å€¼ä¸ä¸€å®šååº”å®ä¾‹çš„å®é™…ç±»</li><li>ä½ æ°¸è¿œä¸åº”ä¾é  isa æŒ‡é’ˆæ¥ç¡®å®šç±»æˆå‘˜èº«ä»½ã€‚ç›¸åï¼Œä½ åº”è¯¥ä½¿ç”¨ class æ–¹æ³•æ¥ç¡®å®šå¯¹è±¡å®ä¾‹çš„ç±»</li></ul><h4 id=ä»£ç è°ƒå¼æ¢ç´¢><a href=#ä»£ç è°ƒå¼æ¢ç´¢ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä»£ç è°ƒå¼æ¢ç´¢</h4><p><strong>KVO åªå¯¹å±æ€§è§‚å¯Ÿ</strong></p><p>åœ¨ç±»Personä¸­æœ‰ä¸€ä¸ª<code>æˆå‘˜å˜é‡name</code> å’Œ <code>å±æ€§nickName</code>ï¼Œåˆ†åˆ«æ³¨å†ŒKVOè§‚å¯Ÿï¼Œè§¦å‘å±æ€§å˜åŒ–æ—¶ï¼Œä¼šæœ‰ä»€ä¹ˆç°è±¡ï¼Ÿ</p><ul><li>åˆ†åˆ«ä¸º<code>æˆå‘˜å˜é‡name</code> å’Œ <code>å±æ€§nickName</code>æ³¨å†ŒKVOè§‚å¯Ÿ</li></ul><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=o>=</span> <span class=p>[[</span><span class=n>LGPerson</span> <span class=n>alloc</span><span class=p>]</span> <span class=n>init</span><span class=p>];</span>
<span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;nickName&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=nb>NULL</span><span class=p>];</span>
<span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span> <span class=nl>addObserver</span><span class=p>:</span><span class=nb>self</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=s>@&#34;name&#34;</span> <span class=nl>options</span><span class=p>:(</span><span class=n>NSKeyValueObservingOptionNew</span><span class=p>)</span> <span class=nl>context</span><span class=p>:</span><span class=nb>NULL</span><span class=p>];</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>observeValueForKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>ofObject:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>object</span> <span class=nf>change:</span><span class=p>(</span><span class=n>NSDictionary</span><span class=o>&lt;</span><span class=n>NSKeyValueChangeKey</span><span class=p>,</span><span class=kt>id</span><span class=o>&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>change</span> <span class=nf>context:</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=nv>context</span> <span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>object</span><span class=p>);</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>touchesBegan:</span><span class=p>(</span><span class=n>NSSet</span><span class=o>&lt;</span><span class=n>UITouch</span> <span class=o>*&gt;</span> <span class=o>*</span><span class=p>)</span><span class=nv>touches</span> <span class=nf>withEvent:</span><span class=p>(</span><span class=n>UIEvent</span> <span class=o>*</span><span class=p>)</span><span class=nv>event</span> <span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;å®é™…æƒ…å†µ:%@-%@&#34;</span><span class=p>,</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>.</span><span class=n>nickName</span><span class=p>,</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
    <span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>.</span><span class=n>nickName</span> <span class=o>=</span> <span class=s>@&#34;Zsy&#34;</span><span class=p>;</span>
    <span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=o>-&gt;</span><span class=n>name</span>    <span class=o>=</span> <span class=s>@&#34;dev&#34;</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// è¾“å‡º
</span><span class=c1></span><span class=err>å®é™…æƒ…å†µï¼š</span><span class=p>(</span><span class=n>null</span><span class=p>)</span><span class=o>-</span><span class=p>(</span><span class=n>null</span><span class=p>)</span>
<span class=p>{</span>
   <span class=n>kind</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
   <span class=n>new</span> <span class=o>=</span> <span class=n>Zsy</span>
<span class=p>}</span>
</code></pre></div><p>ç»“è®ºï¼šKVO åªå¯¹å±æ€§è§‚å¯Ÿï¼Œè€Œæˆå‘˜å˜é‡ä¸è§‚å¯Ÿï¼Œè¿™ä¹ŸéªŒè¯äº† KVO æ˜¯å»ºç«‹åœ¨ KVC çš„åŸºç¡€ä¸Šçš„ï¼Œå› ä¸ºæˆå‘˜å˜é‡æ²¡æœ‰ setter æ–¹æ³•</p><p><strong>ä¸­é—´ç±»</strong></p><p>åœ¨æ³¨å†Œ KVO è§‚å¯Ÿè€…åï¼Œè§‚å¯Ÿå¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘ä¼šæ”¹å˜</p><ul><li><p>æ³¨å†Œè§‚å¯Ÿè€…ä¹‹å‰ï¼šç±»å¯¹è±¡ä¸º Personï¼Œå®ä¾‹å¯¹è±¡ isa æŒ‡å‘ Person</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=c1>// è°ƒå¼è¾“å‡º
</span><span class=c1></span><span class=n>po</span> <span class=n>object_getClassName</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>)</span>
<span class=s>&#34;Person&#34;</span>
</code></pre></div></li><li><p>æ³¨å†Œè§‚å¯Ÿè€…ä¹‹åï¼šç±»å¯¹è±¡ä¸º Personï¼Œå®ä¾‹å¯¹è±¡ isa æŒ‡å‘ NSKVONotifying_Person</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=c1>// è°ƒå¼è¾“å‡º
</span><span class=c1></span><span class=n>po</span> <span class=n>object_getClassName</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>person</span><span class=p>)</span>
<span class=s>&#34;NSKVONotifying_Person&#34;</span>
</code></pre></div></li></ul><p>é€šè¿‡åˆ†åˆ«åœ¨æ³¨å†Œ KVO è§‚å¯Ÿå‰åè¾“å‡ºï¼Œå¯çŸ¥ï¼šå®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘ç”± <code>Person</code> ç±»å˜ä¸º <code>NSKVONotifying_Person</code>ä¸­é—´ç±»</p><p>é‚£ä¹ˆ<code>NSKVONotifying_Person</code>ä¸<code>Person</code>æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p><p>é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ï¼Œè·å– <code>Person</code> çš„ç›¸å…³ç±»</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=cp>#pragma mark - éå†ç±»ä»¥åŠå­ç±»
</span><span class=cp></span><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>printClasses:</span><span class=p>(</span><span class=kt>Class</span><span class=p>)</span><span class=nv>cls</span><span class=p>{</span>
    
    <span class=c1>// æ³¨å†Œç±»çš„æ€»æ•°
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>objc_getClassList</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=c1>// åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œ å…¶ä¸­åŒ…å«ç»™å®šå¯¹è±¡
</span><span class=c1></span>    <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mArray</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSMutableArray</span> <span class=nl>arrayWithObject</span><span class=p>:</span><span class=n>cls</span><span class=p>];</span>
    <span class=c1>// è·å–æ‰€æœ‰å·²æ³¨å†Œçš„ç±»
</span><span class=c1></span>    <span class=kt>Class</span><span class=o>*</span> <span class=n>classes</span> <span class=o>=</span> <span class=p>(</span><span class=kt>Class</span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>Class</span><span class=p>)</span><span class=o>*</span><span class=n>count</span><span class=p>);</span>
    <span class=n>objc_getClassList</span><span class=p>(</span><span class=n>classes</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cls</span> <span class=o>==</span> <span class=n>class_getSuperclass</span><span class=p>(</span><span class=n>classes</span><span class=p>[</span><span class=n>i</span><span class=p>]))</span> <span class=p>{</span>
            <span class=p>[</span><span class=n>mArray</span> <span class=nl>addObject</span><span class=p>:</span><span class=n>classes</span><span class=p>[</span><span class=n>i</span><span class=p>]];</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>free</span><span class=p>(</span><span class=n>classes</span><span class=p>);</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;classes = %@&#34;</span><span class=p>,</span> <span class=n>mArray</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>æ‰“å°ç»“æœï¼š</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># æ³¨å†Œ KVO å‰</span>
<span class=k>class</span> <span class=o>=</span> <span class=p>(</span>
	<span class=no>Person</span>
<span class=p>)</span>
<span class=c1># æ³¨å†Œ KVO å</span>
<span class=k>class</span> <span class=o>=</span> <span class=p>(</span>
	<span class=no>Person</span><span class=p>,</span>
	<span class=s2>&#34;NSKVONotifying_Person&#34;</span>
<span class=p>)</span>
</code></pre></div><p>è¿™å°±è¯´æ˜ï¼Œ<code>NSKVONotifying_Person</code>æ˜¯<code>Person</code>çš„å­ç±»</p><h4 id=åŠ¨æ€å­ç±»æ¢ç´¢><a href=#åŠ¨æ€å­ç±»æ¢ç´¢ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åŠ¨æ€å­ç±»æ¢ç´¢</h4><p>è·å–<code>NSKVONotifying_Person</code>ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=cp>#pragma mark - éå†æ–¹æ³•-ivar-property
</span><span class=cp></span><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>printClassAllMethod:</span><span class=p>(</span><span class=kt>Class</span><span class=p>)</span><span class=nv>cls</span><span class=p>{</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>Method</span> <span class=o>*</span><span class=n>methodList</span> <span class=o>=</span> <span class=n>class_copyMethodList</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Method</span> <span class=n>method</span> <span class=o>=</span> <span class=n>methodList</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=kt>SEL</span> <span class=n>sel</span> <span class=o>=</span> <span class=n>method_getName</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
        <span class=kt>IMP</span> <span class=n>imp</span> <span class=o>=</span> <span class=n>class_getMethodImplementation</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>sel</span><span class=p>);</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@-%p&#34;</span><span class=p>,</span><span class=n>NSStringFromSelector</span><span class=p>(</span><span class=n>sel</span><span class=p>),</span><span class=n>imp</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>free</span><span class=p>(</span><span class=n>methodList</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>//********è°ƒç”¨********
</span><span class=c1></span><span class=p>[</span><span class=nb>self</span> <span class=nl>printClassAllMethod</span><span class=p>:</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSKVONotifying_Person&#34;</span><span class=p>)];</span>

<span class=c1>//********è¾“å‡º********
</span><span class=c1>// setName:-0x7fff207bab57
</span><span class=c1>// class-0x7fff207b9662
</span><span class=c1>// dealloc-0x7fff207b940b
</span><span class=c1>// _isKVOA-0x7fff207b9403
</span><span class=c1></span>
<span class=c1>//********è°ƒç”¨********
</span><span class=c1></span><span class=p>[</span><span class=nb>self</span> <span class=nl>printClassAllMethod</span><span class=p>:</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;Person&#34;</span><span class=p>)];</span>
<span class=c1>//********è¾“å‡º********
</span><span class=c1>// name-0x10a6acd50
</span><span class=c1>// .cxx_destruct-0x10a6acdb0
</span><span class=c1>// setName:-0x10a6acd70
</span></code></pre></div><p>é€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼š</p><ul><li><code>Person</code>ç±»ä¸­çš„æ–¹æ³•æ²¡æœ‰æ”¹å˜</li><li><code>NSKVONotifying_Person</code>ç±»é‡å†™åŸºç±» <code>NSObject</code> çš„ <code>classã€deallocã€_isKVOA</code> æ–¹æ³•<ul><li><code>class</code> â€”â€” é‡å†™ class æ–¹æ³•ï¼Œå°† isa æŒ‡å‘ <code>NSKVONotifying_Person</code></li><li><code>dealloc</code> â€”â€” é‡å†™ dealloc æ–¹æ³•ï¼Œå°† isa æŒ‡å› <code>Person</code></li><li><code>_isKVOA</code> â€”â€” ç”¨äºåˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯ KVO ç±»</li></ul></li><li><code>NSKVONotifying_Person</code>ç±»é‡å†™çˆ¶ç±»çš„ <code>setName</code> æ–¹æ³•<ul><li>å­ç±»åªç»§æ‰¿ã€ä¸é‡å†™æ˜¯ä¸ä¼šæœ‰æ–¹æ³• IMPï¼Œä¸”ä¸¤ä¸ª setName çš„åœ°å€ä¸ä¸€æ ·</li></ul></li></ul><p><strong>deallocä¹‹ååŠ¨æ€å­ç±»ä¼šé”€æ¯å—ï¼Ÿ</strong></p><p>ç­”ï¼šä¸ä¼šé”€æ¯</p><p>ä¸­é—´ç±»ä¸€æ—¦ç”Ÿæˆï¼Œä¼šä¸€ç›´å­˜åœ¨åœ¨å†…å­˜ä¸­ â€”â€” ä¸»è¦æ˜¯è€ƒè™‘é‡ç”¨çš„ï¼Œé¿å…é‡å¤å¤šæ¬¡æ³¨å†ŒåŠ¨æ€å­ç±»åˆ°å†…å­˜ä¸­</p><p><strong>automaticallyNotifiesObserversForKeyæ˜¯å¦ä¼šå½±å“åŠ¨æ€å­ç±»ç”Ÿæˆ</strong></p><p>ç­”ï¼šä¼š</p><p>åŠ¨æ€å­ç±»ä¼šæ ¹æ®è§‚å¯Ÿå±æ€§çš„<code>automaticallyNotifiesObserversForKey</code>çš„å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ç”Ÿæˆ</p><p>æ€»ç»“ï¼š</p><ol><li><code>automaticallyNotifiesObserversForKey</code>ä¸º<code>YES</code>æ—¶æ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»<code>NSKVONotifying_XXX</code></li><li>åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯<code>setter</code>æ–¹æ³•</li><li>åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„<code>setter</code>æ–¹æ³•ã€<code>dealloc</code>ã€<code>class</code>ã€<code>_isKVOA</code>æ–¹æ³•<ul><li><code>setter</code>æ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼</li><li><code>dealloc</code>æ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å¯¹isaæŒ‡å‘è¿›è¡Œæ“ä½œ</li><li><code>class</code>æ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±»</li><li><code>_isKVOA</code>ç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½</li></ul></li><li><code>dealloc</code> ä¹‹å <code>isa</code> æŒ‡å‘åŸæ¥çš„ç±» â€”â€” çˆ¶ç±»</li><li><code>dealloc</code> ä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯</li></ol><h3 id=è‡ªå®šä¹‰kvo><a href=#è‡ªå®šä¹‰kvo class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>è‡ªå®šä¹‰KVO</h3><p>è‡ªå®šKVOçš„æµç¨‹ï¼Œè·Ÿç³»ç»Ÿä¸€è‡´ï¼Œåªæ˜¯åœ¨ç³»ç»Ÿçš„åŸºç¡€ä¸Šé’ˆå¯¹å…¶ä¸­çš„éƒ¨åˆ†åšäº†ä¸€äº›ä¼˜åŒ–å¤„ç†ã€‚</p><ul><li>1ã€å°†<code>æ³¨å†Œå’Œå“åº”</code>é€šè¿‡å‡½æ•°å¼ç¼–ç¨‹ï¼Œå³<code>block</code>çš„æ–¹æ³•ç»“åˆåœ¨ä¸€èµ·</li><li>2ã€å»æ‰ç³»ç»Ÿç¹ççš„ä¸‰éƒ¨æ›²ï¼Œå®ç°<code>KVOè‡ªåŠ¨é”€æ¯æœºåˆ¶</code></li></ul><p><strong>å®šä¹‰ blockï¼Œæ³¨å†Œè§‚å¯Ÿæ–¹æ³•ï¼Œç§»é™¤è§‚å¯Ÿæ–¹æ³•</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>typedef</span> <span class=nf>void</span><span class=p>(</span><span class=o>^</span><span class=n>KVOBlock</span><span class=p>)(</span><span class=kt>id</span> <span class=n>observer</span><span class=p>,</span><span class=n>NSString</span> <span class=o>*</span><span class=n>keyPath</span><span class=p>,</span><span class=kt>id</span> <span class=n>oldValue</span><span class=p>,</span><span class=kt>id</span> <span class=n>newValue</span><span class=p>);</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>kvo_addObserver:</span><span class=p>(</span><span class=n>NSObject</span> <span class=o>*</span><span class=p>)</span><span class=nv>observer</span> <span class=nf>forKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>handleBlock:</span><span class=p>(</span><span class=n>KVOBlock</span><span class=p>)</span><span class=nv>block</span><span class=p>;</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>kvo_removeObserver:</span><span class=p>(</span><span class=n>NSObject</span> <span class=o>*</span><span class=p>)</span><span class=nv>observer</span> <span class=nf>forKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span><span class=p>;</span>
</code></pre></div><p>æ•´ä¸ªè¿‡ç¨‹ä¸ºï¼š</p><ol><li><p>åˆ¤æ–­å½“å‰è§‚å¯Ÿå€¼ <code>keyPath</code> çš„ <code>setter</code> æ–¹æ³•æ˜¯å¦å­˜åœ¨</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>BOOL</span><span class=p>)</span><span class=nf>judgeSetterMethodFromKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=p>{</span>
       
    <span class=kt>Class</span> <span class=n>superClass</span> <span class=o>=</span> <span class=n>object_getClass</span><span class=p>(</span><span class=nb>self</span><span class=p>);</span>
       
    <span class=kt>SEL</span> <span class=n>setterSelector</span> <span class=o>=</span> <span class=n>NSSelectorFromString</span><span class=p>(</span><span class=n>setterForGetter</span><span class=p>(</span><span class=n>keyPath</span><span class=p>));</span>
       
    <span class=n>Method</span> <span class=n>setterMethod</span> <span class=o>=</span> <span class=n>class_getInstanceMethod</span><span class=p>(</span><span class=n>superClass</span><span class=p>,</span> <span class=n>setterSelector</span><span class=p>);</span>
       
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>setterMethod</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;æ²¡æœ‰æ‰¾åˆ°è¯¥å±æ€§çš„setteræ–¹æ³•--%@&#34;</span><span class=p>,</span> <span class=n>keyPath</span><span class=p>);</span>
        <span class=k>return</span> <span class=nb>NO</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>YES</span><span class=p>;</span>
<span class=p>}</span>
   
<span class=cp>#pragma mark - ä»getæ–¹æ³•è·å–setæ–¹æ³•çš„åç§°
</span><span class=cp></span><span class=k>static</span> <span class=n>NSString</span> <span class=o>*</span><span class=nf>setterForGetter</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=k>getter</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=k>getter</span><span class=p>.</span><span class=n>length</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span> <span class=p>}</span>
    <span class=n>NSString</span> <span class=o>*</span><span class=n>firstString</span> <span class=o>=</span> <span class=p>[[</span><span class=k>getter</span> <span class=nl>substringToIndex</span><span class=p>:</span><span class=mi>1</span><span class=p>]</span> <span class=n>uppercaseString</span><span class=p>];</span>
    <span class=n>NSString</span> <span class=o>*</span><span class=n>leaveString</span> <span class=o>=</span> <span class=p>[</span><span class=k>getter</span> <span class=nl>substringFromIndex</span><span class=p>:</span><span class=mi>1</span><span class=p>];</span>
    <span class=k>return</span> <span class=p>[</span><span class=n>NSString</span> <span class=nl>stringWithFormat</span><span class=p>:</span><span class=s>@&#34;set%@%@:&#34;</span><span class=p>,</span><span class=n>firstString</span><span class=p>,</span><span class=n>leaveString</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div></li><li><p>åˆ¤æ–­è§‚å¯Ÿå±æ€§çš„<code>automaticallyNotifiesObserversForKey</code>æ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>BOOL</span><span class=p>)</span><span class=nf>kvo_performSelectorWithMethodName:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>methodName</span> <span class=nf>keyPath:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>keyPath</span> <span class=p>{</span>
       
    <span class=k>if</span> <span class=p>([[</span><span class=nb>self</span> <span class=k>class</span><span class=p>]</span> <span class=nl>respondsToSelector</span><span class=p>:</span><span class=n>NSSelectorFromString</span><span class=p>(</span><span class=n>methodName</span><span class=p>)])</span> <span class=p>{</span>
           
<span class=cp>#pragma clang diagnostic push
</span><span class=cp>#pragma clang diagnostic ignored &#34;-Warc-performSelector-leaks&#34;
</span><span class=cp></span>        <span class=kt>BOOL</span> <span class=n>i</span> <span class=o>=</span> <span class=p>[[</span><span class=nb>self</span> <span class=k>class</span><span class=p>]</span> <span class=nl>performSelector</span><span class=p>:</span><span class=n>NSSelectorFromString</span><span class=p>(</span><span class=n>methodName</span><span class=p>)</span> <span class=nl>withObject</span><span class=p>:</span><span class=n>keyPath</span><span class=p>];</span>
        <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
<span class=cp>#pragma clang diagnostic pop
</span><span class=cp></span>    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>NO</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></li><li><p>åŠ¨æ€ç”Ÿæˆå­ç±»ï¼Œæ·»åŠ <code>class</code>æ–¹æ³•æŒ‡å‘åŸå…ˆçš„ç±»</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>Class</span><span class=p>)</span><span class=nf>cretaChildClassWithKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=p>{</span>
       
    <span class=n>NSString</span> <span class=o>*</span><span class=n>oldClassName</span> <span class=o>=</span> <span class=n>NSStringFromClass</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=k>class</span><span class=p>);</span>
    <span class=n>NSString</span> <span class=o>*</span><span class=n>newClassName</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSString</span> <span class=nl>stringWithFormat</span><span class=p>:</span><span class=s>@&#34;%@%@&#34;</span><span class=p>,</span> <span class=n>kKVOPrefix</span><span class=p>,</span> <span class=n>oldClassName</span><span class=p>];</span>
       
    <span class=kt>Class</span> <span class=n>newClass</span> <span class=o>=</span> <span class=n>NSClassFromString</span><span class=p>(</span><span class=n>newClassName</span><span class=p>);</span>
       
    <span class=k>if</span> <span class=p>(</span><span class=n>newClass</span><span class=p>)</span> <span class=k>return</span> <span class=n>newClass</span><span class=p>;</span>
       
    <span class=n>newClass</span> <span class=o>=</span> <span class=n>objc_allocateClassPair</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=k>class</span><span class=p>,</span> <span class=n>newClassName</span><span class=p>.</span><span class=n>UTF8String</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
    <span class=n>objc_registerClassPair</span><span class=p>(</span><span class=n>newClass</span><span class=p>);</span>
       
    <span class=c1>//  class
</span><span class=c1></span>    <span class=kt>SEL</span> <span class=n>classSel</span> <span class=o>=</span> <span class=n>NSSelectorFromString</span><span class=p>(</span><span class=s>@&#34;class&#34;</span><span class=p>);</span>
    <span class=n>Method</span> <span class=n>classMethod</span> <span class=o>=</span> <span class=n>class_getInstanceMethod</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=k>class</span><span class=p>,</span> <span class=n>classSel</span><span class=p>);</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>classType</span> <span class=o>=</span> <span class=n>method_getTypeEncoding</span><span class=p>(</span><span class=n>classMethod</span><span class=p>);</span>
    <span class=n>class_addMethod</span><span class=p>(</span><span class=n>newClass</span><span class=p>,</span> <span class=n>classSel</span><span class=p>,</span> <span class=p>(</span><span class=kt>IMP</span><span class=p>)</span><span class=n>kvo_class</span><span class=p>,</span> <span class=n>classType</span><span class=p>);</span>
       
    <span class=c1>// setter
</span><span class=c1></span>    <span class=kt>SEL</span> <span class=n>setterSel</span> <span class=o>=</span> <span class=n>NSSelectorFromString</span><span class=p>(</span><span class=n>setterForGetter</span><span class=p>(</span><span class=n>keyPath</span><span class=p>));</span>
    <span class=n>Method</span> <span class=n>setterMethod</span> <span class=o>=</span> <span class=n>class_getInstanceMethod</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=k>class</span><span class=p>,</span> <span class=n>setterSel</span><span class=p>);</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>setterType</span> <span class=o>=</span> <span class=n>method_getTypeEncoding</span><span class=p>(</span><span class=n>setterMethod</span><span class=p>);</span>
    <span class=n>class_addMethod</span><span class=p>(</span><span class=n>newClass</span><span class=p>,</span> <span class=n>setterSel</span><span class=p>,</span> <span class=p>(</span><span class=kt>IMP</span><span class=p>)</span><span class=n>kvo_setter</span><span class=p>,</span> <span class=n>setterType</span><span class=p>);</span>
       
    <span class=c1>// dealloc
</span><span class=c1></span>    <span class=k>static</span> <span class=n>dispatch_once_t</span> <span class=n>onceToken</span><span class=p>;</span>
    <span class=n>dispatch_once</span><span class=p>(</span><span class=o>&amp;</span><span class=n>onceToken</span><span class=p>,</span> <span class=o>^</span><span class=p>{</span>
        <span class=p>[</span><span class=nb>self</span> <span class=nl>kvo_MethodSwizzlingWithClass</span><span class=p>:</span><span class=nb>self</span><span class=p>.</span><span class=k>class</span>
                                    <span class=nl>oriSEL</span><span class=p>:</span><span class=n>NSSelectorFromString</span><span class=p>(</span><span class=s>@&#34;dealloc&#34;</span><span class=p>)</span>
                               <span class=nl>swizzledSEL</span><span class=p>:</span><span class=k>@selector</span><span class=p>(</span><span class=n>kvo_dealloc</span><span class=p>)];</span>
    <span class=p>});</span>
       
    <span class=k>return</span> <span class=n>newClass</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>é‡å†™ <code>class</code> æ–¹æ³•</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=kt>Class</span> <span class=nf>kvo_class</span><span class=p>(</span><span class=kt>id</span> <span class=nb>self</span><span class=p>,</span> <span class=kt>SEL</span> <span class=n>_cmd</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>class_getSuperclass</span><span class=p>(</span><span class=n>object_getClass</span><span class=p>(</span><span class=nb>self</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div></li><li><p>é‡å†™ <code>setter</code> æ–¹æ³•</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>static</span> <span class=kt>void</span> <span class=nf>kvo_setter</span><span class=p>(</span><span class=kt>id</span> <span class=nb>self</span><span class=p>,</span><span class=kt>SEL</span> <span class=n>_cmd</span><span class=p>,</span><span class=kt>id</span> <span class=n>newValue</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>NSString</span> <span class=o>*</span><span class=n>keyPath</span> <span class=o>=</span> <span class=n>getterForSetter</span><span class=p>(</span><span class=n>NSStringFromSelector</span><span class=p>(</span><span class=n>_cmd</span><span class=p>));</span>
         
    <span class=kt>id</span> <span class=n>oldValue</span> <span class=o>=</span> <span class=p>[</span><span class=nb>self</span> <span class=nl>valueForKey</span><span class=p>:</span><span class=n>keyPath</span><span class=p>];</span>
    <span class=c1>//é€šè¿‡ç³»ç»Ÿå¼ºåˆ¶ç±»å‹è½¬æ¢è‡ªå®šä¹‰objc_msgSendSuper
</span><span class=c1></span>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>kvo_msgSenderSuper</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=kt>SEL</span><span class=p>,</span> <span class=kt>id</span><span class=p>)</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSendSuper</span><span class=p>;</span>
    <span class=c1>//å®šä¹‰ä¸€ä¸ªç»“æ„ä½“
</span><span class=c1></span>    <span class=k>struct</span> <span class=n>objc_super</span> <span class=n>superStruct</span> <span class=o>=</span> <span class=p>{</span>
        <span class=p>.</span><span class=n>receiver</span> <span class=o>=</span> <span class=nb>self</span><span class=p>,</span>
        <span class=p>.</span><span class=n>super_class</span> <span class=o>=</span> <span class=n>class_getSuperclass</span><span class=p>(</span><span class=n>object_getClass</span><span class=p>(</span><span class=nb>self</span><span class=p>)),</span>
    <span class=p>};</span>
  <span class=c1>//è°ƒç”¨è‡ªå®šä¹‰çš„å‘é€æ¶ˆæ¯å‡½æ•°
</span><span class=c1></span>    <span class=n>kvo_msgSenderSuper</span><span class=p>(</span><span class=o>&amp;</span><span class=n>superStruct</span><span class=p>,</span> <span class=n>_cmd</span><span class=p>,</span> <span class=n>newValue</span><span class=p>);</span>
       
    <span class=cm>/*---å‡½æ•°å¼ç¼–ç¨‹---*/</span>
    <span class=c1>//è®©vcå»å“åº”
</span><span class=c1></span>    <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mArray</span> <span class=o>=</span> <span class=n>objc_getAssociatedObject</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=p>(</span><span class=k>__bridge</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span> <span class=n>_Nonnull</span><span class=p>)(</span><span class=n>kKVOAssiociateKey</span><span class=p>));</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>KVOInfo</span> <span class=o>*</span><span class=n>info</span> <span class=k>in</span> <span class=n>mArray</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>([</span><span class=n>info</span><span class=p>.</span><span class=n>keyPath</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=n>keyPath</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>info</span><span class=p>.</span><span class=n>handleBlock</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>info</span><span class=p>.</span><span class=n>handleBlock</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=n>observer</span><span class=p>,</span> <span class=n>keyPath</span><span class=p>,</span> <span class=n>oldValue</span><span class=p>,</span> <span class=n>newValue</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li><li><p>é‡å†™ <code>dealloc</code> æ–¹æ³•</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>kvo_dealloc</span> <span class=p>{</span>
    <span class=kt>Class</span> <span class=n>superClass</span> <span class=o>=</span> <span class=p>[</span><span class=nb>self</span> <span class=k>class</span><span class=p>];</span>
    <span class=n>object_setClass</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=n>superClass</span><span class=p>);</span>
    <span class=p>[</span><span class=nb>self</span> <span class=n>kvo_dealloc</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div></li></ul></li><li><p>isaé‡æŒ‡å‘â€”â€”ä½¿å¯¹è±¡çš„<code>isa</code>çš„å€¼æŒ‡å‘åŠ¨æ€å­ç±»</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=n>object_setClass</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=n>newClass</span><span class=p>);</span>
</code></pre></div></li><li><p>ä¿å­˜ä¿¡æ¯</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>KVOInfo</span> : <span class=nc>NSObject</span>
   
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>weak</span><span class=p>)</span> <span class=n>NSObject</span> <span class=o>*</span><span class=n>observer</span><span class=p>;</span>
   
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>keyPath</span><span class=p>;</span>
   
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>KVOBlock</span> <span class=n>handleBlock</span><span class=p>;</span>
   
<span class=k>@end</span>
   
<span class=k>@implementation</span> <span class=nc>KVOInfo</span>
   
<span class=p>-</span> <span class=p>(</span><span class=kt>instancetype</span><span class=p>)</span><span class=nf>initWitObserver:</span><span class=p>(</span><span class=n>NSObject</span> <span class=o>*</span><span class=p>)</span><span class=nv>observer</span> <span class=nf>forKeyPath:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>keyPath</span> <span class=nf>handleBlock:</span><span class=p>(</span><span class=n>KVOBlock</span><span class=p>)</span><span class=nv>block</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nb>self</span><span class=o>=</span><span class=p>[</span><span class=nb>super</span> <span class=n>init</span><span class=p>])</span> <span class=p>{</span>
        <span class=n>_observer</span> <span class=o>=</span> <span class=n>observer</span><span class=p>;</span>
        <span class=n>_keyPath</span>  <span class=o>=</span> <span class=n>keyPath</span><span class=p>;</span>
        <span class=n>_handleBlock</span> <span class=o>=</span> <span class=n>block</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>self</span><span class=p>;</span>
<span class=p>}</span>
<span class=k>@end</span>
     
<span class=n>KVOInfo</span> <span class=o>*</span><span class=n>info</span> <span class=o>=</span> <span class=p>[[</span><span class=n>KVOInfo</span> <span class=n>alloc</span><span class=p>]</span> <span class=nl>initWitObserver</span><span class=p>:</span><span class=n>observer</span> <span class=nl>forKeyPath</span><span class=p>:</span><span class=n>keyPath</span> <span class=nl>handleBlock</span><span class=p>:</span><span class=n>block</span><span class=p>];</span>
<span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mArray</span> <span class=o>=</span> <span class=n>objc_getAssociatedObject</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=p>(</span><span class=k>__bridge</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span> <span class=n>_Nonnull</span><span class=p>)(</span><span class=n>kKVOAssiociateKey</span><span class=p>));</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mArray</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>mArray</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSMutableArray</span> <span class=nl>arrayWithCapacity</span><span class=p>:</span><span class=mi>1</span><span class=p>];</span>
    <span class=n>objc_setAssociatedObject</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=p>(</span><span class=k>__bridge</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span> <span class=n>_Nonnull</span><span class=p>)(</span><span class=n>kKVOAssiociateKey</span><span class=p>),</span> <span class=n>mArray</span><span class=p>,</span> <span class=n>OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=p>);</span>
<span class=p>}</span>
<span class=p>[</span><span class=n>mArray</span> <span class=nl>addObject</span><span class=p>:</span><span class=n>info</span><span class=p>];</span>
</code></pre></div></li></ol><p>è¿™æ ·è‡ªå®šä¹‰ KVO å°±å°† KVO ä¸‰æ­¥æ“ä½œç”¨ block å½¢å¼åˆæˆä¸€æ­¥</p><p>è‡ªå®šä¹‰KVOæ•´ä¸ªè¿‡ç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥</p><ul><li>æ³¨å†Œè§‚å¯Ÿè€… & å“åº”<ul><li>1ã€éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•</li><li>2ã€ä¿å­˜ä¿¡æ¯</li><li>3ã€åŠ¨æ€ç”Ÿæˆå­ç±»ï¼Œéœ€è¦é‡å†™<code>class</code>ã€<code>setter</code>æ–¹æ³•</li><li>4ã€åœ¨å­ç±»çš„setteræ–¹æ³•ä¸­å‘çˆ¶ç±»å‘æ¶ˆæ¯ï¼Œå³è‡ªå®šä¹‰æ¶ˆæ¯å‘é€</li><li>5ã€è®©è§‚å¯Ÿè€…å“åº”</li></ul></li><li>ç§»é™¤è§‚å¯Ÿè€…<ul><li>1ã€æ›´æ”¹<code>isaæŒ‡å‘</code>ä¸ºåŸæœ‰ç±»</li><li>2ã€é‡å†™å­ç±»çš„<code>dealloc</code>æ–¹æ³•</li></ul></li></ul><p><a href=https://github.com/dev-jw/Custom_KVO target=_blank rel=noopener>å®Œæ•´ Demo</a></p><blockquote><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href=https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html target=_blank rel=noopener>è‹¹æœå®˜æ–¹æ–‡æ¡£</a></p><p><a href=https://github.com/knightsj/SJKVOController target=_blank rel=noopener>J_Knight_å†™çš„SJKVOController</a><a href=https://github.com/facebookarchive/KVOController target=_blank rel=noopener>FBKVO</a>ï¼ˆå¼ºçƒˆå»ºè®®é˜…è¯»æˆç†Ÿçš„è‡ªå®šä¹‰ KVOï¼‰</p></blockquote></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>