<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-åˆ†ç±»å’Œæ‹“å±•çš„åŠ è½½ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="ä¸Šç¯‡æ–‡ç« iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½åˆ†æäº†ç±»çš„åŠ è½½è¿‡ç¨‹ï¼Œç†è§£äº†ç±»æ˜¯å¦‚ä½•ä» Mach-O åŠ è½½åˆ°å†…å­˜â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/category/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-10-16T20:02:39+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/category/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-åˆ†ç±»å’Œæ‹“å±•çš„åŠ è½½","description":"ä¸Šç¯‡æ–‡ç« iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½åˆ†æäº†ç±»çš„åŠ è½½è¿‡ç¨‹ï¼Œç†è§£äº†ç±»æ˜¯å¦‚ä½•ä» Mach-O åŠ è½½åˆ°å†…å­˜â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-åˆ†ç±»å’Œæ‹“å±•çš„åŠ è½½"><meta property="og:description" content="ä¸Šç¯‡æ–‡ç« iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½åˆ†æäº†ç±»çš„åŠ è½½è¿‡ç¨‹ï¼Œç†è§£äº†ç±»æ˜¯å¦‚ä½•ä» Mach-O åŠ è½½åˆ°å†…å­˜â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/category/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-åˆ†ç±»å’Œæ‹“å±•çš„åŠ è½½</h1><div class=post-meta><time datetime=2020-10-16T20:02:39+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-10-16</time></div><div class="post-body e-content"><p>ä¸Šç¯‡æ–‡ç« <a href=../class-load>iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½</a>åˆ†æäº†<code>ç±»çš„åŠ è½½</code>è¿‡ç¨‹ï¼Œç†è§£äº†ç±»æ˜¯å¦‚ä½•ä» Mach-O åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å¯¹<code>attachCategories</code>è¯¦ç»†å±•å¼€ï¼Œè€Œè¿™ä¸ªå‡½æ•°æ­£æ˜¯åˆ†ç±»çš„åŠ è½½çš„å…¥å£</p><p>ï¼ˆè¯·å…ˆå¯¹<code>ç±»çš„åŠ è½½è¿‡ç¨‹</code>æœ‰äº†ä¸€å®šäº†è§£ä¹‹åå†å¼€å¯æœ¬æ–‡ï¼‰</p><p>åŒæ ·çš„ï¼Œæå‡ºå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>åˆ†ç±»çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ</li><li>åˆ†ç±»ä¸ç±»çš„å‡ ç§æ­é…åŠ è½½è¿‡ç¨‹</li><li>ç±»æ‹“å±•çš„åŠ è½½</li><li><code>initalize</code>çš„åˆ†æ</li></ul><h3 id=åˆ†ç±»çš„æœ¬è´¨><a href=#åˆ†ç±»çš„æœ¬è´¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åˆ†ç±»çš„æœ¬è´¨</h3><p>ä¸ºäº†æ¢ç´¢åˆ†ç±»çš„æœ¬è´¨ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ© <code>clang</code> æŸ¥çœ‹åˆ†ç±»åœ¨åº•å±‚ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ</p><p>åˆ›å»ºä¸€ä¸ªç±»ï¼Œä»¥åŠå…¶åˆ†ç±»</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>Person</span> : <span class=nc>NSObject</span>
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>assign</span><span class=p>)</span> <span class=n>NSNumber</span> <span class=o>*</span><span class=n>age</span><span class=p>;</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>doFirst</span><span class=p>;</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>doSecond</span><span class=p>;</span>
<span class=k>@end</span>

<span class=k>@implementation</span> <span class=nc>Person</span>
<span class=p>+</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>load</span> <span class=p>{</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>doFirst</span> <span class=p>{}</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>doSecond</span> <span class=p>{}</span>
<span class=k>@end</span>

<span class=k>@interface</span> <span class=nc>Person</span> <span class=nl>(Test)</span>

<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>test_name</span><span class=p>;</span>
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>assign</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>test_age</span><span class=p>;</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>test_doFirst</span><span class=p>;</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>test_doSecond</span><span class=p>;</span>
<span class=k>@end</span>

<span class=k>@implementation</span> <span class=nc>Person</span> <span class=nl>(Test)</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>test_doFirst</span> <span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%s&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>);</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>test_doSecond</span> <span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%s&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>@end</span>
</code></pre></div><p><code>clang</code> ç¼–è¯‘ï¼Œé¦–å…ˆå¯ä»¥å¾—å‡ºåˆ†ç±»æ˜¯å­˜å‚¨åœ¨ Mach-O çš„ <code>__DATA</code> æ®µçš„ <code>__objc_catlist</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=k>struct</span> <span class=nc>_category_t</span> <span class=o>*</span><span class=n>L_OBJC_LABEL_CATEGORY_</span><span class=err>$</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=n>__attribute__</span><span class=p>((</span><span class=n>used</span><span class=p>,</span> <span class=n>section</span> <span class=p>(</span><span class=s>&#34;__DATA, __objc_catlist,regular,no_dead_strip&#34;</span><span class=p>)))</span><span class=o>=</span> <span class=p>{</span>
	<span class=o>&amp;</span><span class=n>_OBJC_</span><span class=err>$</span><span class=n>_CATEGORY_Person_</span><span class=err>$</span><span class=n>_Test</span><span class=p>,</span>
<span class=p>};</span>
</code></pre></div><p>ç„¶åæ˜¯ Person çš„åˆ†ç±»ç»“æ„ä¸º<code>_category_t</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=k>struct</span> <span class=nc>_category_t</span> <span class=n>_OBJC_</span><span class=err>$</span><span class=n>_CATEGORY_Person_</span><span class=err>$</span><span class=n>_Test</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>used</span><span class=p>,</span> <span class=n>section</span> <span class=p>(</span><span class=s>&#34;__DATA,__objc_const&#34;</span><span class=p>)))</span> <span class=o>=</span> 
<span class=p>{</span>
	<span class=s>&#34;Person&#34;</span><span class=p>,</span>
	<span class=mi>0</span><span class=p>,</span> <span class=c1>// &amp;OBJC_CLASS_$_Person,
</span><span class=c1></span>	<span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=nc>_method_list_t</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>_OBJC_</span><span class=err>$</span><span class=n>_CATEGORY_INSTANCE_METHODS_Person_</span><span class=err>$</span><span class=n>_Test</span><span class=p>,</span>
	<span class=mi>0</span><span class=p>,</span>
	<span class=mi>0</span><span class=p>,</span>
	<span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=nc>_prop_list_t</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>_OBJC_</span><span class=err>$</span><span class=n>_PROP_LIST_Person_</span><span class=err>$</span><span class=n>_Test</span><span class=p>,</span>
<span class=p>};</span>
</code></pre></div><p>å†æ¥çœ‹ä¸€ä¸‹<code>_category_t</code>åœ¨åº•å±‚å…·ä½“ç»“æ„ä¸º</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>_category_t</span> <span class=p>{</span>
	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
	<span class=k>struct</span> <span class=nc>_class_t</span> <span class=o>*</span><span class=n>cls</span><span class=p>;</span>
	<span class=k>const</span> <span class=k>struct</span> <span class=nc>_method_list_t</span> <span class=o>*</span><span class=n>instance_methods</span><span class=p>;</span>
	<span class=k>const</span> <span class=k>struct</span> <span class=nc>_method_list_t</span> <span class=o>*</span><span class=n>class_methods</span><span class=p>;</span>
	<span class=k>const</span> <span class=k>struct</span> <span class=nc>_protocol_list_t</span> <span class=o>*</span><span class=n>protocols</span><span class=p>;</span>
	<span class=k>const</span> <span class=k>struct</span> <span class=nc>_prop_list_t</span> <span class=o>*</span><span class=n>properties</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div><p>è€Œåœ¨objcæºç ä¸­çš„ç»“æ„ä¸º</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>category_t</span> <span class=p>{</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
    <span class=n>classref_t</span> <span class=n>cls</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>method_list_t</span> <span class=o>*</span><span class=n>instanceMethods</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>method_list_t</span> <span class=o>*</span><span class=n>classMethods</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>protocol_list_t</span> <span class=o>*</span><span class=n>protocols</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>property_list_t</span> <span class=o>*</span><span class=n>instanceProperties</span><span class=p>;</span>
    <span class=c1>// Fields below this point are not always present on disk.
</span><span class=c1></span>    <span class=k>struct</span> <span class=nc>property_list_t</span> <span class=o>*</span><span class=n>_classProperties</span><span class=p>;</span>

    <span class=n>method_list_t</span> <span class=o>*</span><span class=nf>methodsForMeta</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMeta</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isMeta</span><span class=p>)</span> <span class=k>return</span> <span class=n>classMethods</span><span class=p>;</span>
        <span class=k>else</span> <span class=k>return</span> <span class=n>instanceMethods</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>property_list_t</span> <span class=o>*</span><span class=nf>propertiesForMeta</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMeta</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>header_info</span> <span class=o>*</span><span class=n>hi</span><span class=p>);</span>
    
    <span class=n>protocol_list_t</span> <span class=o>*</span><span class=nf>protocolsForMeta</span><span class=p>(</span><span class=kt>bool</span> <span class=n>isMeta</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isMeta</span><span class=p>)</span> <span class=k>return</span> <span class=k>nullptr</span><span class=p>;</span>
        <span class=k>else</span> <span class=k>return</span> <span class=n>protocols</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>};</span>
</code></pre></div><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¹Ÿå°±å¾—å‡ºäº†åˆ†ç±»çš„æœ¬è´¨æ˜¯ä¸€ä¸ª<code>category_t</code>çš„ç»“æ„ä½“ï¼Œå…¶å†…éƒ¨æˆå‘˜æœ‰ï¼š</p><ul><li><code>name</code>ï¼šç±»çš„åå­—ï¼Œå¹¶ä¸æ˜¯åˆ†ç±»çš„åå­—</li><li><code>cls</code>ï¼šç±»å¯¹è±¡</li><li><code>instanceMethods</code>ï¼šåˆ†ç±»ä¸Šå­˜å‚¨çš„å®ä¾‹æ–¹æ³•</li><li><code>classMethods</code>ï¼šåˆ†ç±»ä¸Šå­˜å‚¨çš„ç±»æ–¹æ³•</li><li><code>protocols</code>ï¼šåˆ†ç±»ä¸Šæ‰€å®ç°çš„åè®®</li><li><code>instanceProperties</code>ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„å®ä¾‹å±æ€§ï¼Œä¸ä¼šå®ç°<code>setã€get</code>ï¼Œå› æ­¤é€šå¸¸æ˜¯é€šè¿‡å…³è”å¯¹è±¡çš„æ–¹å¼å®ç°</li><li><code>_classProperties</code>ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„ç±»å±æ€§</li></ul><blockquote><p>åˆ†ç±»çš„æ–¹æ³•ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºå®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•å­˜å‚¨å‘¢ï¼Ÿ</p><p>ç­”ï¼šå› ä¸ºç±»å’Œå…ƒç±»åœ¨ç¼–è¯‘æœŸé—´ï¼Œå·²ç»ç¡®å®šå¥½äº†å†…å­˜å¸ƒå±€ï¼Œå³å®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»ä¸­ï¼Œç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»ä¸­ï¼Œè€Œåˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶æ‰åŠ å…¥çš„ï¼Œæ‰€ä»¥éœ€è¦å°†æ–¹æ³•åŠ è½½åˆ°å¯¹åº”çš„ä½ç½®</p></blockquote><h3 id=åˆ†ç±»çš„åŠ è½½><a href=#åˆ†ç±»çš„åŠ è½½ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åˆ†ç±»çš„åŠ è½½</h3><p>å‰é¢æˆ‘ä»¬å·²ç»åˆ†æè¿‡<strong>æ‡’åŠ è½½ç±»</strong>å’Œ<strong>éæ‡’åŠ è½½ç±»</strong>çš„åŠ è½½æ—¶æœºå¹¶ä¸ä¸€æ ·</p><p>å¯¹äºåˆ†ç±»ï¼ŒåŒæ ·æœ‰<strong>æ‡’åŠ è½½åˆ†ç±»</strong>å’Œ<strong>éæ‡’åŠ è½½åˆ†ç±»</strong></p><p>å› æ­¤ï¼Œå°±å‡ºç°è¿™æ ·å››ç§ç»„åˆæƒ…å†µï¼š</p><ul><li>æ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»</li><li>éæ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»</li><li>æ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»</li><li>éæ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»</li></ul><p><strong>ç ”ç©¶å„ç§ç»„åˆä¸‹çš„åˆ†ç±»åŠ è½½æµç¨‹</strong></p><h4 id=æ‡’åŠ è½½ç±»--æ‡’åŠ è½½åˆ†ç±»><a href=#æ‡’åŠ è½½ç±»--æ‡’åŠ è½½åˆ†ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»</h4><blockquote><p>ä¸»ç±»ã€åˆ†ç±»éƒ½ä¸å®ç°<code>+load</code></p></blockquote><p><strong>æ‡’åŠ è½½ç±»çš„åŠ è½½æ—¶æœº</strong>æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯<code>lookUpImpOrForward -> realizeClassMaybeSwiftAndLeaveLocked -> realizeClassMaybeSwiftMaybeRelock -> realizeClassWithoutSwift</code></p><p>åœ¨<code>readClass</code>åŠ å…¥è°ƒè¯•ä»£ç ï¼Œå¹¶ä¸‹æ–­ç‚¹</p><p><img src=https://w-md.imzsy.design/image-20201209150540453.png alt=image-20201209150540453></p><p>ç»ˆç«¯æ‰“å° <code>test_ro</code> ä¸­çš„ <code>baseMethodList</code>, å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„æ–¹æ³•ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬åˆ†ç±»çš„</p><p>é‚£ä¹ˆï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong>æ‡’åŠ è½½åˆ†ç±»</strong>åœ¨<strong>ç¼–è¯‘æ—¶</strong>å°±å·²ç»ç¡®å®šäº†ï¼Œå½“<strong>æ‡’åŠ è½½ç±»</strong>åœ¨æ…¢é€Ÿæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹ä¸­é€šè¿‡<code>realizeClassWithoutSwift</code>åŠ è½½ï¼Œä¼šå°† Mach-O æ•°æ®çš„æ•°æ®æ®µè¯»å–åˆ°å†…å­˜ï¼Œå…¶ä¸­åŒ…æ‹¬åˆ†ç±»æ•°æ®</p><h4 id=éæ‡’åŠ è½½ç±»--æ‡’åŠ è½½åˆ†ç±»><a href=#éæ‡’åŠ è½½ç±»--æ‡’åŠ è½½åˆ†ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>éæ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»</h4><blockquote><p>ä¸»ç±»å®ç°<code>+load</code>ï¼Œåˆ†ç±»ä¸å®ç°</p></blockquote><p><strong>éæ‡’åŠ è½½</strong>æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ»â€”â€”PreMainé˜¶æ®µåŠ è½½çš„ï¼Œå³ <code>map_images -> readClass -> realizeClassWithoutSwift</code>ï¼Œé‚£ä¹ˆåŒæ ·åªè¦åœ¨<code>readClass</code>ä¸­æ‰“å° <code>test_ro</code> çš„ <code>baseMethodList</code>ï¼Œæ‰“å°ç»“æœä¸­ï¼ŒåŒæ ·å«æœ‰åˆ†ç±»çš„æ–¹æ³•</p><p>è¿™ä¹Ÿè¯´æ˜äº†ï¼Œæ‡’åŠ è½½åˆ†ç±»ï¼Œä¸ç®¡æ˜¯æ‡’åŠ è½½ç±»è¿˜æ˜¯æ‡’åŠ è½½åˆ†ç±»ï¼Œéƒ½åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†</p><h4 id=éæ‡’åŠ è½½ç±»--éæ‡’åŠ è½½åˆ†ç±»><a href=#éæ‡’åŠ è½½ç±»--éæ‡’åŠ è½½åˆ†ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>éæ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»</h4><blockquote><p>ä¸»ç±»ã€åˆ†ç±»å‡å®ç°<code>+load</code></p></blockquote><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°ï¼šåœ¨<code>methodizeClass</code>ä¸­çš„<code>attachToClass</code>æ–¹æ³•ä¼šå»åŠ è½½åˆ†ç±»</p><p>é€šè¿‡<code>attachToClass</code>æºç å®ç°ï¼Œ<code>attachCategories</code>ä¾¿æ˜¯åˆ†ç±»çš„åŠ è½½</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>attachToClass</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>Class</span> <span class=n>previously</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
    <span class=n>ASSERT</span><span class=p>((</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_CLASS</span><span class=p>)</span> <span class=o>||</span>
           <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_METACLASS</span><span class=p>)</span> <span class=o>||</span>
           <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_CLASS_AND_METACLASS</span><span class=p>));</span>

    <span class=k>auto</span> <span class=o>&amp;</span><span class=n>map</span> <span class=o>=</span> <span class=n>get</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>it</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>previously</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>map</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>category_list</span> <span class=o>&amp;</span><span class=n>list</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_CLASS_AND_METACLASS</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>otherFlags</span> <span class=o>=</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>ATTACH_CLASS_AND_METACLASS</span><span class=p>;</span>
            <span class=n>attachCategories</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>list</span><span class=p>.</span><span class=n>array</span><span class=p>(),</span> <span class=n>list</span><span class=p>.</span><span class=n>count</span><span class=p>(),</span> <span class=n>otherFlags</span> <span class=o>|</span> <span class=n>ATTACH_CLASS</span><span class=p>);</span>
            <span class=n>attachCategories</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>ISA</span><span class=p>(),</span> <span class=n>list</span><span class=p>.</span><span class=n>array</span><span class=p>(),</span> <span class=n>list</span><span class=p>.</span><span class=n>count</span><span class=p>(),</span> <span class=n>otherFlags</span> <span class=o>|</span> <span class=n>ATTACH_METACLASS</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>attachCategories</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>list</span><span class=p>.</span><span class=n>array</span><span class=p>(),</span> <span class=n>list</span><span class=p>.</span><span class=n>count</span><span class=p>(),</span> <span class=n>flags</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>map</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>it</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>ç°åœ¨çš„é—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™<code>attachCategories</code>ä¼šè¢«è°ƒç”¨</p><p>é€šè¿‡å…¨å±€æœç´¢ï¼Œå‘ç°æœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šè°ƒç”¨<code>attachCategories</code></p><ul><li><code>attachToClass</code></li><li><code>load_categories_nolock</code></li></ul><p>è€Œæ ¹æ®æ–­ç‚¹è°ƒè¯•ï¼Œ<code>attachToClass</code>ä¸ä¼šæ‰§è¡Œåˆ°<code>if</code>æµç¨‹ï¼Œå³<code>attachCategories</code>ä¸ä¼šè¢«è°ƒç”¨ï¼Œé™¤éç±»åŠ è½½ä¸¤æ¬¡</p><p><code>load_categories_nolock</code>åˆæœ‰ä¸¤æ¬¡è¢«è°ƒç”¨</p><ul><li><code>loadAllCategories</code></li><li><code>_read_images</code></li></ul><p>åŒæ ·åœ°ï¼Œæ–­ç‚¹è°ƒè¯•å‘ç°ï¼Œ<code>_read_images</code>å¹¶ä¸ä¼šè¿›å…¥ï¼Œè€Œ<code>loadAllCategories</code>åˆæ˜¯åœ¨<code>load_images</code>ä¸­è¢«è°ƒç”¨çš„</p><p>å› æ­¤ï¼Œåˆ†ç±»çš„åŠ è½½æµç¨‹ä¸ºï¼š<code>load_images -> loadAllCategories -> load_categories_nolock -> attachCategories</code></p><ul><li><strong>éæ‡’åŠ è½½åˆ†ç±»</strong>æ˜¯åœ¨ <code>load_images</code> æ—¶åŠ è½½çš„</li><li><strong>æ‡’åŠ è½½ç±»</strong>æ˜¯åœ¨<code>map_images</code>æ—¶åŠ è½½çš„</li></ul><h4 id=æ‡’åŠ è½½ç±»--éæ‡’åŠ è½½åˆ†ç±»><a href=#æ‡’åŠ è½½ç±»--éæ‡’åŠ è½½åˆ†ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»</h4><blockquote><p>ä¸»ç±»ä¸å®ç°ï¼Œåˆ†ç±»å®ç°<code>+load</code></p></blockquote><p>åŒæ ·çš„ï¼Œåœ¨<code>realizeClassWithoutSwift</code>åŠ å…¥è°ƒè¯•ä»£ç ï¼Œå¹¶ä¸‹æ–­ç‚¹</p><p>ä½†æ˜¯ï¼Œå¯ä»¥å‘ç°çš„æ˜¯ï¼Œåœ¨ç±»å¹¶æ²¡æœ‰å‘é€ç¬¬ä¸€æ¬¡æ¶ˆæ¯æ—¶ï¼Œå°±å·²ç»æ¥åˆ°æ–­ç‚¹äº†</p><blockquote><p>é‚£ä¹ˆæ‡’åŠ è½½ç±»ä¸ºä»€ä¹ˆä¼šæå‰è¢«åŠ è½½ï¼Œ<code>realizeClassWithoutSwift</code>åˆæ˜¯åœ¨ä»€ä¹ˆæ—¶åˆ»è¢«è°ƒç”¨çš„</p></blockquote><p>å…ˆåœ¨ <code>readClass</code> åŠ å…¥åŒæ ·çš„è°ƒè¯•ä»£ç ï¼Œå¹¶ä¸”æ­¤æ—¶æ‰“å° <code>test_ro</code>ï¼Œä¸èƒ½å¾—åˆ°åˆ†ç±»ä¸­çš„æ–¹æ³•</p><p>å†åˆ°<code>attachCategories</code>ä¸‹æ–­ç‚¹ï¼Œæ–­ç‚¹è¿›å…¥æ—¶ï¼Œé€šè¿‡ <code>bt</code> æ‰“å°å‡½æ•°å †æ ˆï¼š<code>load_images -> loadAllCategories -> load_categories_nolock -> attachCategories</code></p><p>é‚£ä¹ˆä¹Ÿå°±è¯´æ˜äº†ï¼Œ<strong>æ‡’åŠ è½½åˆ†ç±»</strong>åœ¨å½“ç±»ä¸º<strong>æ‡’åŠ è½½ç±»</strong>æ—¶ï¼Œä¼šè¿«ä½¿ä¸»ç±»æå‰åŠ è½½ï¼Œå³æ‡’åŠ è½½ç±»å˜ä¸ºéæ‡’åŠ è½½ç±»</p><h4 id=ç±»å’Œåˆ†ç±»åŠ è½½æ€»ç»“><a href=#ç±»å’Œåˆ†ç±»åŠ è½½æ€»ç»“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»å’Œåˆ†ç±»åŠ è½½æ€»ç»“</h4><ul><li>æ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»<ul><li>ç±»çš„åŠ è½½ï¼šç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯</li><li>åˆ†ç±»çš„åŠ è½½ï¼šç¼–è¯‘æ—¶</li></ul></li><li>éæ‡’åŠ è½½ç±» + æ‡’åŠ è½½åˆ†ç±»<ul><li>ç±»çš„åŠ è½½ï¼š<code>_read_images</code></li><li>åˆ†ç±»çš„åŠ è½½ï¼šç¼–è¯‘æ—¶</li></ul></li><li>éæ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»<ul><li>ç±»çš„åŠ è½½ï¼š<code>_read_images</code></li><li>åˆ†ç±»çš„åŠ è½½ï¼š<code>load_image</code></li></ul></li><li>æ‡’åŠ è½½ç±» + éæ‡’åŠ è½½åˆ†ç±»<ul><li>ç±»çš„åŠ è½½ï¼šåœ¨<code>_read_images</code>ä¸­å®Œæˆç±»çš„é‡æ˜ å°„æ“ä½œï¼Œè€Œåœ¨<code>load_image</code>ä¸­å®ç°æ•°æ®çš„åŠ è½½</li><li>åˆ†ç±»çš„åŠ è½½ï¼š<code>load_image</code></li></ul></li></ul><h4 id=ç±»å’Œåˆ†ç±»çš„åŒåæ–¹æ³•è°ƒç”¨><a href=#ç±»å’Œåˆ†ç±»çš„åŒåæ–¹æ³•è°ƒç”¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»å’Œåˆ†ç±»çš„åŒåæ–¹æ³•è°ƒç”¨</h4><blockquote><p>å½“ç±»å’Œåˆ†ç±»ä¸­ï¼Œæœ‰åŒåçš„æ–¹æ³•æ—¶ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å“ªä¸ªæ–¹æ³•</p></blockquote><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæåˆ°è¿‡<code>prepareMethodLists</code>ä¸­çš„<code>fixupMethodList</code>ä¼šå¯¹æ–¹æ³•è¿›è¡Œæ’åº</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> 
<span class=nf>prepareMethodLists</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>method_list_t</span> <span class=o>**</span><span class=n>addedLists</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addedCount</span><span class=p>,</span>
                   <span class=kt>bool</span> <span class=n>baseMethods</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>methodsFromBundle</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>addedCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>

    <span class=c1>// There exist RR/AWZ/Core special cases for some class&#39;s base methods.
</span><span class=c1></span>    <span class=c1>// But this code should never need to scan base methods for RR/AWZ/Core:
</span><span class=c1></span>    <span class=c1>// default RR/AWZ/Core cannot be set before setInitialized().
</span><span class=c1></span>    <span class=c1>// Therefore we need not handle any special cases here.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>baseMethods</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>hasCustomAWZ</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>hasCustomRR</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>hasCustomCore</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=c1>// Add method lists to array.
</span><span class=c1></span>    <span class=c1>// Reallocate un-fixed method lists.
</span><span class=c1></span>    <span class=c1>// The new methods are PREPENDED to the method list array.
</span><span class=c1></span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>addedCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>method_list_t</span> <span class=o>*</span><span class=n>mlist</span> <span class=o>=</span> <span class=n>addedLists</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>mlist</span><span class=p>);</span>

        <span class=c1>// Fixup selectors if necessary
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isFixedUp</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>fixupMethodList</span><span class=p>(</span><span class=n>mlist</span><span class=p>,</span> <span class=n>methodsFromBundle</span><span class=p>,</span> <span class=nb>true</span><span class=cm>/*sort*/</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// If the class is initialized, then scan for method implementations
</span><span class=c1></span>    <span class=c1>// tracked by the class&#39;s flags. If it&#39;s not initialized yet,
</span><span class=c1></span>    <span class=c1>// then objc_class::setInitialized() will take care of it.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isInitialized</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>objc</span><span class=o>::</span><span class=n>AWZScanner</span><span class=o>::</span><span class=n>scanAddedMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>addedLists</span><span class=p>,</span> <span class=n>addedCount</span><span class=p>);</span>
        <span class=n>objc</span><span class=o>::</span><span class=n>RRScanner</span><span class=o>::</span><span class=n>scanAddedMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>addedLists</span><span class=p>,</span> <span class=n>addedCount</span><span class=p>);</span>
        <span class=n>objc</span><span class=o>::</span><span class=n>CoreScanner</span><span class=o>::</span><span class=n>scanAddedMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>addedLists</span><span class=p>,</span> <span class=n>addedCount</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> 
<span class=nf>fixupMethodList</span><span class=p>(</span><span class=n>method_list_t</span> <span class=o>*</span><span class=n>mlist</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>bundleCopy</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>sort</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isFixedUp</span><span class=p>());</span>

    <span class=c1>// fixme lock less in attachMethodLists ?
</span><span class=c1></span>    <span class=c1>// dyld3 may have already uniqued, but not sorted, the list
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isUniqued</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>mutex_locker_t</span> <span class=n>lock</span><span class=p>(</span><span class=n>selLock</span><span class=p>);</span>
    
        <span class=c1>// Unique selectors in list.
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>meth</span> <span class=p>:</span> <span class=o>*</span><span class=n>mlist</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span> <span class=o>=</span> <span class=n>sel_cname</span><span class=p>(</span><span class=n>meth</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
            <span class=n>meth</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>sel_registerNameNoLock</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>bundleCopy</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Sort by selector address.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sort</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>method_t</span><span class=o>::</span><span class=n>SortBySELAddress</span> <span class=n>sorter</span><span class=p>;</span>
        <span class=n>std</span><span class=o>::</span><span class=n>stable_sort</span><span class=p>(</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span> <span class=n>mlist</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>(),</span> <span class=n>sorter</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=c1>// Mark method list as uniqued and sorted
</span><span class=c1></span>    <span class=n>mlist</span><span class=o>-&gt;</span><span class=n>setFixedUp</span><span class=p>();</span>
<span class=p>}</span>

<span class=k>struct</span> <span class=nc>method_t</span> <span class=p>{</span>
    <span class=n>SEL</span> <span class=n>name</span><span class=p>;</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>types</span><span class=p>;</span>
    <span class=n>MethodListIMP</span> <span class=n>imp</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>SortBySELAddress</span> <span class=o>:</span>
        <span class=k>public</span> <span class=n>std</span><span class=o>::</span><span class=n>binary_function</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span><span class=p>,</span>
                                    <span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span><span class=p>,</span> <span class=kt>bool</span><span class=o>&gt;</span>
    <span class=p>{</span>
        <span class=kt>bool</span> <span class=nf>operator</span><span class=p>()</span> <span class=p>(</span><span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span> <span class=n>lhs</span><span class=p>,</span>
                         <span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
        <span class=p>{</span> <span class=k>return</span> <span class=n>lhs</span><span class=p>.</span><span class=n>name</span> <span class=o>&lt;</span> <span class=n>rhs</span><span class=p>.</span><span class=n>name</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>};</span>
<span class=p>};</span>
</code></pre></div><p>æ ¹æ®æ’åºè§„åˆ™å¯å¾—ï¼šå½“æ–¹æ³•åŒåæ—¶ï¼Œä¼šæ ¹æ®æ–¹æ³•çš„ <code>name</code> è¿›è¡Œæ’åº</p><p>å†æ¥åˆ†æ<code>attachCategories</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span>
<span class=nf>attachCategories</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=k>const</span> <span class=n>locstamped_category_t</span> <span class=o>*</span><span class=n>cats_list</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>cats_count</span><span class=p>,</span>
                 <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>slowpath</span><span class=p>(</span><span class=n>PrintReplacedMethods</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>printReplacements</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>cats_list</span><span class=p>,</span> <span class=n>cats_count</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>slowpath</span><span class=p>(</span><span class=n>PrintConnecting</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;CLASS: attaching %d categories to%s class &#39;%s&#39;%s&#34;</span><span class=p>,</span>
                     <span class=n>cats_count</span><span class=p>,</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_EXISTING</span><span class=p>)</span> <span class=o>?</span> <span class=s>&#34; existing&#34;</span> <span class=o>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
                     <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>(),</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_METACLASS</span><span class=p>)</span> <span class=o>?</span> <span class=s>&#34; (meta)&#34;</span> <span class=o>:</span> <span class=s>&#34;&#34;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=cm>/*
</span><span class=cm>     * Only a few classes have more than 64 categories during launch.
</span><span class=cm>     * This uses a little stack, and avoids malloc.
</span><span class=cm>     *
</span><span class=cm>     * Categories must be added in the proper order, which is back
</span><span class=cm>     * to front. To do that with the chunking, we iterate cats_list
</span><span class=cm>     * from front to back, build up the local buffers backwards,
</span><span class=cm>     * and call attachLists on the chunks. attachLists prepends the
</span><span class=cm>     * lists, so the final result is in the expected order.
</span><span class=cm>     */</span>
    <span class=k>constexpr</span> <span class=kt>uint32_t</span> <span class=n>ATTACH_BUFSIZ</span> <span class=o>=</span> <span class=mi>64</span><span class=p>;</span>
    <span class=n>method_list_t</span>   <span class=o>*</span><span class=n>mlists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span><span class=p>];</span>
    <span class=n>property_list_t</span> <span class=o>*</span><span class=n>proplists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span><span class=p>];</span>
    <span class=n>protocol_list_t</span> <span class=o>*</span><span class=n>protolists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span><span class=p>];</span>

    <span class=kt>uint32_t</span> <span class=n>mcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>uint32_t</span> <span class=n>propcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>uint32_t</span> <span class=n>protocount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>bool</span> <span class=n>fromBundle</span> <span class=o>=</span> <span class=n>NO</span><span class=p>;</span>
    <span class=kt>bool</span> <span class=n>isMeta</span> <span class=o>=</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_METACLASS</span><span class=p>);</span>
    <span class=k>auto</span> <span class=n>rwe</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>extAllocIfNeeded</span><span class=p>();</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>cats_count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>auto</span><span class=o>&amp;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>cats_list</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>

        <span class=n>method_list_t</span> <span class=o>*</span><span class=n>mlist</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=n>cat</span><span class=o>-&gt;</span><span class=n>methodsForMeta</span><span class=p>(</span><span class=n>isMeta</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>mlist</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mcount</span> <span class=o>==</span> <span class=n>ATTACH_BUFSIZ</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>prepareMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>mlists</span><span class=p>,</span> <span class=n>mcount</span><span class=p>,</span> <span class=n>NO</span><span class=p>,</span> <span class=n>fromBundle</span><span class=p>);</span>
                <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>methods</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>mlists</span><span class=p>,</span> <span class=n>mcount</span><span class=p>);</span>
                <span class=n>mcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>mlists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=o>++</span><span class=n>mcount</span><span class=p>]</span> <span class=o>=</span> <span class=n>mlist</span><span class=p>;</span>
            <span class=n>fromBundle</span> <span class=o>|=</span> <span class=n>entry</span><span class=p>.</span><span class=n>hi</span><span class=o>-&gt;</span><span class=n>isBundle</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=n>property_list_t</span> <span class=o>*</span><span class=n>proplist</span> <span class=o>=</span>
            <span class=n>entry</span><span class=p>.</span><span class=n>cat</span><span class=o>-&gt;</span><span class=n>propertiesForMeta</span><span class=p>(</span><span class=n>isMeta</span><span class=p>,</span> <span class=n>entry</span><span class=p>.</span><span class=n>hi</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>proplist</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>propcount</span> <span class=o>==</span> <span class=n>ATTACH_BUFSIZ</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>properties</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>proplists</span><span class=p>,</span> <span class=n>propcount</span><span class=p>);</span>
                <span class=n>propcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>proplists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=o>++</span><span class=n>propcount</span><span class=p>]</span> <span class=o>=</span> <span class=n>proplist</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>protocol_list_t</span> <span class=o>*</span><span class=n>protolist</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=n>cat</span><span class=o>-&gt;</span><span class=n>protocolsForMeta</span><span class=p>(</span><span class=n>isMeta</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>protolist</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>protocount</span> <span class=o>==</span> <span class=n>ATTACH_BUFSIZ</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>protocols</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>protolists</span><span class=p>,</span> <span class=n>protocount</span><span class=p>);</span>
                <span class=n>protocount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>protolists</span><span class=p>[</span><span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=o>++</span><span class=n>protocount</span><span class=p>]</span> <span class=o>=</span> <span class=n>protolist</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>mcount</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>prepareMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>mlists</span> <span class=o>+</span> <span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=n>mcount</span><span class=p>,</span> <span class=n>mcount</span><span class=p>,</span> <span class=n>NO</span><span class=p>,</span> <span class=n>fromBundle</span><span class=p>);</span>
        <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>methods</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>mlists</span> <span class=o>+</span> <span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=n>mcount</span><span class=p>,</span> <span class=n>mcount</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>ATTACH_EXISTING</span><span class=p>)</span> <span class=n>flushCaches</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>properties</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>proplists</span> <span class=o>+</span> <span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=n>propcount</span><span class=p>,</span> <span class=n>propcount</span><span class=p>);</span>

    <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>protocols</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=n>protolists</span> <span class=o>+</span> <span class=n>ATTACH_BUFSIZ</span> <span class=o>-</span> <span class=n>protocount</span><span class=p>,</span> <span class=n>protocount</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>æ²¡é”™ï¼Œåˆ†ç±»æ·»åŠ æ–¹æ³•ã€å±æ€§ã€åè®®ä¹Ÿæ˜¯é€šè¿‡<code>attachLists</code>ï¼Œè€Œå…¶å†…éƒ¨æ˜¯é€šè¿‡<code>memmoveã€memcpy</code></p><p>æ‰€ä»¥å¾—å‡ºï¼š</p><ul><li><p>åˆ†ç±»å¹¶ä¸ä¼šè¦†ç›–ä¸»ç±»å·²æœ‰çš„æ–¹æ³•</p></li><li><p>åˆ†ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€Œç±»çš„æ–¹æ³•è¢«æ”¾å€’äº†æ–°åˆ—è¡¨çš„åé¢</p><p>å½“è¿è¡Œæ—¶åœ¨è¿›è¡Œæ–¹æ³•æŸ¥æ‰¾æ—¶ï¼Œä¼šä¼˜å…ˆæ‰¾åˆ°åˆ†ç±»çš„æ–¹æ³•ï¼Œè¿”å›<code>imp</code></p></li></ul><p><strong>åˆ†ç±»ä¸ä¸»ç±»åŒåæ–¹æ³•è°ƒç”¨é¡ºåº</strong></p><ul><li>ç±»å’Œåˆ†ç±»æ–¹æ³•åŒåæ—¶ï¼Œå¿…å®šå“åº”åˆ†ç±»æ–¹æ³•ï¼ˆä¸ç®¡ç±»å’Œåˆ†ç±»æ˜¯å¦å®ç°<code>+load</code>ï¼‰</li><li>ç±»å’Œå¤šä¸ªåˆ†ç±»æ–¹æ³•åŒåæ—¶<ul><li>å¦‚æœåˆ†ç±»æ²¡æœ‰å®ç°æˆ–å…¨éƒ½<code>+load</code>æ–¹æ³•ï¼Œå“åº”çš„æ˜¯<strong>ç¼–è¯‘å™¨</strong>æœ€åä¸€ä¸ªåˆ†ç±»ï¼Œå³<code>Compile Sources</code>ä¸­çš„æœ€åä¸€ä¸ªåˆ†ç±»</li><li>å¦‚æœåˆ†ç±»ä¸­å…¶ä¸­ä¸€ä¸ªå®ç°<code>+load</code>ï¼Œé‚£ä¹ˆå“åº”çš„æ˜¯ç¼–è¯‘å™¨ä¸­æœ€åçš„ä¸€ä¸ªéæ‡’åŠ è½½åˆ†ç±»</li></ul></li></ul><h3 id=load_images><a href=#load_images class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>load_images</h3><p><code>load_image</code>æºç </p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>load_images</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>path</span> <span class=n>__unused</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=nc>mach_header</span> <span class=o>*</span><span class=n>mh</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>didInitialAttachCategories</span> <span class=o>&amp;&amp;</span> <span class=n>didCallDyldNotifyRegister</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>didInitialAttachCategories</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
        <span class=n>loadAllCategories</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// Return without taking locks if there are no +load methods here.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasLoadMethods</span><span class=p>((</span><span class=k>const</span> <span class=n>headerType</span> <span class=o>*</span><span class=p>)</span><span class=n>mh</span><span class=p>))</span> <span class=k>return</span><span class=p>;</span>

    <span class=n>recursive_mutex_locker_t</span> <span class=n>lock</span><span class=p>(</span><span class=n>loadMethodLock</span><span class=p>);</span>

    <span class=c1>// Discover load methods
</span><span class=c1></span>    <span class=p>{</span>
        <span class=n>mutex_locker_t</span> <span class=n>lock2</span><span class=p>(</span><span class=n>runtimeLock</span><span class=p>);</span>
        <span class=n>prepare_load_methods</span><span class=p>((</span><span class=k>const</span> <span class=n>headerType</span> <span class=o>*</span><span class=p>)</span><span class=n>mh</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Call +load methods (without runtimeLock - re-entrant)
</span><span class=c1></span>    <span class=n>call_load_methods</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p><code>loadAllCategories</code>ä¹‹å‰åˆ†æäº†ï¼Œä¸»è¦æ˜¯è´Ÿè´£åŠ è½½åˆ†ç±»çš„</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªå…³é”®çš„å‡½æ•°ï¼š</p><ul><li><code>prepare_load_methods</code>ï¼šå‘ç° load æ–¹æ³•</li><li><code>call_load_methods</code>ï¼šè°ƒç”¨ load æ–¹æ³•</li></ul><h4 id=prepare_load_methods><a href=#prepare_load_methods class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>prepare_load_methods</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>prepare_load_methods</span><span class=p>(</span><span class=k>const</span> <span class=n>headerType</span> <span class=o>*</span><span class=n>mhdr</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>i</span><span class=p>;</span>

    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>

    <span class=n>classref_t</span> <span class=k>const</span> <span class=o>*</span><span class=n>classlist</span> <span class=o>=</span> 
        <span class=n>_getObjc2NonlazyClassList</span><span class=p>(</span><span class=n>mhdr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>schedule_class_load</span><span class=p>(</span><span class=n>remapClass</span><span class=p>(</span><span class=n>classlist</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span>
    <span class=p>}</span>

    <span class=n>category_t</span> <span class=o>*</span> <span class=k>const</span> <span class=o>*</span><span class=n>categorylist</span> <span class=o>=</span> <span class=n>_getObjc2NonlazyCategoryList</span><span class=p>(</span><span class=n>mhdr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>category_t</span> <span class=o>*</span><span class=n>cat</span> <span class=o>=</span> <span class=n>categorylist</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=n>remapClass</span><span class=p>(</span><span class=n>cat</span><span class=o>-&gt;</span><span class=n>cls</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>  <span class=c1>// category for ignored weak-linked class
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isSwiftStable</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;Swift class extensions and categories on Swift &#34;</span>
                        <span class=s>&#34;classes are not allowed to have +load methods&#34;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>nil</span><span class=p>);</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>ISA</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>());</span>
        <span class=n>add_category_to_loadable_list</span><span class=p>(</span><span class=n>cat</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>é€šè¿‡<code>_getObjc2NonlazyClassList</code>ä» Mach-O ä¸­è¯»å–æ‰€æœ‰çš„éæ‡’åŠ è½½ç±»éå†è°ƒç”¨<code>schedule_class_load</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>schedule_class_load</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>());</span>  <span class=c1>// _read_images should realize
</span><span class=c1></span>  
    <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>RW_LOADED</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
  
    <span class=c1>// Ensure superclass-first ordering
</span><span class=c1></span>    <span class=n>schedule_class_load</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>superclass</span><span class=p>);</span>
  
    <span class=n>add_class_to_loadable_list</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=n>cls</span><span class=o>-&gt;</span><span class=n>setInfo</span><span class=p>(</span><span class=n>RW_LOADED</span><span class=p>);</span> 
<span class=p>}</span>
  
<span class=c1>// ä¿å­˜ +load æ–¹æ³•
</span><span class=c1></span><span class=kt>void</span> <span class=nf>add_class_to_loadable_list</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>IMP</span> <span class=n>method</span><span class=p>;</span>
  
    <span class=n>loadMethodLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
  
    <span class=n>method</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>getLoadMethod</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>method</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>  <span class=c1>// Don&#39;t bother if cls has no +load method
</span><span class=c1></span>      
    <span class=k>if</span> <span class=p>(</span><span class=n>PrintLoading</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;LOAD: class &#39;%s&#39; scheduled for +load&#34;</span><span class=p>,</span> 
                     <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
    <span class=p>}</span>
      
    <span class=k>if</span> <span class=p>(</span><span class=n>loadable_classes_used</span> <span class=o>==</span> <span class=n>loadable_classes_allocated</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>loadable_classes_allocated</span> <span class=o>=</span> <span class=n>loadable_classes_allocated</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=mi>16</span><span class=p>;</span>
        <span class=n>loadable_classes</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>loadable_class</span> <span class=o>*</span><span class=p>)</span>
            <span class=n>realloc</span><span class=p>(</span><span class=n>loadable_classes</span><span class=p>,</span>
                              <span class=n>loadable_classes_allocated</span> <span class=o>*</span>
                              <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>loadable_class</span><span class=p>));</span>
    <span class=p>}</span>
      
    <span class=n>loadable_classes</span><span class=p>[</span><span class=n>loadable_classes_used</span><span class=p>].</span><span class=n>cls</span> <span class=o>=</span> <span class=n>cls</span><span class=p>;</span>
    <span class=n>loadable_classes</span><span class=p>[</span><span class=n>loadable_classes_used</span><span class=p>].</span><span class=n>method</span> <span class=o>=</span> <span class=n>method</span><span class=p>;</span>
    <span class=n>loadable_classes_used</span><span class=o>++</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>å†…éƒ¨é€’å½’è°ƒç”¨<code>schedule_class_load</code>ï¼Œæ ¹æ®ç±»çš„ç»§æ‰¿é“¾é€’å½’å»å‘ç°çˆ¶ç±»çš„<code>+load</code>æ–¹æ³•ï¼Œä»¥ç¡®ä¿çˆ¶ç±»çš„<code>+load</code>æ–¹æ³•ä¼˜å…ˆåŠ è½½</p><p>å†è°ƒç”¨<code>add_class_to_loadable_list</code>æŠŠç±»çš„<code>+load</code>æ–¹æ³•å­˜åœ¨<code>loadable_classes</code></p></li><li><p>é€šè¿‡<code>_getObjc2NonlazyCategoryList</code>ä» Mach-O ä¸­è¯»å–æ‰€æœ‰çš„éæ‡’åŠ è½½åˆ†ç±»éå†</p><ul><li>é€šè¿‡<code>realizeClassWithoutSwift</code>æ¥é˜²æ­¢ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼ˆè‹¥å·²ç»åˆå§‹åŒ–äº†åˆ™ä¸å½±å“ï¼‰</li><li>è°ƒç”¨<code>add_category_to_loadable_list</code>åŠ è½½åˆ†ç±»ä¸­çš„<code>+load</code>æ–¹æ³•åˆ°<code>loadable_categories</code></li></ul></li></ul><h4 id=call_load_methods><a href=#call_load_methods class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>call_load_methods</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>call_load_methods</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>static</span> <span class=kt>bool</span> <span class=n>loading</span> <span class=o>=</span> <span class=n>NO</span><span class=p>;</span>
    <span class=kt>bool</span> <span class=n>more_categories</span><span class=p>;</span>

    <span class=n>loadMethodLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>

    <span class=c1>// Re-entrant calls do nothing; the outermost call will finish the job.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>loading</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
    <span class=n>loading</span> <span class=o>=</span> <span class=n>YES</span><span class=p>;</span>

    <span class=kt>void</span> <span class=o>*</span><span class=n>pool</span> <span class=o>=</span> <span class=n>objc_autoreleasePoolPush</span><span class=p>();</span>

    <span class=k>do</span> <span class=p>{</span>
        <span class=c1>// 1. Repeatedly call class +loads until there aren&#39;t any more
</span><span class=c1></span>        <span class=k>while</span> <span class=p>(</span><span class=n>loadable_classes_used</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>call_class_loads</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=c1>// 2. Call category +loads ONCE
</span><span class=c1></span>        <span class=n>more_categories</span> <span class=o>=</span> <span class=n>call_category_loads</span><span class=p>();</span>

        <span class=c1>// 3. Run more +loads if there are classes OR more untried categories
</span><span class=c1></span>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>loadable_classes_used</span> <span class=o>&gt;</span> <span class=mi>0</span>  <span class=o>||</span>  <span class=n>more_categories</span><span class=p>);</span>

    <span class=n>objc_autoreleasePoolPop</span><span class=p>(</span><span class=n>pool</span><span class=p>);</span>

    <span class=n>loading</span> <span class=o>=</span> <span class=n>NO</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// è°ƒç”¨ç±»çš„+load
</span><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>call_class_loads</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
    
    <span class=c1>// Detach current loadable list.
</span><span class=c1></span>    <span class=k>struct</span> <span class=nc>loadable_class</span> <span class=o>*</span><span class=n>classes</span> <span class=o>=</span> <span class=n>loadable_classes</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>used</span> <span class=o>=</span> <span class=n>loadable_classes_used</span><span class=p>;</span>
    <span class=n>loadable_classes</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
    <span class=n>loadable_classes_allocated</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>loadable_classes_used</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    
    <span class=c1>// Call all +loads for the detached list.
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>used</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=n>classes</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cls</span><span class=p>;</span>
        <span class=n>load_method_t</span> <span class=n>load_method</span> <span class=o>=</span> <span class=p>(</span><span class=n>load_method_t</span><span class=p>)</span><span class=n>classes</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>method</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span> 

        <span class=k>if</span> <span class=p>(</span><span class=n>PrintLoading</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;LOAD: +[%s load]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=p>(</span><span class=o>*</span><span class=n>load_method</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=err>@</span><span class=n>selector</span><span class=p>(</span><span class=n>load</span><span class=p>));</span>
    <span class=p>}</span>
    
    <span class=c1>// Destroy the detached list.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>classes</span><span class=p>)</span> <span class=n>free</span><span class=p>(</span><span class=n>classes</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// è°ƒç”¨åˆ†ç±»çš„+load
</span><span class=c1></span><span class=k>static</span> <span class=kt>bool</span> <span class=nf>call_category_loads</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>shift</span><span class=p>;</span>
    <span class=kt>bool</span> <span class=n>new_categories_added</span> <span class=o>=</span> <span class=n>NO</span><span class=p>;</span>
    
    <span class=c1>// Detach current loadable list.
</span><span class=c1></span>    <span class=k>struct</span> <span class=nc>loadable_category</span> <span class=o>*</span><span class=n>cats</span> <span class=o>=</span> <span class=n>loadable_categories</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>used</span> <span class=o>=</span> <span class=n>loadable_categories_used</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>allocated</span> <span class=o>=</span> <span class=n>loadable_categories_allocated</span><span class=p>;</span>
    <span class=n>loadable_categories</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
    <span class=n>loadable_categories_allocated</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>loadable_categories_used</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=c1>// Call all +loads for the detached list.
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>used</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Category</span> <span class=n>cat</span> <span class=o>=</span> <span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cat</span><span class=p>;</span>
        <span class=n>load_method_t</span> <span class=n>load_method</span> <span class=o>=</span> <span class=p>(</span><span class=n>load_method_t</span><span class=p>)</span><span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>method</span><span class=p>;</span>
        <span class=n>Class</span> <span class=n>cls</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cat</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>

        <span class=n>cls</span> <span class=o>=</span> <span class=n>_category_getClass</span><span class=p>(</span><span class=n>cat</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cls</span>  <span class=o>&amp;&amp;</span>  <span class=n>cls</span><span class=o>-&gt;</span><span class=n>isLoadable</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>PrintLoading</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;LOAD: +[%s(%s) load]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
                             <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>(),</span> 
                             <span class=n>_category_getName</span><span class=p>(</span><span class=n>cat</span><span class=p>));</span>
            <span class=p>}</span>
            <span class=p>(</span><span class=o>*</span><span class=n>load_method</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=err>@</span><span class=n>selector</span><span class=p>(</span><span class=n>load</span><span class=p>));</span>
            <span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cat</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Compact detached list (order-preserving)
</span><span class=c1></span>    <span class=n>shift</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>used</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cat</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=n>shift</span><span class=p>]</span> <span class=o>=</span> <span class=n>cats</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>shift</span><span class=o>++</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>used</span> <span class=o>-=</span> <span class=n>shift</span><span class=p>;</span>

    <span class=c1>// Copy any new +load candidates from the new list to the detached list.
</span><span class=c1></span>    <span class=n>new_categories_added</span> <span class=o>=</span> <span class=p>(</span><span class=n>loadable_categories_used</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>loadable_categories_used</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>used</span> <span class=o>==</span> <span class=n>allocated</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>allocated</span> <span class=o>=</span> <span class=n>allocated</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=mi>16</span><span class=p>;</span>
            <span class=n>cats</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>loadable_category</span> <span class=o>*</span><span class=p>)</span>
                <span class=n>realloc</span><span class=p>(</span><span class=n>cats</span><span class=p>,</span> <span class=n>allocated</span> <span class=o>*</span>
                                  <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>loadable_category</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=n>cats</span><span class=p>[</span><span class=n>used</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>loadable_categories</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
    <span class=p>}</span>

    <span class=c1>// Destroy the new list.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>loadable_categories</span><span class=p>)</span> <span class=n>free</span><span class=p>(</span><span class=n>loadable_categories</span><span class=p>);</span>

    <span class=c1>// Reattach the (now augmented) detached list. 
</span><span class=c1></span>    <span class=c1>// But if there&#39;s nothing left to load, destroy the list.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>used</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>loadable_categories</span> <span class=o>=</span> <span class=n>cats</span><span class=p>;</span>
        <span class=n>loadable_categories_used</span> <span class=o>=</span> <span class=n>used</span><span class=p>;</span>
        <span class=n>loadable_categories_allocated</span> <span class=o>=</span> <span class=n>allocated</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cats</span><span class=p>)</span> <span class=n>free</span><span class=p>(</span><span class=n>cats</span><span class=p>);</span>
        <span class=n>loadable_categories</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
        <span class=n>loadable_categories_used</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=n>loadable_categories_allocated</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>PrintLoading</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>loadable_categories_used</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;LOAD: %d categories still waiting for +load</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
                         <span class=n>loadable_categories_used</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>new_categories_added</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><code>do-while</code>å¾ªç¯ä¸­ä¸»è¦åš 3 ä¸ªæ“ä½œï¼š</p><ul><li>å¾ªç¯è°ƒç”¨<code>ç±»çš„+load</code>æ–¹æ³•ï¼Œç›´åˆ°è°ƒç”¨å®Œ</li><li>è°ƒç”¨ä¸€æ¬¡<code>åˆ†ç±»ä¸­çš„+load</code></li><li>å¦‚æœæœ‰ç±»æˆ–æ›´å¤šæœªå°è¯•çš„åˆ†ç±»ï¼Œåˆ™è¿è¡Œæ›´å¤šçš„<code>+load</code></li></ul><blockquote><p>ä½¿ç”¨<strong>è‡ªåŠ¨é‡Šæ”¾æ± </strong>ç®¡ç†å†…å­˜ï¼Œå…³äºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œåœ¨åç»­ç¯‡ç« ä¼šè¯¦ç»†å±•å¼€</p></blockquote><h2 id=initalizeåˆ†æ><a href=#initalizeåˆ†æ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>initalizeåˆ†æ</h2><p>å…³äº<code>initalize</code>çš„è‹¹æœå®˜æ–¹æ–‡æ¡£å®šä¹‰ä¸ºï¼šInitializes the class before it receives its first message.</p><blockquote><p><a href="https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize?language=objc" target=_blank rel=noopener><code>initalize</code>å®šä¹‰</a></p></blockquote><p>å³åœ¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªæ¶ˆæ¯ä¹‹å‰åˆå§‹åŒ–è¯¥ç±»</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨ objcæºç ä¸­ <code>lookUpImpOrForward</code>æŸ¥çœ‹</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>IMP</span> <span class=nf>lookUpImpOrForward</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>SEL</span> <span class=n>sel</span><span class=p>,</span> <span class=n>id</span> <span class=n>inst</span><span class=p>,</span> 
                       <span class=kt>bool</span> <span class=n>initialize</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>cache</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>resolver</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>initialize</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isInitialized</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>cls</span> <span class=o>=</span> <span class=n>initializeAndLeaveLocked</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>inst</span><span class=p>,</span> <span class=n>runtimeLock</span><span class=p>);</span>
        <span class=p>...</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=k>static</span> <span class=n>Class</span> <span class=nf>initializeAndLeaveLocked</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>id</span> <span class=n>obj</span><span class=p>,</span> <span class=n>mutex_t</span><span class=o>&amp;</span> <span class=n>lock</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>initializeAndMaybeRelock</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>obj</span><span class=p>,</span> <span class=n>lock</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>static</span> <span class=n>Class</span> <span class=nf>initializeAndMaybeRelock</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>id</span> <span class=n>inst</span><span class=p>,</span>
                                      <span class=n>mutex_t</span><span class=o>&amp;</span> <span class=n>lock</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>leaveLocked</span><span class=p>)</span>
<span class=p>{</span>
    <span class=err>Â·Â·Â·</span>
    <span class=n>initializeNonMetaClass</span><span class=p>(</span><span class=n>nonmeta</span><span class=p>);</span>
    <span class=err>Â·Â·Â·</span>
<span class=p>}</span>
</code></pre></div><p><code>lookUpImpOrForward -> initializeAndLeaveLocked -> initializeAndMaybeRelock -> initializeNonMetaClass</code></p><p>åœ¨<code>initializeNonMetaClass</code>é€’å½’è°ƒç”¨çˆ¶ç±»<code>initialize</code>ï¼Œç„¶åè°ƒç”¨<code>callInitialize</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>initializeNonMetaClass</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>
    <span class=n>supercls</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>superclass</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>supercls</span>  <span class=o>&amp;&amp;</span>  <span class=o>!</span><span class=n>supercls</span><span class=o>-&gt;</span><span class=n>isInitialized</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>initializeNonMetaClass</span><span class=p>(</span><span class=n>supercls</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=p>...</span>
    <span class=p>{</span>
            <span class=n>callInitialize</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>PrintInitializing</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;INITIALIZE: thread %p: finished +[%s initialize]&#34;</span><span class=p>,</span>
                             <span class=n>pthread_self</span><span class=p>(),</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p><code>callInitialize</code>æ˜¯ä¸€ä¸ªæ™®é€šçš„æ¶ˆæ¯å‘é€</p><div class=highlight><pre class=chroma><code class=language-C++ data-lang=C++><span class=kt>void</span> <span class=nf>callInitialize</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>((</span><span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>Class</span><span class=p>,</span> <span class=n>SEL</span><span class=p>))</span><span class=n>objc_msgSend</span><span class=p>)(</span><span class=n>cls</span><span class=p>,</span> <span class=n>SEL_initialize</span><span class=p>);</span>
    <span class=k>asm</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>å…³äº<code>initalize</code>çš„ç»“è®ºï¼š</p><ul><li><code>initialize</code>åœ¨ç±»æˆ–è€…å…¶å­ç±»çš„ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å‰ï¼ˆå‘é€æ¶ˆæ¯å‰ï¼‰è°ƒç”¨</li><li>åªåœ¨ç±»ä¸­æ·»åŠ <code>initialize</code>ä½†ä¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šè°ƒç”¨<code>initialize</code></li><li>çˆ¶ç±»çš„<code>initialize</code>æ–¹æ³•ä¼šæ¯”å­ç±»å…ˆæ‰§è¡Œ</li><li>å½“å­ç±»æœªå®ç°<code>initialize</code>æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨çˆ¶ç±»<code>initialize</code>æ–¹æ³•ï¼›å­ç±»å®ç°<code>initialize</code>æ–¹æ³•æ—¶ï¼Œä¼šè¦†ç›–çˆ¶ç±»<code>initialize</code>æ–¹æ³•</li><li>å½“æœ‰å¤šä¸ªåˆ†ç±»éƒ½å®ç°äº†<code>initialize</code>æ–¹æ³•ï¼Œä¼šè¦†ç›–ç±»ä¸­çš„æ–¹æ³•ï¼Œåªæ‰§è¡Œä¸€ä¸ª(ä¼šæ‰§è¡Œæœ€åè¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„åˆ†ç±»çš„æ–¹æ³•)</li></ul><h3 id=ç±»æ‹“å±•><a href=#ç±»æ‹“å±• class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»æ‹“å±•</h3><p>ç±»æ‹“å±• <code>extension</code> åˆç§°ä¸º<code>åŒ¿åçš„åˆ†ç±»</code>ï¼ŒåŒæ ·å¯ä»¥ä¸ºç±»å¢åŠ å±æ€§å’Œæ–¹æ³•</p><p>åœ¨å¼€å§‹çš„ç±»ä¸­ï¼ŒåŠ å…¥ç±»æ‹“å±•</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>Person</span> <span class=p>()</span>

<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>ex_name</span><span class=p>;</span>
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>assign</span><span class=p>)</span> <span class=n>NSNumber</span> <span class=o>*</span><span class=n>ex_age</span><span class=p>;</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>ex_doFirst</span><span class=p>;</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>ex_doSecond</span><span class=p>;</span>
<span class=k>@end</span>
</code></pre></div><p><code>clang</code> ç¼–è¯‘</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=k>struct</span> <span class=err>/*</span><span class=nc>_ivar_list_t</span><span class=err>*/</span> <span class=p>{</span>
	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>entsize</span><span class=p>;</span>  <span class=c1>// sizeof(struct _prop_t)
</span><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>count</span><span class=p>;</span>
	<span class=k>struct</span> <span class=nc>_ivar_t</span> <span class=n>ivar_list</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
<span class=p>}</span> <span class=n>_OBJC_</span><span class=err>$</span><span class=n>_INSTANCE_VARIABLES_Person</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>used</span><span class=p>,</span> <span class=n>section</span> <span class=p>(</span><span class=s>&#34;__DATA,__objc_const&#34;</span><span class=p>)))</span> <span class=o>=</span> <span class=p>{</span>
	<span class=k>sizeof</span><span class=p>(</span><span class=n>_ivar_t</span><span class=p>),</span>
	<span class=mi>4</span><span class=p>,</span>
	<span class=p>{{(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>OBJC_IVAR_</span><span class=err>$</span><span class=n>_Person</span><span class=err>$</span><span class=n>_name</span><span class=p>,</span> <span class=s>&#34;_name&#34;</span><span class=p>,</span> <span class=s>&#34;@</span><span class=se>\&#34;</span><span class=s>NSString</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>},</span>
	 <span class=p>{(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>OBJC_IVAR_</span><span class=err>$</span><span class=n>_Person</span><span class=err>$</span><span class=n>_age</span><span class=p>,</span> <span class=s>&#34;_age&#34;</span><span class=p>,</span> <span class=s>&#34;@</span><span class=se>\&#34;</span><span class=s>NSNumber</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>},</span>
	 <span class=p>{(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>OBJC_IVAR_</span><span class=err>$</span><span class=n>_Person</span><span class=err>$</span><span class=n>_ex_name</span><span class=p>,</span> <span class=s>&#34;_ex_name&#34;</span><span class=p>,</span> <span class=s>&#34;@</span><span class=se>\&#34;</span><span class=s>NSString</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>},</span>
	 <span class=p>{(</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>int</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>OBJC_IVAR_</span><span class=err>$</span><span class=n>_Person</span><span class=err>$</span><span class=n>_ex_age</span><span class=p>,</span> <span class=s>&#34;_ex_age&#34;</span><span class=p>,</span> <span class=s>&#34;@</span><span class=se>\&#34;</span><span class=s>NSNumber</span><span class=se>\&#34;</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>8</span><span class=p>}}</span>
<span class=p>};</span>

<span class=k>static</span> <span class=k>struct</span> <span class=err>/*</span><span class=nc>_method_list_t</span><span class=err>*/</span> <span class=p>{</span>
	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>entsize</span><span class=p>;</span>  <span class=c1>// sizeof(struct _objc_method)
</span><span class=c1></span>	<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>method_count</span><span class=p>;</span>
	<span class=k>struct</span> <span class=nc>_objc_method</span> <span class=n>method_list</span><span class=p>[</span><span class=mi>19</span><span class=p>];</span>
<span class=p>}</span> <span class=n>_OBJC_</span><span class=err>$</span><span class=n>_INSTANCE_METHODS_Person</span> <span class=n>__attribute__</span> <span class=p>((</span><span class=n>used</span><span class=p>,</span> <span class=n>section</span> <span class=p>(</span><span class=s>&#34;__DATA,__objc_const&#34;</span><span class=p>)))</span> <span class=o>=</span> <span class=p>{</span>
	<span class=k>sizeof</span><span class=p>(</span><span class=n>_objc_method</span><span class=p>),</span>
	<span class=mi>19</span><span class=p>,</span>
	<span class=p>{{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;doFirst&#34;</span><span class=p>,</span> <span class=s>&#34;v16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_doFirst</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;doSecond&#34;</span><span class=p>,</span> <span class=s>&#34;v16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_doSecond</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;ex_doFirst&#34;</span><span class=p>,</span> <span class=s>&#34;v16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_ex_doFirst</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_name</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setName:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setName_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_age</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setAge:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setAge_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;ex_name&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_ex_name</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setEx_name:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setEx_name_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;ex_age&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_ex_age</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setEx_age:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setEx_age_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_name</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setName:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setName_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;age&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_age</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setAge:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setAge_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;ex_name&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_ex_name</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setEx_name:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setEx_name_</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;ex_age&#34;</span><span class=p>,</span> <span class=s>&#34;@16@0:8&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_ex_age</span><span class=p>},</span>
	<span class=p>{(</span><span class=k>struct</span> <span class=nc>objc_selector</span> <span class=o>*</span><span class=p>)</span><span class=s>&#34;setEx_age:&#34;</span><span class=p>,</span> <span class=s>&#34;v24@0:8@16&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>_I_Person_setEx_age_</span><span class=p>}}</span>
<span class=p>};</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œç±»æ‹“å±•ä¸­çš„å±æ€§å·²ç»è¢«åŠ å…¥åˆ° <code>ivar_list_t</code> ä¸­ï¼Œæ–¹æ³•<code>ex_doFirst</code>è¢«åŠ å…¥åˆ°äº† <code>method_list_t</code>ï¼Œ<code>ex_doSecond</code>æ²¡æœ‰è¢«åŠ å…¥æ˜¯å› ä¸ºæ²¡æœ‰åœ¨ä¸»ç±»ä¸­å®ç°</p><p>å› æ­¤</p><ul><li><p>ç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶ä¼šä½œä¸ºç±»çš„ä¸€éƒ¨åˆ†è¿›è¡Œç¼–è¯‘</p></li><li><p>ç±»æ‹“å±•åªæ˜¯å£°æ˜ï¼Œä¾èµ–äºå½“å‰ä¸»ç±»ï¼Œæ–¹æ³•éœ€è¦åœ¨ä¸»ç±» <code>.m</code> æ–‡ä»¶ä¸­å®ç°</p></li></ul><h3 id=ç±»æ‹“å±•ä¸åˆ†ç±»çš„åŒºåˆ«><a href=#ç±»æ‹“å±•ä¸åˆ†ç±»çš„åŒºåˆ« class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»æ‹“å±•ä¸åˆ†ç±»çš„åŒºåˆ«</h3><p><strong>åˆ†ç±»</strong></p><ul><li>ä¸ºæŸä¸ªç±»æ·»åŠ æ–¹æ³•ã€åè®®ã€å±æ€§ï¼ˆä¸€èˆ¬ä½¿ç”¨å…³è”å¯¹è±¡ï¼‰ï¼Œé€šå¸¸ç”¨æ¥ä¸ºç³»ç»Ÿçš„ç±»æ‹“å±•æ–¹æ³•æˆ–è€…æŠŠå¤æ‚ç±»æ ¹æ®åŠŸèƒ½æ‹†åˆ†åˆ°ä¸åŒçš„æ–‡ä»¶é‡Œ</li></ul><p><strong>ç±»æ‹“å±•</strong></p><ul><li>ä¸ºæŸä¸ªç±»æ·»åŠ åŸæ¥æ²¡æœ‰çš„æˆå‘˜å˜é‡ã€å±æ€§ã€æ–¹æ³•ï¼ˆæ–¹æ³•åªæ˜¯å£°æ˜ï¼Œéœ€è¦å®ç°ï¼‰ï¼Œé€šå¸¸ç”¨æ¥æ‰©å±•ç§æœ‰å±æ€§ï¼Œæˆ–è€…æŠŠ<code>.h</code>çš„<strong>åªè¯»å±æ€§</strong>é‡å†™<strong>å¯è¯»å†™</strong>çš„</li></ul><p><strong>åŒºåˆ«</strong></p><ul><li>åˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œæ‰æŠŠåˆ†ç±»çš„ä¿¡æ¯åˆå¹¶åˆ°ç±»ä¿¡æ¯ä¸­ï¼Œè€Œç±»æ‹“å±•æ˜¯åœ¨ç¼–è¯‘æ—¶</li><li>åˆ†ç±»å£°æ˜çš„å±æ€§ï¼Œåªä¼šç”Ÿæˆ <code>setter/getter</code> æ–¹æ³•çš„å£°æ˜ï¼Œä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ<strong>æˆå‘˜å˜é‡</strong>å’Œ<code>setter/getter</code> æ–¹æ³•çš„å®ç°ï¼Œè€Œç±»æ‹“å±•å¯ä»¥</li><li>åˆ†ç±»ä¸å¯ä»¥ä¸ºç±»æ·»åŠ å®ä¾‹å˜é‡ï¼Œè€Œç±»æ‹“å±•å¯ä»¥</li><li>åˆ†ç±»å¯ä»¥ä¸ºç±»æ·»åŠ æ–¹æ³•çš„å®ç°ï¼Œè€Œç±»æ‹“å±•åªèƒ½å£°æ˜æ–¹æ³•ï¼Œè€Œä¸èƒ½å®ç°</li></ul><p><strong>åˆ†ç±»çš„å±€é™ç‚¹</strong></p><ul><li>æ— æ³•ä¸ºç±»æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†å¯é€šè¿‡å…³è”å¯¹è±¡è¿›è¡Œå®ç°</li><li>åˆ†ç±»çš„æ–¹æ³•è‹¥å’Œç±»ä¸­åŸæ¥çš„æ–¹æ³•å®ç°é‡åï¼Œä¼šä¼˜å…ˆè°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•</li><li>å¤šä¸ªåˆ†ç±»çš„æ–¹æ³•é‡åï¼Œä¼šè°ƒç”¨æœ€åç¼–è¯‘çš„é‚£ä¸ªåˆ†ç±»çš„æ–¹æ³•å®ç°</li></ul></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>