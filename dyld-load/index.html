<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºçš„å…¥å£å‡½æ•°æ˜¯ main.m æ–‡ä»¶é‡Œçš„ mainå‡½æ•°ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ª App çš„ç”Ÿå‘½èµ·ç‚¹ï¼Œåœ¨è¿›å…¥â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/dyld-load/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-09-25T21:51:41+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/dyld-load/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹","description":"æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºçš„å…¥å£å‡½æ•°æ˜¯ main.m æ–‡ä»¶é‡Œçš„ mainå‡½æ•°ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ª App çš„ç”Ÿå‘½èµ·ç‚¹ï¼Œåœ¨è¿›å…¥â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹"><meta property="og:description" content="æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºçš„å…¥å£å‡½æ•°æ˜¯ main.m æ–‡ä»¶é‡Œçš„ mainå‡½æ•°ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ª App çš„ç”Ÿå‘½èµ·ç‚¹ï¼Œåœ¨è¿›å…¥â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/dyld-load/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹</h1><div class=post-meta><time datetime=2020-09-25T21:51:41+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-09-25</time></div><div class="post-body e-content"><p>æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºçš„å…¥å£å‡½æ•°æ˜¯ <code>main.m</code> æ–‡ä»¶é‡Œçš„ <code>mainå‡½æ•°</code>ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ª App çš„ç”Ÿå‘½èµ·ç‚¹ï¼Œåœ¨è¿›å…¥ <code>mainå‡½æ•°</code>ä¹‹å‰è¿˜è¿›è¡Œäº†è®¸å¤šçš„æ“ä½œï¼Œæœ¬æ–‡å°†å¯¹è¿™äº›æ“ä½œè¿›è¡Œæ¢³ç†</p><p>åŒæ ·çš„ï¼Œæå‡ºå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>é™æ€åº“ä¸åŠ¨æ€åº“çš„åŒºåˆ«</li><li>dyld æ˜¯ä»€ä¹ˆ</li><li>dyld åŠ è½½è¿‡ç¨‹</li></ul><h3 id=é™æ€åº“ä¸åŠ¨æ€åº“><a href=#é™æ€åº“ä¸åŠ¨æ€åº“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é™æ€åº“ä¸åŠ¨æ€åº“</h3><p>Objective-C æ˜¯åŠ¨æ€è¯­è¨€ï¼Œå¾—ç›Šäºç‰¹æœ‰çš„ <strong>Runtime</strong> æœºåˆ¶ï¼ŒåŒæ—¶ï¼Œä¹Ÿæ˜¯ç¼–è¯‘å‹è¯­è¨€ï¼Œéœ€è¦é€šè¿‡ç¼–è¯‘å™¨å°†æºä»£ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œé“¾æ¥å„ä¸ªæ¨¡å—çš„æœºå™¨ç å’Œä¾èµ–åº“ï¼Œä¸²è”èµ·æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶<code>mach-o</code></p><h5 id=ç¼–è¯‘è¿‡ç¨‹><a href=#ç¼–è¯‘è¿‡ç¨‹ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç¼–è¯‘è¿‡ç¨‹</h5><blockquote><p>äº‹å®ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†è§£ä¸º4ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯é¢„å¤„ç†(Prepressing)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)å’Œé“¾æ¥(Linking).------ æ‘˜è‡ªã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-- é“¾æ¥ã€è£…è½½ä¸åº“ã€‹</p></blockquote><p>Xcode é€šå¸¸å¸®æˆ‘ä»¬åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>é¢„ç¼–è¯‘ï¼šå¤„ç†ä»£ç ä¸­çš„<code>#å¼€å¤´</code>çš„é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œæ¯”å¦‚åˆ é™¤<code>#define</code>å¹¶å±•å¼€å®å®šä¹‰ï¼Œå°†<code>#include</code>åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥æŒ‡ä»¤ä½ç½®ç­‰</li><li>ç¼–è¯‘ï¼šå¯¹é¢„ç¼–è¯‘å¤„ç†è¿‡çš„æ–‡ä»¶è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼Œå¹¶è¿›è¡Œæºä»£ç ä¼˜åŒ–ï¼Œç„¶åç”Ÿæˆæ±‡ç¼–ä»£ç </li><li>æ±‡ç¼–ï¼šé€šè¿‡æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œå¹¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶<code>.oæ–‡ä»¶</code></li><li>é“¾æ¥ï¼šå°†ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé“¾æ¥å™¨ä¼šå°†ä¸åŒçš„ç›®æ ‡æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œå› ä¸ºç›®æ ‡æ–‡ä»¶éœ€è¦ä¾èµ–åˆ«çš„æ¡†æ¶ï¼Œæ¯”å¦‚ç»å¸¸è°ƒç”¨ Foundation æ¡†æ¶å’Œ UIKit æ¡†æ¶</li></ul><p><img src=https://w-md.imzsy.design/%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B.png alt=ç¼–è¯‘è¿‡ç¨‹></p><blockquote><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=sb>`Foundation`</span><span class=err>å’Œ</span><span class=sb>`UIKit`</span><span class=err>è¿™ç§å¯ä»¥å…±äº«ä»£ç ã€å®ç°ä»£ç çš„å¤ç”¨ç»Ÿç§°ä¸º</span><span class=sb>`åº“`</span>

<span class=err>å®ƒæ˜¯å¯æ‰§è¡Œä»£ç çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥è¢«æ“ä½œç³»ç»Ÿå†™å…¥å†…å­˜ï¼Œå®ƒåˆåˆ†ä¸º</span><span class=sb>`é™æ€åº“`</span><span class=err>å’Œ</span><span class=sb>`åŠ¨æ€åº“
</span></code></pre></div></blockquote><h5 id=é™æ€åº“><a href=#é™æ€åº“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é™æ€åº“</h5><p><code>é™æ€åº“</code>æ˜¯æŒ‡åœ¨é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œä»è¿™ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ã€æ‹·è´ã€å®ƒè‡ªå·±éœ€è¦çš„å†…å®¹åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¦‚<code>.aã€.lib</code>éƒ½æ˜¯é™æ€åº“</p><h5 id=åŠ¨æ€åº“><a href=#åŠ¨æ€åº“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åŠ¨æ€åº“</h5><p><code>åŠ¨æ€åº“</code>æ˜¯æŒ‡åœ¨é“¾æ¥æ—¶ä¸æ‹·è´åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯ç¨‹åºè¿è¡Œæ—¶ç”±ç³»ç»ŸåŠ åœ¨åˆ°å†…å­˜ä¸­ï¼Œä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿåªéœ€åŠ è½½ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œå…±ç”¨èŠ‚çœå†…å­˜ã€‚</p><p>å¦‚<code>.dylib</code>ã€<code>.framework</code>éƒ½æ˜¯åŠ¨æ€åº“</p><blockquote><p><strong>ç³»ç»Ÿçš„frameworkæ˜¯åŠ¨æ€çš„ï¼Œå¼€å‘è€…åˆ›å»ºçš„frameworkæ˜¯é™æ€çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€çš„</strong></p></blockquote><h3 id=dyld><a href=#dyld class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyld</h3><p><strong>dyldç®€ä»‹</strong></p><p><code>dyld(The dynamic link editor)</code>æ˜¯è‹¹æœçš„åŠ¨æ€é“¾æ¥å™¨ï¼Œè´Ÿè´£ç¨‹åºçš„é“¾æ¥åŠåŠ è½½å·¥ä½œï¼Œæ˜¯è‹¹æœæ“ä½œç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå­˜åœ¨äºMacOSç³»ç»Ÿçš„<code>(/usr/lib/dyld)</code>ç›®å½•ä¸‹ã€‚</p><p>åœ¨åº”ç”¨è¢«ç¼–è¯‘æ‰“åŒ…æˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„<code>Mach-O</code>æ–‡ä»¶ä¹‹å ï¼Œäº¤ç”±<code>dyld</code>è´Ÿè´£é“¾æ¥ï¼ŒåŠ è½½ç¨‹åº</p><p><strong>dyld_shared_cache</strong></p><p>ç”±äºä¸æ­¢ä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨<code>UIKit</code>ç³»ç»ŸåŠ¨æ€åº“ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨æ¯ä¸ªç¨‹åºåŠ è½½æ—¶éƒ½å»åŠ è½½æ‰€æœ‰çš„ç³»ç»ŸåŠ¨æ€åº“ã€‚</p><p>ä¸ºäº†ä¼˜åŒ–ç¨‹åºå¯åŠ¨é€Ÿåº¦å’Œåˆ©ç”¨åŠ¨æ€åº“ç¼“å­˜ï¼Œè‹¹æœä»<code>iOS3.1</code>ä¹‹åï¼Œå°†æ‰€æœ‰ç³»ç»Ÿåº“ï¼ˆç§æœ‰ä¸å…¬æœ‰ï¼‰ç¼–è¯‘æˆä¸€ä¸ªå¤§çš„ç¼“å­˜æ–‡ä»¶ï¼Œè¿™å°±æ˜¯<code>dyld_shared_cache</code>ï¼Œè¯¥ç¼“å­˜æ–‡ä»¶å­˜åœ¨iOSç³»ç»Ÿä¸‹çš„<code>/System/Library/Caches/com.apple.dyld/</code>ç›®å½•ä¸‹</p><h3 id=dyldåŠ è½½æµç¨‹><a href=#dyldåŠ è½½æµç¨‹ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyldåŠ è½½æµç¨‹</h3><p>åˆ†åˆ«åœ¨ <code>mainå‡½æ•°</code>å’Œ ViewController çš„<code>+load</code>å‡½æ•°æ‰“æ–­ç‚¹ï¼Œçœ‹ä¸€ä¸‹æ–­ç‚¹è¿›å…¥ä½ç½®ï¼Œä»¥åŠè°ƒç”¨å †æ ˆ</p><p>å¯ä»¥å‘ç°ï¼Œæ–­ç‚¹ä¼šå…ˆè¿›å…¥åˆ°<code>+loadå‡½æ•°</code>ï¼Œå¹¶ä¸”å †æ ˆå¦‚ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=o>*</span> <span class=n>thread</span> <span class=c1>#1, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.1</span>
  <span class=o>*</span> <span class=n>frame</span> <span class=c1>#0: 0x0000000101d4aaec NSProxyTest`+[ViewController load](self=ViewController, _cmd=&#34;load&#34;) at ViewController.m:18:1</span>
    <span class=n>frame</span> <span class=c1>#1: 0x00007fff201805e3 libobjc.A.dylib`load_images + 1442</span>
    <span class=n>frame</span> <span class=c1>#2: 0x0000000101d63e54 dyld_sim`dyld::notifySingle(dyld_image_states, ImageLoader const*, ImageLoader::InitializerTimingList*) + 425</span>
    <span class=n>frame</span> <span class=c1>#3: 0x0000000101d72887 dyld_sim`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&amp;, unsigned int, char const*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + 437</span>
    <span class=n>frame</span> <span class=c1>#4: 0x0000000101d70bb0 dyld_sim`ImageLoader::processInitializers(ImageLoader::LinkContext const&amp;, unsigned int, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + 188</span>
    <span class=n>frame</span> <span class=c1>#5: 0x0000000101d70c50 dyld_sim`ImageLoader::runInitializers(ImageLoader::LinkContext const&amp;, ImageLoader::InitializerTimingList&amp;) + 82</span>
    <span class=n>frame</span> <span class=c1>#6: 0x0000000101d642a9 dyld_sim`dyld::initializeMainExecutable() + 199</span>
    <span class=n>frame</span> <span class=c1>#7: 0x0000000101d68d50 dyld_sim`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 4431</span>
    <span class=n>frame</span> <span class=c1>#8: 0x0000000101d631c7 dyld_sim`start_sim + 122</span>
    <span class=n>frame</span> <span class=c1>#9: 0x0000000110dc285c dyld`dyld::useSimulatorDyld(int, macho_header const*, char const*, int, char const**, char const**, char const**, unsigned long*, unsigned long*) + 2308</span>
    <span class=n>frame</span> <span class=c1>#10: 0x0000000110dc04f4 dyld`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 837</span>
    <span class=n>frame</span> <span class=c1>#11: 0x0000000110dbb227 dyld`dyldbootstrap::start(dyld3::MachOLoaded const*, int, char const**, dyld3::MachOLoaded const*, unsigned long*) + 453</span>
    <span class=n>frame</span> <span class=c1>#12: 0x0000000110dbb025 dyld`_dyld_start + 37</span>
</code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆè°ƒç”¨ <code>dyld</code> ä¸­çš„ <code>_dyld_start</code> å‡½æ•°ï¼Œå†æ¥ç€è°ƒç”¨<code>dyldbootstrap::start()</code>å‡½æ•°</p><p>è¿™é‡Œéœ€è¦å€ŸåŠ© <a href=https://opensource.apple.com/tarballs/dyld/ target=_blank rel=noopener>dyldæºç </a>æ¥æŸ¥çœ‹å‡½æ•°çš„å…·ä½“å®ç°</p><h4 id=_dyld_start><a href=#_dyld_start class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>_dyld_start</h4><p>é€šè¿‡æœç´¢<code>_dyld_start</code>ï¼Œå¯ä»¥å‘ç°æ˜¯åœ¨<code>dyldStartup.s</code>æ±‡ç¼–æ–‡ä»¶å†…ï¼Œä»æ±‡ç¼–æ³¨é‡Šå¯ä»¥çœ‹åˆ°ä¼šå»è°ƒç”¨<code>dyldbootstrap::start()</code>å‡½æ•°</p><p><img src=https://w-md.imzsy.design/_dyld_start.png alt=_dyld_start></p><h4 id=dyldbootstrapstart><a href=#dyldbootstrapstart class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyldbootstrap::start()</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>uintptr_t</span> <span class=nf>start</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=nc>macho_header</span><span class=o>*</span> <span class=n>appsMachHeader</span><span class=p>,</span> <span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> 
				<span class=n>intptr_t</span> <span class=n>slide</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=nc>macho_header</span><span class=o>*</span> <span class=n>dyldsMachHeader</span><span class=p>,</span>
				<span class=n>uintptr_t</span><span class=o>*</span> <span class=n>startGlue</span><span class=p>)</span>
<span class=p>{</span>
	<span class=c1>// if kernel had to slide dyld, we need to fix up load sensitive locations
</span><span class=c1></span>	<span class=c1>// we have to do this before using any global variables
</span><span class=c1></span>    <span class=c1>// è·å– slide
</span><span class=c1></span>    <span class=n>slide</span> <span class=o>=</span> <span class=n>slideOfMainExecutable</span><span class=p>(</span><span class=n>dyldsMachHeader</span><span class=p>);</span>
    <span class=kt>bool</span> <span class=n>shouldRebase</span> <span class=o>=</span> <span class=n>slide</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>;</span>
<span class=cp>#if __has_feature(ptrauth_calls)
</span><span class=cp></span>    <span class=n>shouldRebase</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>shouldRebase</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// æ ¹æ® slide ç¡®å®šæ˜¯å¦ rebase
</span><span class=c1></span>        <span class=n>rebaseDyld</span><span class=p>(</span><span class=n>dyldsMachHeader</span><span class=p>,</span> <span class=n>slide</span><span class=p>);</span>
    <span class=p>}</span>

	<span class=c1>// allow dyld to use mach messaging
</span><span class=c1></span>    <span class=c1>// åˆå§‹åŒ– mach æ¶ˆæ¯
</span><span class=c1></span>	<span class=n>mach_init</span><span class=p>();</span>

	<span class=c1>// kernel sets up env pointer to be just past end of agv array
</span><span class=c1></span>	<span class=k>const</span> <span class=kt>char</span><span class=o>**</span> <span class=n>envp</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
	
	<span class=c1>// kernel sets up apple pointer to be just past end of envp array
</span><span class=c1></span>	<span class=k>const</span> <span class=kt>char</span><span class=o>**</span> <span class=n>apple</span> <span class=o>=</span> <span class=n>envp</span><span class=p>;</span>
	<span class=k>while</span><span class=p>(</span><span class=o>*</span><span class=n>apple</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span> <span class=o>++</span><span class=n>apple</span><span class=p>;</span> <span class=p>}</span>
	<span class=o>++</span><span class=n>apple</span><span class=p>;</span>

	<span class=c1>// set up random value for stack canary
</span><span class=c1></span>    <span class=c1>// ä¿æŠ¤æ ˆæº¢å‡º
</span><span class=c1></span>	<span class=n>__guard_setup</span><span class=p>(</span><span class=n>apple</span><span class=p>);</span>

<span class=cp>#if DYLD_INITIALIZER_SUPPORT
</span><span class=cp></span>	<span class=c1>// run all C++ initializers inside dyld
</span><span class=c1></span>	<span class=n>runDyldInitializers</span><span class=p>(</span><span class=n>dyldsMachHeader</span><span class=p>,</span> <span class=n>slide</span><span class=p>,</span> <span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>envp</span><span class=p>,</span> <span class=n>apple</span><span class=p>);</span>
<span class=cp>#endif
</span><span class=cp></span>
	<span class=c1>// now that we are done bootstrapping dyld, call dyld&#39;s main
</span><span class=c1></span>    <span class=c1>// å®Œæˆå¼•å¯¼ï¼Œè°ƒç”¨ dyld::main å‡½æ•°
</span><span class=c1></span>    <span class=c1>// appsSlide è·å–åç§»å€¼ï¼Œä¼ ç»™ main å‡½æ•°
</span><span class=c1></span>	<span class=n>uintptr_t</span> <span class=n>appsSlide</span> <span class=o>=</span> <span class=n>slideOfMainExecutable</span><span class=p>(</span><span class=n>appsMachHeader</span><span class=p>);</span>
	<span class=k>return</span> <span class=n>dyld</span><span class=o>::</span><span class=n>_main</span><span class=p>(</span><span class=n>appsMachHeader</span><span class=p>,</span> <span class=n>appsSlide</span><span class=p>,</span> <span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>envp</span><span class=p>,</span> <span class=n>apple</span><span class=p>,</span> <span class=n>startGlue</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>åœ¨è¿™é‡Œä¸»è¦åšäº†å››ä¸ªæ“ä½œ</p><ul><li><p>æ ¹æ® <code>dyldsMachHeader</code> è®¡ç®—å‡º <code>slide</code>ï¼Œé€šè¿‡ <code>slide</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šä½ï¼›</p><p><code>slide</code> æ˜¯æ ¹æ® <code>ASLRæŠ€æœ¯</code> è®¡ç®—å‡ºçš„ä¸€ä¸ªéšæœºå€¼ï¼Œä½¿ç¨‹åºæ¯ä¸€æ¬¡è¿è¡Œçš„åç§»å€¼éƒ½ä¸ä¸€æ ·ï¼Œé˜²æ­¢æ”»å‡»è€…é€šè¿‡å›ºå®šåœ°å€å‘èµ·æ¶æ„æ”»å‡»</p></li><li><p><code>mach_init()</code>åˆå§‹åŒ–ï¼ˆå…è®¸ dyld ä½¿ç”¨ mach æ¶ˆæ¯ä¼ é€’ï¼‰</p></li><li><p>æ ˆæº¢å‡ºä¿æŠ¤</p></li><li><p>è®¡ç®— <code>appsMachHeader</code> çš„åç§»ï¼Œè°ƒç”¨ <code>dyld::main()</code> å‡½æ•°</p></li></ul><h4 id=dyldmain><a href=#dyldmain class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyld::main()</h4><p>å†…æ ¸åŠ è½½ <code>dyld</code> å¹¶è·³è½¬åˆ° <code>__dyld_start</code> è®¾ç½®ä¸€äº›å¯„å­˜å™¨ä¿¡æ¯ä¹‹åï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚</p><p><code>dyld::main()</code> å‡½æ•°å®ç°æ˜¯åŠ è½½ <code>dyld</code> çš„ä¸»è¦æ­¥éª¤</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>uintptr_t</span>
<span class=nf>_main</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mainExecutableMH</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>mainExecutableSlide</span><span class=p>,</span> 
        <span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[],</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>apple</span><span class=p>[],</span> 
        <span class=n>uintptr_t</span><span class=o>*</span> <span class=n>startGlue</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// Grab the cdHash of the main executable from the environment
</span><span class=c1></span>    <span class=c1>// ç¬¬ä¸€æ­¥ï¼Œè®¾ç½®è¿è¡Œç¯å¢ƒ
</span><span class=c1></span>    <span class=kt>uint8_t</span> <span class=n>mainExecutableCDHashBuffer</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
    <span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>mainExecutableCDHash</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>hexToBytes</span><span class=p>(</span><span class=n>_simple_getenv</span><span class=p>(</span><span class=n>apple</span><span class=p>,</span> <span class=s>&#34;executable_cdhash&#34;</span><span class=p>),</span> <span class=mi>40</span><span class=p>,</span> <span class=n>mainExecutableCDHashBuffer</span><span class=p>)</span> <span class=p>)</span>
        <span class=c1>// è·å–ä¸»ç¨‹åºçš„hash
</span><span class=c1></span>        <span class=n>mainExecutableCDHash</span> <span class=o>=</span> <span class=n>mainExecutableCDHashBuffer</span><span class=p>;</span>
    <span class=c1>// Trace dyld&#39;s load
</span><span class=c1></span>    <span class=n>notifyKernelAboutImage</span><span class=p>((</span><span class=n>macho_header</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__dso_handle</span><span class=p>,</span> <span class=n>_simple_getenv</span><span class=p>(</span><span class=n>apple</span><span class=p>,</span> <span class=s>&#34;dyld_file&#34;</span><span class=p>));</span>
<span class=cp>#if !TARGET_IPHONE_SIMULATOR
</span><span class=cp></span>    <span class=c1>// Trace the main executable&#39;s load
</span><span class=c1></span>    <span class=n>notifyKernelAboutImage</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>,</span> <span class=n>_simple_getenv</span><span class=p>(</span><span class=n>apple</span><span class=p>,</span> <span class=s>&#34;executable_file&#34;</span><span class=p>));</span>
<span class=cp>#endif
</span><span class=cp></span>    <span class=n>uintptr_t</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=c1>// è·å–ä¸»ç¨‹åºçš„macho_headerç»“æ„
</span><span class=c1></span>    <span class=n>sMainExecutableMachHeader</span> <span class=o>=</span> <span class=n>mainExecutableMH</span><span class=p>;</span>
    <span class=c1>// è·å–ä¸»ç¨‹åºçš„slideå€¼
</span><span class=c1></span>    <span class=n>sMainExecutableSlide</span> <span class=o>=</span> <span class=n>mainExecutableSlide</span><span class=p>;</span>
    <span class=n>CRSetCrashLogMessage</span><span class=p>(</span><span class=s>&#34;dyld: launch started&#34;</span><span class=p>);</span>
    <span class=c1>// è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
</span><span class=c1></span>    <span class=n>setContext</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>,</span> <span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>envp</span><span class=p>,</span> <span class=n>apple</span><span class=p>);</span>
    <span class=c1>// Pickup the pointer to the exec path.
</span><span class=c1></span>    <span class=c1>// è·å–ä¸»ç¨‹åºè·¯å¾„
</span><span class=c1></span>    <span class=n>sExecPath</span> <span class=o>=</span> <span class=n>_simple_getenv</span><span class=p>(</span><span class=n>apple</span><span class=p>,</span> <span class=s>&#34;executable_path&#34;</span><span class=p>);</span>
    <span class=c1>// &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sExecPath</span><span class=p>)</span> <span class=n>sExecPath</span> <span class=o>=</span> <span class=n>apple</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>sExecPath</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=sc>&#39;/&#39;</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// have relative path, use cwd to make absolute
</span><span class=c1></span>        <span class=kt>char</span> <span class=n>cwdbuff</span><span class=p>[</span><span class=n>MAXPATHLEN</span><span class=p>];</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>getcwd</span><span class=p>(</span><span class=n>cwdbuff</span><span class=p>,</span> <span class=n>MAXPATHLEN</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=p>{</span>
            <span class=c1>// maybe use static buffer to avoid calling malloc so early...
</span><span class=c1></span>            <span class=kt>char</span><span class=o>*</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=n>strlen</span><span class=p>(</span><span class=n>cwdbuff</span><span class=p>)</span> <span class=o>+</span> <span class=n>strlen</span><span class=p>(</span><span class=n>sExecPath</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>];</span>
            <span class=n>strcpy</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>cwdbuff</span><span class=p>);</span>
            <span class=n>strcat</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>);</span>
            <span class=n>strcat</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>sExecPath</span><span class=p>);</span>
            <span class=n>sExecPath</span> <span class=o>=</span> <span class=n>s</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=c1>// Remember short name of process for later logging
</span><span class=c1></span>    <span class=c1>// è·å–è¿›ç¨‹åç§°
</span><span class=c1></span>    <span class=n>sExecShortName</span> <span class=o>=</span> <span class=o>::</span><span class=n>strrchr</span><span class=p>(</span><span class=n>sExecPath</span><span class=p>,</span> <span class=sc>&#39;/&#39;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>sExecShortName</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span>
        <span class=o>++</span><span class=n>sExecShortName</span><span class=p>;</span>
    <span class=k>else</span>
        <span class=n>sExecShortName</span> <span class=o>=</span> <span class=n>sExecPath</span><span class=p>;</span>
    
    <span class=c1>// é…ç½®è¿›ç¨‹å—é™æ¨¡å¼
</span><span class=c1></span>    <span class=n>configureProcessRestrictions</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>);</span>
    <span class=c1>// æ£€æµ‹ç¯å¢ƒå˜é‡
</span><span class=c1></span>    <span class=n>checkEnvironmentVariables</span><span class=p>(</span><span class=n>envp</span><span class=p>);</span>
    <span class=n>defaultUninitializedFallbackPaths</span><span class=p>(</span><span class=n>envp</span><span class=p>);</span>
    <span class=c1>// å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSåˆ™è°ƒç”¨printOptions()æ‰“å°å‚æ•°
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_PRINT_OPTS</span> <span class=p>)</span>
        <span class=n>printOptions</span><span class=p>(</span><span class=n>argv</span><span class=p>);</span>
    <span class=c1>// å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVåˆ™è°ƒç”¨printEnvironmentVariables()æ‰“å°ç¯å¢ƒå˜é‡
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_PRINT_ENV</span> <span class=p>)</span> 
        <span class=n>printEnvironmentVariables</span><span class=p>(</span><span class=n>envp</span><span class=p>);</span>
    <span class=c1>// è·å–å½“å‰ç¨‹åºæ¶æ„
</span><span class=c1></span>    <span class=n>getHostInfo</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>,</span> <span class=n>mainExecutableSlide</span><span class=p>);</span>
    <span class=c1>//-------------ç¬¬ä¸€æ­¥ç»“æŸ-------------
</span><span class=c1></span>    
    <span class=c1>// load shared cache
</span><span class=c1></span>    <span class=c1>// ç¬¬äºŒæ­¥ï¼ŒåŠ è½½å…±äº«ç¼“å­˜
</span><span class=c1></span>    <span class=c1>// æ£€æŸ¥å…±äº«ç¼“å­˜æ˜¯å¦å¼€å¯ï¼ŒiOSå¿…é¡»å¼€å¯
</span><span class=c1></span>    <span class=n>checkSharedRegionDisable</span><span class=p>((</span><span class=n>mach_header</span><span class=o>*</span><span class=p>)</span><span class=n>mainExecutableMH</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>gLinkContext</span><span class=p>.</span><span class=n>sharedRegionMode</span> <span class=o>!=</span> <span class=n>ImageLoader</span><span class=o>::</span><span class=n>kDontUseSharedRegion</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>mapSharedCache</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=p>...</span>
    <span class=k>try</span> <span class=p>{</span>
        <span class=c1>// add dyld itself to UUID list
</span><span class=c1></span>        <span class=n>addDyldImageToUUIDList</span><span class=p>();</span>
        <span class=c1>// instantiate ImageLoader for main executable
</span><span class=c1></span>        <span class=c1>// ç¬¬ä¸‰æ­¥ å®ä¾‹åŒ–ä¸»ç¨‹åº
</span><span class=c1></span>        <span class=n>sMainExecutable</span> <span class=o>=</span> <span class=n>instantiateFromLoadedImage</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>,</span> <span class=n>mainExecutableSlide</span><span class=p>,</span> <span class=n>sExecPath</span><span class=p>);</span>
        <span class=n>gLinkContext</span><span class=p>.</span><span class=n>mainExecutable</span> <span class=o>=</span> <span class=n>sMainExecutable</span><span class=p>;</span>
        <span class=n>gLinkContext</span><span class=p>.</span><span class=n>mainExecutableCodeSigned</span> <span class=o>=</span> <span class=n>hasCodeSignatureLoadCommand</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>);</span>
        <span class=c1>// Now that shared cache is loaded, setup an versioned dylib overrides
</span><span class=c1></span>    <span class=cp>#if SUPPORT_VERSIONED_PATHS
</span><span class=cp></span>        <span class=n>checkVersionedPaths</span><span class=p>();</span>
    <span class=cp>#endif
</span><span class=cp></span>        <span class=c1>// dyld_all_image_infos image list does not contain dyld
</span><span class=c1></span>        <span class=c1>// add it as dyldPath field in dyld_all_image_infos
</span><span class=c1></span>        <span class=c1>// for simulator, dyld_sim is in image list, need host dyld added
</span><span class=c1></span><span class=cp>#if TARGET_IPHONE_SIMULATOR
</span><span class=cp></span>        <span class=c1>// get path of host dyld from table of syscall vectors in host dyld
</span><span class=c1></span>        <span class=kt>void</span><span class=o>*</span> <span class=n>addressInDyld</span> <span class=o>=</span> <span class=n>gSyscallHelpers</span><span class=p>;</span>
<span class=cp>#else
</span><span class=cp></span>        <span class=c1>// get path of dyld itself
</span><span class=c1></span>        <span class=kt>void</span><span class=o>*</span>  <span class=n>addressInDyld</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__dso_handle</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>        <span class=kt>char</span> <span class=n>dyldPathBuffer</span><span class=p>[</span><span class=n>MAXPATHLEN</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>proc_regionfilename</span><span class=p>(</span><span class=n>getpid</span><span class=p>(),</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>addressInDyld</span><span class=p>,</span> <span class=n>dyldPathBuffer</span><span class=p>,</span> <span class=n>MAXPATHLEN</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>len</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
            <span class=n>dyldPathBuffer</span><span class=p>[</span><span class=n>len</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span> <span class=c1>// proc_regionfilename() does not zero terminate returned string
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span> <span class=n>strcmp</span><span class=p>(</span><span class=n>dyldPathBuffer</span><span class=p>,</span> <span class=n>gProcessInfo</span><span class=o>-&gt;</span><span class=n>dyldPath</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
                <span class=n>gProcessInfo</span><span class=o>-&gt;</span><span class=n>dyldPath</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=n>dyldPathBuffer</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=c1>// load any inserted libraries
</span><span class=c1></span>        <span class=c1>// ç¬¬å››æ­¥ åŠ è½½æ’å…¥çš„åŠ¨æ€åº“
</span><span class=c1></span>        <span class=k>if</span>  <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_INSERT_LIBRARIES</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=k>const</span><span class=o>*</span> <span class=n>lib</span> <span class=o>=</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_INSERT_LIBRARIES</span><span class=p>;</span> <span class=o>*</span><span class=n>lib</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=o>++</span><span class=n>lib</span><span class=p>)</span>
                <span class=n>loadInsertedDylib</span><span class=p>(</span><span class=o>*</span><span class=n>lib</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=c1>// record count of inserted libraries so that a flat search will look at 
</span><span class=c1></span>        <span class=c1>// inserted libraries, then main, then others.
</span><span class=c1></span>        <span class=c1>// è®°å½•æ’å…¥çš„åŠ¨æ€åº“æ•°é‡
</span><span class=c1></span>        <span class=n>sInsertedDylibCount</span> <span class=o>=</span> <span class=n>sAllImages</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=c1>// link main executable
</span><span class=c1></span>        <span class=c1>// ç¬¬äº”æ­¥ é“¾æ¥ä¸»ç¨‹åº
</span><span class=c1></span>        <span class=n>gLinkContext</span><span class=p>.</span><span class=n>linkingMainExecutable</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
<span class=cp>#if SUPPORT_ACCELERATE_TABLES
</span><span class=cp></span>        <span class=k>if</span> <span class=p>(</span> <span class=n>mainExcutableAlreadyRebased</span> <span class=p>)</span> <span class=p>{</span>
            <span class=c1>// previous link() on main executable has already adjusted its internal pointers for ASLR
</span><span class=c1></span>            <span class=c1>// work around that by rebasing by inverse amount
</span><span class=c1></span>            <span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>rebase</span><span class=p>(</span><span class=n>gLinkContext</span><span class=p>,</span> <span class=o>-</span><span class=n>mainExecutableSlide</span><span class=p>);</span>
        <span class=p>}</span>
<span class=cp>#endif
</span><span class=cp></span>        <span class=n>link</span><span class=p>(</span><span class=n>sMainExecutable</span><span class=p>,</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_BIND_AT_LAUNCH</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> <span class=n>ImageLoader</span><span class=o>::</span><span class=n>RPathChain</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>),</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
        <span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>setNeverUnloadRecursive</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>forceFlat</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
            <span class=n>gLinkContext</span><span class=p>.</span><span class=n>bindFlat</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
            <span class=n>gLinkContext</span><span class=p>.</span><span class=n>prebindUsage</span> <span class=o>=</span> <span class=n>ImageLoader</span><span class=o>::</span><span class=n>kUseNoPrebinding</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// link any inserted libraries
</span><span class=c1></span>        <span class=c1>// do this after linking main executable so that any dylibs pulled in by inserted 
</span><span class=c1></span>        <span class=c1>// dylibs (e.g. libSystem) will not be in front of dylibs the program uses
</span><span class=c1></span>        <span class=c1>// ç¬¬å…­æ­¥ é“¾æ¥æ’å…¥çš„åŠ¨æ€åº“
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span> <span class=n>sInsertedDylibCount</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sInsertedDylibCount</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>sAllImages</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
                <span class=n>link</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_BIND_AT_LAUNCH</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> <span class=n>ImageLoader</span><span class=o>::</span><span class=n>RPathChain</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>),</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
                <span class=n>image</span><span class=o>-&gt;</span><span class=n>setNeverUnloadRecursive</span><span class=p>();</span>
            <span class=p>}</span>
            <span class=c1>// only INSERTED libraries can interpose
</span><span class=c1></span>            <span class=c1>// register interposing info after all inserted libraries are bound so chaining works
</span><span class=c1></span>            <span class=k>for</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sInsertedDylibCount</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>sAllImages</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
                <span class=n>image</span><span class=o>-&gt;</span><span class=n>registerInterposing</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=kt>long</span> <span class=n>i</span><span class=o>=</span><span class=n>sInsertedDylibCount</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sAllImages</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>sAllImages</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>inSharedCache</span><span class=p>()</span> <span class=p>)</span>
                <span class=k>continue</span><span class=p>;</span>
            <span class=n>image</span><span class=o>-&gt;</span><span class=n>registerInterposing</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=p>...</span>
        <span class=c1>// apply interposing to initial set of images
</span><span class=c1></span>        <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sImageRoots</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>sImageRoots</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>applyInterposing</span><span class=p>(</span><span class=n>gLinkContext</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>gLinkContext</span><span class=p>.</span><span class=n>linkingMainExecutable</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
        
        <span class=c1>// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked
</span><span class=c1></span>        <span class=c1>// ç¬¬ä¸ƒæ­¥ æ‰§è¡Œå¼±ç¬¦å·ç»‘å®š
</span><span class=c1></span>        <span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>weakBind</span><span class=p>(</span><span class=n>gLinkContext</span><span class=p>);</span>
        <span class=c1>// If cache has branch island dylibs, tell debugger about them
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>.</span><span class=n>mappingOffset</span> <span class=o>&gt;=</span> <span class=mh>0x78</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>.</span><span class=n>branchPoolsOffset</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
            <span class=kt>uint32_t</span> <span class=n>count</span> <span class=o>=</span> <span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>.</span><span class=n>branchPoolsCount</span><span class=p>;</span>
            <span class=n>dyld_image_info</span> <span class=n>info</span><span class=p>[</span><span class=n>count</span><span class=p>];</span>
            <span class=k>const</span> <span class=kt>uint64_t</span><span class=o>*</span> <span class=n>poolAddress</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=o>*</span><span class=p>)((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span> <span class=o>+</span> <span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>loadAddress</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>.</span><span class=n>branchPoolsOffset</span><span class=p>);</span>
            <span class=c1>// &lt;rdar://problem/20799203&gt; empty branch pools can be in development cache
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span> <span class=p>((</span><span class=n>mach_header</span><span class=o>*</span><span class=p>)</span><span class=n>poolAddress</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>magic</span> <span class=o>==</span> <span class=n>sMainExecutableMachHeader</span><span class=o>-&gt;</span><span class=n>magic</span> <span class=p>)</span> <span class=p>{</span>
                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>poolIndex</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>poolIndex</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=o>++</span><span class=n>poolIndex</span><span class=p>)</span> <span class=p>{</span>
                    <span class=kt>uint64_t</span> <span class=n>poolAddr</span> <span class=o>=</span> <span class=n>poolAddress</span><span class=p>[</span><span class=n>poolIndex</span><span class=p>]</span> <span class=o>+</span> <span class=n>sSharedCacheLoadInfo</span><span class=p>.</span><span class=n>slide</span><span class=p>;</span>
                    <span class=n>info</span><span class=p>[</span><span class=n>poolIndex</span><span class=p>].</span><span class=n>imageLoadAddress</span> <span class=o>=</span> <span class=p>(</span><span class=n>mach_header</span><span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>poolAddr</span><span class=p>;</span>
                    <span class=n>info</span><span class=p>[</span><span class=n>poolIndex</span><span class=p>].</span><span class=n>imageFilePath</span> <span class=o>=</span> <span class=s>&#34;dyld_shared_cache_branch_islands&#34;</span><span class=p>;</span>
                    <span class=n>info</span><span class=p>[</span><span class=n>poolIndex</span><span class=p>].</span><span class=n>imageFileModDate</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                <span class=p>}</span>
                <span class=c1>// add to all_images list
</span><span class=c1></span>                <span class=n>addImagesToAllImages</span><span class=p>(</span><span class=n>count</span><span class=p>,</span> <span class=n>info</span><span class=p>);</span>
                <span class=c1>// tell gdb about new branch island images
</span><span class=c1></span>                <span class=n>gProcessInfo</span><span class=o>-&gt;</span><span class=n>notification</span><span class=p>(</span><span class=n>dyld_image_adding</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>info</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=n>CRSetCrashLogMessage</span><span class=p>(</span><span class=s>&#34;dyld: launch, running initializers&#34;</span><span class=p>);</span>
        <span class=p>...</span>
        <span class=c1>// run all initializers
</span><span class=c1></span>        <span class=c1>// ç¬¬å…«æ­¥ æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•
</span><span class=c1></span>        <span class=n>initializeMainExecutable</span><span class=p>();</span> 
        <span class=c1>// notify any montoring proccesses that this process is about to enter main()
</span><span class=c1></span>        <span class=n>dyld3</span><span class=o>::</span><span class=n>kdebug_trace_dyld_signpost</span><span class=p>(</span><span class=n>DBG_DYLD_SIGNPOST_START_MAIN_DYLD2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
        <span class=n>notifyMonitoringDyldMain</span><span class=p>();</span>
        <span class=c1>// find entry point for main executable
</span><span class=c1></span>        <span class=c1>// ç¬¬ä¹æ­¥ æŸ¥æ‰¾å…¥å£ç‚¹å¹¶è¿”å›
</span><span class=c1></span>        <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>getThreadPC</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>result</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
            <span class=c1>// main executable uses LC_MAIN, needs to return to glue in libdyld.dylib
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>gLibSystemHelpers</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>gLibSystemHelpers</span><span class=o>-&gt;</span><span class=n>version</span> <span class=o>&gt;=</span> <span class=mi>9</span><span class=p>)</span> <span class=p>)</span>
                <span class=o>*</span><span class=n>startGlue</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>gLibSystemHelpers</span><span class=o>-&gt;</span><span class=n>startGlueToCallExit</span><span class=p>;</span>
            <span class=k>else</span>
                <span class=n>halt</span><span class=p>(</span><span class=s>&#34;libdyld.dylib support not present for LC_MAIN&#34;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// main executable uses LC_UNIXTHREAD, dyld needs to let &#34;start&#34; in program set up for main()
</span><span class=c1></span>            <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>getMain</span><span class=p>();</span>
            <span class=o>*</span><span class=n>startGlue</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>catch</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>message</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>syncAllImages</span><span class=p>();</span>
        <span class=n>halt</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>catch</span><span class=p>(...)</span> <span class=p>{</span>
        <span class=n>dyld</span><span class=o>::</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;dyld: launch failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=p>...</span>
    
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>ç®€åŒ–ä¹‹åçš„ä»£ç ï¼Œæ•´ä¸ªåŠ è½½è¿‡ç¨‹å¯ç»†åˆ†ä¸ºä¹ä¸ªæ­¥éª¤</p><ul><li>ç¬¬ä¸€æ­¥ï¼šè®¾ç½®è¿è¡Œç¯å¢ƒ</li><li>ç¬¬äºŒæ­¥ï¼šåŠ è½½å…±äº«ç¼“å­˜</li><li>ç¬¬ä¸‰æ­¥ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº</li><li>ç¬¬å››æ­¥ï¼šåŠ è½½æ’å…¥çš„åŠ¨æ€åº“</li><li>ç¬¬äº”æ­¥ï¼šé“¾æ¥ä¸»ç¨‹åº</li><li>ç¬¬å…­æ­¥ï¼šé“¾æ¥æ’å…¥çš„åŠ¨æ€åº“</li><li>ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œå¼±ç¬¦å·ç»‘å®š</li><li>ç¬¬å…«æ­¥ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</li><li>ç¬¬ä¹æ­¥ï¼šæŸ¥æ‰¾å…¥å£ç‚¹å¹¶è¿”å›</li></ul><h5 id=è®¾ç½®è¿è¡Œç¯å¢ƒ><a href=#è®¾ç½®è¿è¡Œç¯å¢ƒ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>è®¾ç½®è¿è¡Œç¯å¢ƒ</h5><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯è®¾ç½®è¿è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡ç­‰ã€‚</p><p>ä»£ç åœ¨å¼€å§‹çš„æ—¶å€™ï¼Œå°†å…¥å‚ <code>mainExecutableMH</code> èµ‹å€¼ç»™ <code>sMainExecutableMachHeader</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>macho_header</code> ç»“æ„ä½“ï¼Œè¡¨ç¤ºçš„æ˜¯å½“å‰ä¸»ç¨‹åºçš„ <code>Mach-O</code> å¤´éƒ¨ä¿¡æ¯ï¼ŒåŠ è½½å™¨ä¾æ® <code>Mach-O</code> å¤´éƒ¨ä¿¡æ¯å°±å¯ä»¥è§£ææ•´ä¸ªæ–‡ä»¶ä¿¡æ¯</p><p>æ¥ç€è°ƒç”¨ <code>setContext()</code> è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸€äº›å›è°ƒå‡½æ•°ã€å‚æ•°ã€æ ‡å¿—ä¿¡æ¯ç­‰ã€‚</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>setContext</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mainExecutableMH</span><span class=p>,</span> <span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[],</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[],</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>apple</span><span class=p>[])</span>
<span class=p>{</span>
   <span class=n>gLinkContext</span><span class=p>.</span><span class=n>loadLibrary</span>         <span class=o>=</span> <span class=o>&amp;</span><span class=n>libraryLocator</span><span class=p>;</span>
   <span class=n>gLinkContext</span><span class=p>.</span><span class=n>terminationRecorder</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>terminationRecorder</span><span class=p>;</span>
   <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p>è®¾ç½®çš„å›è°ƒå‡½æ•°éƒ½æ˜¯ dyld æ¨¡å—è‡ªèº«å®ç°çš„ï¼Œå¦‚ <code>loadLibrary()</code>å‡½æ•°å®é™…è°ƒç”¨çš„æ˜¯ <code>libraryLocator()</code>ï¼Œè´Ÿè´£åŠ è½½åŠ¨æ€åº“</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>configureProcessRestrictions</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mainExecutableMH</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>sEnvMode</span> <span class=o>=</span> <span class=n>envNone</span><span class=p>;</span> <span class=c1>// å—é™æ¨¡å¼
</span><span class=c1></span>    <span class=n>gLinkContext</span><span class=p>.</span><span class=n>requireCodeSignature</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span> <span class=c1>// éœ€è¦ä»£ç ç­¾å
</span><span class=c1></span>    <span class=kt>uint32_t</span> <span class=n>flags</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>csops</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>CS_OPS_STATUS</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>flags</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>flags</span><span class=p>))</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// å¯ç”¨ä»£ç ç­¾å
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>CS_ENFORCEMENT</span> <span class=p>)</span> <span class=p>{</span>
            <span class=c1>// get_task_allow
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=n>CS_GET_TASK_ALLOW</span> <span class=p>)</span> <span class=p>{</span>
                <span class=c1>// Xcode built app for Debug allowed to use DYLD_* variables
</span><span class=c1></span>                <span class=c1>// Xcodeè°ƒè¯•æ—¶å…è®¸ä½¿ç”¨DYLD_*ç¯å¢ƒå˜é‡
</span><span class=c1></span>                <span class=n>sEnvMode</span> <span class=o>=</span> <span class=n>envAll</span><span class=p>;</span> <span class=c1>// éå—é™æ¨¡å¼
</span><span class=c1></span>            <span class=p>}</span>
            <span class=k>else</span> <span class=p>{</span>
                <span class=c1>// Development kernel can use DYLD_PRINT_* variables on any FairPlay encrypted app
</span><span class=c1></span>                <span class=kt>uint32_t</span> <span class=n>secureValue</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                <span class=n>size_t</span>   <span class=n>secureValueSize</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>secureValue</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>sysctlbyname</span><span class=p>(</span><span class=s>&#34;kern.secure_kernel&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>secureValue</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>secureValueSize</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>secureValue</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>isFairPlayEncrypted</span><span class=p>(</span><span class=n>mainExecutableMH</span><span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
                    <span class=n>sEnvMode</span> <span class=o>=</span> <span class=n>envPrintOnly</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// Development kernel can run unsigned code
</span><span class=c1></span>            <span class=c1>// å†…æ ¸å¼€å‘è¿è¡Œè¿è¡Œéç­¾åä»£ç 
</span><span class=c1></span>            <span class=n>sEnvMode</span> <span class=o>=</span> <span class=n>envAll</span><span class=p>;</span> <span class=c1>// éå—é™æ¨¡å¼
</span><span class=c1></span>            <span class=n>gLinkContext</span><span class=p>.</span><span class=n>requireCodeSignature</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span> <span class=c1>// æ— éœ€ä»£ç ç­¾å
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
    <span class=c1>// å¦‚æœè®¾ç½®äº†uidã€gidåˆ™å˜æˆå—é™æ¨¡å¼
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>issetugid</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>sEnvMode</span> <span class=o>=</span> <span class=n>envNone</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p><code>configureProcessRestrictions()</code>ç”¨æ¥é…ç½®è¿›ç¨‹æ˜¯å¦å—é™ï¼Œä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œ<code>sEnvMode</code>é»˜è®¤ç­‰äº<code>envNone</code>ï¼ˆå³å—é™æ¨¡å¼ï¼‰</p><ul><li><p>å¦‚æœè®¾ç½®äº†<code>get_task_allow</code>æƒé™æˆ–è€…æ˜¯å†…æ ¸å¼€å‘æ—¶ä¼šè®¾ç½®æˆ<code>envAll</code></p></li><li><p>å¦‚æœè®¾ç½®äº†<code>uid</code>å’Œ<code>gid</code>åˆ™ç«‹å³å˜æˆå—é™æ¨¡å¼</p></li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>checkEnvironmentVariables</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>envp</span><span class=p>[])</span>
<span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span> <span class=n>sEnvMode</span> <span class=o>==</span> <span class=n>envNone</span> <span class=p>)</span>
      <span class=k>return</span><span class=p>;</span>
   <span class=k>const</span> <span class=kt>char</span><span class=o>**</span> <span class=n>p</span><span class=p>;</span>
   <span class=k>for</span><span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>envp</span><span class=p>;</span> <span class=o>*</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>keyEqualsValue</span> <span class=o>=</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
       <span class=k>if</span> <span class=p>(</span> <span class=n>strncmp</span><span class=p>(</span><span class=n>keyEqualsValue</span><span class=p>,</span> <span class=s>&#34;DYLD_&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
         <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>equals</span> <span class=o>=</span> <span class=n>strchr</span><span class=p>(</span><span class=n>keyEqualsValue</span><span class=p>,</span> <span class=sc>&#39;=&#39;</span><span class=p>);</span>
         <span class=k>if</span> <span class=p>(</span> <span class=n>equals</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=p>{</span>
            <span class=n>strlcat</span><span class=p>(</span><span class=n>sLoadingCrashMessage</span><span class=p>,</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>sLoadingCrashMessage</span><span class=p>));</span>
            <span class=n>strlcat</span><span class=p>(</span><span class=n>sLoadingCrashMessage</span><span class=p>,</span> <span class=n>keyEqualsValue</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>sLoadingCrashMessage</span><span class=p>));</span>
            <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>value</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>equals</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
            <span class=k>const</span> <span class=n>size_t</span> <span class=n>keyLen</span> <span class=o>=</span> <span class=n>equals</span><span class=o>-</span><span class=n>keyEqualsValue</span><span class=p>;</span>
            <span class=kt>char</span> <span class=n>key</span><span class=p>[</span><span class=n>keyLen</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
            <span class=n>strncpy</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>keyEqualsValue</span><span class=p>,</span> <span class=n>keyLen</span><span class=p>);</span>
            <span class=n>key</span><span class=p>[</span><span class=n>keyLen</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>sEnvMode</span> <span class=o>==</span> <span class=n>envPrintOnly</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s>&#34;DYLD_PRINT_&#34;</span><span class=p>,</span> <span class=mi>11</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>)</span>
               <span class=k>continue</span><span class=p>;</span>
            <span class=c1>// å¤„ç†å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
</span><span class=c1></span>            <span class=n>processDyldEnvironmentVariable</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
         <span class=p>}</span>
      <span class=p>}</span>
      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>strncmp</span><span class=p>(</span><span class=n>keyEqualsValue</span><span class=p>,</span> <span class=s>&#34;LD_LIBRARY_PATH=&#34;</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
         <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>keyEqualsValue</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
         <span class=n>sEnv</span><span class=p>.</span><span class=n>LD_LIBRARY_PATH</span> <span class=o>=</span> <span class=n>parseColonList</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
      <span class=p>}</span>
   <span class=p>}</span>
   <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p><code>checkEnvironmentVariables()</code>æ£€æµ‹ç¯å¢ƒå˜é‡ï¼Œå¦‚æœ<code>sEnvMode</code>ä¸º<code>envNone</code>å°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™è°ƒç”¨<code>processDyldEnvironmentVariable()</code>å¤„ç†å¹¶è®¾ç½®ç¯å¢ƒå˜é‡</p><p>æœ€åæ˜¯è°ƒç”¨<code>getHostInfo()</code>è·å–å½“å‰ç¨‹åºæ¶æ„ï¼Œè‡³æ­¤ï¼Œç¬¬ä¸€æ­¥çš„å‡†å¤‡å·¥ä½œå°±å®Œæˆäº†</p><blockquote><p><code>DYLD_*</code>å¼€å¤´çš„æ˜¯ç¯å¢ƒå˜é‡ï¼Œå¦‚ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSåˆ™è°ƒç”¨printOptions()æ‰“å°å‚æ•°
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_PRINT_OPTS</span> <span class=p>)</span>
    <span class=n>printOptions</span><span class=p>(</span><span class=n>argv</span><span class=p>);</span>
<span class=c1>// å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVåˆ™è°ƒç”¨printEnvironmentVariables()æ‰“å°ç¯å¢ƒå˜é‡
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_PRINT_ENV</span> <span class=p>)</span> 
    <span class=n>printEnvironmentVariables</span><span class=p>(</span><span class=n>envp</span><span class=p>);</span>
</code></pre></div><p>åªè¦åœ¨ Xcode ä¸­é…ç½®ä¸€ä¸‹ï¼Œå³å¯ä½¿è¿™äº›ç¯å¢ƒå˜é‡ç”Ÿæ•ˆï¼Œåœ¨ App å¯åŠ¨æ—¶å°±ä¼šæ‰“å°ç›¸å…³å‚æ•°</p></blockquote><h5 id=åŠ è½½å…±äº«ç¼“å­˜><a href=#åŠ è½½å…±äº«ç¼“å­˜ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åŠ è½½å…±äº«ç¼“å­˜</h5><p>å…ˆè°ƒç”¨<code>checkSharedRegionDisable()</code>æ£€æŸ¥å…±äº«ç¼“å­˜æ˜¯å¦ç¦ç”¨</p><p>è¯¥å‡½æ•°çš„iOSå®ç°éƒ¨åˆ†ä»…æœ‰ä¸€å¥æ³¨é‡Šï¼Œä»æ³¨é‡Šæˆ‘ä»¬å¯ä»¥æ¨æ–­iOSå¿…é¡»å¼€å¯å…±äº«ç¼“å­˜æ‰èƒ½æ­£å¸¸å·¥ä½œ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>checkSharedRegionDisable</span><span class=p>(</span><span class=k>const</span> <span class=n>mach_header</span><span class=o>*</span> <span class=n>mainExecutableMH</span><span class=p>)</span>
<span class=p>{</span>
   <span class=c1>// iOS cannot run without shared region
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>æ¥ç€ä¼šè°ƒç”¨<code>mapSharedCache()</code>åŠ è½½å…±äº«ç¼“å­˜ï¼Œè€Œ<code>mapSharedCache()</code>å®é™…æ˜¯è°ƒç”¨ <code>loadDyldCache()</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>bool</span> <span class=nf>loadDyldCache</span><span class=p>(</span><span class=k>const</span> <span class=n>SharedCacheOptions</span><span class=o>&amp;</span> <span class=n>options</span><span class=p>,</span> <span class=n>SharedCacheLoadInfo</span><span class=o>*</span> <span class=n>results</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>results</span><span class=o>-&gt;</span><span class=n>loadAddress</span>        <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>results</span><span class=o>-&gt;</span><span class=n>slide</span>              <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>results</span><span class=o>-&gt;</span><span class=n>cachedDylibsGroup</span>  <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
    <span class=n>results</span><span class=o>-&gt;</span><span class=n>errorMessage</span>       <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>options</span><span class=p>.</span><span class=n>forcePrivate</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>// mmap cache into this process only
</span><span class=c1></span>        <span class=c1>// ä»…åŠ è½½åˆ°å½“å‰è¿›ç¨‹
</span><span class=c1></span>        <span class=k>return</span> <span class=n>mapCachePrivate</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>results</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// fast path: when cache is already mapped into shared region
</span><span class=c1></span>        <span class=c1>// å…±äº«ç¼“å­˜å·²åŠ è½½ï¼Œä¸åšä»»ä½•å¤„ç†
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span> <span class=n>reuseExistingCache</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span> <span class=p>)</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>results</span><span class=o>-&gt;</span><span class=n>errorMessage</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>);</span>
        <span class=c1>// slow path: this is first process to load cache
</span><span class=c1></span>        <span class=c1>// å½“å‰è¿›ç¨‹é¦–æ¬¡åŠ è½½å…±äº«ç¼“å­˜
</span><span class=c1></span>        <span class=k>return</span> <span class=n>mapCacheSystemWide</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>results</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå…±äº«ç¼“å­˜åŠ è½½åˆ†ä¸ºï¼š</p><ul><li>ä»…åŠ è½½åˆ°å½“å‰è¿›ç¨‹ï¼Œè°ƒç”¨<code>mapCachePrivate()</code></li><li>å…±äº«ç¼“å­˜å·²åŠ è½½ï¼Œä¸åšä»»ä½•å¤„ç†</li><li>å½“å‰è¿›è¡Œé¦–æ¬¡åŠ è½½å…±äº«ç¼“å­˜ï¼Œè°ƒç”¨<code>mapCacheSystemWide()</code></li></ul><p><code>mapCachePrivate()</code>ã€<code>mapCacheSystemWide()</code>é‡Œé¢å°±æ˜¯å…·ä½“çš„å…±äº«ç¼“å­˜è§£æé€»è¾‘ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è¯¦ç»†åˆ†æã€‚</p><h5 id=å®ä¾‹åŒ–ä¸»ç¨‹åº><a href=#å®ä¾‹åŒ–ä¸»ç¨‹åº class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å®ä¾‹åŒ–ä¸»ç¨‹åº</h5><p>è¿™é‡Œä¼šå°†ä¸»ç¨‹åºçš„ <code>Mach-O</code> åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å®ä¾‹åŒ–ä¸€ä¸ª <code>ImageLoader</code> å¯¹è±¡</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=n>ImageLoaderMachO</span><span class=o>*</span> <span class=nf>instantiateFromLoadedImage</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mh</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>slide</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>)</span>
<span class=p>{</span>
  <span class=c1>// try mach-o loader
</span><span class=c1></span>  <span class=c1>// å°è¯•åŠ è½½MachO
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>isCompatibleMachO</span><span class=p>((</span><span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*</span><span class=p>)</span><span class=n>mh</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>ImageLoaderMachO</span><span class=o>::</span><span class=n>instantiateMainExecutable</span><span class=p>(</span><span class=n>mh</span><span class=p>,</span> <span class=n>slide</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>gLinkContext</span><span class=p>);</span>
    <span class=n>addImage</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>ImageLoaderMachO</span><span class=o>*</span><span class=p>)</span><span class=n>image</span><span class=p>;</span>
  <span class=p>}</span>
  
  <span class=k>throw</span> <span class=s>&#34;main executable not a known format&#34;</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><code>instantiateFromLoadedImage()</code>é¦–å…ˆè°ƒç”¨<code>isCompatibleMachO()</code>æ£€æµ‹ Mach-O å¤´éƒ¨çš„ <code>magic</code>ã€<code>cputype</code>ã€<code>cpusubtype</code> ç­‰ç›¸å…³å±æ€§ï¼Œåˆ¤æ–­ Mach-O æ–‡ä»¶çš„å…¼å®¹æ€§ï¼Œå¦‚æœå…¼å®¹ï¼Œåˆ™è°ƒç”¨ <code>ImageLoaderMachO::instantiateMainExecutable()</code>å®ä¾‹åŒ–ä¸»ç¨‹åºçš„<code>ImageLoader</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>ImageLoader</span><span class=o>*</span> <span class=n>ImageLoaderMachO</span><span class=o>::</span><span class=n>instantiateMainExecutable</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mh</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>slide</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=n>LinkContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>)</span>
<span class=p>{</span>
  <span class=kt>bool</span> <span class=n>compressed</span><span class=p>;</span>
  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>segCount</span><span class=p>;</span>
  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>libCount</span><span class=p>;</span>
  <span class=k>const</span> <span class=n>linkedit_data_command</span><span class=o>*</span> <span class=n>codeSigCmd</span><span class=p>;</span>
  <span class=k>const</span> <span class=n>encryption_info_command</span><span class=o>*</span> <span class=n>encryptCmd</span><span class=p>;</span>
  <span class=n>sniffLoadCommands</span><span class=p>(</span><span class=n>mh</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>compressed</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>segCount</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>libCount</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>codeSigCmd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>encryptCmd</span><span class=p>);</span>
  <span class=c1>// instantiate concrete class based on content of load commands
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>compressed</span> <span class=p>)</span> 
    <span class=k>return</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>instantiateMainExecutable</span><span class=p>(</span><span class=n>mh</span><span class=p>,</span> <span class=n>slide</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>segCount</span><span class=p>,</span> <span class=n>libCount</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
  <span class=k>else</span>
<span class=cp>#if SUPPORT_CLASSIC_MACHO
</span><span class=cp></span>    <span class=k>return</span> <span class=n>ImageLoaderMachOClassic</span><span class=o>::</span><span class=n>instantiateMainExecutable</span><span class=p>(</span><span class=n>mh</span><span class=p>,</span> <span class=n>slide</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>segCount</span><span class=p>,</span> <span class=n>libCount</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
<span class=cp>#else
</span><span class=cp></span>    <span class=k>throw</span> <span class=s>&#34;missing LC_DYLD_INFO load command&#34;</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span><span class=p>}</span>
</code></pre></div><p>è¿™ä¸ªå‡½æ•°é¦–å…ˆä¼šè°ƒç”¨<code>sniffLoadCommands()</code>å‡½æ•°æ¥è·å–ä¸€äº›æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><p><code>compressed</code>ï¼šè‹¥ Mach-O å­˜åœ¨ <code>LC_DYLD_INFO</code> å’Œ <code>LC_DYLD_INFO_ONLY</code> åŠ è½½å‘½ä»¤ï¼Œåˆ™è¯´æ˜æ˜¯å‹ç¼©ç±»å‹çš„ Mach-O</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>switch</span> <span class=p>(</span><span class=n>cmd</span><span class=o>-&gt;</span><span class=n>cmd</span><span class=p>)</span> <span class=p>{</span>
<span class=k>case</span> <span class=nl>LC_DYLD_INFO</span><span class=p>:</span>
<span class=k>case</span> <span class=nl>LC_DYLD_INFO_ONLY</span><span class=p>:</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>cmd</span><span class=o>-&gt;</span><span class=n>cmdsize</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>dyld_info_command</span><span class=p>)</span> <span class=p>)</span>
        <span class=k>throw</span> <span class=s>&#34;malformed mach-o image: LC_DYLD_INFO size wrong&#34;</span><span class=p>;</span>
    <span class=n>dyldInfoCmd</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>dyld_info_command</span><span class=o>*</span><span class=p>)</span><span class=n>cmd</span><span class=p>;</span>
    <span class=c1>// å­˜åœ¨LC_DYLD_INFOæˆ–è€…LC_DYLD_INFO_ONLYåˆ™è¡¨ç¤ºæ˜¯å‹ç¼©ç±»å‹çš„Mach-O
</span><span class=c1></span>    <span class=o>*</span><span class=n>compressed</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
    <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></div></li><li><p><code>segCount</code>: æ ¹æ® <code>LC_SEGMENT_COMMAND</code> åŠ è½½å‘½ä»¤æ¥ç»Ÿè®¡æ®µæ•°é‡ï¼Œè¿™é‡ŒæŠ›å‡ºçš„é”™è¯¯æ—¥å¿—ä¹Ÿè¯´æ˜äº†æ®µçš„æ•°é‡ä¸èƒ½è¶…è¿‡ 255 ä¸ª</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>case</span> <span class=nl>LC_SEGMENT_COMMAND</span><span class=p>:</span>
    <span class=n>segCmd</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>macho_segment_command</span><span class=o>*</span><span class=p>)</span><span class=n>cmd</span><span class=p>;</span>
<span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>segCmd</span><span class=o>-&gt;</span><span class=n>vmsize</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
        <span class=o>*</span><span class=n>segCount</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span> <span class=o>*</span><span class=n>segCount</span> <span class=o>&gt;</span> <span class=mi>255</span> <span class=p>)</span>
    <span class=n>dyld</span><span class=o>::</span><span class=n>throwf</span><span class=p>(</span><span class=s>&#34;malformed mach-o image: more than 255 segments in %s&#34;</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</code></pre></div></li><li><p><code>libCount</code>ï¼šæ ¹æ®<code>LC_LOAD_DYLIB</code>ã€<code>LC_LOAD_WEAK_DYLIB</code>ã€<code>LC_REEXPORT_DYLIB</code>ã€<code>LC_LOAD_UPWARD_DYLIB</code> è¿™å‡ ä¸ªåŠ è½½å‘½ä»¤æ¥ç»Ÿè®¡åº“çš„æ•°é‡ï¼Œ åº“çš„æ•°é‡ä¸èƒ½è¶…è¿‡ 4095 ä¸ª</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>case</span> <span class=nl>LC_LOAD_DYLIB</span><span class=p>:</span>
<span class=k>case</span> <span class=nl>LC_LOAD_WEAK_DYLIB</span><span class=p>:</span>
<span class=k>case</span> <span class=nl>LC_REEXPORT_DYLIB</span><span class=p>:</span>
<span class=k>case</span> <span class=nl>LC_LOAD_UPWARD_DYLIB</span><span class=p>:</span>
<span class=o>*</span><span class=n>libCount</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span> <span class=o>*</span><span class=n>libCount</span> <span class=o>&gt;</span> <span class=mi>4095</span> <span class=p>)</span>
    <span class=n>dyld</span><span class=o>::</span><span class=n>throwf</span><span class=p>(</span><span class=s>&#34;malformed mach-o image: more than 4095 dependent libraries in %s&#34;</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</code></pre></div></li><li><p><code>codeSigCmd</code>ï¼šé€šè¿‡è§£æ<code>LC_CODE_SIGNATURE</code>æ¥è·å–ä»£ç ç­¾ååŠ è½½å‘½ä»¤</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>case</span> <span class=nl>LC_CODE_SIGNATURE</span><span class=p>:</span>
<span class=o>*</span><span class=n>codeSigCmd</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>linkedit_data_command</span><span class=o>*</span><span class=p>)</span><span class=n>cmd</span><span class=p>;</span>
<span class=k>break</span><span class=p>;</span>
</code></pre></div></li><li><p><code>encryptCmd</code>ï¼šé€šè¿‡<code>LC_ENCRYPTION_INFO</code>å’Œ<code>LC_ENCRYPTION_INFO_64</code>æ¥è·å–æ®µçš„åŠ å¯†ä¿¡æ¯</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>case</span> <span class=nl>LC_ENCRYPTION_INFO</span><span class=p>:</span>
<span class=p>...</span>
<span class=o>*</span><span class=n>encryptCmd</span> <span class=o>=</span> <span class=p>(</span><span class=n>encryption_info_command</span><span class=o>*</span><span class=p>)</span><span class=n>cmd</span><span class=p>;</span>
<span class=k>break</span><span class=p>;</span>
<span class=k>case</span> <span class=nl>LC_ENCRYPTION_INFO_64</span><span class=p>:</span>
<span class=p>...</span>
<span class=o>*</span><span class=n>encryptCmd</span> <span class=o>=</span> <span class=p>(</span><span class=n>encryption_info_command</span><span class=o>*</span><span class=p>)</span><span class=n>cmd</span><span class=p>;</span>
<span class=k>break</span><span class=p>;</span>
</code></pre></div></li></ul><p><code>ImageLoader</code>æ˜¯æŠ½è±¡ç±»ï¼Œå…¶å­ç±»è´Ÿè´£æŠŠ Mach-O æ–‡ä»¶å®ä¾‹åŒ–ä¸º imageã€‚</p><p>å½“<code>sniffLoadCommands()</code>è§£æå®Œä»¥åï¼Œæ ¹æ®<code>compressed</code>çš„å€¼æ¥è§‰å¾—è°ƒç”¨å“ªä¸ªå­ç±»è¿›è¡Œå®ä¾‹åŒ–</p><p>è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥ç›´è§‚æè¿°</p><p><img src=https://w-md.imzsy.design/image-20201008175315434.png alt=image-20201008175315434></p><p>è¿™é‡Œä»¥<code>ImageLoaderMachOCompressed::instantiateMainExecutable()</code>ä¸ºä¾‹æ¥çœ‹ä¸€ä¸‹å®ç°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// create image for main executable
</span><span class=c1></span><span class=n>ImageLoaderMachOCompressed</span><span class=o>*</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>instantiateMainExecutable</span><span class=p>(</span><span class=k>const</span> <span class=n>macho_header</span><span class=o>*</span> <span class=n>mh</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>slide</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>,</span> 
                                    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>segCount</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>libCount</span><span class=p>,</span> <span class=k>const</span> <span class=n>LinkContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>ImageLoaderMachOCompressed</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>instantiateStart</span><span class=p>(</span><span class=n>mh</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>segCount</span><span class=p>,</span> <span class=n>libCount</span><span class=p>);</span>
  <span class=c1>// set slide for PIE programs
</span><span class=c1></span>  <span class=n>image</span><span class=o>-&gt;</span><span class=n>setSlide</span><span class=p>(</span><span class=n>slide</span><span class=p>);</span>
  <span class=c1>// for PIE record end of program, to know where to start loading dylibs
</span><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>slide</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
    <span class=n>fgNextPIEDylibAddress</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>getEnd</span><span class=p>();</span>
  <span class=n>image</span><span class=o>-&gt;</span><span class=n>disableCoverageCheck</span><span class=p>();</span>
  <span class=n>image</span><span class=o>-&gt;</span><span class=n>instantiateFinish</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=n>image</span><span class=o>-&gt;</span><span class=n>setMapped</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>context</span><span class=p>.</span><span class=n>verboseMapping</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>dyld</span><span class=o>::</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;dyld: Main executable mapped %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
    <span class=k>for</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>e</span><span class=o>=</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>segmentCount</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>name</span> <span class=o>=</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segName</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;__PAGEZERO&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;__UNIXSTACK&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  <span class=p>)</span>
        <span class=n>dyld</span><span class=o>::</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;%18s at 0x%08lX-&gt;0x%08lX</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segPreferredLoadAddress</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segPreferredLoadAddress</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=o>+</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>segSize</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
      <span class=k>else</span>
        <span class=n>dyld</span><span class=o>::</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;%18s at 0x%08lX-&gt;0x%08lX</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segActualLoadAddress</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segActualEndAddress</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>image</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>æ€»ç»“ä¸º 4 æ­¥ï¼š</p><ul><li><code>ImageLoaderMachOCompressed::instantiateStart()</code>åˆ›å»º<code>ImageLoaderMachOCompressed</code>å¯¹è±¡</li><li><code>image->disableCoverageCheck()</code>ç¦ç”¨æ®µè¦†ç›–æ£€æµ‹</li><li><code>image->instantiateFinish()</code>å†…éƒ¨è°ƒç”¨é¡ºåºï¼š<ul><li>è°ƒç”¨<code>parseLoadCmds()</code>è§£æåŠ è½½å‘½ä»¤ï¼Œ</li><li>è°ƒç”¨<code>this->setDyldInfo()</code>è®¾ç½®åŠ¨æ€åº“é“¾æ¥ä¿¡æ¯ï¼Œ</li><li>è°ƒç”¨<code>this->setSymbolTableInfo()</code>è®¾ç½®ç¬¦å·è¡¨ç›¸å…³ä¿¡æ¯</li></ul></li><li><code>image->setMapped()</code>å‡½æ•°æ³¨å†Œé€šçŸ¥å›è°ƒã€è®¡ç®—æ‰§è¡Œæ—¶é—´ç­‰ç­‰</li></ul><p>åœ¨è°ƒç”¨å®Œ<code>ImageLoaderMachO::instantiateMainExecutable()</code>åç»§ç»­è°ƒç”¨<code>addImage()</code>ï¼Œå°†<code>image</code>åŠ å…¥åˆ°<code>sAllImages</code>å…¨å±€é•œåƒåˆ—è¡¨ï¼Œå¹¶å°†<code>image</code>æ˜ å°„åˆ°ç”³è¯·çš„å†…å­˜ä¸­</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>addImage</span><span class=p>(</span><span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span><span class=p>)</span>
<span class=p>{</span>
  <span class=c1>// add to master list
</span><span class=c1></span>    <span class=n>allImagesLock</span><span class=p>();</span>
        <span class=n>sAllImages</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>
    <span class=n>allImagesUnlock</span><span class=p>();</span>
  
  <span class=c1>// update mapped ranges
</span><span class=c1></span>  <span class=n>uintptr_t</span> <span class=n>lastSegStart</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>uintptr_t</span> <span class=n>lastSegEnd</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>for</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>e</span><span class=o>=</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>segmentCount</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>e</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segUnaccessible</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=p>)</span> 
      <span class=k>continue</span><span class=p>;</span>
    <span class=n>uintptr_t</span> <span class=n>start</span> <span class=o>=</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segActualLoadAddress</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=n>uintptr_t</span> <span class=n>end</span> <span class=o>=</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>segActualEndAddress</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>start</span> <span class=o>==</span> <span class=n>lastSegEnd</span> <span class=p>)</span> <span class=p>{</span>
      <span class=c1>// two segments are contiguous, just record combined segments
</span><span class=c1></span>      <span class=n>lastSegEnd</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
      <span class=c1>// non-contiguous segments, record last (if any)
</span><span class=c1></span>      <span class=k>if</span> <span class=p>(</span> <span class=n>lastSegEnd</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
        <span class=n>addMappedRange</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>lastSegStart</span><span class=p>,</span> <span class=n>lastSegEnd</span><span class=p>);</span>
      <span class=n>lastSegStart</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
      <span class=n>lastSegEnd</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
    <span class=p>}</span>   
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>lastSegEnd</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
    <span class=n>addMappedRange</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>lastSegStart</span><span class=p>,</span> <span class=n>lastSegEnd</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>gLinkContext</span><span class=p>.</span><span class=n>verboseLoading</span> <span class=o>||</span> <span class=p>(</span><span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_PRINT_LIBRARIES_POST_LAUNCH</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>sMainExecutable</span><span class=o>!=</span><span class=nb>NULL</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>sMainExecutable</span><span class=o>-&gt;</span><span class=n>isLinked</span><span class=p>())</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>dyld</span><span class=o>::</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;dyld: loaded: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>getPath</span><span class=p>());</span>
  <span class=p>}</span>
  
<span class=p>}</span>
</code></pre></div><p>åˆ°è¿™é‡Œï¼Œåˆå§‹åŒ–ä¸»ç¨‹åºå°±å®Œæˆäº†</p><h5 id=åŠ è½½æ’å…¥åŠ¨æ€åº“><a href=#åŠ è½½æ’å…¥åŠ¨æ€åº“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åŠ è½½æ’å…¥åŠ¨æ€åº“</h5><p>åŠ è½½ç¯å¢ƒå˜é‡<code>DYLD_INSERT_LIBRARIES</code>ä¸­é…ç½®çš„åŠ¨æ€åº“ï¼Œå…ˆåˆ¤æ–­<code>DYLD_INSERT_LIBRARIES</code>ä¸­æ˜¯å¦å­˜åœ¨è¦åŠ è½½çš„åŠ¨æ€åº“ï¼Œå¦‚æœå­˜åœ¨åˆ™è°ƒç”¨ <code>loadInsertedDylib()</code> å‡½æ•°ä¾æ¬¡åŠ è½½</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>if</span>  <span class=p>(</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_INSERT_LIBRARIES</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=k>const</span><span class=o>*</span> <span class=n>lib</span> <span class=o>=</span> <span class=n>sEnv</span><span class=p>.</span><span class=n>DYLD_INSERT_LIBRARIES</span><span class=p>;</span> <span class=o>*</span><span class=n>lib</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=o>++</span><span class=n>lib</span><span class=p>)</span>
    <span class=n>loadInsertedDylib</span><span class=p>(</span><span class=o>*</span><span class=n>lib</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p><code>loadInsertedDylib()</code>å†…éƒ¨è®¾ç½®äº†ä¸€ä¸ª <code>LoadContext</code> å‚æ•°ï¼Œè°ƒç”¨äº† <code>load()</code> å‡½æ•°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>ImageLoader</span><span class=o>*</span> <span class=nf>load</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>path</span><span class=p>,</span> <span class=k>const</span> <span class=n>LoadContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>,</span> <span class=kt>unsigned</span><span class=o>&amp;</span> <span class=n>cacheIndex</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>
    <span class=c1>// try all path permutations and check against existing loaded images
</span><span class=c1></span>    <span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>loadPhase0</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>orgPath</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>cacheIndex</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>image</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>CRSetCrashLogMessage2</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>image</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// try all path permutations and try open() until first success
</span><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=k>const</span> <span class=kt>char</span><span class=o>*&gt;</span> <span class=n>exceptions</span><span class=p>;</span>
    <span class=n>image</span> <span class=o>=</span> <span class=n>loadPhase0</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>orgPath</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>cacheIndex</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>exceptions</span><span class=p>);</span>
<span class=cp>#if !TARGET_IPHONE_SIMULATOR
</span><span class=cp></span>    <span class=c1>// &lt;rdar://problem/16704628&gt; support symlinks on disk to a path in dyld shared cache
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>image</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=n>image</span> <span class=o>=</span> <span class=n>loadPhase2cache</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>orgPath</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>cacheIndex</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>exceptions</span><span class=p>);</span>
<span class=cp>#endif
</span><span class=cp></span>    <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p><code>load()</code> å‡½æ•°å®ç°ä¸ºä¸€ç³»åˆ—çš„<code>loadPhase*()</code>å‡½æ•°ï¼Œ<code>loadPhase0()</code>~<code>loadPhase1()</code>å‡½æ•°ä¼šæŒ‰ç…§ä¸‹å›¾é¡ºåºæœç´¢åŠ¨æ€åº“ï¼Œå¹¶è°ƒç”¨ä¸åŒå‡½æ•°æ¥ç»§ç»­å¤„ç†</p><p><img src=https://w-md.imzsy.design/image-20201008181008709.png alt=image-20201008181008709></p><p>å½“å†…éƒ¨è°ƒç”¨åˆ°<code>loadPhase5load()</code>å‡½æ•°çš„æ—¶å€™ï¼Œä¼šå…ˆåœ¨å…±äº«ç¼“å­˜ä¸­æœå¯»</p><ul><li>å­˜åœ¨åˆ™ä½¿ç”¨<code>ImageLoaderMachO::instantiateFromCache()</code>æ¥å®ä¾‹åŒ–<code>ImageLoader</code></li><li>ä¸å­˜åœ¨åˆ™é€šè¿‡<code>loadPhase5open()</code>æ‰“å¼€æ–‡ä»¶å¹¶è¯»å–æ•°æ®åˆ°å†…å­˜åï¼Œå†è°ƒç”¨<code>loadPhase6()</code>ï¼Œé€šè¿‡<code>ImageLoaderMachO::instantiateFromFile()</code>å®ä¾‹åŒ–<code>ImageLoader</code>ï¼Œæœ€åè°ƒç”¨<code>checkandAddImage()</code>éªŒè¯é•œåƒå¹¶å°†å…¶åŠ å…¥åˆ°å…¨å±€é•œåƒåˆ—è¡¨ä¸­</li></ul><h5 id=é“¾æ¥ä¸»ç¨‹åº><a href=#é“¾æ¥ä¸»ç¨‹åº class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é“¾æ¥ä¸»ç¨‹åº</h5><p>è°ƒç”¨ <code>link()</code>å‡½æ•°å°†å®ä¾‹åŒ–åçš„ä¸»ç¨‹åºè¿›è¡ŒåŠ¨æ€ä¿®æ­£ï¼Œè®©äºŒè¿›åˆ¶å˜ä¸ºå¯æ­£å¸¸æ‰§è¡Œçš„çŠ¶æ€</p><p><code>link()</code>å‡½æ•°å†…éƒ¨è°ƒç”¨äº†<code>ImageLoader::link()</code>å‡½æ•°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=n>ImageLoader</span><span class=o>::</span><span class=n>link</span><span class=p>(</span><span class=k>const</span> <span class=n>LinkContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>forceLazysBound</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>preflightOnly</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>neverUnload</span><span class=p>,</span> <span class=k>const</span> <span class=n>RPathChain</span><span class=o>&amp;</span> <span class=n>loaderRPaths</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>imagePath</span><span class=p>)</span>
<span class=p>{</span>
  <span class=p>...</span>
  <span class=kt>uint64_t</span> <span class=n>t0</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
  <span class=c1>// é€’å½’åŠ è½½åŠ è½½ä¸»ç¨‹åºæ‰€éœ€ä¾èµ–åº“
</span><span class=c1></span>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>recursiveLoadLibraries</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>preflightOnly</span><span class=p>,</span> <span class=n>loaderRPaths</span><span class=p>,</span> <span class=n>imagePath</span><span class=p>);</span>
  <span class=p>...</span>
  <span class=kt>uint64_t</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
  <span class=n>context</span><span class=p>.</span><span class=n>clearAllDepths</span><span class=p>();</span>
  <span class=c1>// é€’å½’åˆ·æ–°ä¾èµ–åº“çš„å±‚çº§
</span><span class=c1></span>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>recursiveUpdateDepth</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>imageCount</span><span class=p>());</span>
  <span class=kt>uint64_t</span> <span class=n>t2</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
  <span class=c1>// é€’å½’è¿›è¡Œrebase
</span><span class=c1></span>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>recursiveRebase</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=kt>uint64_t</span> <span class=n>t3</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
  <span class=c1>// é€’å½’ç»‘å®šç¬¦å·è¡¨
</span><span class=c1></span>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>recursiveBind</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>forceLazysBound</span><span class=p>,</span> <span class=n>neverUnload</span><span class=p>);</span>
  <span class=kt>uint64_t</span> <span class=n>t4</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>context</span><span class=p>.</span><span class=n>linkingMainExecutable</span> <span class=p>)</span>
      <span class=c1>// å¼±ç¬¦å·ç»‘å®š
</span><span class=c1></span>      <span class=k>this</span><span class=o>-&gt;</span><span class=n>weakBind</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=kt>uint64_t</span> <span class=n>t5</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span> 
  <span class=n>context</span><span class=p>.</span><span class=n>notifyBatch</span><span class=p>(</span><span class=n>dyld_image_state_bound</span><span class=p>,</span> <span class=nb>false</span><span class=p>);</span>
  <span class=kt>uint64_t</span> <span class=n>t6</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span> 
  <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>DOFInfo</span><span class=o>&gt;</span> <span class=n>dofs</span><span class=p>;</span>
  <span class=c1>// æ³¨å†ŒDOFèŠ‚
</span><span class=c1></span>  <span class=k>this</span><span class=o>-&gt;</span><span class=n>recursiveGetDOFSections</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>dofs</span><span class=p>);</span>
  <span class=n>context</span><span class=p>.</span><span class=n>registerDOFs</span><span class=p>(</span><span class=n>dofs</span><span class=p>);</span>
  <span class=kt>uint64_t</span> <span class=n>t7</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span> 
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p>ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä¸ªäº‹æƒ…ï¼š</p><ul><li><code>recursiveLoadLibraries()</code> æ ¹æ®<code>LC_LOAD_DYLIB</code>åŠ è½½å‘½ä»¤æŠŠæ‰€æœ‰ä¾èµ–åº“åŠ è½½è¿›å†…å­˜</li><li><code>recursiveUpdateDepth()</code> é€’å½’åˆ·æ–°ä¾èµ–åº“çš„å±‚çº§</li><li><code>recursiveRebase()</code> ç”±äº<code>ASLR</code>çš„å­˜åœ¨ï¼Œå¿…é¡»é€’å½’å¯¹ä¸»ç¨‹åºä»¥åŠä¾èµ–åº“è¿›è¡Œé‡å®šä½æ“ä½œ</li><li><code>recursiveBind()</code> æŠŠä¸»ç¨‹åºäºŒè¿›åˆ¶å’Œä¾èµ–è¿›æ¥çš„åŠ¨æ€åº“å…¨éƒ¨æ‰§è¡Œç¬¦å·è¡¨ç»‘å®š</li><li><code>weakBind()</code> å¦‚æœé“¾æ¥çš„ä¸æ˜¯ä¸»ç¨‹åºäºŒè¿›åˆ¶çš„è¯ï¼Œä¼šåœ¨æ­¤æ—¶æ‰§è¡Œå¼±ç¬¦å·ç»‘å®šï¼Œä¸»ç¨‹åºäºŒè¿›åˆ¶åˆ™åœ¨<code>link()</code>å®Œåå†æ‰§è¡Œå¼±ç¬¦å·ç»‘å®šï¼Œåé¢ä¼šè¿›è¡Œåˆ†æ</li><li><code>recursiveGetDOFSections()</code>ã€<code>context.registerDOFs()</code> æ³¨å†Œ<code>DOF</code>ï¼ˆDTrace Object Formatï¼‰èŠ‚</li></ul><h5 id=é“¾æ¥æ’å…¥çš„åŠ¨æ€åº“><a href=#é“¾æ¥æ’å…¥çš„åŠ¨æ€åº“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é“¾æ¥æ’å…¥çš„åŠ¨æ€åº“</h5><p>è¿™ä¸€æ­¥å’Œé“¾æ¥ä¸»ç¨‹åºä¸€æ ·ï¼Œå°†å‰é¢è°ƒç”¨<code>addImage()</code>å‡½æ•°ä¿å­˜åœ¨ <code>sAllImages</code> ä¸­çš„åŠ¨æ€åº“åˆ—è¡¨å¾ªç¯å–å‡ºå¹¶è°ƒç”¨<code>link()</code>è¿›è¡Œé“¾æ¥</p><blockquote><p><code>sAllImages</code>ä¸­ä¿å­˜çš„ç¬¬ä¸€é¡¹æ˜¯ä¸»ç¨‹åºçš„é•œåƒï¼Œæ‰€ä»¥è¦ä»<code>i+1</code>çš„ä½ç½®å¼€å§‹ï¼Œå–åˆ°çš„æ‰æ˜¯åŠ¨æ€åº“çš„<code>ImageLoader</code></p></blockquote><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=n>sAllImages</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</code></pre></div><p>å¾ªç¯è°ƒç”¨æ¯ä¸ªé•œåƒçš„<code>registerInterposing()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šéå†Mach-Oçš„<code>LC_SEGMENT_COMMAND</code>åŠ è½½å‘½ä»¤ï¼Œè¯»å–<code>__DATA</code>,<code>__interpose</code>ï¼Œå¹¶å°†è¯»å–åˆ°çš„ä¿¡æ¯ä¿å­˜åˆ°<code>fgInterposingTuples</code>ä¸­ï¼Œæ¥ç€è°ƒç”¨<code>applyInterposing()</code>å‡½æ•°ï¼Œå†…éƒ¨ç»ç”±<code>doInterpose()</code>è™šå‡½æ•°è¿›è¡Œæ›¿æ¢æ“ä½œ</p><p>è¿™é‡Œä»¥ <code>ImageLoaderMachOCompressed::doInterpose()</code> å‡½æ•°ä¸ºä¾‹ï¼š</p><p>å†…éƒ¨åˆ†åˆ«è°ƒç”¨<code>eachBind()</code> å’Œ <code>eachLazyBind()</code>ï¼Œå…·ä½“å¤„ç†å‡½æ•°æ˜¯<code>interposeAt()</code>ï¼Œè¯¥å‡½æ•°è°ƒç”¨<code>interposedAddress()</code>åœ¨<code>fgInterposingTuples</code>ä¸­æŸ¥æ‰¾éœ€è¦æ›¿æ¢çš„ç¬¦å·åœ°å€ï¼Œè¿›è¡Œæœ€ç»ˆçš„ç¬¦å·åœ°å€æ›¿æ¢</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>doInterpose</span><span class=p>(</span><span class=k>const</span> <span class=n>LinkContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// update prebound symbols
</span><span class=c1></span>    <span class=n>eachBind</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>interposeAt</span><span class=p>);</span>
    <span class=n>eachLazyBind</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>interposeAt</span><span class=p>);</span>
<span class=p>}</span>
<span class=n>uintptr_t</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>interposeAt</span><span class=p>(</span><span class=k>const</span> <span class=n>LinkContext</span><span class=o>&amp;</span> <span class=n>context</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>type</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span><span class=p>,</span> 
                                                <span class=kt>uint8_t</span><span class=p>,</span> <span class=n>intptr_t</span><span class=p>,</span> <span class=kt>long</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span><span class=p>,</span> <span class=n>LastLookup</span><span class=o>*</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>runResolver</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>type</span> <span class=o>==</span> <span class=n>BIND_TYPE_POINTER</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>uintptr_t</span><span class=o>*</span> <span class=n>fixupLocation</span> <span class=o>=</span> <span class=p>(</span><span class=n>uintptr_t</span><span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
        <span class=n>uintptr_t</span> <span class=n>curValue</span> <span class=o>=</span> <span class=o>*</span><span class=n>fixupLocation</span><span class=p>;</span>
        <span class=n>uintptr_t</span> <span class=n>newValue</span> <span class=o>=</span> <span class=n>interposedAddress</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>curValue</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>newValue</span> <span class=o>!=</span> <span class=n>curValue</span><span class=p>)</span> <span class=p>{</span>
            <span class=o>*</span><span class=n>fixupLocation</span> <span class=o>=</span> <span class=n>newValue</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h5 id=æ‰§è¡Œå¼±ç¬¦å·ç»‘å®š><a href=#æ‰§è¡Œå¼±ç¬¦å·ç»‘å®š class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ‰§è¡Œå¼±ç¬¦å·ç»‘å®š</h5><p><code>weakBind()</code>é¦–å…ˆé€šè¿‡<code>getCoalescedImages()</code>åˆå¹¶æ‰€æœ‰åŠ¨æ€åº“çš„å¼±ç¬¦å·åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œç„¶åè°ƒç”¨<code>initializeCoalIterator()</code>å¯¹éœ€è¦ç»‘å®šçš„å¼±ç¬¦å·è¿›è¡Œæ’åºï¼Œæ¥ç€è°ƒç”¨<code>incrementCoalIterator()</code>è¯»å–<code>dyld_info_command</code>ç»“æ„çš„<code>weak_bind_off</code>å’Œ<code>weak_bind_size</code>å­—æ®µï¼Œç¡®å®šå¼±ç¬¦å·çš„æ•°æ®åç§»ä¸å¤§å°ï¼Œæœ€ç»ˆè¿›è¡Œå¼±ç¬¦å·ç»‘å®šï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>bool</span> <span class=n>ImageLoaderMachOCompressed</span><span class=o>::</span><span class=n>incrementCoalIterator</span><span class=p>(</span><span class=n>CoalIterator</span><span class=o>&amp;</span> <span class=n>it</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span> <span class=n>it</span><span class=p>.</span><span class=n>done</span> <span class=p>)</span>
        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
    
    <span class=k>if</span> <span class=p>(</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>fDyldInfo</span><span class=o>-&gt;</span><span class=n>weak_bind_size</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
        <span class=c1>/// hmmm, ld set MH_WEAK_DEFINES or MH_BINDS_TO_WEAK, but there is no weak binding info
</span><span class=c1></span>        <span class=n>it</span><span class=p>.</span><span class=n>done</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
        <span class=n>it</span><span class=p>.</span><span class=n>symbolName</span> <span class=o>=</span> <span class=s>&#34;~~~&#34;</span><span class=p>;</span>
        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>start</span> <span class=o>=</span> <span class=n>fLinkEditBase</span> <span class=o>+</span> <span class=n>fDyldInfo</span><span class=o>-&gt;</span><span class=n>weak_bind_off</span><span class=p>;</span>
    <span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>p</span> <span class=o>=</span> <span class=n>start</span> <span class=o>+</span> <span class=n>it</span><span class=p>.</span><span class=n>curIndex</span><span class=p>;</span>
    <span class=k>const</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>end</span> <span class=o>=</span> <span class=n>fLinkEditBase</span> <span class=o>+</span> <span class=n>fDyldInfo</span><span class=o>-&gt;</span><span class=n>weak_bind_off</span> <span class=o>+</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>fDyldInfo</span><span class=o>-&gt;</span><span class=n>weak_bind_size</span><span class=p>;</span>
    <span class=n>uintptr_t</span> <span class=n>count</span><span class=p>;</span>
    <span class=n>uintptr_t</span> <span class=n>skip</span><span class=p>;</span>
    <span class=n>uintptr_t</span> <span class=n>segOffset</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>(</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>end</span> <span class=p>)</span> <span class=p>{</span>
        <span class=kt>uint8_t</span> <span class=n>immediate</span> <span class=o>=</span> <span class=o>*</span><span class=n>p</span> <span class=o>&amp;</span> <span class=n>BIND_IMMEDIATE_MASK</span><span class=p>;</span>
        <span class=kt>uint8_t</span> <span class=n>opcode</span> <span class=o>=</span> <span class=o>*</span><span class=n>p</span> <span class=o>&amp;</span> <span class=n>BIND_OPCODE_MASK</span><span class=p>;</span>
        <span class=o>++</span><span class=n>p</span><span class=p>;</span>
        <span class=k>switch</span> <span class=p>(</span><span class=n>opcode</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>case</span> <span class=nl>BIND_OPCODE_DONE</span><span class=p>:</span>
                <span class=n>it</span><span class=p>.</span><span class=n>done</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
                <span class=n>it</span><span class=p>.</span><span class=n>curIndex</span> <span class=o>=</span> <span class=n>p</span> <span class=o>-</span> <span class=n>start</span><span class=p>;</span>
                <span class=n>it</span><span class=p>.</span><span class=n>symbolName</span> <span class=o>=</span> <span class=s>&#34;~~~&#34;</span><span class=p>;</span> <span class=c1>// sorts to end
</span><span class=c1></span>                <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>break</span><span class=p>;</span>
        <span class=p>...</span>
    <span class=p>}</span>
    <span class=p>...</span>
    <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h5 id=æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•><a href=#æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</h5><p>è¿™ä¸€æ­¥ç”±<code>initializeMainExecutable()</code>å®Œæˆï¼Œ<code>dyld</code>ä¼šä¼˜å…ˆåˆå§‹åŒ–åŠ¨æ€åº“ï¼Œç„¶ååˆå§‹åŒ–ä¸»ç¨‹åº</p><p>è¯¥å‡½æ•°é¦–å…ˆæ‰§è¡Œ<code>runInitializers()</code>ï¼Œå†…éƒ¨å†ä¾æ¬¡è°ƒç”¨<code>processInitializers()</code>ã€<code>recursiveInitialization()</code></p><p>åœ¨<code>recursiveInitialization()</code>å‡½æ•°é‡Œæ‰¾åˆ°äº†<code>notifySingle()</code>å‡½æ•°ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>context</span><span class=p>.</span><span class=n>notifySingle</span><span class=p>(</span><span class=n>dyld_image_state_dependents_initialized</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>timingInfo</span><span class=p>);</span>
</code></pre></div><p>æ¥ç€è·Ÿè¿›<code>notifySingle</code>å‡½æ•°ï¼Œçœ‹åˆ°ä¸‹é¢å¤„ç†ä»£ç ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>state</span> <span class=o>==</span> <span class=n>dyld_image_state_dependents_initialized</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>sNotifyObjCInit</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>notifyObjC</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
    <span class=kt>uint64_t</span> <span class=n>t0</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
    <span class=p>(</span><span class=o>*</span><span class=n>sNotifyObjCInit</span><span class=p>)(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>getRealPath</span><span class=p>(),</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>machHeader</span><span class=p>());</span>
    <span class=kt>uint64_t</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
    <span class=kt>uint64_t</span> <span class=n>t2</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
    <span class=kt>uint64_t</span> <span class=n>timeInObjC</span> <span class=o>=</span> <span class=n>t1</span><span class=o>-</span><span class=n>t0</span><span class=p>;</span>
    <span class=kt>uint64_t</span> <span class=n>emptyTime</span> <span class=o>=</span> <span class=p>(</span><span class=n>t2</span><span class=o>-</span><span class=n>t1</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>timeInObjC</span> <span class=o>&gt;</span> <span class=n>emptyTime</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>timingInfo</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
        <span class=n>timingInfo</span><span class=o>-&gt;</span><span class=n>addTime</span><span class=p>(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>getShortName</span><span class=p>(),</span> <span class=n>timeInObjC</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>å…³å¿ƒçš„åªæœ‰<code>sNotifyObjCInit</code>è¿™ä¸ªå›è°ƒï¼Œç»§ç»­å¯»æ‰¾èµ‹å€¼çš„åœ°æ–¹ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>registerObjCNotifiers</span><span class=p>(</span><span class=n>_dyld_objc_notify_mapped</span> <span class=n>mapped</span><span class=p>,</span> <span class=n>_dyld_objc_notify_init</span> <span class=n>init</span><span class=p>,</span> <span class=n>_dyld_objc_notify_unmapped</span> <span class=n>unmapped</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// record functions to call
</span><span class=c1></span>    <span class=n>sNotifyObjCMapped</span>   <span class=o>=</span> <span class=n>mapped</span><span class=p>;</span>
    <span class=n>sNotifyObjCInit</span>     <span class=o>=</span> <span class=n>init</span><span class=p>;</span>
    <span class=n>sNotifyObjCUnmapped</span> <span class=o>=</span> <span class=n>unmapped</span><span class=p>;</span>
    <span class=p>...</span>
</code></pre></div><p>æ¥ç€æ‰¾<code>registerObjCNotifiers</code>å‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆæ‰¾åˆ°è¿™é‡Œï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>_dyld_objc_notify_register</span><span class=p>(</span><span class=n>_dyld_objc_notify_mapped</span>    <span class=n>mapped</span><span class=p>,</span>
                                <span class=n>_dyld_objc_notify_init</span>      <span class=n>init</span><span class=p>,</span>
                                <span class=n>_dyld_objc_notify_unmapped</span>  <span class=n>unmapped</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>dyld</span><span class=o>::</span><span class=n>registerObjCNotifiers</span><span class=p>(</span><span class=n>mapped</span><span class=p>,</span> <span class=n>init</span><span class=p>,</span> <span class=n>unmapped</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>é‚£ä¹ˆç©¶ç«Ÿæ˜¯è°è°ƒç”¨äº†<code>_dyld_objc_notify_register()</code></p><p>é™æ€åˆ†æå·²ç»æ— æ³•å¾—çŸ¥ï¼Œåªèƒ½å¯¹<code>_dyld_objc_notify_register</code>ä¸‹ä¸ªç¬¦å·æ–­ç‚¹ï¼Œæ‰“å°å †æ ˆæ¥æ¢ç´¢ä¸€ä¸‹äº†</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=o>*</span> <span class=n>thread</span> <span class=c1>#1, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.2</span>
  <span class=o>*</span> <span class=n>frame</span> <span class=c1>#0: 0x00007fff2025bda1 libdyld.dylib`_dyld_objc_notify_register</span>
    <span class=n>frame</span> <span class=c1>#1: 0x00007fff2018dbdb libobjc.A.dylib`_objc_init + 1092</span>
    <span class=n>frame</span> <span class=c1>#2: 0x000000010bed1110 libdispatch.dylib`_os_object_init + 13</span>
    <span class=n>frame</span> <span class=c1>#3: 0x000000010bee047d libdispatch.dylib`libdispatch_init + 303</span>
    <span class=n>frame</span> <span class=c1>#4: 0x00007fff531d286f libSystem.B.dylib`libSystem_initializer + 252</span>
    <span class=n>frame</span> <span class=c1>#5: 0x000000010bc8794b dyld_sim`ImageLoaderMachO::doModInitFunctions(ImageLoader::LinkContext const&amp;) + 537</span>
    <span class=n>frame</span> <span class=c1>#6: 0x000000010bc87d34 dyld_sim`ImageLoaderMachO::doInitialization(ImageLoader::LinkContext const&amp;) + 40</span>
    <span class=n>frame</span> <span class=c1>#7: 0x000000010bc82899 dyld_sim`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&amp;, unsigned int, char const*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + 455</span>
    <span class=n>frame</span> <span class=c1>#8: 0x000000010bc82806 dyld_sim`ImageLoader::recursiveInitialization(ImageLoader::LinkContext const&amp;, unsigned int, char const*, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + 308</span>
    <span class=n>frame</span> <span class=c1>#9: 0x000000010bc80bb0 dyld_sim`ImageLoader::processInitializers(ImageLoader::LinkContext const&amp;, unsigned int, ImageLoader::InitializerTimingList&amp;, ImageLoader::UninitedUpwards&amp;) + 188</span>
    <span class=n>frame</span> <span class=c1>#10: 0x000000010bc80c50 dyld_sim`ImageLoader::runInitializers(ImageLoader::LinkContext const&amp;, ImageLoader::InitializerTimingList&amp;) + 82</span>
    <span class=n>frame</span> <span class=c1>#11: 0x000000010bc74263 dyld_sim`dyld::initializeMainExecutable() + 129</span>
    <span class=n>frame</span> <span class=c1>#12: 0x000000010bc78d50 dyld_sim`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 4431</span>
    <span class=n>frame</span> <span class=c1>#13: 0x000000010bc731c7 dyld_sim`start_sim + 122</span>
    <span class=n>frame</span> <span class=c1>#14: 0x0000000110dac85c dyld`dyld::useSimulatorDyld(int, macho_header const*, char const*, int, char const**, char const**, char const**, unsigned long*, unsigned long*) + 2308</span>
    <span class=n>frame</span> <span class=c1>#15: 0x0000000110daa4f4 dyld`dyld::_main(macho_header const*, unsigned long, int, char const**, char const**, char const**, unsigned long*) + 837</span>
    <span class=n>frame</span> <span class=c1>#16: 0x0000000110da5227 dyld`dyldbootstrap::start(dyld3::MachOLoaded const*, int, char const**, dyld3::MachOLoaded const*, unsigned long*) + 453</span>
    <span class=n>frame</span> <span class=c1>#17: 0x0000000110da5025 dyld`_dyld_start + 37</span>
</code></pre></div><p>ä»è°ƒç”¨æ ˆçœ‹åˆ°æ˜¯<code>libobjc.A.dylib</code>çš„<code>_objc_init</code>å‡½æ•°è°ƒç”¨äº†<code>_dyld_objc_notify_register()</code></p><p>ä» objcæºç ä¸­ï¼Œæ‰¾åˆ°<code>_objc_init</code>å‡½æ•°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>_objc_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>static</span> <span class=kt>bool</span> <span class=n>initialized</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>initialized</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
    <span class=n>initialized</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
    
    <span class=c1>// fixme defer initialization until an objc-using image is found?
</span><span class=c1></span>    <span class=n>environ_init</span><span class=p>();</span>
    <span class=n>tls_init</span><span class=p>();</span>
    <span class=n>static_init</span><span class=p>();</span>
    <span class=n>runtime_init</span><span class=p>();</span>
    <span class=n>exception_init</span><span class=p>();</span>
    <span class=n>cache_init</span><span class=p>();</span>
    <span class=n>_imp_implementationWithBlock_init</span><span class=p>();</span>

    <span class=n>_dyld_objc_notify_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>map_images</span><span class=p>,</span> <span class=n>load_images</span><span class=p>,</span> <span class=n>unmap_image</span><span class=p>);</span>

<span class=cp>#if __OBJC2__
</span><span class=cp></span>    <span class=n>didCallDyldNotifyRegister</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span><span class=p>}</span>
</code></pre></div><p>è¿™é‡Œæ³¨å†Œçš„ init å›è°ƒå‡½æ•°å°±æ˜¯ <code>load_images()</code>ï¼Œå›è°ƒå‡½æ•°<code>load_images()</code>é‡Œé¢ä¼šè°ƒç”¨<code>call_load_methods()</code>æ¥æ‰§è¡Œæ‰€æœ‰çš„<code>+load()</code>æ–¹æ³•ï¼Œè¿™ä¹Ÿå°±éªŒè¯äº†ï¼Œä¸ºä»€ä¹ˆä¸€å¼€å§‹<code>+load()</code>å‡½æ•°ä¼šæ¯” <code>main()</code> å‡½æ•°å…ˆæ‰§è¡Œ</p><p>ä»æ–‡ç« ä¸€å¼€å§‹çš„å †æ ˆä¸­å¯ä»¥çœ‹åˆ°<code>notifySingle()</code>ä¹‹åè°ƒç”¨<code>doInitialization()</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// initialize this image
</span><span class=c1>// è°ƒç”¨constructor()
</span><span class=c1></span><span class=kt>bool</span> <span class=n>hasInitializers</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>doInitialization</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</code></pre></div><p><code>doInitialization()</code>å†…éƒ¨è°ƒç”¨é¡ºåº</p><ul><li><code>doImageInit</code>æ¥æ‰§è¡Œé•œåƒçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>LC_ROUTINES_COMMAND</code>ä¸­è®°å½•çš„å‡½æ•°ï¼Œ</li><li><code>doModInitFunctions()</code>æ–¹æ³•æ¥è§£æå¹¶æ‰§è¡Œ<code>_DATA_</code>,<code>__mod_init_func</code>è¿™ä¸ª<code>section</code>ä¸­ä¿å­˜çš„å‡½æ•°</li></ul><p><code>_mod_init_funcs</code>ä¸­ä¿å­˜çš„æ˜¯å…¨å±€<code>C++</code>å¯¹è±¡çš„æ„é€ å‡½æ•°ä»¥åŠæ‰€æœ‰å¸¦<code>__attribute__</code>((constructor)çš„Cå‡½æ•°</p><p>æˆ‘ä»¬åœ¨ <code>main()</code> å‡½æ•°ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç </p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=cp>#import &#34;AppDelegate.h&#34;
</span><span class=cp></span>
<span class=n>__attribute__</span><span class=p>((</span><span class=n>constructor</span><span class=p>))</span>  <span class=kt>void</span> <span class=n>init_func1</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTION__</span><span class=p>);</span>
<span class=p>}</span>


<span class=n>__attribute__</span><span class=p>((</span><span class=n>constructor</span><span class=p>))</span>  <span class=kt>void</span> <span class=n>init_func2</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__FUNCTION__</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=n>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
    <span class=n>NSString</span> <span class=o>*</span> <span class=n>appDelegateClassName</span><span class=p>;</span>
    <span class=k>@autoreleasepool</span> <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;main&#34;</span><span class=p>);</span>
        <span class=c1>// Setup code that might create autoreleased objects goes here.
</span><span class=c1></span>        <span class=n>appDelegateClassName</span> <span class=o>=</span> <span class=n>NSStringFromClass</span><span class=p>([</span><span class=n>AppDelegate</span> <span class=k>class</span><span class=p>]);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>UIApplicationMain</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=nb>nil</span><span class=p>,</span> <span class=n>appDelegateClassName</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>è¾“å‡ºï¼š</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=mi>2020</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>25</span> <span class=mi>19</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>41</span><span class=o>.</span><span class=mi>850546</span><span class=o>+</span><span class=mi>0800</span> <span class=no>DyldTest</span><span class=o>[</span><span class=mi>14523</span><span class=p>:</span><span class=mi>25898716</span><span class=o>]</span> <span class=nb>load</span>
<span class=n>init_func1</span>
<span class=n>init_func2</span>
<span class=mi>2020</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>25</span> <span class=mi>19</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>41</span><span class=o>.</span><span class=mi>851222</span><span class=o>+</span><span class=mi>0800</span> <span class=no>DyldTest</span><span class=o>[</span><span class=mi>14523</span><span class=p>:</span><span class=mi>25898716</span><span class=o>]</span> <span class=n>main</span>
</code></pre></div><h5 id=æŸ¥æ‰¾ç¨‹åºå…¥å£ç‚¹å¹¶è¿”å›><a href=#æŸ¥æ‰¾ç¨‹åºå…¥å£ç‚¹å¹¶è¿”å› class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æŸ¥æ‰¾ç¨‹åºå…¥å£ç‚¹å¹¶è¿”å›</h5><p>è¿™ä¸€æ­¥è°ƒç”¨ä¸»ç¨‹åºé•œåƒçš„<code>getThreadPC()</code>ï¼Œä»åŠ è½½å‘½ä»¤è¯»å–<code>LC_MAIN</code>å…¥å£ï¼Œå¦‚æœæ²¡æœ‰<code>LC_MAIN</code>å°±è°ƒç”¨<code>getMain()</code>è¯»å–<code>LC_UNIXTHREAD</code>ï¼Œæ‰¾åˆ°åå°±è·³åˆ°å…¥å£ç‚¹æŒ‡å®šçš„åœ°å€å¹¶è¿”å›</p><p>è‡³æ­¤ï¼Œæ•´ä¸ª dyld çš„åŠ è½½è¿‡ç¨‹å°±åˆ†æå®Œäº†</p><h3 id=dyld-åŠ è½½æµç¨‹å›¾><a href=#dyld-åŠ è½½æµç¨‹å›¾ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyld åŠ è½½æµç¨‹å›¾</h3><p><img src=https://w-md.imzsy.design/dyld%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png alt=dyldåŠ è½½è¿‡ç¨‹></p><h3 id=å‚è€ƒèµ„æ–™><a href=#å‚è€ƒèµ„æ–™ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å‚è€ƒèµ„æ–™</h3><blockquote><p><a href=https://leylfl.github.io/2018/05/28/dyld%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/ target=_blank rel=noopener>dyldå¯åŠ¨æµç¨‹</a></p><p><a href=http://www.zoomfeng.com/blog/launch-optimize-from-wwdc2019.html target=_blank rel=noopener>WWDC2019ä¹‹å¯åŠ¨æ—¶é—´ä¸Dyld3</a></p><p><a href=https://developer.apple.com/videos/play/wwdc2017/413/ target=_blank rel=noopener>App Startup Time: Past, Present, and Future</a></p><p><a href=https://www.dllhook.com/post/238.html target=_blank rel=noopener>dyldè¯¦è§£</a></p></blockquote></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>