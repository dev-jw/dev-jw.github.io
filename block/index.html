<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-Blockåˆ†æ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="Blockåœ¨æ—¥å¸¸å¼€å‘ä¸­çš„ä½¿ç”¨ï¼Œç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘è€…éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆå…³äºblockâ€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/block/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-11-09T20:12:50+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/block/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-Blockåˆ†æ","description":"Blockåœ¨æ—¥å¸¸å¼€å‘ä¸­çš„ä½¿ç”¨ï¼Œç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘è€…éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆå…³äºblockâ€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-Blockåˆ†æ"><meta property="og:description" content="Blockåœ¨æ—¥å¸¸å¼€å‘ä¸­çš„ä½¿ç”¨ï¼Œç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘è€…éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆå…³äºblockâ€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/block/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-Blockåˆ†æ</h1><div class=post-meta><time datetime=2020-11-09T20:12:50+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-11-09</time></div><div class="post-body e-content"><p><code>Block</code>åœ¨æ—¥å¸¸å¼€å‘ä¸­çš„ä½¿ç”¨ï¼Œç›¸ä¿¡æ¯ä¸€ä½iOSå¼€å‘è€…éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆå…³äº<code>block</code>çš„ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼Œæ˜¯å¦å·²ç»æŒæ¡ï¼Œèƒ½å¤Ÿå¿«é€Ÿç»™å‡ºç­”æ¡ˆå‘¢</p><ul><li><code>Block</code>çš„åˆ†ç±»æœ‰å“ªäº›ï¼Ÿ</li><li>å¾ªç¯å¼•ç”¨çš„äº§ç”Ÿä¸è§£å†³ï¼Ÿ</li><li><code>Block</code>æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</li><li><code>Block</code>æ˜¯æ€ä¹ˆæ•è·å¤–ç•Œå˜é‡çš„ï¼Ÿ</li><li><code>__block</code>çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><h3 id=blockå®šä¹‰ä¸åˆ†ç±»><a href=#blockå®šä¹‰ä¸åˆ†ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>blockå®šä¹‰ä¸åˆ†ç±»</h3><p><strong>å®šä¹‰</strong></p><p>å¸¦æœ‰è‡ªåŠ¨å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰çš„åŒ¿åå‡½æ•°å«åš<code>Block</code>ï¼Œåˆå«åš<code>åŒ¿åå‡½æ•°</code>ã€<code>ä»£ç å—</code></p><p>ä¸åŒè¯­è¨€ä¸­çš„å«æ³•ï¼š</p><div class=table-container><table><thead><tr><th>ç¨‹åºè¯­è¨€</th><th>Blockçš„åç§°</th></tr></thead><tbody><tr><td>C</td><td>Blcok</td></tr><tr><td>Ruby</td><td>Blcok</td></tr><tr><td>JS</td><td>Anonymous function</td></tr><tr><td>Java</td><td>Lambda</td></tr><tr><td>Python</td><td>Lambda</td></tr></tbody></table></div><p><strong>åˆ†ç±»</strong></p><p>æ ¹æ®<code>Block</code>å­˜å‚¨çš„å†…å­˜åŒºåŸŸä¸åŒï¼Œåˆ†ä¸ºï¼šå…¨å±€<code>Block</code>ã€æ ˆ<code>Block</code>ã€å †<code>Block</code>ä¸‰ç§å½¢å¼</p><ul><li><p>å…¨å±€ Blockï¼š<code>__NSGlobalBlock__</code>ï¼Œå­˜å‚¨åœ¨<strong>å·²åˆå§‹åŒ–æ•°æ®(.data)åŒº</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;block&#34;</span><span class=p>);</span>
<span class=p>};</span>
<span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;block:%@&#34;</span><span class=p>,</span> <span class=n>block</span><span class=p>);</span>
  
<span class=o>--------------------</span><span class=err>è¾“å‡ºç»“æœï¼š</span><span class=o>-------------------</span>
<span class=nl>block</span><span class=p>:</span> <span class=o>&lt;</span><span class=nl>__NSGlobalBlock__</span><span class=p>:</span> <span class=mh>0x10b39f088</span><span class=o>&gt;</span>
</code></pre></div></li><li><p>æ ˆ Blockï¼š<code>__NSMallocBlock__</code>ï¼Œå­˜å‚¨åœ¨<strong>æ ˆ(stack)åŒº</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=c1>//    int a = 0;
</span><span class=c1>//    NSLog(@&#34;%@&#34;, ^{
</span><span class=c1>//        NSLog(@&#34;%d&#34;, a);
</span><span class=c1>//    });
</span><span class=c1>// iOS14ä¹‹å‰ï¼Œè¾“å‡ºçš„æ˜¯æ ˆ Block
</span><span class=c1>// ç»è¿‡ iOS14 ä¼˜åŒ–ï¼Œè¿™ä¸€å—å·²ç»å˜ä¸ºå † block
</span><span class=c1></span>  
<span class=c1>// iOS14ä¹‹åï¼Œæ ˆ block
</span><span class=c1></span><span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=k>__weak</span> <span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%d&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>);</span>
<span class=p>};</span>
<span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;block: %@&#34;</span><span class=p>,</span> <span class=n>block</span><span class=p>);</span>
  
<span class=o>--------------------</span><span class=err>è¾“å‡ºç»“æœï¼š</span><span class=o>-------------------</span>
<span class=nl>block</span><span class=p>:</span> <span class=o>&lt;</span><span class=nl>__NSStackBlock__</span><span class=p>:</span> <span class=mh>0x7ffee9324558</span><span class=o>&gt;</span>
</code></pre></div></li><li><p>å †blockï¼š<code>__NSMallocBlock__</code>ï¼Œå­˜å‚¨åœ¨<strong>å †(heap)åŒº</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%d&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>);</span>
<span class=p>};</span>
  
<span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;block: %@&#34;</span><span class=p>,</span> <span class=n>block</span><span class=p>);</span>
  
<span class=o>--------------------</span><span class=err>è¾“å‡ºç»“æœï¼š</span><span class=o>-------------------</span>
<span class=nl>block</span><span class=p>:</span> <span class=o>&lt;</span><span class=nl>__NSMallocBlock__</span><span class=p>:</span> <span class=mh>0x6000038a8ed0</span><span class=o>&gt;</span>
</code></pre></div></li></ul><p>æ€»ç»“ï¼š</p><ul><li><p>ä¸æ•è·å¤–ç•Œå˜é‡çš„ block æ˜¯å…¨å±€ Blockï¼š<code>__NSGlobalBlock__</code></p></li><li><p>æ•è·å¤–ç•Œå˜é‡çš„ block</p><ul><li><p><strong>å¼±å¼•ç”¨ä¿®é¥°</strong>æ˜¯æ ˆ blockï¼š<code>__NSMallocBlock__</code></p></li><li><p><strong>å¼ºå¼•ç”¨ä¿®é¥°</strong>æ˜¯å † blockï¼š<code>__NSMallocBlock__</code></p></li></ul></li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸‰ç§ç³»ç»Ÿçº§åˆ«çš„blockç±»å‹ï¼ˆèƒ½åœ¨<a href=https://opensource.apple.com/tarballs/libclosure/ target=_blank rel=noopener>libclosure</a>æºç ä¸­çœ‹åˆ°ï¼‰</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteStackBlock</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
<span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteMallocBlock</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
<span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteAutoBlock</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
<span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteFinalizingBlock</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
<span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteGlobalBlock</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
<span class=kt>void</span> <span class=o>*</span> <span class=n>_NSConcreteWeakBlockVariable</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span> <span class=p>};</span>
</code></pre></div><h3 id=blockå¾ªç¯å¼•ç”¨><a href=#blockå¾ªç¯å¼•ç”¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>blockå¾ªç¯å¼•ç”¨</h3><p><strong>å¾ªç¯å¼•ç”¨çš„åˆ†æ</strong></p><p>å¾ªç¯å¼•ç”¨ç»å…¸æ¡ˆä¾‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=nb>self</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;block&#34;</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=nb>self</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><p>ç¼–è¯‘å™¨ä¼šå‘å‡ºè­¦å‘Š</p><pre><code>Capturing 'self' strongly in this block is likely to lead to a retain cycle
</code></pre><p>äº§ç”Ÿå¾ªç¯å¼•ç”¨é—®é¢˜çš„å…³é”®æ‰€åœ¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>é€šè¿‡ä»£ç ï¼Œå¯ä»¥å‘ç°ï¼š</p><ul><li><code>self</code>æŒæœ‰<code>block</code></li><li><code>block</code>æŒæœ‰<code>self</code>(self.name)</li></ul><p>è¿™æ ·ä¹Ÿå°±æ˜¯ <code>self->block->self</code> çš„å¾ªç¯å¼•ç”¨</p><p>å¾ªç¯å¼•ç”¨ä¼šå¯¼è‡´ä»€ä¹ˆæ ·çš„åæœå‘¢ï¼Ÿ</p><p>é€šå¸¸ï¼Œæ­£å¸¸é‡Šæ”¾æ—¶ï¼š<strong>å¯¹è±¡A</strong>å‘é€<code>dealloc</code>ä¿¡å·è®©<strong>å¯¹è±¡B</strong> è¿›è¡Œ<code>dealloc</code></p><p><img src=https://w-md.imzsy.design/image-20201116152542511.png alt=image-20201116152542511></p><p>å½“å­˜åœ¨å¾ªç¯å¼•ç”¨æ—¶ï¼š<strong>å¯¹è±¡A</strong>ä¸<strong>å¯¹è±¡B</strong>ç›¸äº’å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°ä¸èƒ½å‡ä¸º 0ï¼Œ<code>dealloc</code>å°±ä¸ä¼šè¢«è°ƒç”¨</p><p><img src=https://w-md.imzsy.design/image-20201116153042577.png alt=image-20201116153042577></p><p><strong>å¾ªç¯å¼•ç”¨çš„è§£å†³æ–¹æ³•</strong></p><ul><li><p>å¼ºå¼±å…±èˆ</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>__weak</span> <span class=nf>typeof</span><span class=p>(</span><span class=nb>self</span><span class=p>)</span> <span class=n>weakSelf</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;block&#34;</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>weakSelf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><p>ä½¿ç”¨<strong>ä¸­ä»‹è€…æ¨¡å¼</strong> <code>__weak typeof(self) weakSelf = self;</code> å°†å¾ªç¯å¼•ç”¨æ”¹ä¸ºï¼š<code>weakself -> self -> block -> weakself</code></p><p>çœ‹èµ·æ¥è¿˜æ˜¯ä¸€ä¸ªã€Œå¼•ç”¨ç¯ã€ï¼Œä½†æ˜¯ <code>weakSelf -> self</code> æ˜¯å¼±å¼•ç”¨â€”â€”å¼•ç”¨è®¡æ•°ä¸å¤„ç†ï¼Œä½¿ç”¨ <code>Weakè¡¨</code>ç®¡ç†ï¼Œæ‰€ä»¥åœ¨ææ„æ—¶ï¼Œ<code>self</code> èƒ½å¤Ÿè°ƒç”¨ <code>dealloc</code></p><blockquote><p>ä½†è¿™å¹¶ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä»ç„¶å­˜åœ¨ç€é—®é¢˜</p></blockquote><p>åœ¨ <code>block</code> å†…éƒ¨å­˜åœ¨<strong>å»¶æ—¶å‡½æ•°</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>__weak</span> <span class=nf>typeof</span><span class=p>(</span><span class=nb>self</span><span class=p>)</span> <span class=n>weakSelf</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;block&#34;</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>dispatch_after</span><span class=p>(</span><span class=n>dispatch_time</span><span class=p>(</span><span class=n>DISPATCH_TIME_NOW</span><span class=p>,</span>
                                 <span class=p>(</span><span class=n>int64_t</span><span class=p>)(</span><span class=mf>3.0</span> <span class=o>*</span> <span class=n>NSEC_PER_SEC</span><span class=p>)),</span>
                   <span class=n>dispatch_get_main_queue</span><span class=p>(),</span>
                   <span class=o>^</span><span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>weakSelf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
    <span class=p>});</span>
<span class=p>};</span>
</code></pre></div><p>å¦‚æœåœ¨è°ƒç”¨ <code>block</code> ä¹‹åï¼Œé‡Šæ”¾äº† <code>self</code>ï¼Œé‚£ä¹ˆ 3 ç§’å <code>weakSelf</code> æŒ‡å‘çš„ <code>self</code> å·²ç»å˜ä¸º nilï¼Œé‚£ä¹ˆæ‰“å°ç»“æœä¹Ÿåªèƒ½æ˜¯ <code>null</code></p><p>å› æ­¤ï¼Œå°±éœ€è¦åŠ å…¥<strong>å¼ºå¼•ç”¨</strong></p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>__weak</span> <span class=nf>typeof</span><span class=p>(</span><span class=nb>self</span><span class=p>)</span> <span class=n>weakSelf</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;block&#34;</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=k>__strong</span> <span class=k>typeof</span><span class=p>(</span><span class=n>weakSelf</span><span class=p>)</span> <span class=n>strongSelf</span> <span class=o>=</span> <span class=n>weakSelf</span><span class=p>;</span>
    <span class=n>dispatch_after</span><span class=p>(</span><span class=n>dispatch_time</span><span class=p>(</span><span class=n>DISPATCH_TIME_NOW</span><span class=p>,</span>
                                 <span class=p>(</span><span class=n>int64_t</span><span class=p>)(</span><span class=mf>3.0</span> <span class=o>*</span> <span class=n>NSEC_PER_SEC</span><span class=p>)),</span>
                   <span class=n>dispatch_get_main_queue</span><span class=p>(),</span>
                   <span class=o>^</span><span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>strongSelf</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
    <span class=p>});</span>
<span class=p>};</span>
</code></pre></div><p>é€šè¿‡å†åŠ ä¸€å±‚ä¸´æ—¶çš„å¼ºå¼•ç”¨<code>__strong typeof(weakSelf) strongSelf = weakSelf</code>ï¼Œå°†å¼•ç”¨é“¾æ”¹ä¸ºï¼š<code>strongSelf -> weakself -> self -> block -> strongSelf</code></p><p>çœ‹èµ·æ¥ä»ç„¶æ˜¯ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼Œä½†å®é™…ä¸Š<code>strongSelf</code>æ˜¯ä¸´æ—¶å˜é‡ï¼Œå½“ block ä½œç”¨åŸŸç»“æŸåå°±ä¼šé‡Šæ”¾ï¼Œä»è€Œä¼šæ‰“ç ´å¾ªç¯å¼•ç”¨ï¼Œè¿›è¡Œæ­£å¸¸é‡Šæ”¾</p></li><li><p>å¼•å…¥å…¶ä»–ä¸­é—´è€…</p><p>æ—¢ç„¶æœ‰ã€Œè‡ªåŠ¨ç½®ç©ºã€ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ã€Œæ‰‹åŠ¨ç½®ç©ºã€</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>__block</span> <span class=n>ViewController</span> <span class=o>*</span><span class=n>vc</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;block&#34;</span><span class=p>;</span>
<span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
    <span class=n>dispatch_after</span><span class=p>(</span><span class=n>dispatch_time</span><span class=p>(</span><span class=n>DISPATCH_TIME_NOW</span><span class=p>,</span>
                                 <span class=p>(</span><span class=n>int64_t</span><span class=p>)(</span><span class=mf>3.0</span> <span class=o>*</span> <span class=n>NSEC_PER_SEC</span><span class=p>)),</span>
                   <span class=n>dispatch_get_main_queue</span><span class=p>(),</span>
                   <span class=o>^</span><span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>vc</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
        <span class=n>vc</span> <span class=o>=</span> <span class=nb>nil</span><span class=p>;</span>
    <span class=p>});</span>
<span class=p>};</span>
</code></pre></div><p>è¿™ä¹Ÿæ˜¯é€šè¿‡<strong>ä¸­ä»‹è€…æ¨¡å¼</strong>æ‰“ç ´å¾ªç¯å¼•ç”¨çš„æ–¹å¼â€”â€”ä½¿ç”¨ <code>vc</code> ä½œä¸ºä¸­ä»‹è€…ä»£æ›¿ <code>self</code></p><p>æ­¤æ—¶çš„å¼•ç”¨é“¾ä¸ºï¼š<code>vc -> self -> block -> vc</code>ï¼ˆvcåœ¨ç”¨å®Œä¹‹åï¼Œæ‰‹åŠ¨ç½®ç©ºï¼‰</p></li><li><p>ä¸å¼•ç”¨</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=nb>self</span><span class=p>.</span><span class=n>block</span> <span class=o>=</span> <span class=o>^</span><span class=p>(</span><span class=n>ViewController</span> <span class=o>*</span><span class=n>vc</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>dispatch_after</span><span class=p>(</span><span class=n>dispatch_time</span><span class=p>(</span><span class=n>DISPATCH_TIME_NOW</span><span class=p>,</span>
                                 <span class=p>(</span><span class=n>int64_t</span><span class=p>)(</span><span class=mf>3.0</span> <span class=o>*</span> <span class=n>NSEC_PER_SEC</span><span class=p>)),</span>
                   <span class=n>dispatch_get_main_queue</span><span class=p>(),</span>
                   <span class=o>^</span><span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>vc</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
    <span class=p>});</span>
<span class=p>};</span>
</code></pre></div><p>å°†ä½¿ç”¨<code>å½“å‰ vc</code>ä½œä¸ºå‚æ•°ä¼ å…¥ <code>block</code> æ—¶ï¼Œå°±ä¸ä¼šå‡ºç°æŒæœ‰çš„æƒ…å†µï¼ŒåŒæ—¶è¿˜èƒ½ä½¿ç”¨ <code>self</code> çš„å±æ€§ï¼Œé¿å…å¾ªç¯å¼•ç”¨</p></li></ul><p><strong>è¡¥å……è¯´æ˜</strong></p><ul><li><p><code>Masonry</code>ä¸­æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Ÿ</p><p><code>Masonry</code>ä½¿ç”¨çš„ block æ˜¯å½“ä½œå‚æ•°ä¼ é€’çš„ï¼Œå³ä½¿ block å†…éƒ¨æŒæœ‰ selfï¼Œè®¾ç½®å¸ƒå±€çš„ view æŒæœ‰ blockï¼Œä½†æ˜¯ block ä¸æŒæœ‰ viewã€‚</p><p>å½“ block æ‰§è¡Œå®Œåå°±ä¼šé‡Šæ”¾ï¼Œself çš„å¼•ç”¨è®¡æ•°-1ï¼Œæ‰€ä»¥ block ä¹Ÿä¸ä¼šæŒæœ‰ selfï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨</p></li><li><p><code>[UIView animateWithDuration: animations:]</code>ä¸­æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Ÿ</p><p><code>UIViewåŠ¨ç”»</code>æ˜¯ç±»æ–¹æ³•ï¼Œä¸è¢« self æŒæœ‰ï¼ˆå³ self æŒæœ‰ viewï¼Œä½† view æ²¡æœ‰å®ä¾‹åŒ–ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå¾ªç¯å¼•ç”¨</p></li></ul><h3 id=blockåº•å±‚åˆ†æ><a href=#blockåº•å±‚åˆ†æ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>blockåº•å±‚åˆ†æ</h3><p><strong>æœ¬è´¨</strong></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&#34;stdio.h&#34;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
    <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Block - %d&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>);</span>
    <span class=p>};</span>
    <span class=n>block</span><span class=p>();</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>é€šè¿‡ <code>clang</code> ï¼Œä½¿ç”¨ <code>clang -rewrite-objc main.c -o main.cpp</code>ï¼Œ å°†ä¸Šé¢ä»£ç ç¼–è¯‘æˆ <code>c++</code> æ–‡ä»¶ï¼ŒæŸ¥çœ‹åº•å±‚å®ç°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
    <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> 
                                                           <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> 
                                                           <span class=n>a</span><span class=p>));</span>
    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>blockå£°æ˜ä¸­ï¼Œä¸éš¾å‘ç°ä¸º<code>__main_block_impl_0</code>ç±»å‹ï¼Œè¿™æ˜¯ C++ ä¸­çš„æ„é€ å‡½æ•°</p><p><code>__main_block_impl_0</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
  <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
  <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>a</span><span class=p>;</span>
  <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>int</span> <span class=n>_a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>a</span><span class=p>(</span><span class=n>_a</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
    <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
    <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
    <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>};</span>
</code></pre></div><p>å› æ­¤ï¼Œ<code>block</code> çš„æœ¬è´¨æ˜¯ä¸ª<code>__main_block_impl_0</code>çš„ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯å¯ä»¥ç”¨<code>%@</code>æ‰“å° block çš„åŸå› </p><p>æ„é€ å‡½æ•°æ­£æ˜¯å°†<code>block</code>å…·ä½“å®ç°<code>__main_block_func_0</code>ï¼Œä½œä¸ºå‚æ•° <code>fp</code> ä¼ é€’å¹¶ä¿å­˜åˆ°äº† <code>impl</code></p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦Block()</strong></p><p><code>((**void** (*)(__block_impl *))((__block_impl *)block)->FuncPtr)((__block_impl *)block);</code></p><p>å‡½æ•°è°ƒç”¨æ­£æ˜¯è°ƒç”¨ä¿å­˜åœ¨ <code>impl</code> ä¸­çš„ <code>FuncPtr</code></p><p>è¿™å°±æ˜¯è¯´æ˜äº†ï¼Œblock å£°æ˜åªæ˜¯å°† block å®ç°è¿›è¡Œä¿å­˜ï¼Œå‡½æ•°å®ç°åˆ™éœ€è¦è‡ªè¡Œè°ƒç”¨</p><p><strong>è‡ªåŠ¨æ•è·å¤–ç•Œå˜é‡</strong></p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå˜é‡ a åœ¨åº•å±‚ä»ç„¶æ˜¯ <strong>int</strong>ç±»å‹ï¼Œå¹¶ä½œä¸º<code>__main_block_impl_0</code>æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå¹¶ä¸”ä¿å­˜åœ¨<code>__main_block_impl_0</code>ç»“æ„ä½“çš„æˆå‘˜å˜é‡ a ä¸­</p><p>å¯¹äºblockå‡½æ•°å®ç°ï¼š<code>__main_block_func_0</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=n>__cself</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>;</span> <span class=c1>// bound by copy
</span><span class=c1></span>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Block - %d&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>ä¸éš¾çœ‹å‡ºï¼š</p><ul><li><code>__cself</code>å³<code>__main_block_impl_0</code>çš„æŒ‡é’ˆï¼Œblock æœ¬èº«</li><li><code>int a = __cself->a</code>å³ <code>int a = block->a</code></li><li>ç”±äº a æ˜¯ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæ‰€ä»¥åªæ˜¯<strong>å€¼æ‹·è´</strong></li></ul><p>ç”±äºæ˜¯å€¼æ‹·è´ï¼Œä¸éš¾ç›´æ¥å¯¹æ•è·çš„å¤–ç•Œå˜é‡è¿›è¡Œæ“ä½œï¼Œå¦‚<code>a++</code></p><p><strong>__block ä¿®é¥°å¤–ç•Œå˜é‡</strong></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=n>__block</span> <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
    <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Block - %d&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>);</span>
    <span class=p>};</span>
    <span class=n>block</span><span class=p>();</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>åœ¨åº•å±‚è¢«ç¼–è¯‘ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=n>__attribute__</span><span class=p>((</span><span class=n>__blocks__</span><span class=p>(</span><span class=n>byref</span><span class=p>)))</span> <span class=n>__Block_byref_a_0</span> <span class=n>a</span> <span class=o>=</span> <span class=p>{(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=mi>0</span><span class=p>,(</span><span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>__Block_byref_a_0</span><span class=p>),</span> <span class=mi>10</span><span class=p>};</span>
    <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> 
                                                           <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> 
                                                           <span class=p>(</span><span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> 
                                                           <span class=mi>570425344</span><span class=p>));</span>
    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>æ­¤æ—¶çš„<code>__main_block_impl_0</code>ç»“æ„ä½“ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
    <span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=n>a</span><span class=p>;</span> <span class=c1>// by ref
</span><span class=c1></span>    <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=n>_a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>a</span><span class=p>(</span><span class=n>_a</span><span class=o>-&gt;</span><span class=n>__forwarding</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
        <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
        <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
        <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>};</span>
</code></pre></div><p>è€Œå‡½æ•°å®ç°<code>__main_block_func_0</code>ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=n>a</span> <span class=o>=</span> <span class=n>__cself</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>;</span> <span class=c1>// bound by ref
</span><span class=c1></span>    
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Block - %d&#34;</span><span class=p>,(</span><span class=n>a</span><span class=o>-&gt;</span><span class=n>__forwarding</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div><p><code>__Block_byref_a_0</code>ç»“æ„ä½“ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>__Block_byref_a_0</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>__isa</span><span class=p>;</span>
    <span class=n>__Block_byref_a_0</span> <span class=o>*</span><span class=n>__forwarding</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>__flags</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>__size</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>a</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div><p><code>__block</code>ä¿®é¥°çš„å˜é‡ï¼Œé€šè¿‡ç¼–è¯‘åœ¨åº•å±‚ä¼šç”Ÿæˆ<code>__Block_byref_a_0</code>çš„ç»“æ„ä½“ï¼Œä¸”å°†ç»“æ„ä½“çš„æŒ‡é’ˆåœ°å€ä½œä¸º<code>__main_block_impl_0</code>æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œè¢«ä¿å­˜åˆ°<code>__main_block_impl_0</code>ç»“æ„ä½“ä¸­ï¼Œè¿™æ­£æ˜¯æŒ‡é’ˆæ‹·è´</p><h3 id=blockåº•å±‚æºç åˆ†æ><a href=#blockåº•å±‚æºç åˆ†æ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>blockåº•å±‚æºç åˆ†æ</h3><p>å€ŸåŠ©æ±‡ç¼–è°ƒç”¨å †æ ˆï¼Œä¸éš¾å‘ç°è¿è¡Œæ—¶çš„ block ä¼šè¿›å…¥<code>objc_retainBlock</code>ï¼Œè¿›è€Œèµ°åˆ°<code>_Block_copy</code>å‡½æ•°</p><blockquote><p>å€ŸåŠ©<a href=https://opensource.apple.com/source/libclosure/libclosure-74/ target=_blank rel=noopener>libclosure-74</a>æºç ï¼Œé…ç½®ä¸€ä»½å¯ç¼–è¯‘è°ƒè¯•çš„æºç ï¼Œæ–¹ä¾¿æ¢ç©¶ <code>Block</code></p></blockquote><p>Blockç»“æ„ä½“<code>Block_layout</code>ï¼ˆç­‰åŒäº <code>clang</code> ç¼–è¯‘å‡ºæ¥çš„<code>__Block_byref_a_0</code>ï¼‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#define BLOCK_DESCRIPTOR_1 1
</span><span class=cp></span><span class=k>struct</span> <span class=nc>Block_descriptor_1</span> <span class=p>{</span>
    <span class=n>uintptr_t</span> <span class=n>reserved</span><span class=p>;</span>
    <span class=n>uintptr_t</span> <span class=n>size</span><span class=p>;</span>
<span class=p>};</span>

<span class=cp>#define BLOCK_DESCRIPTOR_2 1
</span><span class=cp></span><span class=k>struct</span> <span class=nc>Block_descriptor_2</span> <span class=p>{</span>
    <span class=c1>// requires BLOCK_HAS_COPY_DISPOSE
</span><span class=c1></span>    <span class=n>BlockCopyFunction</span> <span class=n>copy</span><span class=p>;</span>
    <span class=n>BlockDisposeFunction</span> <span class=n>dispose</span><span class=p>;</span>
<span class=p>};</span>

<span class=cp>#define BLOCK_DESCRIPTOR_3 1
</span><span class=cp></span><span class=k>struct</span> <span class=nc>Block_descriptor_3</span> <span class=p>{</span>
    <span class=c1>// requires BLOCK_HAS_SIGNATURE
</span><span class=c1></span>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>signature</span><span class=p>;</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>layout</span><span class=p>;</span>     <span class=c1>// contents depend on BLOCK_HAS_EXTENDED_LAYOUT
</span><span class=c1></span><span class=p>};</span>

<span class=c1>// Block ç»“æ„ä½“
</span><span class=c1></span><span class=k>struct</span> <span class=nc>Block_layout</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>isa</span><span class=p>;</span>
    <span class=k>volatile</span> <span class=kt>int32_t</span> <span class=n>flags</span><span class=p>;</span> <span class=c1>// contains ref count
</span><span class=c1></span>    <span class=kt>int32_t</span> <span class=n>reserved</span><span class=p>;</span>
    <span class=n>BlockInvokeFunction</span> <span class=n>invoke</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>Block_descriptor_1</span> <span class=o>*</span><span class=n>descriptor</span><span class=p>;</span>
    <span class=c1>// imported variables
</span><span class=c1></span><span class=p>};</span>
</code></pre></div><p>å…¶ä¸­<code>Block_layout</code>æ˜¯åŸºç¡€ block ç»“æ„</p><ul><li><p><code>isa</code>ï¼šè¡¨æ˜ block çš„ç±»å‹</p></li><li><p><code>flags</code>ï¼šæ ‡è¯†ç¬¦ï¼Œè®°å½•äº†ä¸€äº›ä¿¡æ¯ï¼Œ ç±»ä¼¼ isa ç»“æ„ä¸­çš„ä½åŸŸ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>enum</span> <span class=p>{</span>
    <span class=n>BLOCK_DEALLOCATING</span> <span class=o>=</span>      <span class=p>(</span><span class=mh>0x0001</span><span class=p>),</span>  <span class=c1>// runtime
</span><span class=c1></span>    <span class=n>BLOCK_REFCOUNT_MASK</span> <span class=o>=</span>     <span class=p>(</span><span class=mh>0xfffe</span><span class=p>),</span>  <span class=c1>// runtime
</span><span class=c1></span>    <span class=n>BLOCK_NEEDS_FREE</span> <span class=o>=</span>        <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>24</span><span class=p>),</span> <span class=c1>// runtime
</span><span class=c1></span>    <span class=n>BLOCK_HAS_COPY_DISPOSE</span> <span class=o>=</span>  <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>25</span><span class=p>),</span> <span class=c1>// compiler
</span><span class=c1></span>    <span class=n>BLOCK_HAS_CTOR</span> <span class=o>=</span>          <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>26</span><span class=p>),</span> <span class=c1>// compiler: helpers have C++ code
</span><span class=c1></span>    <span class=n>BLOCK_IS_GC</span> <span class=o>=</span>             <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>27</span><span class=p>),</span> <span class=c1>// runtime
</span><span class=c1></span>    <span class=n>BLOCK_IS_GLOBAL</span> <span class=o>=</span>         <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>28</span><span class=p>),</span> <span class=c1>// compiler
</span><span class=c1></span>    <span class=n>BLOCK_USE_STRET</span> <span class=o>=</span>         <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>29</span><span class=p>),</span> <span class=c1>// compiler: undefined if !BLOCK_HAS_SIGNATURE
</span><span class=c1></span>    <span class=n>BLOCK_HAS_SIGNATURE</span>  <span class=o>=</span>    <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>30</span><span class=p>),</span> <span class=c1>// compiler
</span><span class=c1></span>    <span class=n>BLOCK_HAS_EXTENDED_LAYOUT</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>31</span><span class=p>)</span>  <span class=c1>// compiler
</span><span class=c1></span><span class=p>};</span>
  
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>1</span><span class=err>ä½ï¼šé‡Šæ”¾æ ‡è®°ï¼Œä¸€èˆ¬å¸¸ç”¨</span><span class=n>BLOCK_NEEDS_FREEåšä½ä¸æ“ä½œ</span><span class=err>ï¼Œä¸€åŒä¼ å…¥</span><span class=n>flags</span><span class=err>ï¼Œå‘ŠçŸ¥è¯¥</span><span class=n>blockå¯é‡Šæ”¾</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>16</span><span class=err>ä½ï¼šå­˜å‚¨å¼•ç”¨è®¡æ•°çš„å€¼ï¼Œæ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>24</span><span class=err>ä½ï¼šä½</span><span class=mi>16</span><span class=err>ä½æ˜¯å¦æœ‰æ•ˆçš„æ ‡å¿—ï¼Œç¨‹åºæ ¹æ®å®ƒæ¥å†³å®šæ˜¯å¦å¢åŠ æˆ–å‡å°‘å¼•ç”¨è®¡æ•°ä½çš„å€¼</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>25</span><span class=err>ä½ï¼šæ˜¯å¦æ‹¥æœ‰æ‹·è´è¾…åŠ©å‡½æ•°ï¼›å†³å®š</span> <span class=n>Block_descriptor_2</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>26</span><span class=err>ä½ï¼šæ˜¯å¦æ‹¥æœ‰</span><span class=n>blockææ„å‡½æ•°</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>27</span><span class=err>ä½ï¼šæ ‡å¿—æ˜¯å¦æœ‰åƒåœ¾å›æ”¶</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>28</span><span class=err>ä½ï¼šæ ‡å¿—æ˜¯å¦æ˜¯å…¨å±€</span><span class=n>block</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>29</span><span class=err>ä½ï¼šä¸</span><span class=n>BLOCK_USE_STARTç›¸å¯¹</span><span class=err>ï¼Œåˆ¤æ–­å½“å‰</span><span class=n>blockæ˜¯å¦æ‹¥æœ‰ä¸€ä¸ªç­¾å</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>30</span><span class=err>ä½ï¼šæ ‡å¿—æ˜¯å¦æœ‰ç­¾å</span>
<span class=o>-</span> <span class=err>ç¬¬</span><span class=mi>31</span><span class=err>ä½ï¼šæ ‡å¿—æ˜¯å¦æœ‰æ‹“å±•ï¼Œå†³å®š</span> <span class=n>Block_descriptor_3</span>
</code></pre></div></li><li><p><code>invoke</code>ï¼šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ block çš„æ‰§è¡Œä»£ç </p></li><li><p><code>descriptor</code>ï¼šblock çš„é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚ä¿ç•™å˜é‡æ•°ã€block çš„å¤§å°ã€è¿›è¡Œ <code>copy</code> ä¼š <code>dispose</code> çš„è¾…åŠ©å‡½æ•°æŒ‡é’ˆ</p><ul><li><code>Block_descriptor_1</code>æ˜¯å¿…å®šå­˜åœ¨çš„ä¿¡æ¯</li><li>è€Œéƒ¨åˆ†blockåˆ™æ‹¥æœ‰<code>Block_descriptor_2</code>å’Œ<code>Block_descriptor_3</code>ç»“æ„</li></ul></li></ul><p>å¯¹äºéƒ¨åˆ† block æ‹¥æœ‰<code>Block_descriptor_2</code>å’Œ<code>Block_descriptor_3</code>ç»“æ„ï¼Œæ˜¯æ ¹æ®å…¶æ„é€ å‡½æ•°æ‰€ä½“ç°çš„</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// copy å’Œ dispose å‡½æ•°
</span><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=nc>Block_descriptor_2</span> <span class=o>*</span> <span class=nf>_Block_descriptor_2</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=n>aBlock</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_HAS_COPY_DISPOSE</span><span class=p>))</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>descriptor</span><span class=p>;</span>
    <span class=n>desc</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Block_descriptor_1</span><span class=p>);</span>
    <span class=k>return</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_descriptor_2</span> <span class=o>*</span><span class=p>)</span><span class=n>desc</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// ç­¾åç›¸å…³
</span><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=nc>Block_descriptor_3</span> <span class=o>*</span> <span class=nf>_Block_descriptor_3</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=n>aBlock</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_HAS_SIGNATURE</span><span class=p>))</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>descriptor</span><span class=p>;</span>
    <span class=n>desc</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Block_descriptor_1</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_HAS_COPY_DISPOSE</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>desc</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>Block_descriptor_2</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_descriptor_3</span> <span class=o>*</span><span class=p>)</span><span class=n>desc</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>å¦‚æœ<code>aBlock->flags & BLOCK_HAS_COPY_DISPOSE</code>æ¡ä»¶æ»¡è¶³ï¼Œé‚£ä¹ˆå­˜åœ¨<code>Block_descriptor_2</code>ï¼Œ<code>Block_descriptor_2</code>å¯ä»¥é€šè¿‡<code>Block_descriptor_1</code>å†…å­˜åç§»å¾—åˆ°</p><p>åŒæ ·çš„ï¼Œ<code>aBlock->flags & BLOCK_HAS_SIGNATURE</code>æ¡ä»¶æ»¡è¶³ï¼Œé‚£ä¹ˆå­˜åœ¨<code>Block_descriptor_3</code>ï¼Œ<code>Block_descriptor_3</code>åˆ™å¯ä»¥æ ¹æ®<code>Block_descriptor_1</code>å’Œ<code>Block_descriptor_2</code>å†…å­˜åç§»å¾—åˆ°</p><p>å› æ­¤ï¼Œblock çš„å†…å­˜å¸ƒå±€åº”è¯¥é•¿è¿™æ ·ï¼š</p><p><img src=https://w-md.imzsy.design/image-20201117191449285.png alt=image-20201117191449285></p><p><strong>blockç­¾å</strong></p><p>åœ¨<code>Block_descriptor_3</code>ä¸­ï¼Œæœ‰<code>signature</code>æˆå‘˜å˜é‡ï¼Œåœ¨<code>_Block_copy</code>åŠ å…¥æ–­ç‚¹ï¼Œæ‰“å°ä¸€ä¸‹å…¨å±€ Block</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>&lt;__NSGlobalBlock__: 0x100004030&gt;
 signature: <span class=s2>&#34;v8@?0&#34;</span>
 invoke   : 0x100003ef0 <span class=o>(</span>/Users/zsy/Library/Developer/Xcode/DerivedData/Blocks-apixiageymqzowcvafsoicordsqh/Build/Products/Debug/BlockDemo<span class=sb>`</span>__main_block_invoke<span class=o>)</span>
</code></pre></div><p>è¿™é‡Œçš„<code>signature: "v8@?0"</code>ä¾¿æ˜¯ block çš„ç­¾å</p><p>é€šè¿‡<code>[NSMethodSignature signatureWithObjCTypes:"v8@?0"]</code>æ‰“å°</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>&lt;NSMethodSignature: 0x3b5569f7a14d3061&gt;
    number of <span class=nv>arguments</span> <span class=o>=</span> <span class=m>1</span>
    frame <span class=nv>size</span> <span class=o>=</span> <span class=m>224</span>
    is special struct <span class=k>return</span>? NO
    <span class=c1># æ— è¿”å›å€¼</span>
    <span class=k>return</span> value: -------- -------- -------- --------
        <span class=nb>type</span> encoding <span class=o>(</span>v<span class=o>)</span> <span class=s1>&#39;v&#39;</span>
        flags <span class=o>{}</span>
        modifiers <span class=o>{}</span>
        frame <span class=o>{</span><span class=nv>offset</span> <span class=o>=</span> 0, offset <span class=nv>adjust</span> <span class=o>=</span> 0, <span class=nv>size</span> <span class=o>=</span> 0, size <span class=nv>adjust</span> <span class=o>=</span> 0<span class=o>}</span>
        memory <span class=o>{</span><span class=nv>offset</span> <span class=o>=</span> 0, <span class=nv>size</span> <span class=o>=</span> 0<span class=o>}</span>
    <span class=c1># å‚æ•°</span>
    argument 0: -------- -------- -------- --------
        <span class=c1># encoding = (@),ç±»å‹æ˜¯ @?</span>
        <span class=nb>type</span> encoding <span class=o>(</span>@<span class=o>)</span> <span class=s1>&#39;@?&#39;</span>
        flags <span class=o>{</span>isObject, isBlock<span class=o>}</span>
        modifiers <span class=o>{}</span>
        frame <span class=o>{</span><span class=nv>offset</span> <span class=o>=</span> 0, offset <span class=nv>adjust</span> <span class=o>=</span> 0, <span class=nv>size</span> <span class=o>=</span> 8, size <span class=nv>adjust</span> <span class=o>=</span> 0<span class=o>}</span>
        <span class=c1># æ‰€åœ¨åç§»ä½ç½®æ˜¯8å­—èŠ‚</span>
        memory <span class=o>{</span><span class=nv>offset</span> <span class=o>=</span> 0, <span class=nv>size</span> <span class=o>=</span> 8<span class=o>}</span>
</code></pre></div><p>blockçš„ç­¾åä¿¡æ¯ç±»ä¼¼æ–¹æ³•çš„ç­¾åï¼Œå› æ­¤å¯ä»¥æ›´åŠ ç­¾åï¼Œå¯¹ block è¿›è¡Œ Hook</p><h3 id=__blockçš„åŸç†ä¸‰æ¬¡æ‹·è´><a href=#__blockçš„åŸç†ä¸‰æ¬¡æ‹·è´ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>__blockçš„åŸç†ï¼ˆä¸‰æ¬¡æ‹·è´ï¼‰</h3><h4 id=ç¬¬ä¸€æ¬¡æ‹·è´æ ˆblock---å †block><a href=#ç¬¬ä¸€æ¬¡æ‹·è´æ ˆblock---å †block class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç¬¬ä¸€æ¬¡æ‹·è´ï¼šæ ˆblock -> å †block</h4><p>é€šè¿‡<code>_Block_copy</code>å‡½æ•°ï¼Œæ‰“å° block ç»“æœå¦‚ä¸‹</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell><span class=c1>#_Block_copy è°ƒç”¨å‰</span>
&lt;__NSStackBlock__: 0x7ffeefbff478&gt;
 signature: <span class=s2>&#34;v8@?0&#34;</span>
 invoke   : 0x100003ef0 <span class=o>(</span>/Users/zsy/Library/Developer/Xcode/DerivedData/Blocks-apixiageymqzowcvafsoicordsqh/Build/Products/Debug/BlockDemo<span class=sb>`</span>__main_block_invoke<span class=o>)</span>

<span class=c1>#_Block_copy è°ƒç”¨å</span>
&lt;__NSMallocBlock__: 0x100705560&gt;
 signature: <span class=s2>&#34;v8@?0&#34;</span>
 invoke   : 0x100003ef0 <span class=o>(</span>/Users/zsy/Library/Developer/Xcode/DerivedData/Blocks-apixiageymqzowcvafsoicordsqh/Build/Products/Debug/BlockDemo<span class=sb>`</span>__main_block_invoke<span class=o>)</span>
</code></pre></div><p>æ˜¯çš„ï¼Œå‡½æ•°<code>_Block_copy</code>æ­£æ˜¯å°†<code>æ ˆ Block</code>æ‹·è´åˆ°<code>å † Block</code>çš„å…³é”®æ‰€åœ¨ï¼Œå…·ä½“çš„å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Copy, or bump refcount, of a block.  If really copying, call the copy helper if present.
</span><span class=c1>// blockçš„æ‹·è´æ“ä½œ: æ ˆBlock -&gt; å †Block
</span><span class=c1></span><span class=kt>void</span> <span class=o>*</span><span class=nf>_Block_copy</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=n>aBlock</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>arg</span><span class=p>)</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    
    <span class=c1>// The following would be better done as a switch statement
</span><span class=c1></span>    <span class=n>aBlock</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_NEEDS_FREE</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// latches on high
</span><span class=c1></span>        <span class=n>latching_incr_int</span><span class=p>(</span><span class=o>&amp;</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>aBlock</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_IS_GLOBAL</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>aBlock</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Its a stack block.  Make a copy.
</span><span class=c1></span>        <span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=n>result</span> <span class=o>=</span>
            <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_layout</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>descriptor</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>)</span> <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=n>memmove</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>aBlock</span><span class=p>,</span> <span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>descriptor</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span> <span class=c1>// bitcopy first
</span><span class=c1></span><span class=cp>#if __has_feature(ptrauth_calls)
</span><span class=cp></span>        <span class=c1>// Resign the invoke pointer as it uses address authentication.
</span><span class=c1></span>        <span class=n>result</span><span class=o>-&gt;</span><span class=n>invoke</span> <span class=o>=</span> <span class=n>aBlock</span><span class=o>-&gt;</span><span class=n>invoke</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>        <span class=c1>// reset refcount
</span><span class=c1></span>        <span class=n>result</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=p>(</span><span class=n>BLOCK_REFCOUNT_MASK</span><span class=o>|</span><span class=n>BLOCK_DEALLOCATING</span><span class=p>);</span>    <span class=c1>// XXX not needed
</span><span class=c1></span>        <span class=n>result</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|=</span> <span class=n>BLOCK_NEEDS_FREE</span> <span class=o>|</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// logical refcount 1
</span><span class=c1></span>        <span class=n>_Block_call_copy_helper</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>aBlock</span><span class=p>);</span>
        <span class=c1>// Set isa last so memory analysis tools see a fully-initialized object.
</span><span class=c1></span>        <span class=n>result</span><span class=o>-&gt;</span><span class=n>isa</span> <span class=o>=</span> <span class=n>_NSConcreteMallocBlock</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>æ•´ä¸ªæµç¨‹åˆ†ä¸ºï¼š</p><ol><li>é€šè¿‡ <code>flags</code>æ ‡è¯†ä½<code>BLOCK_NEEDS_FREE</code>â€”â€”å­˜å‚¨å¼•ç”¨è®¡æ•°çš„å€¼æ˜¯å¦æœ‰æ•ˆ<ul><li>å½“æ ˆ block è¿›å…¥å‡½æ•°æ—¶ï¼Œ<code>aBlock->flags & BLOCK_NEEDS_FREE</code> ä¸º 0ï¼Œå› æ­¤ï¼Œæ‹·è´ä¸ºå † blockæ—¶ï¼Œä¼šé‡æ–°è®¾ç½®å¼•ç”¨è®¡æ•°</li><li>å½“å † block è¿›å…¥å‡½æ•°æ—¶ï¼Œé€šè¿‡å‡½æ•°<code>latching_incr_int</code>ï¼Œæ”¹å˜å¼•ç”¨è®¡æ•°ï¼Œå¹¶è¿”å› block</li></ul></li><li>åˆ¤æ–­æ˜¯å¦æ˜¯å…¨å±€ Blockâ€”â€”å¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›</li><li>æ ˆ block -> å † block<ul><li>é€šè¿‡ <code>malloc</code> åœ¨å †åŒºç”³è¯·å¼€è¾Ÿå†…å­˜ç©ºé—´</li><li>é€šè¿‡ <code>memove</code> å°†æ•°æ®ä»æ ˆåŒºæ‹·è´åˆ°å †åŒº</li><li>è®¾ç½® <code>invoke</code></li><li>é‡ç½®å¼•ç”¨è®¡æ•°</li><li>å°† block çš„ <code>isa</code> æ ‡è®°ä¸º<code>_NSConcreteMallocBlock</code></li></ul></li></ol><h4 id=ç¬¬äºŒæ¬¡æ‹·è´æ•è·å¤–ç•Œå˜é‡çš„æ“ä½œ><a href=#ç¬¬äºŒæ¬¡æ‹·è´æ•è·å¤–ç•Œå˜é‡çš„æ“ä½œ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç¬¬äºŒæ¬¡æ‹·è´ï¼šæ•è·å¤–ç•Œå˜é‡çš„æ“ä½œ</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_copy_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span><span class=n>_Block_object_assign</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>dst</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span> <span class=mi>8</span><span class=cm>/*BLOCK_FIELD_IS_BYREF*/</span><span class=p>);}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_dispose_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span><span class=n>_Block_object_dispose</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span> <span class=mi>8</span><span class=cm>/*BLOCK_FIELD_IS_BYREF*/</span><span class=p>);}</span>

<span class=k>static</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=p>{</span>
  <span class=n>size_t</span> <span class=n>reserved</span><span class=p>;</span>
  <span class=n>size_t</span> <span class=n>Block_size</span><span class=p>;</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>copy</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>dispose</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
<span class=p>}</span> <span class=n>__main_block_desc_0_DATA</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=p>),</span> <span class=n>__main_block_copy_0</span><span class=p>,</span> <span class=n>__main_block_dispose_0</span><span class=p>};</span>
</code></pre></div><p>åœ¨**__blockæ•è·å¤–éƒ¨å˜é‡**æ—¶ï¼Œåœ¨åº•å±‚<code>__main_block_impl_0</code>æ„é€ å‡½æ•°ä¸­ï¼Œè¿˜ä¼šä¼ é€’<code>main_block_desc_0_DATA</code></p><p>è€Œ<code>__main_block_desc_0_DATA</code>å†…éƒ¨ä¼šä¼ é€’<code>__main_block_copy_0</code>å‡½æ•°ã€<code>__main_block_dispose_0</code>å‡½æ•°</p><ul><li><code>__main_block_copy_0</code>å‡½æ•°ä¼šè°ƒç”¨<code>_Block_object_assign</code></li><li><code>__main_block_dispose_0</code>å‡½æ•°ä¼šè°ƒç”¨<code>_Block_object_dispose</code></li></ul><p><strong>_Block_object_assign</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// _Block_object_assign((void*)&amp;dst-&gt;a, (void*)src-&gt;a, 8/*BLOCK_FIELD_IS_BYREF*/); ä¼ é€’çš„å‚æ•°
</span><span class=c1></span><span class=kt>void</span> <span class=nf>_Block_object_assign</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>destArg</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>const</span> <span class=kt>void</span> <span class=o>**</span><span class=n>dest</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>**</span><span class=p>)</span><span class=n>destArg</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>os_assumes</span><span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_ALL_COPY_DISPOSE_FLAGS</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_OBJECT</span><span class=p>:</span>
        <span class=cm>/*******
</span><span class=cm>        id object = ...;
</span><span class=cm>        [^{ object; } copy];
</span><span class=cm>        ********/</span>

        <span class=n>_Block_retain_object</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
        <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>object</span><span class=p>;</span>
        <span class=k>break</span><span class=p>;</span>

      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_BLOCK</span><span class=p>:</span>
        <span class=cm>/*******
</span><span class=cm>        void (^object)(void) = ...;
</span><span class=cm>        [^{ object; } copy];
</span><span class=cm>        ********/</span>

        <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>_Block_copy</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
    
      <span class=k>case</span> <span class=n>BLOCK_FIELD_IS_BYREF</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_BYREF</span><span class=p>:</span>
        <span class=cm>/*******
</span><span class=cm>         // copy the onstack __block container to the heap
</span><span class=cm>         // Note this __weak is old GC-weak/MRC-unretained.
</span><span class=cm>         // ARC-style __weak is handled by the copy helper directly.
</span><span class=cm>         __block ... x;
</span><span class=cm>         __weak __block ... x;
</span><span class=cm>         [^{ x; } copy];
</span><span class=cm>         ********/</span>

        <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>_Block_byref_copy</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
        
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_OBJECT</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_BLOCK</span><span class=p>:</span>
        <span class=cm>/*******
</span><span class=cm>         // copy the actual field held in the __block container
</span><span class=cm>         // Note this is MRC unretained __block only. 
</span><span class=cm>         // ARC retained __block is handled by the copy helper directly.
</span><span class=cm>         __block id object;
</span><span class=cm>         __block void (^object)(void);
</span><span class=cm>         [^{ object; } copy];
</span><span class=cm>         ********/</span>

        <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>object</span><span class=p>;</span>
        <span class=k>break</span><span class=p>;</span>

      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=n>BLOCK_FIELD_IS_OBJECT</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=n>BLOCK_FIELD_IS_BLOCK</span>  <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
        <span class=cm>/*******
</span><span class=cm>         // copy the actual field held in the __block container
</span><span class=cm>         // Note this __weak is old GC-weak/MRC-unretained.
</span><span class=cm>         // ARC-style __weak is handled by the copy helper directly.
</span><span class=cm>         __weak __block id object;
</span><span class=cm>         __weak __block void (^object)(void);
</span><span class=cm>         [^{ object; } copy];
</span><span class=cm>         ********/</span>

        <span class=o>*</span><span class=n>dest</span> <span class=o>=</span> <span class=n>object</span><span class=p>;</span>
        <span class=k>break</span><span class=p>;</span>

      <span class=k>default</span><span class=o>:</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>æ ¹æ®<code>flags & BLOCK_ALL_COPY_DISPOSE_FLAGS</code>è¿›åˆ°ä¸åŒåˆ†æ”¯æ¥å¤„ç†æ•è·åˆ°çš„å˜é‡</p><div class=table-container><table><thead><tr><th>æšä¸¾å€¼</th><th style=text-align:center>æ•°å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>BLOCK_FIELD_IS_OBJECT</td><td style=text-align:center>3</td><td>å¯¹è±¡</td></tr><tr><td>BLOCK_FIELD_IS_BLOCK</td><td style=text-align:center>7</td><td>blockå˜é‡</td></tr><tr><td>BLOCK_FIELD_IS_BYREF</td><td style=text-align:center>8</td><td>__blockä¿®é¥°çš„ç»“æ„ä½“</td></tr><tr><td>BLOCK_FIELD_IS_WEAK</td><td style=text-align:center>16</td><td>__weakä¿®é¥°çš„å˜é‡</td></tr><tr><td>BLOCK_BYREF_CALLER</td><td style=text-align:center>128</td><td>å¤„ç†block_byrefå†…éƒ¨å¯¹è±¡å†…å­˜çš„æ—¶å€™ ä¼šåŠ çš„ä¸€ä¸ªé¢å¤–çš„æ ‡è®°ï¼Œé…åˆä¸Šé¢çš„æšä¸¾ä¸€èµ·ä½¿ç”¨</td></tr></tbody></table></div><p>æ ¹æ®æºç ä¸éš¾çœ‹å‡ºï¼š</p><ul><li><code>BLOCK_FIELD_IS_OBJECT</code>ï¼šäº¤ç»™ç³»ç»Ÿ ARC å¤„ç†ï¼Œå¹¶æ‹·è´å¯¹è±¡æŒ‡é’ˆï¼Œå³å¼•ç”¨è®¡æ•°+1</li><li><code>BLOCK_FIELD_IS_BLOCK</code>ï¼šè°ƒç”¨<code>_Block_copy</code>å‡½æ•°ï¼Œå°† block ä»æ ˆåŒºæ‹·è´åˆ°å †åŒº</li><li><code>BLOCK_FIELD_IS_BYREF</code>ï¼šè°ƒç”¨<code>_Block_byref_copy</code>å‡½æ•°ï¼Œè¿›è¡Œå†…å­˜æ‹·è´ã€å¼•ç”¨è®¡æ•°çš„å¤„ç†</li></ul><p><strong>_Block_byref_copy</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=nf>_Block_byref_copy</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span> <span class=p>{</span>
    
    <span class=c1>//å¼ºè½¬ä¸ºBlock_byrefç»“æ„ä½“ç±»å‹ï¼Œä¿å­˜ä¸€ä»½
</span><span class=c1></span>    <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>src</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>((</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_REFCOUNT_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// src points to stack ç”³è¯·å†…å­˜
</span><span class=c1></span>        <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>copy</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>isa</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=c1>// byref value 4 is logical refcount of 2: one for caller, one for stack
</span><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>=</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span> <span class=o>|</span> <span class=mi>4</span><span class=p>;</span>
        <span class=c1>//blockå†…éƒ¨æŒæœ‰çš„Block_byref å’Œ å¤–ç•Œçš„Block_byref æ‰€æŒæœ‰çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ__blockä¿®é¥°çš„å˜é‡å…·æœ‰ä¿®æ”¹èƒ½åŠ›
</span><span class=c1></span>        <span class=c1>//copy å’Œ scr çš„åœ°å€æŒ‡é’ˆè¾¾åˆ°äº†å®Œç¾çš„åŒä¸€ä»½æ‹·è´ï¼Œç›®å‰åªæœ‰æŒæœ‰èƒ½åŠ›
</span><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>forwarding</span> <span class=o>=</span> <span class=n>copy</span><span class=p>;</span> <span class=c1>// patch heap copy to point to itself
</span><span class=c1></span>        <span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span> <span class=o>=</span> <span class=n>copy</span><span class=p>;</span>  <span class=c1>// patch stack to point to heap copy
</span><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
        <span class=c1>//å¦‚æœæœ‰copyèƒ½åŠ›
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_HAS_COPY_DISPOSE</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Trust copy helper to copy everything of interest
</span><span class=c1></span>            <span class=c1>// If more than one field shows up in a byref block this is wrong XXX
</span><span class=c1></span>            <span class=c1>//Block_byref_2æ˜¯ç»“æ„ä½“ï¼Œ__blockä¿®é¥°çš„å¯èƒ½æ˜¯å¯¹è±¡ï¼Œå¯¹è±¡é€šè¿‡byref_keepä¿å­˜ï¼Œåœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œè°ƒç”¨
</span><span class=c1></span>            <span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=n>src2</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=p>)(</span><span class=n>src</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
            <span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=n>copy2</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=p>)(</span><span class=n>copy</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
            <span class=n>copy2</span><span class=o>-&gt;</span><span class=n>byref_keep</span> <span class=o>=</span> <span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_keep</span><span class=p>;</span>
            <span class=n>copy2</span><span class=o>-&gt;</span><span class=n>byref_destroy</span> <span class=o>=</span> <span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_destroy</span><span class=p>;</span>

            <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_LAYOUT_EXTENDED</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=n>src3</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=p>)(</span><span class=n>src2</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
                <span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=n>copy3</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_3</span><span class=o>*</span><span class=p>)(</span><span class=n>copy2</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
                <span class=n>copy3</span><span class=o>-&gt;</span><span class=n>layout</span> <span class=o>=</span> <span class=n>src3</span><span class=o>-&gt;</span><span class=n>layout</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=c1>//ç­‰ä»·äº __Block_byref_id_object_copy
</span><span class=c1></span>            <span class=p>(</span><span class=o>*</span><span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_keep</span><span class=p>)(</span><span class=n>copy</span><span class=p>,</span> <span class=n>src</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// Bitwise copy.
</span><span class=c1></span>            <span class=c1>// This copy includes Block_byref_3, if any.
</span><span class=c1></span>            <span class=n>memmove</span><span class=p>(</span><span class=n>copy</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>src</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>src</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=c1>// already copied to heap
</span><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span><span class=p>)</span> <span class=o>==</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>latching_incr_int</span><span class=p>(</span><span class=o>&amp;</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=k>return</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>æ•´ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>å°†ä¼ å…¥çš„å¯¹è±¡ï¼Œå¼ºè½¬ä¸º<code>Block_byref</code>ç»“æ„ä½“</li><li>åˆ¤æ–­æ˜¯å¦å°†å¯¹è±¡æ‹·è´åˆ°å †åŒº<ul><li>å¦‚æœå·²ç»æ‹·è´è¿‡äº†ï¼Œåˆ™å¤„ç†å¼•ç”¨è®¡æ•°</li><li>å¦‚æœæ²¡æœ‰æ‹·è´ï¼Œåˆ™éœ€è¦ç”³è¯·å†…å­˜<code>Block_byref *copy</code>ï¼Œå¹¶ä¸”è®©<code>copy->forwarding</code>å’Œ<code>src->forwarding</code>éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>__block</code>ä¿®é¥°çš„å¯¹è±¡å…·å¤‡ä¿®æ”¹èƒ½åŠ›çš„åŸå› </li></ul></li></ul><p><strong>Block_byrefç»“æ„ä½“çš„å†…å­˜å¸ƒå±€</strong></p><p><img src=https://w-md.imzsy.design/image-20201117210815025.png alt=image-20201117210815025></p><h4 id=ç¬¬ä¸‰æ¬¡æ‹·è´æ‹·è´å¯¹è±¡><a href=#ç¬¬ä¸‰æ¬¡æ‹·è´æ‹·è´å¯¹è±¡ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç¬¬ä¸‰æ¬¡æ‹·è´ï¼šæ‹·è´å¯¹è±¡</h4><p>åœ¨<code>_Block_byref_copy</code>å‡½æ•°ä¸­ï¼Œå°†<code>Block_byref</code>å¯¹è±¡ä»æ ˆæ‹·è´åˆ°å †æ—¶ï¼Œå¦‚æœå¯¹è±¡çš„<code>flags</code>å…·æœ‰<code>BLOCK_BYREF_HAS_COPY_DISPOSE</code>æ ‡è¯†æ—¶ï¼Œå³<code>__block</code>ä¿®é¥°çš„å¯¹è±¡å†…éƒ¨è¿˜å­˜åœ¨å¯¹è±¡ï¼Œé‚£ä¹ˆéœ€è¦å¯¹å†…éƒ¨çš„å¯¹è±¡ä¹Ÿè¿›è¡Œæ‹·è´</p><p><code>(*src2->byref_keep)(copy, src)</code>å°±æ˜¯å¯¹è±¡æ‹·è´</p><p><code>byref_keep</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>isa</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>forwarding</span><span class=p>;</span>
    <span class=k>volatile</span> <span class=kt>int32_t</span> <span class=n>flags</span><span class=p>;</span> <span class=c1>// contains ref count
</span><span class=c1></span>    <span class=kt>uint32_t</span> <span class=n>size</span><span class=p>;</span>
<span class=p>};</span>

<span class=c1>// __Block ä¿®é¥°çš„ç»“æ„ä½“ byref_keep å’Œ byref_destroy å‡½æ•° - æ¥å¤„ç†é‡Œé¢æŒæœ‰å¯¹è±¡çš„ä¿æŒå’Œé”€æ¯
</span><span class=c1></span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=p>{</span>
    <span class=c1>// requires BLOCK_BYREF_HAS_COPY_DISPOSE
</span><span class=c1></span>    <span class=n>BlockByrefKeepFunction</span> <span class=n>byref_keep</span><span class=p>;</span>
    <span class=n>BlockByrefDestroyFunction</span> <span class=n>byref_destroy</span><span class=p>;</span>
<span class=p>};</span>

<span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=p>{</span>
    <span class=c1>// requires BLOCK_BYREF_LAYOUT_EXTENDED
</span><span class=c1></span>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>layout</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div><p>é‡æ–° <code>clang</code> å¯¹ä¸‹é¢çš„ä»£ç ç¼–è¯‘çœ‹ä¸€çœ‹</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=cp>#import &lt;Foundation/Foundation.h&gt;
</span><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=k>__block</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>name</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSString</span> <span class=nl>stringWithFormat</span><span class=p>:</span><span class=s>@&#34;test&#34;</span><span class=p>];</span>
    <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
        <span class=n>name</span> <span class=o>=</span> <span class=s>@&#34;name&#34;</span><span class=p>;</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;Block: %@&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
    <span class=p>};</span>
    <span class=n>block</span><span class=p>();</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>ç¼–è¯‘ç»“æœï¼š</p><ul><li>ç¼–è¯‘åçš„<code>Block_byref</code>ç»“æ„ä½“ï¼Œå¤šäº†<code>__Block_byref_id_object_copy_131</code>å’Œ<code>__Block_byref_id_object_dispose_131</code></li><li><code>__Block_byref_name_0</code>ç»“æ„ä½“ï¼Œå¤šäº†<code>__Block_byref_id_object_copy</code>å’Œ<code>__Block_byref_id_object_dispose</code></li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
    <span class=n>__attribute__</span><span class=p>((</span><span class=n>__blocks__</span><span class=p>(</span><span class=n>byref</span><span class=p>)))</span> <span class=n>__Block_byref_name_0</span> <span class=n>name</span> <span class=o>=</span> <span class=p>{</span>
        <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=mi>0</span><span class=p>,</span>
        <span class=p>(</span><span class=n>__Block_byref_name_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span>
        <span class=mi>33554432</span><span class=p>,</span>
        <span class=k>sizeof</span><span class=p>(</span><span class=n>__Block_byref_name_0</span><span class=p>),</span>
        <span class=n>__Block_byref_id_object_copy_131</span><span class=p>,</span>
        <span class=n>__Block_byref_id_object_dispose_131</span><span class=p>,</span>
        <span class=p>((</span><span class=n>NSString</span> <span class=o>*</span> <span class=n>_Nonnull</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>*</span> <span class=n>_Nonnull</span><span class=p>,</span> <span class=p>...))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSString&#34;</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;stringWithFormat:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_qs_68kbrd0j4790ypksky9f_kgr0000gn_T_main_1106ed_mi_0</span><span class=p>)};</span>

    <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> <span class=p>(</span><span class=n>__Block_byref_name_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span> <span class=mi>570425344</span><span class=p>));</span>

    <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>struct</span> <span class=nc>__Block_byref_name_0</span> <span class=p>{</span>
  <span class=kt>void</span> <span class=o>*</span><span class=n>__isa</span><span class=p>;</span>
<span class=n>__Block_byref_name_0</span> <span class=o>*</span><span class=n>__forwarding</span><span class=p>;</span>
 <span class=kt>int</span> <span class=n>__flags</span><span class=p>;</span>
 <span class=kt>int</span> <span class=n>__size</span><span class=p>;</span>
 <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>__Block_byref_id_object_copy</span><span class=p>)(</span><span class=kt>void</span><span class=o>*</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span><span class=p>);</span>
 <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>__Block_byref_id_object_dispose</span><span class=p>)(</span><span class=kt>void</span><span class=o>*</span><span class=p>);</span>
 <span class=n>NSString</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
<span class=p>};</span>

<span class=k>static</span> <span class=kt>void</span> <span class=nf>__Block_byref_id_object_copy_131</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>_Block_object_assign</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>dst</span> <span class=o>+</span> <span class=mi>40</span><span class=p>,</span> <span class=o>*</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>src</span> <span class=o>+</span> <span class=mi>40</span><span class=p>),</span> <span class=mi>131</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=nf>__Block_byref_id_object_dispose_131</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>_Block_object_dispose</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>src</span> <span class=o>+</span> <span class=mi>40</span><span class=p>),</span> <span class=mi>131</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>æ²¡é”™ï¼Œè¿™é‡Œçš„<code>__Block_byref_id_object_copy_131</code>æ­£æ˜¯<code>byref_keep</code></p><p>ç¬¬ä¸‰æ¬¡æ‹·è´æ­£æ˜¯è°ƒç”¨<code>__Block_byref_id_object_copy_131</code>æ–¹æ³•ï¼Œè€Œæœ¬è´¨æ˜¯è°ƒç”¨<code>_Block_object_assign</code>ï¼Œ<code>(char*)dst + 40</code>å…¶å®æ˜¯é€šè¿‡å†…å­˜å¹³ç§»ï¼Œä¼ å…¥æˆå‘˜å˜é‡ <code>name</code></p><p><strong>æ€»ç»“</strong></p><p>é€šè¿‡<code>libclosure-74</code>å¯ç¼–è¯‘æºç æ–­ç‚¹è°ƒè¯•ï¼Œå…³é”®æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼š<code>_Block_copy -> _Block_byref_copy -> *src2->byref_keep (å³_Block_object_assign)</code></p><p>è¿™å°±æ˜¯<code>__blockçš„ä¸‰æ¬¡æ‹·è´</code></p><ul><li>ç¬¬ä¸€æ¬¡æ‹·è´ï¼šé€šè¿‡<code>_Block_copy</code>å‡½æ•°ï¼Œå°†å¯¹è±¡ä»æ ˆåŒºæ‹·è´åˆ°å †åŒº</li><li>ç¬¬äºŒæ¬¡æ‹·è´ï¼šé€šè¿‡<code>_Block_byref_copy</code>å‡½æ•°ï¼Œå°†å¯¹è±¡æ‹·è´ä¸º<code>Block_byref</code>ç»“æ„ä½“</li><li>ç¬¬ä¸‰æ¬¡æ‹·è´ï¼šè°ƒç”¨å¯¹è±¡çš„<code>byref_keep</code>å‡½æ•°ï¼Œå®é™…æ˜¯è°ƒç”¨<code>_Block_object_assign</code>å‡½æ•°ï¼Œå¯¹<code>__block</code>ä¿®é¥°çš„<code>å½“å‰å˜é‡</code>æ‹·è´</li></ul><p><strong>_Block_object_dispose</strong></p><p><code>_Block_object_dispose</code>å’Œ<code>_Block_object_assign</code>éå¸¸ç±»ä¼¼ï¼Œä¸»è¦æ˜¯è´Ÿè´£ block çš„é‡Šæ”¾æ“ä½œ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// When Blocks or Block_byrefs hold objects their destroy helper routines call this entry point
</span><span class=c1>// to help dispose of the contents å½“Blocksæˆ–Block_byrefsæŒæœ‰å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯åŠ©æ‰‹ä¾‹ç¨‹å°†è°ƒç”¨æ­¤å…¥å£ç‚¹ä»¥å¸®åŠ©å¤„ç½®å†…å®¹
</span><span class=c1></span><span class=kt>void</span> <span class=nf>_Block_object_dispose</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>os_assumes</span><span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_ALL_COPY_DISPOSE_FLAGS</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>case</span> <span class=n>BLOCK_FIELD_IS_BYREF</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_BYREF</span><span class=p>:</span><span class=c1>//__blockä¿®é¥°çš„å˜é‡ï¼Œå³brefç±»å‹çš„
</span><span class=c1></span>        <span class=c1>// get rid of the __block data structure held in a Block
</span><span class=c1></span>        <span class=n>_Block_byref_release</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_BLOCK</span><span class=p>:</span><span class=c1>//blockç±»å‹çš„å˜é‡
</span><span class=c1></span>        <span class=n>_Block_release</span><span class=p>(</span><span class=n>object</span><span class=p>)</span> <span class=p>;</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=nl>BLOCK_FIELD_IS_OBJECT</span><span class=p>:</span><span class=c1>//æ™®é€šå¯¹è±¡
</span><span class=c1></span>        <span class=n>_Block_release_object</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_OBJECT</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_BLOCK</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=n>BLOCK_FIELD_IS_OBJECT</span> <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>BLOCK_BYREF_CALLER</span> <span class=o>|</span> <span class=n>BLOCK_FIELD_IS_BLOCK</span>  <span class=o>|</span> <span class=nl>BLOCK_FIELD_IS_WEAK</span><span class=p>:</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>default</span><span class=o>:</span>
        <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> <span class=nf>_Block_byref_release</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>byref</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>

    <span class=c1>// dereference the forwarding pointer since the compiler isn&#39;t doing this anymore (ever?)
</span><span class=c1></span>    <span class=n>byref</span> <span class=o>=</span> <span class=n>byref</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=p>;</span>
    
    <span class=k>if</span> <span class=p>(</span><span class=n>byref</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int32_t</span> <span class=n>refcount</span> <span class=o>=</span> <span class=n>byref</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_REFCOUNT_MASK</span><span class=p>;</span>
        <span class=n>os_assert</span><span class=p>(</span><span class=n>refcount</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>latching_decr_int_should_deallocate</span><span class=p>(</span><span class=o>&amp;</span><span class=n>byref</span><span class=o>-&gt;</span><span class=n>flags</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>byref</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_HAS_COPY_DISPOSE</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=n>byref2</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=p>)(</span><span class=n>byref</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
                <span class=p>(</span><span class=o>*</span><span class=n>byref2</span><span class=o>-&gt;</span><span class=n>byref_destroy</span><span class=p>)(</span><span class=n>byref</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>free</span><span class=p>(</span><span class=n>byref</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>é€šè¿‡æºç ï¼Œä¸éš¾å¾—å‡ºä¸‹é¢çš„ç»“è®º</p><ul><li>å¦‚æœæ˜¯é‡Šæ”¾å¯¹è±¡å°±ä»€ä¹ˆä¹Ÿä¸åšï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰</li><li>å¦‚æœæ˜¯<code>__block</code>ä¿®é¥°ï¼Œå°±å°†æŒ‡å‘æŒ‡å›åŸæ¥çš„åŒºåŸŸå¹¶ä½¿ç”¨<code>free</code>é‡Šæ”¾</li></ul><blockquote><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href=https://opensource.apple.com/source/libclosure/libclosure-74/ target=_blank rel=noopener>libclosure-74</a></p><p><a href=https://github.com/dev-jw/objc_debug/tree/master/libclosure-74 target=_blank rel=noopener>å¯ç¼–è¯‘è°ƒè¯•æºç </a></p></blockquote></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>