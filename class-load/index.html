<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹ã€ä¸­ï¼Œä»‹ç»äº† App å¯åŠ¨æ—¶åˆ»çš„ä¸€äº›æ“ä½œã€‚ é‚£ä¹ˆå…³äºç±»â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/class-load/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-10-13T14:21:19+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/class-load/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½","description":"åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹ã€ä¸­ï¼Œä»‹ç»äº† App å¯åŠ¨æ—¶åˆ»çš„ä¸€äº›æ“ä½œã€‚ é‚£ä¹ˆå…³äºç±»â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½"><meta property="og:description" content="åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹ã€ä¸­ï¼Œä»‹ç»äº† App å¯åŠ¨æ—¶åˆ»çš„ä¸€äº›æ“ä½œã€‚ é‚£ä¹ˆå…³äºç±»â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/class-load/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„åŠ è½½</h1><div class=post-meta><time datetime=2020-10-13T14:21:19+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-10-13</time></div><div class="post-body e-content"><p>åœ¨ã€<a href=../dyld-load>iOSåº•å±‚åŸç†æ¢ç´¢-dyldåŠ è½½æµç¨‹</a>ã€ä¸­ï¼Œä»‹ç»äº† App å¯åŠ¨æ—¶åˆ»çš„ä¸€äº›æ“ä½œã€‚</p><p>é‚£ä¹ˆå…³äºç±»çš„åŠ è½½å…·ä½“æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å‘¢ï¼ŸåŒæ ·çš„ï¼Œä»¥ä¸‹å‡ ä¸ªé—®é¢˜ä¼šå¸®åŠ©å¯¹æœ¬æ–‡çš„ç†è§£ï¼š</p><ul><li><code>_objc_init</code>å…·ä½“åšäº†ä»€ä¹ˆ</li><li><code>readClass</code>å…·ä½“åšäº†ä»€ä¹ˆ</li><li><code>realizeClassWithoutSwift</code>å…·ä½“åšäº†ä»€ä¹ˆ</li><li>ç±»çš„åŠ è½½è¿‡ç¨‹â€”â€”éæ‡’åŠ è½½</li><li>ç±»çš„åŠ è½½è¿‡ç¨‹â€”â€”æ‡’åŠ è½½</li></ul><h3 id=_objc_init><a href=#_objc_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>_objc_init</h3><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* _objc_init
</span><span class=cm>* Bootstrap initialization. Registers our image notifier with dyld.
</span><span class=cm>* Called by libSystem BEFORE library initialization time
</span><span class=cm>**********************************************************************/</span>

<span class=kt>void</span> <span class=nf>_objc_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>static</span> <span class=kt>bool</span> <span class=n>initialized</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>initialized</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
    <span class=n>initialized</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
    
    <span class=c1>// fixme defer initialization until an objc-using image is found?
</span><span class=c1></span>    <span class=n>environ_init</span><span class=p>();</span>
    <span class=n>tls_init</span><span class=p>();</span>
    <span class=n>static_init</span><span class=p>();</span>
    <span class=n>runtime_init</span><span class=p>();</span>
    <span class=n>exception_init</span><span class=p>();</span>
    <span class=n>cache_init</span><span class=p>();</span>
    <span class=n>_imp_implementationWithBlock_init</span><span class=p>();</span>

    <span class=n>_dyld_objc_notify_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>map_images</span><span class=p>,</span> <span class=n>load_images</span><span class=p>,</span> <span class=n>unmap_image</span><span class=p>);</span>

<span class=cp>#if __OBJC2__
</span><span class=cp></span>    <span class=n>didCallDyldNotifyRegister</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span><span class=p>}</span>
</code></pre></div><p>å…ˆçœ‹<strong>æºç </strong>ï¼Œé€è¡Œåˆ†æ</p><h4 id=environ_init><a href=#environ_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>environ_init()</h4><p>è¿™ä¸ªå‡½æ•°ä¼šè¯»å–å½±å“è¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚æœéœ€è¦ï¼Œè¿˜å¯ä»¥æ‰“å°ç¯å¢ƒå˜é‡å¸®åŠ©ã€‚</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>if</span> <span class=p>(</span><span class=n>PrintHelp</span>  <span class=o>||</span>  <span class=n>PrintOptions</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>PrintHelp</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;Objective-C runtime debugging. Set variable=YES to enable.&#34;</span><span class=p>);</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;OBJC_HELP: describe available environment variables&#34;</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>PrintOptions</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;OBJC_HELP is set&#34;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;OBJC_PRINT_OPTIONS: list which options are set&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>PrintOptions</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;OBJC_PRINT_OPTIONS is set&#34;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Settings</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=n>Settings</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>const</span> <span class=n>option_t</span> <span class=o>*</span><span class=n>opt</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>Settings</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>            
        <span class=k>if</span> <span class=p>(</span><span class=n>PrintHelp</span><span class=p>)</span> <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;%s: %s&#34;</span><span class=p>,</span> <span class=n>opt</span><span class=o>-&gt;</span><span class=n>env</span><span class=p>,</span> <span class=n>opt</span><span class=o>-&gt;</span><span class=n>help</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>PrintOptions</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=n>opt</span><span class=o>-&gt;</span><span class=n>var</span><span class=p>)</span> <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;%s is set&#34;</span><span class=p>,</span> <span class=n>opt</span><span class=o>-&gt;</span><span class=n>env</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>è¿™é‡Œåˆ—äº†æ‰€æœ‰çš„<a href=https://w-md.imzsy.design/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B1%87%E6%80%BB.pdf target=_blank rel=noopener>ç¯å¢ƒå˜é‡</a>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç»ˆç«¯è¾“å…¥<code>export OBJC_HELP=1</code>æŸ¥çœ‹</p><p>å¸¸ç”¨çš„ç¯å¢ƒå˜é‡å¦‚ï¼š</p><ul><li><p><code>OBJC_PRINT_LOAD_METHODS</code>ï¼šæ‰“å°æ‰€æœ‰çš„<code>+load</code>æ–¹æ³•</p></li><li><p><code>OBJC_DISABLE_NONPOINTER_ISA</code>ï¼šæ§åˆ¶ <code>isa</code> ä¼˜åŒ–å¼€å…³</p></li></ul><h4 id=tls_init><a href=#tls_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>tls_init()</h4><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æœ¬åœ°çº¿ç¨‹æ± çš„åˆå§‹åŒ–ï¼Œå…³äºçº¿ç¨‹ key çš„ç»‘å®š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>tls_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
<span class=cp>#if SUPPORT_DIRECT_THREAD_KEYS </span><span class=c1>// æœ¬åœ°çº¿ç¨‹æ± 
</span><span class=c1></span>    <span class=n>pthread_key_init_np</span><span class=p>(</span><span class=n>TLS_DIRECT_KEY</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_objc_pthread_destroyspecific</span><span class=p>);</span> <span class=c1>// åˆå§‹init
</span><span class=c1></span><span class=cp>#else
</span><span class=cp></span>    <span class=n>_objc_pthread_key</span> <span class=o>=</span> <span class=n>tls_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_objc_pthread_destroyspecific</span><span class=p>);</span> <span class=c1>// ææ„
</span><span class=c1></span><span class=cp>#endif
</span><span class=cp></span><span class=p>}</span>
</code></pre></div><h4 id=static_init><a href=#static_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>static_init()</h4><p>é€šè¿‡å‡½æ•°æ³¨é‡Šå¯çŸ¥ï¼Œä¸»è¦æ˜¯è¿è¡Œ <strong>C++ é™æ€æ„é€ å‡½æ•°</strong>ï¼ˆåªä¼šè¿è¡Œç³»ç»Ÿçº§åˆ«çš„æ„é€ å‡½æ•°ï¼‰</p><p>åœ¨ Dyld è°ƒç”¨æˆ‘ä»¬çš„é™æ€æ„é€ å‡½æ•°ä¹‹å‰ï¼Œ<code>libc</code>è°ƒç”¨<code>_objc_init()</code>æ–¹æ³•ï¼Œä¹Ÿå°±è¯´<strong>ç³»ç»Ÿçš„C++æ„é€ å‡½æ•° ä¼˜å…ˆäº è‡ªå®šä¹‰çš„C++æ„é€ å‡½æ•°</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* static_init
</span><span class=cm>* Run C++ static constructor functions.
</span><span class=cm>* libc calls _objc_init() before dyld would call our static constructors, 
</span><span class=cm>* so we have to do it ourselves.
</span><span class=cm>**********************************************************************/</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>static_init</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>size_t</span> <span class=n>count</span><span class=p>;</span>
    <span class=k>auto</span> <span class=n>inits</span> <span class=o>=</span> <span class=n>getLibobjcInitializers</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_mh_dylib_header</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>inits</span><span class=p>[</span><span class=n>i</span><span class=p>]();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h4 id=runtime_init><a href=#runtime_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>runtime_init()</h4><p>è¿è¡Œæ—¶çš„åˆå§‹åŒ–ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ“ä½œï¼š</p><ul><li>å¼€è¾Ÿå­˜å‚¨åˆ†ç±»çš„è¡¨</li><li>å¼€è¾Ÿå­˜å‚¨ç±»çš„è¡¨</li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>runtime_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>objc</span><span class=o>::</span><span class=n>unattachedCategories</span><span class=p>.</span><span class=n>init</span><span class=p>(</span><span class=mi>32</span><span class=p>);</span>
    <span class=n>objc</span><span class=o>::</span><span class=n>allocatedClasses</span><span class=p>.</span><span class=n>init</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><h4 id=exception_init><a href=#exception_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>exception_init()</h4><p>åˆå§‹åŒ– <code>libobjc</code> çš„å¼‚å¸¸å¤„ç†ç³»ç»Ÿï¼Œæ³¨å†Œå¼‚å¸¸å¤„ç†çš„å›è°ƒï¼Œä»è€Œç›‘æ§å¼‚å¸¸çš„å¤„ç†</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* exception_init
</span><span class=cm>* Initialize libobjc&#39;s exception handling system.
</span><span class=cm>* Called by map_images().
</span><span class=cm>**********************************************************************/</span>
<span class=kt>void</span> <span class=nf>exception_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>old_terminate</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>set_terminate</span><span class=p>(</span><span class=o>&amp;</span><span class=n>_objc_terminate</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>å½“äº§ç”Ÿ <code>crash</code> æ—¶ï¼Œä¼šæ¥åˆ°<code>_objc_terminate</code>æ–¹æ³•ï¼Œèµ°åˆ° <code>uncaught_handler</code> æŠ›å‡ºå¼‚å¸¸</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* _objc_terminate
</span><span class=cm>* Custom std::terminate handler.
</span><span class=cm>*
</span><span class=cm>* The uncaught exception callback is implemented as a std::terminate handler. 
</span><span class=cm>* 1. Check if there&#39;s an active exception
</span><span class=cm>* 2. If so, check if it&#39;s an Objective-C exception
</span><span class=cm>* 3. If so, call our registered callback with the object.
</span><span class=cm>* 4. Finally, call the previous terminate handler.
</span><span class=cm>**********************************************************************/</span>
<span class=k>static</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>old_terminate</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>_objc_terminate</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>PrintExceptions</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;EXCEPTIONS: terminating&#34;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=n>__cxa_current_exception_type</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// No current exception.
</span><span class=c1></span>        <span class=p>(</span><span class=o>*</span><span class=n>old_terminate</span><span class=p>)();</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// There is a current exception. Check if it&#39;s an objc exception.
</span><span class=c1></span>        <span class=err>@</span><span class=k>try</span> <span class=p>{</span>
            <span class=n>__cxa_rethrow</span><span class=p>();</span>
        <span class=p>}</span> <span class=err>@</span><span class=k>catch</span> <span class=p>(</span><span class=n>id</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// It&#39;s an objc object. Call Foundation&#39;s handler, if any.
</span><span class=c1></span>            <span class=p>(</span><span class=o>*</span><span class=n>uncaught_handler</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>e</span><span class=p>);</span>
            <span class=p>(</span><span class=o>*</span><span class=n>old_terminate</span><span class=p>)();</span>
        <span class=p>}</span> <span class=err>@</span><span class=k>catch</span> <span class=p>(...)</span> <span class=p>{</span>
            <span class=c1>// It&#39;s not an objc object. Continue to C++ terminate.
</span><span class=c1></span>            <span class=p>(</span><span class=o>*</span><span class=n>old_terminate</span><span class=p>)();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>åœ¨åº•å±‚<code>objc_setExceptionMatcher</code>å‡½æ•°ä¼šå°†ä¼ å…¥çš„ <code>fn</code> èµ‹å€¼ç»™<code>uncaught_handler</code>ï¼Œç»è¿‡å°è£…åœ¨ä¸Šå±‚è°ƒç”¨çš„æ˜¯<code>NSSetUncaughtExceptionHandler</code>æ–¹æ³•ï¼Œ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* objc_setExceptionMatcher
</span><span class=cm>* Set a handler for matching Objective-C exceptions. 
</span><span class=cm>* Returns the previous handler. 
</span><span class=cm>**********************************************************************/</span>
<span class=n>objc_exception_matcher</span>
<span class=nf>objc_setExceptionMatcher</span><span class=p>(</span><span class=n>objc_exception_matcher</span> <span class=n>fn</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>objc_exception_matcher</span> <span class=n>result</span> <span class=o>=</span> <span class=n>exception_matcher</span><span class=p>;</span>
    <span class=n>exception_matcher</span> <span class=o>=</span> <span class=n>fn</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><strong>å…³äº Crash</strong></p><p>é€ æˆ Crash çš„ä¸»è¦åŸå› å°±æ˜¯æ”¶åˆ°æœªå¤„ç†çš„ä¿¡å·ï¼Œè€Œè¿™ä¸ªä¿¡å·æ¥æºäºä¸‰ä¸ªåœ°æ–¹ï¼š</p><ul><li>kernelå†…æ ¸</li><li>å…¶ä»–è¿›è¡Œ</li><li>Appæœ¬èº«</li></ul><p>ç›¸åº”çš„ï¼Œcrash ä¹Ÿåˆ†ä¸ºäº† 3 ç±»</p><ul><li>Machå¼‚å¸¸ï¼šåº•å±‚å†…æ ¸çº§å¼‚å¸¸ã€‚ç”¨æˆ·æ€çš„å¼€å‘è€…å¯ä»¥ç›´æ¥é€šè¿‡ Mach API è®¾ç½® Threadã€taskã€host çš„å¼‚å¸¸ç«¯å£ï¼Œæ•è· Mach å¼‚å¸¸</li><li>Unixå¼‚å¸¸ï¼šBSDä¿¡å·ï¼Œå¦‚æœå¼€å‘è€…æ²¡æœ‰æ•è· Mach å¼‚å¸¸ï¼Œåˆ™ä¼šè¢« host å±‚çš„æ–¹æ³• ux_exception() å°†å¼‚å¸¸è½¬æ¢ä¸ºå¯¹åº”çš„ UNIX ä¿¡å·ï¼Œå¹¶é€šè¿‡ threadsignal() å°†ä¿¡å·æŠ•é€’åˆ°å‡ºé”™çº¿ç¨‹ã€‚é€šè¿‡æ–¹æ³• <code>signal(x, fn)</code> æ•è·</li><li>NSExceptionåº”ç”¨å¼‚å¸¸ï¼šæœªè¢«ä¸æ•è·çš„ Objective-C å¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå‘è‡ªèº«å‘é€äº† <code>SIGABRT</code> ä¿¡å·è€Œå´©æºƒï¼Œå¯ä»¥é€šè¿‡ <code>try-catch</code> æˆ–è€…<code>NSSetUncaughtExceptionHandler</code>æ•è·</li></ul><p><strong>Crashæ‹¦æˆª</strong></p><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¼šé’ˆå¯¹ Crash è¿›è¡Œæ‹¦æˆªå¤„ç†ï¼Œå…¶æœ¬è´¨å°±æ˜¯é€šè¿‡<code>NSSetUncaughtExceptionHandler</code>æ³¨å†Œå¼‚å¸¸æ•è·å‡½æ•°<code>fn</code>ã€‚</p><p>å½“å‘é€å¼‚å¸¸æ—¶ï¼Œ<code>fn</code>å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œåœ¨å‡½æ•°ä¸­ï¼Œæ”¶é›†å´©æºƒæ—¥å¿—ã€çº¿ç¨‹ä¿æ´»ç­‰æ“ä½œ</p><blockquote><p><a href=https://github.com/dev-jw/CrashDemo/blob/master/CrashDemo/UncaughtExceptionHandler.m target=_blank rel=noopener>Crashæ‹¦æˆªDemo</a></p></blockquote><h4 id=cache_init><a href=#cache_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>cache_init()</h4><p>ç¼“å­˜åˆå§‹åŒ–</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>cache_init</span><span class=p>()</span>
<span class=p>{</span>
<span class=cp>#if HAVE_TASK_RESTARTABLE_RANGES
</span><span class=cp></span>    <span class=n>mach_msg_type_number_t</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>kern_return_t</span> <span class=n>kr</span><span class=p>;</span>

    <span class=k>while</span> <span class=p>(</span><span class=n>objc_restartableRanges</span><span class=p>[</span><span class=n>count</span><span class=p>].</span><span class=n>location</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>count</span><span class=o>++</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>kr</span> <span class=o>=</span> <span class=n>task_restartable_ranges_register</span><span class=p>(</span><span class=n>mach_task_self</span><span class=p>(),</span>
                                          <span class=n>objc_restartableRanges</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>kr</span> <span class=o>==</span> <span class=n>KERN_SUCCESS</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
    <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;task_restartable_ranges_register failed (result 0x%x: %s)&#34;</span><span class=p>,</span>
                <span class=n>kr</span><span class=p>,</span> <span class=n>mach_error_string</span><span class=p>(</span><span class=n>kr</span><span class=p>));</span>
<span class=cp>#endif </span><span class=c1>// HAVE_TASK_RESTARTABLE_RANGES
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><h4 id=_imp_implementationwithblock_init><a href=#_imp_implementationwithblock_init class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>_imp_implementationWithBlock_init()</h4><p>å¯åŠ¨å›è°ƒæœºåˆ¶ï¼Œé€šå¸¸ä¸ä¼šåšä»€ä¹ˆï¼Œå› ä¸ºä¸€åˆ‡éƒ½æ˜¯æ‡’åˆå§‹åŒ–çš„ï¼Œä½†æ˜¯å¯¹äºæŸäº›è¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦æ€¥åˆ‡åœ°åŠ è½½<code>libobjc-trampolines.dylib</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>_imp_implementationWithBlock_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
<span class=cp>#if TARGET_OS_OSX
</span><span class=cp></span>    <span class=c1>// Eagerly load libobjc-trampolines.dylib in certain processes. Some
</span><span class=c1></span>    <span class=c1>// programs (most notably QtWebEngineProcess used by older versions of
</span><span class=c1></span>    <span class=c1>// embedded Chromium) enable a highly restrictive sandbox profile which
</span><span class=c1></span>    <span class=c1>// blocks access to that dylib. If anything calls
</span><span class=c1></span>    <span class=c1>// imp_implementationWithBlock (as AppKit has started doing) then we&#39;ll
</span><span class=c1></span>    <span class=c1>// crash trying to load it. Loading it here sets it up before the sandbox
</span><span class=c1></span>    <span class=c1>// profile is enabled and blocks it.
</span><span class=c1></span>    <span class=c1>//
</span><span class=c1></span>    <span class=c1>// This fixes EA Origin (rdar://problem/50813789)
</span><span class=c1></span>    <span class=c1>// and Steam (rdar://problem/55286131)
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>__progname</span> <span class=o>&amp;&amp;</span>
        <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>__progname</span><span class=p>,</span> <span class=s>&#34;QtWebEngineProcess&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span>
         <span class=n>strcmp</span><span class=p>(</span><span class=n>__progname</span><span class=p>,</span> <span class=s>&#34;Steam Helper&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Trampolines</span><span class=p>.</span><span class=n>Initialize</span><span class=p>();</span>
    <span class=p>}</span>
<span class=cp>#endif
</span><span class=cp></span><span class=p>}</span>
</code></pre></div><h4 id=_dyld_objc_notify_register><a href=#_dyld_objc_notify_register class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>_dyld_objc_notify_register</h4><p><code>_dyld_objc_notify_register</code>å‡½æ•°å£°æ˜</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>//
</span><span class=c1>// Note: only for use by objc runtime
</span><span class=c1>// Register handlers to be called when objc images are mapped, unmapped, and initialized.
</span><span class=c1>// Dyld will call back the &#34;mapped&#34; function with an array of images that contain an objc-image-info section.
</span><span class=c1>// Those images that are dylibs will have the ref-counts automatically bumped, so objc will no longer need to
</span><span class=c1>// call dlopen() on them to keep them from being unloaded.  During the call to _dyld_objc_notify_register(),
</span><span class=c1>// dyld will call the &#34;mapped&#34; function with already loaded objc images.  During any later dlopen() call,
</span><span class=c1>// dyld will also call the &#34;mapped&#34; function.  Dyld will call the &#34;init&#34; function when dyld would be called
</span><span class=c1>// initializers in that image.  This is when objc calls any +load methods in that image.
</span><span class=c1>//
</span><span class=c1></span><span class=kt>void</span> <span class=nf>_dyld_objc_notify_register</span><span class=p>(</span><span class=n>_dyld_objc_notify_mapped</span>    <span class=n>mapped</span><span class=p>,</span>
                                <span class=n>_dyld_objc_notify_init</span>      <span class=n>init</span><span class=p>,</span>
                                <span class=n>_dyld_objc_notify_unmapped</span>  <span class=n>unmapped</span><span class=p>);</span>
</code></pre></div><p>ä»æ³¨é‡Šä¸­ï¼Œä¸éš¾å¾—å‡ºï¼š</p><ul><li>ä»…ä¾›<code>objcè¿è¡Œæ—¶</code>ä½¿ç”¨</li><li>æ³¨å†Œå¤„ç†ç¨‹åºï¼Œä»¥ä¾¿åœ¨æ˜ å°„ã€å–æ¶ˆæ˜ å°„å’Œåˆå§‹åŒ– objc é•œåƒæ—¶è°ƒç”¨</li><li><code>dyld</code>å°†ä¼šé€šè¿‡ä¸€ä¸ªåŒ…å«objc-image-infoçš„é•œåƒæ–‡ä»¶çš„æ•°ç»„å›è°ƒ<code>mapped</code>å‡½æ•°</li></ul><p>ä¸‰ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><code>map_images</code>ï¼šdyld å°† image åŠ è½½å†…å­˜æ—¶ï¼Œä¼šè§¦å‘è¯¥å‡½æ•°</li><li><code>load_images</code>ï¼šdyld åˆå§‹åŒ– image ä¼šè§¦å‘è¯¥å‡½æ•°</li><li><code>unmap_image</code>ï¼šdyld å°† image ç§»é™¤æ—¶ï¼Œä¼šè§¦å‘è¯¥å‡½æ•°</li></ul><p>è€Œè¿™ä¸ªä¸‰ä¸ªå‚æ•°ï¼Œä¼šåœ¨<code>registerObjCNotifiers</code>å‡½æ•°ä¸­ï¼Œåˆ†åˆ«åœ°ä¿å­˜åˆ°<code>sNotifyObjCMapped</code>ã€<code>sNotifyObjCInit</code>ã€<code>sNotifyObjCUnmapped</code></p><p>å¾—åˆ°ä»¥ä¸‹ç­‰ä»·å…³ç³»ï¼š</p><ul><li><code>sNotifyObjCMapped</code> == <code>mapped</code> == <code>map_images</code></li><li><code>sNotifyObjCInit</code> == <code>init</code> == <code>load_images</code></li><li><code>sNotifyObjCUnmapped</code> == <code>unmapped</code> == <code>unmap_image</code></li></ul><p><strong>è°ƒç”¨æ—¶æœº</strong></p><p>åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œåˆ†æäº† <code>load_images</code> çš„è°ƒç”¨æ—¶æœºï¼Œå†æ¥çœ‹ä¸€ä¸‹ <code>map_images</code> çš„è°ƒç”¨æ—¶æœº</p><p>åœ¨ dyld æºç ä¸­æœç´¢<code>sNotifyObjCMapped</code>ï¼Œå‘ç°æ˜¯åœ¨<code>notifyBatchPartial</code>å‡½æ•°ä¸­è°ƒç”¨çš„</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>notifyBatchPartial</span><span class=p>(</span><span class=n>dyld_image_states</span> <span class=n>state</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>orLater</span><span class=p>,</span> <span class=n>dyld_image_state_change_handler</span> <span class=n>onlyHandler</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>preflightOnly</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>onlyObjCMappedNotification</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>dyld_image_state_change_handler</span><span class=o>&gt;*</span> <span class=n>handlers</span> <span class=o>=</span> <span class=n>stateToHandlers</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>sBatchHandlers</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>handlers</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>||</span> <span class=p>((</span><span class=n>state</span> <span class=o>==</span> <span class=n>dyld_image_state_bound</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>sNotifyObjCMapped</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>))</span> <span class=p>)</span> <span class=p>{</span>
        <span class=p>...</span>
        <span class=k>if</span> <span class=p>(</span> <span class=n>imageCount</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
            <span class=p>...</span>
            <span class=k>if</span> <span class=p>(</span> <span class=n>objcImageCount</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
                    <span class=n>dyld3</span><span class=o>::</span><span class=n>ScopedTimer</span> <span class=n>timer</span><span class=p>(</span><span class=n>DBG_DYLD_TIMING_OBJC_MAP</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
                    <span class=kt>uint64_t</span> <span class=n>t0</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
                    <span class=c1>// è°ƒç”¨sNotifyObjCMapped
</span><span class=c1></span>                    <span class=p>(</span><span class=o>*</span><span class=n>sNotifyObjCMapped</span><span class=p>)(</span><span class=n>objcImageCount</span><span class=p>,</span> <span class=n>paths</span><span class=p>,</span> <span class=n>mhs</span><span class=p>);</span>
                    <span class=kt>uint64_t</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>mach_absolute_time</span><span class=p>();</span>
                    <span class=n>ImageLoader</span><span class=o>::</span><span class=n>fgTotalObjCSetupTime</span> <span class=o>+=</span> <span class=p>(</span><span class=n>t1</span><span class=o>-</span><span class=n>t0</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>...</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p><code>notifyBatchPartial</code>åˆæ˜¯åœ¨<code>registerObjCNotifiers</code>ä¸­è¢«è°ƒç”¨çš„</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>registerObjCNotifiers</span><span class=p>(</span><span class=n>_dyld_objc_notify_mapped</span> <span class=n>mapped</span><span class=p>,</span> <span class=n>_dyld_objc_notify_init</span> <span class=n>init</span><span class=p>,</span> <span class=n>_dyld_objc_notify_unmapped</span> <span class=n>unmapped</span><span class=p>)</span>
<span class=p>{</span>
	<span class=c1>// record functions to call
</span><span class=c1></span>	<span class=n>sNotifyObjCMapped</span>	<span class=o>=</span> <span class=n>mapped</span><span class=p>;</span>
	<span class=n>sNotifyObjCInit</span>		<span class=o>=</span> <span class=n>init</span><span class=p>;</span>
	<span class=n>sNotifyObjCUnmapped</span> <span class=o>=</span> <span class=n>unmapped</span><span class=p>;</span>

	<span class=c1>// call &#39;mapped&#39; function with all images mapped so far
</span><span class=c1></span>	<span class=k>try</span> <span class=p>{</span>
		<span class=n>notifyBatchPartial</span><span class=p>(</span><span class=n>dyld_image_state_bound</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
	<span class=p>}</span>
	<span class=k>catch</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>msg</span><span class=p>)</span> <span class=p>{</span>
		<span class=c1>// ignore request to abort during registration
</span><span class=c1></span>	<span class=p>}</span>

	<span class=c1>// &lt;rdar://problem/32209809&gt; call &#39;init&#39; function on all images already init&#39;ed (below libSystem)
</span><span class=c1></span>	<span class=k>for</span> <span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>ImageLoader</span><span class=o>*&gt;::</span><span class=n>iterator</span> <span class=n>it</span><span class=o>=</span><span class=n>sAllImages</span><span class=p>.</span><span class=n>begin</span><span class=p>();</span> <span class=n>it</span> <span class=o>!=</span> <span class=n>sAllImages</span><span class=p>.</span><span class=n>end</span><span class=p>();</span> <span class=n>it</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
		<span class=n>ImageLoader</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=o>*</span><span class=n>it</span><span class=p>;</span>
		<span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>()</span> <span class=o>==</span> <span class=n>dyld_image_state_initialized</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>notifyObjC</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
			<span class=n>dyld3</span><span class=o>::</span><span class=n>ScopedTimer</span> <span class=n>timer</span><span class=p>(</span><span class=n>DBG_DYLD_TIMING_OBJC_INIT</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>machHeader</span><span class=p>(),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
			<span class=p>(</span><span class=o>*</span><span class=n>sNotifyObjCInit</span><span class=p>)(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>getRealPath</span><span class=p>(),</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>machHeader</span><span class=p>());</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>å› æ­¤ï¼Œ<code>map_images</code> æ˜¯å…ˆäº <code>load_images</code> æ‰§è¡Œ</p><h4 id=dyldä¸objcå…³è”><a href=#dyldä¸objcå…³è” class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>dyldä¸Objcå…³è”</h4><p>ç»¼åˆ<strong>dyldçš„åŠ è½½æµç¨‹</strong>ï¼Œdyld ä¸ Objc çš„å…³è”æµç¨‹å›¾</p><p><img src=https://w-md.imzsy.design/dyld&objc.png alt=dyld&objc></p><h3 id=map_images><a href=#map_images class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>map_images</h3><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* map_images
</span><span class=cm>* Process the given images which are being mapped in by dyld.
</span><span class=cm>* Calls ABI-agnostic code after taking ABI-specific locks.
</span><span class=cm>*
</span><span class=cm>* Locking: write-locks runtimeLock
</span><span class=cm>**********************************************************************/</span>
<span class=kt>void</span>
<span class=nf>map_images</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>count</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span> <span class=k>const</span> <span class=n>paths</span><span class=p>[],</span>
           <span class=k>const</span> <span class=k>struct</span> <span class=nc>mach_header</span> <span class=o>*</span> <span class=k>const</span> <span class=n>mhdrs</span><span class=p>[])</span>
<span class=p>{</span>
    <span class=n>mutex_locker_t</span> <span class=n>lock</span><span class=p>(</span><span class=n>runtimeLock</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>map_images_nolock</span><span class=p>(</span><span class=n>count</span><span class=p>,</span> <span class=n>paths</span><span class=p>,</span> <span class=n>mhdrs</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p><code>map_images</code> è°ƒç”¨ <code>map_images_nolock</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>map_images_nolock</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>mhCount</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span> <span class=k>const</span> <span class=n>mhPaths</span><span class=p>[],</span>
                  <span class=k>const</span> <span class=k>struct</span> <span class=nc>mach_header</span> <span class=o>*</span> <span class=k>const</span> <span class=n>mhdrs</span><span class=p>[])</span>
<span class=p>{</span>
    <span class=c1>//...çœç•¥
</span><span class=c1></span>
    <span class=c1>// Find all images with Objective-C metadata.æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰Objective-Cå…ƒæ•°æ®çš„æ˜ åƒ
</span><span class=c1></span>    <span class=n>hCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=c1>// Count classes. Size various table based on the total.è®¡ç®—ç±»çš„ä¸ªæ•°
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>totalClasses</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>unoptimizedTotalClasses</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=c1>//ä»£ç å—ï¼šä½œç”¨åŸŸï¼Œè¿›è¡Œå±€éƒ¨å¤„ç†ï¼Œå³å±€éƒ¨å¤„ç†ä¸€äº›äº‹ä»¶
</span><span class=c1></span>    <span class=p>{</span>
        <span class=c1>//...çœç•¥
</span><span class=c1></span>    <span class=p>}</span>
    
    <span class=c1>//...çœç•¥
</span><span class=c1></span>
    <span class=k>if</span> <span class=p>(</span><span class=n>hCount</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>//åŠ è½½é•œåƒæ–‡ä»¶
</span><span class=c1></span>        <span class=n>_read_images</span><span class=p>(</span><span class=n>hList</span><span class=p>,</span> <span class=n>hCount</span><span class=p>,</span> <span class=n>totalClasses</span><span class=p>,</span> <span class=n>unoptimizedTotalClasses</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>firstTime</span> <span class=o>=</span> <span class=n>NO</span><span class=p>;</span>
    
    <span class=c1>// Call image load funcs after everything is set up.ä¸€åˆ‡è®¾ç½®å®Œæˆåï¼Œè°ƒç”¨é•œåƒåŠ è½½åŠŸèƒ½ã€‚
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>func</span> <span class=p>:</span> <span class=n>loadImageFuncs</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>mhCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>func</span><span class=p>(</span><span class=n>mhdrs</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>è¯¥å‡½æ•°æ˜¯åœ¨é•œåƒåŠ è½½åˆ°å†…å­˜æ—¶è§¦å‘è°ƒç”¨çš„ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯<code>Mach-O</code>æ–‡ä»¶ä¸­<strong>ç±»ä¿¡æ¯</strong>åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘éƒ½åœ¨<code>_read_images</code>å‡½æ•°</p><h4 id=_read_images><a href=#_read_images class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>_read_images</h4><p>é€šè¿‡æºç ï¼Œè¯¥å‡½æ•°ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ“ä½œï¼š</p><ul><li>åˆ›å»ºè¡¨</li><li>ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„@selectorçš„æ··ä¹±é—®é¢˜</li><li>ç±»çš„é‡æ˜ å°„</li><li>ä¿®å¤é‡æ˜ å°„</li><li>ä¿®å¤ä¸€äº›æ¶ˆæ¯</li><li>å½“ç±»é‡Œé¢æœ‰åè®®æ—¶ï¼šreadProtocol è¯»å–åè®®</li><li>ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®</li><li>åˆ†ç±»å¤„ç†</li><li>ç±»çš„åŠ è½½å¤„ç†</li><li>æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±»</li></ul><h5 id=åˆ›å»ºè¡¨><a href=#åˆ›å»ºè¡¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åˆ›å»ºè¡¨</h5><p>åœ¨<code>doneOnce</code>æµç¨‹ä¸­é€šè¿‡<code>NXCreateMapTable</code> åˆ›å»ºè¡¨ï¼Œå­˜æ”¾ç±»ä¿¡æ¯ï¼Œå³åˆ›å»ºä¸€å¼ ç±»çš„<code>å“ˆå¸Œè¡¨``gdb_objc_realized_classes</code>ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ç±»æŸ¥æ‰¾æ–¹ä¾¿ã€å¿«æ·</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>doneOnce</span><span class=p>)</span> <span class=p>{</span>
     
    <span class=c1>//...çœç•¥
</span><span class=c1></span>    
    <span class=c1>// namedClasses
</span><span class=c1></span>    <span class=c1>// Preoptimized classes don&#39;t go in this table.
</span><span class=c1></span>    <span class=c1>// 4/3 is NXMapTable&#39;s load factor
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>namedClassesSize</span> <span class=o>=</span> 
        <span class=p>(</span><span class=n>isPreoptimized</span><span class=p>()</span> <span class=o>?</span> <span class=nl>unoptimizedTotalClasses</span> <span class=p>:</span> <span class=n>totalClasses</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>/</span> <span class=mi>3</span><span class=p>;</span>
    <span class=c1>// åˆ›å»ºè¡¨ï¼ˆå“ˆå¸Œè¡¨key-valueï¼‰ï¼Œç›®çš„æ˜¯æŸ¥æ‰¾å¿«
</span><span class=c1></span>    <span class=n>gdb_objc_realized_classes</span> <span class=o>=</span>
        <span class=n>NXCreateMapTable</span><span class=p>(</span><span class=n>NXStrValueMapPrototype</span><span class=p>,</span> <span class=n>namedClassesSize</span><span class=p>);</span>

    <span class=n>ts</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;IMAGE TIMES: first time tasks&#34;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><ul><li><code>gdb_objc_realized_classes</code>å­˜å‚¨ä¸åœ¨å…±äº«ç¼“å­˜ä¸”å·²å‘½åçš„æ‰€æœ‰ç±»ï¼Œå…¶å®¹é‡æ˜¯ç±»æ•°é‡çš„4/3</li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// This is a misnomer: gdb_objc_realized_classes is actually a list of 
</span><span class=c1>// named classes not in the dyld shared cache, whether realized or not.
</span><span class=c1></span><span class=n>NXMapTable</span> <span class=o>*</span><span class=n>gdb_objc_realized_classes</span><span class=p>;</span>  <span class=c1>// exported for debuggers in objc-gdb.h
</span></code></pre></div><h5 id=ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„selectorçš„æ··ä¹±é—®é¢˜><a href=#ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„selectorçš„æ··ä¹±é—®é¢˜ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„@selectorçš„æ··ä¹±é—®é¢˜</h5><p>ä¸»è¦æ˜¯é€šè¿‡é€šè¿‡<code>_getObjc2SelectorRefs</code>æ‹¿åˆ°<code>Mach-O</code>ä¸­çš„é™æ€æ®µ<code>__objc_selrefs</code>ï¼Œéå†åˆ—è¡¨è°ƒç”¨<code>sel_registerNameNoLock</code>å°†<code>SEL</code>æ·»åŠ åˆ°<code>namedSelectors</code>å“ˆå¸Œè¡¨ä¸­</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Fix up @selector references ä¿®å¤@selectorå¼•ç”¨
</span><span class=c1>//sel ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å¸¦åœ°å€çš„å­—ç¬¦ä¸²
</span><span class=c1></span><span class=k>static</span> <span class=n>size_t</span> <span class=n>UnfixedSelectors</span><span class=p>;</span>
<span class=p>{</span>
    <span class=n>mutex_locker_t</span> <span class=nf>lock</span><span class=p>(</span><span class=n>selLock</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>hi</span><span class=o>-&gt;</span><span class=n>hasPreoptimizedSelectors</span><span class=p>())</span> <span class=k>continue</span><span class=p>;</span>

        <span class=kt>bool</span> <span class=n>isBundle</span> <span class=o>=</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>isBundle</span><span class=p>();</span>
        <span class=c1>//é€šè¿‡_getObjc2SelectorRefsæ‹¿åˆ°Mach-Oä¸­çš„é™æ€æ®µ__objc_selrefs
</span><span class=c1></span>        <span class=n>SEL</span> <span class=o>*</span><span class=n>sels</span> <span class=o>=</span> <span class=n>_getObjc2SelectorRefs</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
        <span class=n>UnfixedSelectors</span> <span class=o>+=</span> <span class=n>count</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//åˆ—è¡¨éå†
</span><span class=c1></span>            <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span> <span class=o>=</span> <span class=n>sel_cname</span><span class=p>(</span><span class=n>sels</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
            <span class=c1>//æ³¨å†Œselæ“ä½œï¼Œå³å°†selæ·»åŠ åˆ°
</span><span class=c1></span>            <span class=n>SEL</span> <span class=n>sel</span> <span class=o>=</span> <span class=n>sel_registerNameNoLock</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>isBundle</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>sels</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>sel</span><span class=p>)</span> <span class=p>{</span><span class=c1>//å½“selä¸sels[i]åœ°å€ä¸ä¸€è‡´æ—¶ï¼Œéœ€è¦è°ƒæ•´ä¸ºä¸€è‡´çš„
</span><span class=c1></span>                <span class=n>sels</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>sel</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><ul><li><p><code>_getObjc2SelectorRefs</code>ï¼šè¡¨ç¤ºè·å–<code>Mach-O</code>ä¸­çš„é™æ€æ®µ<code>__objc_selrefs</code>ï¼Œè¿˜æœ‰å…¶ä»–çš„ Section è·å–æ–¹æ³•</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#define GETSECT(name, type, sectname)                                   \
</span><span class=cp>    type *name(const headerType *mhdr, size_t *outCount) {              \
</span><span class=cp>        return getDataSection&lt;type&gt;(mhdr, sectname, nil, outCount);     \
</span><span class=cp>    }                                                                   \
</span><span class=cp>    type *name(const header_info *hi, size_t *outCount) {               \
</span><span class=cp>        return getDataSection&lt;type&gt;(hi-&gt;mhdr(), sectname, nil, outCount); \
</span><span class=cp>    }
</span><span class=cp></span><span class=c1>//      function name                 content type     section name
</span><span class=c1></span><span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2SelectorRefs</span><span class=p>,</span>        <span class=n>SEL</span><span class=p>,</span>             <span class=s>&#34;__objc_selrefs&#34;</span><span class=p>);</span> 
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2MessageRefs</span><span class=p>,</span>         <span class=n>message_ref_t</span><span class=p>,</span>   <span class=s>&#34;__objc_msgrefs&#34;</span><span class=p>);</span> 
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2ClassRefs</span><span class=p>,</span>           <span class=n>Class</span><span class=p>,</span>           <span class=s>&#34;__objc_classrefs&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2SuperRefs</span><span class=p>,</span>           <span class=n>Class</span><span class=p>,</span>           <span class=s>&#34;__objc_superrefs&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2ClassList</span><span class=p>,</span>           <span class=n>classref_t</span> <span class=k>const</span><span class=p>,</span>      <span class=s>&#34;__objc_classlist&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2NonlazyClassList</span><span class=p>,</span>    <span class=n>classref_t</span> <span class=k>const</span><span class=p>,</span>      <span class=s>&#34;__objc_nlclslist&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2CategoryList</span><span class=p>,</span>        <span class=n>category_t</span> <span class=o>*</span> <span class=k>const</span><span class=p>,</span>    <span class=s>&#34;__objc_catlist&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2CategoryList2</span><span class=p>,</span>       <span class=n>category_t</span> <span class=o>*</span> <span class=k>const</span><span class=p>,</span>    <span class=s>&#34;__objc_catlist2&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2NonlazyCategoryList</span><span class=p>,</span> <span class=n>category_t</span> <span class=o>*</span> <span class=k>const</span><span class=p>,</span>    <span class=s>&#34;__objc_nlcatlist&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2ProtocolList</span><span class=p>,</span>        <span class=n>protocol_t</span> <span class=o>*</span> <span class=k>const</span><span class=p>,</span>    <span class=s>&#34;__objc_protolist&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>_getObjc2ProtocolRefs</span><span class=p>,</span>        <span class=n>protocol_t</span> <span class=o>*</span><span class=p>,</span>    <span class=s>&#34;__objc_protorefs&#34;</span><span class=p>);</span>
<span class=n>GETSECT</span><span class=p>(</span><span class=n>getLibobjcInitializers</span><span class=p>,</span>       <span class=n>UnsignedInitializer</span><span class=p>,</span> <span class=s>&#34;__objc_init_func&#34;</span><span class=p>);</span>
</code></pre></div></li><li><p><code>sel_registerNameNoLock</code>ï¼šå°† <code>sel</code> æ’å…¥ <code>namedSelectors</code> å“ˆå¸Œè¡¨ä¸­</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>SEL</span> <span class=nf>sel_registerNameNoLock</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>__sel_registerName</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>copy</span><span class=p>);</span>  <span class=c1>// NO lock, maybe copy
</span><span class=c1></span><span class=p>}</span>
  
<span class=k>static</span> <span class=n>SEL</span> <span class=nf>__sel_registerName</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>shouldLock</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>copy</span><span class=p>)</span> 
<span class=p>{</span>
    <span class=n>SEL</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  
    <span class=k>if</span> <span class=p>(</span><span class=n>shouldLock</span><span class=p>)</span> <span class=n>selLock</span><span class=p>.</span><span class=n>assertUnlocked</span><span class=p>();</span>
    <span class=k>else</span> <span class=n>selLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
  
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>name</span><span class=p>)</span> <span class=k>return</span> <span class=p>(</span><span class=n>SEL</span><span class=p>)</span><span class=mi>0</span><span class=p>;</span>
  
    <span class=n>result</span> <span class=o>=</span> <span class=n>search_builtins</span><span class=p>(</span><span class=n>name</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
      
    <span class=n>conditional_mutex_locker_t</span> <span class=n>lock</span><span class=p>(</span><span class=n>selLock</span><span class=p>,</span> <span class=n>shouldLock</span><span class=p>);</span>
    <span class=k>auto</span> <span class=n>it</span> <span class=o>=</span> <span class=n>namedSelectors</span><span class=p>.</span><span class=n>get</span><span class=p>().</span><span class=n>insert</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=c1>//selæ’å…¥è¡¨
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span><span class=p>.</span><span class=n>second</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// No match. Insert.
</span><span class=c1></span>        <span class=o>*</span><span class=n>it</span><span class=p>.</span><span class=n>first</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>sel_alloc</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>copy</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>SEL</span><span class=p>)</span><span class=o>*</span><span class=n>it</span><span class=p>.</span><span class=n>first</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></li></ul><h5 id=ç±»çš„é‡æ˜ å°„><a href=#ç±»çš„é‡æ˜ å°„ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»çš„é‡æ˜ å°„</h5><p>ä»Mach-Oä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œéå†å¤„ç†</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Discover classes. Fix up unresolved future classes. Mark bundle classes.
</span><span class=c1></span><span class=kt>bool</span> <span class=n>hasDyldRoots</span> <span class=o>=</span> <span class=n>dyld_shared_cache_some_image_overridden</span><span class=p>();</span>
<span class=c1>//è¯»å–ç±»ï¼šreadClass
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=n>mustReadClasses</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=n>hasDyldRoots</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Image is sufficiently optimized that we need not call readClass()
</span><span class=c1></span>        <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>//ä»ç¼–è¯‘åçš„ç±»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œå³ä»Mach-Oä¸­è·å–é™æ€æ®µ__objc_classlistï¼Œæ˜¯ä¸€ä¸ªclassref_tç±»å‹çš„æŒ‡é’ˆ
</span><span class=c1></span>    <span class=n>classref_t</span> <span class=k>const</span> <span class=o>*</span><span class=n>classlist</span> <span class=o>=</span> <span class=n>_getObjc2ClassList</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>

    <span class=kt>bool</span> <span class=n>headerIsBundle</span> <span class=o>=</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>isBundle</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=n>headerIsPreoptimized</span> <span class=o>=</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>hasPreoptimizedClasses</span><span class=p>();</span>

    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=p>)</span><span class=n>classlist</span><span class=p>[</span><span class=n>i</span><span class=p>];</span><span class=c1>//æ­¤æ—¶è·å–çš„clsåªæ˜¯ä¸€ä¸ªåœ°å€
</span><span class=c1></span>        <span class=n>Class</span> <span class=n>newCls</span> <span class=o>=</span> <span class=n>readClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>headerIsBundle</span><span class=p>,</span> <span class=n>headerIsPreoptimized</span><span class=p>);</span> <span class=c1>//è¯»å–ç±»ï¼Œç»è¿‡è¿™æ­¥åï¼Œclsè·å–çš„å€¼æ‰æ˜¯ä¸€ä¸ªåå­—
</span><span class=c1></span>        <span class=c1>//ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œifé‡Œé¢çš„æµç¨‹
</span><span class=c1></span>        <span class=c1>//åˆå§‹åŒ–æ‰€æœ‰æ‡’åŠ è½½çš„ç±»éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯æ‡’åŠ è½½ç±»çš„æ•°æ®ç°åœ¨æ˜¯æ²¡æœ‰åŠ è½½åˆ°çš„ï¼Œè¿ç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>newCls</span> <span class=o>!=</span> <span class=n>cls</span>  <span class=o>&amp;&amp;</span>  <span class=n>newCls</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Class was moved but not deleted. Currently this occurs 
</span><span class=c1></span>            <span class=c1>// only when the new class resolved a future class.
</span><span class=c1></span>            <span class=c1>// Non-lazily realize the class below.
</span><span class=c1></span>            <span class=c1>//å°†æ‡’åŠ è½½çš„ç±»æ·»åŠ åˆ°æ•°ç»„ä¸­
</span><span class=c1></span>            <span class=n>resolvedFutureClasses</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span> <span class=o>*</span><span class=p>)</span>
                <span class=n>realloc</span><span class=p>(</span><span class=n>resolvedFutureClasses</span><span class=p>,</span> 
                        <span class=p>(</span><span class=n>resolvedFutureClassCount</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Class</span><span class=p>));</span>
            <span class=n>resolvedFutureClasses</span><span class=p>[</span><span class=n>resolvedFutureClassCount</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>newCls</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
<span class=n>ts</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;IMAGE TIMES: discover classes&#34;</span><span class=p>);</span>
</code></pre></div><p>å…³äº <code>readClass</code> å‡½æ•°, ä¸‹é¢ä¼šè¯¦ç»†åˆ†æ</p><h5 id=ä¿®å¤é‡æ˜ å°„><a href=#ä¿®å¤é‡æ˜ å°„ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä¿®å¤é‡æ˜ å°„</h5><p>å°†æœªæ˜ å°„ Class å’Œ Super Class é‡æ˜ å°„ï¼Œ</p><ul><li>è°ƒç”¨<code>_getObjc2ClassRefs</code>è·å–ç±»çš„å¼•ç”¨</li><li>è°ƒç”¨<code>_getObjc2SuperRefs</code>è·å–çˆ¶ç±»çš„å¼•ç”¨</li><li>é€šè¿‡<code>remapClassRef</code>è¿›è¡Œé‡æ˜ å°„ï¼Œè¢«</li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Fix up remapped classes ä¿®æ­£é‡æ–°æ˜ å°„çš„ç±»
</span><span class=c1>// Class list and nonlazy class list remain unremapped.ç±»åˆ—è¡¨å’Œéæƒ°æ€§ç±»åˆ—è¡¨ä¿æŒæœªæ˜ å°„
</span><span class=c1>// Class refs and super refs are remapped for message dispatching.ç±»å¼•ç”¨å’Œè¶…çº§å¼•ç”¨å°†é‡æ–°æ˜ å°„ä»¥è¿›è¡Œæ¶ˆæ¯åˆ†å‘
</span><span class=c1>//ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œifé‡Œé¢çš„æµç¨‹
</span><span class=c1>//å°†æœªæ˜ å°„çš„Class å’Œ Super Classé‡æ˜ å°„ï¼Œè¢«remapçš„ç±»éƒ½æ˜¯æ‡’åŠ è½½çš„ç±»
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>noClassesRemapped</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span> <span class=o>*</span><span class=n>classrefs</span> <span class=o>=</span> <span class=n>_getObjc2ClassRefs</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span><span class=c1>//Mach-Oçš„é™æ€æ®µ __objc_classrefs
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>remapClassRef</span><span class=p>(</span><span class=o>&amp;</span><span class=n>classrefs</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        <span class=p>}</span>
        <span class=c1>// fixme why doesn&#39;t test future1 catch the absence of this?
</span><span class=c1></span>        <span class=n>classrefs</span> <span class=o>=</span> <span class=n>_getObjc2SuperRefs</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span><span class=c1>//Mach_Oä¸­çš„é™æ€æ®µ __objc_superrefs
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>remapClassRef</span><span class=p>(</span><span class=o>&amp;</span><span class=n>classrefs</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h5 id=ä¿®å¤ä¸€äº›æ¶ˆæ¯><a href=#ä¿®å¤ä¸€äº›æ¶ˆæ¯ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä¿®å¤ä¸€äº›æ¶ˆæ¯</h5><p>é€šè¿‡<code>_getObjc2MessageRefs</code>è·å–åˆ°é™æ€æ®µ<code>__objc_selrefs</code>ï¼Œ<code>fixupMessageRef</code>éå†å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#if SUPPORT_FIXUP
</span><span class=cp></span>    <span class=c1>// Fix up old objc_msgSend_fixup call sites
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// _getObjc2MessageRefs è·å–Mach-Oçš„é™æ€æ®µ __objc_msgrefs
</span><span class=c1></span>        <span class=n>message_ref_t</span> <span class=o>*</span><span class=n>refs</span> <span class=o>=</span> <span class=n>_getObjc2MessageRefs</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>PrintVtables</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;VTABLES: repairing %zu unsupported vtable dispatch &#34;</span>
                         <span class=s>&#34;call sites in %s&#34;</span><span class=p>,</span> <span class=n>count</span><span class=p>,</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>fname</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=c1>//ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œforé‡Œé¢çš„æµç¨‹
</span><span class=c1></span>        <span class=c1>//éå†å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>fixupMessageRef</span><span class=p>(</span><span class=n>refs</span><span class=o>+</span><span class=n>i</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>ts</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;IMAGE TIMES: fix up objc_msgSend_fixup&#34;</span><span class=p>);</span>
<span class=cp>#endif
</span></code></pre></div><h5 id=å½“ç±»é‡Œé¢æœ‰åè®®æ—¶readprotocol-è¯»å–åè®®><a href=#å½“ç±»é‡Œé¢æœ‰åè®®æ—¶readprotocol-è¯»å–åè®® class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å½“ç±»é‡Œé¢æœ‰åè®®æ—¶ï¼šreadProtocol è¯»å–åè®®</h5><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Discover protocols. Fix up protocol refs. å‘ç°åè®®ã€‚ä¿®æ­£åè®®å‚è€ƒ
</span><span class=c1>//éå†æ‰€æœ‰åè®®åˆ—è¡¨ï¼Œå¹¶ä¸”å°†åè®®åˆ—è¡¨åŠ è½½åˆ°Protocolçš„å“ˆå¸Œè¡¨ä¸­
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>extern</span> <span class=n>objc_class</span> <span class=n>OBJC_CLASS_</span><span class=err>$</span><span class=n>_Protocol</span><span class=p>;</span>
    <span class=c1>//cls = Protocolç±»ï¼Œæ‰€æœ‰åè®®å’Œå¯¹è±¡çš„ç»“æ„ä½“éƒ½ç±»ä¼¼ï¼Œisaéƒ½å¯¹åº”Protocolç±»
</span><span class=c1></span>    <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=p>)</span><span class=o>&amp;</span><span class=n>OBJC_CLASS_</span><span class=err>$</span><span class=n>_Protocol</span><span class=p>;</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=c1>//è·å–protocolå“ˆå¸Œè¡¨ -- protocol_map
</span><span class=c1></span>    <span class=n>NXMapTable</span> <span class=o>*</span><span class=n>protocol_map</span> <span class=o>=</span> <span class=n>protocols</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=n>isPreoptimized</span> <span class=o>=</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>hasPreoptimizedProtocols</span><span class=p>();</span>

    <span class=c1>// Skip reading protocols if this is an image from the shared cache
</span><span class=c1></span>    <span class=c1>// and we support roots
</span><span class=c1></span>    <span class=c1>// Note, after launch we do need to walk the protocol as the protocol
</span><span class=c1></span>    <span class=c1>// in the shared cache is marked with isCanonical() and that may not
</span><span class=c1></span>    <span class=c1>// be true if some non-shared cache binary was chosen as the canonical
</span><span class=c1></span>    <span class=c1>// definition
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>launchTime</span> <span class=o>&amp;&amp;</span> <span class=n>isPreoptimized</span> <span class=o>&amp;&amp;</span> <span class=n>cacheSupportsProtocolRoots</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>PrintProtocols</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;PROTOCOLS: Skipping reading protocols in image: %s&#34;</span><span class=p>,</span>
                         <span class=n>hi</span><span class=o>-&gt;</span><span class=n>fname</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>bool</span> <span class=n>isBundle</span> <span class=o>=</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>isBundle</span><span class=p>();</span>
    <span class=c1>//é€šè¿‡_getObjc2ProtocolList è·å–åˆ°Mach-Oä¸­çš„é™æ€æ®µ__objc_protoliståè®®åˆ—è¡¨ï¼Œ
</span><span class=c1></span>    <span class=c1>//å³ä»ç¼–è¯‘å™¨ä¸­è¯»å–å¹¶åˆå§‹åŒ–protocol
</span><span class=c1></span>    <span class=n>protocol_t</span> <span class=o>*</span> <span class=k>const</span> <span class=o>*</span><span class=n>protolist</span> <span class=o>=</span> <span class=n>_getObjc2ProtocolList</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>//é€šè¿‡æ·»åŠ protocolåˆ°protocol_mapå“ˆå¸Œè¡¨ä¸­
</span><span class=c1></span>        <span class=n>readProtocol</span><span class=p>(</span><span class=n>protolist</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>cls</span><span class=p>,</span> <span class=n>protocol_map</span><span class=p>,</span> 
                     <span class=n>isPreoptimized</span><span class=p>,</span> <span class=n>isBundle</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>é€šè¿‡<code>protocols()</code>åˆ›å»º<code>protocol_map</code>å“ˆå¸Œè¡¨</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* protocols
</span><span class=cm>* Returns the protocol name =&gt; protocol map for protocols.
</span><span class=cm>* Locking: runtimeLock must read- or write-locked by the caller
</span><span class=cm>**********************************************************************/</span>
<span class=k>static</span> <span class=n>NXMapTable</span> <span class=o>*</span><span class=nf>protocols</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>static</span> <span class=n>NXMapTable</span> <span class=o>*</span><span class=n>protocol_map</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
      
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
  
    <span class=n>INIT_ONCE_PTR</span><span class=p>(</span><span class=n>protocol_map</span><span class=p>,</span> 
                  <span class=n>NXCreateMapTable</span><span class=p>(</span><span class=n>NXStrValueMapPrototype</span><span class=p>,</span> <span class=mi>16</span><span class=p>),</span> 
                  <span class=n>NXFreeMapTable</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>);</span>
  
    <span class=k>return</span> <span class=n>protocol_map</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></li><li><p>é€šè¿‡<code>_getObjc2ProtocolList</code>è·å–åˆ°Mach-Oä¸­çš„é™æ€æ®µ<code>__objc_protolist</code>åè®®åˆ—è¡¨</p></li><li><p>å¾ªç¯éå†åè®®åˆ—è¡¨ï¼Œé€šè¿‡<code>readProtocol</code>æ–¹æ³•å°†åè®®æ·»åŠ åˆ°<code>protocol_map</code>å“ˆå¸Œè¡¨ä¸­</p></li></ul><h5 id=ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®><a href=#ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®® class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®</h5><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Fix up @protocol references
</span><span class=c1>// Preoptimized images may have the right 
</span><span class=c1>// answer already but we don&#39;t know for sure.
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// At launch time, we know preoptimized image refs are pointing at the
</span><span class=c1></span>    <span class=c1>// shared cache definition of a protocol.  We can skip the check on
</span><span class=c1></span>    <span class=c1>// launch, but have to visit @protocol refs for shared cache images
</span><span class=c1></span>    <span class=c1>// loaded later.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>launchTime</span> <span class=o>&amp;&amp;</span> <span class=n>cacheSupportsProtocolRoots</span> <span class=o>&amp;&amp;</span> <span class=n>hi</span><span class=o>-&gt;</span><span class=n>isPreoptimized</span><span class=p>())</span>
        <span class=k>continue</span><span class=p>;</span>
    <span class=c1>//_getObjc2ProtocolRefs è·å–åˆ°Mach-Oçš„é™æ€æ®µ __objc_protorefs
</span><span class=c1></span>    <span class=n>protocol_t</span> <span class=o>**</span><span class=n>protolist</span> <span class=o>=</span> <span class=n>_getObjc2ProtocolRefs</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=c1>//éå†
</span><span class=c1></span>        <span class=c1>//æ¯”è¾ƒå½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­çš„åŒä¸€ä¸ªå†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™æ›¿æ¢
</span><span class=c1></span>        <span class=n>remapProtocolRef</span><span class=p>(</span><span class=o>&amp;</span><span class=n>protolist</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=c1>//ç»è¿‡ä»£ç è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œ
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>é€šè¿‡ <code>_getObjc2ProtocolRefs</code> è·å–åˆ°Mach-Oçš„é™æ€æ®µ <code>__objc_protorefs</code></p><blockquote><p><em>ä¸Šé¢çš„_getObjc2ProtocolList</em>å¹¶ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿</p></blockquote></li><li><p>éå†é€šè¿‡<code>remapProtocolRef</code>ä¿®å¤åè®®ï¼Œ<code>remapProtocolRef</code>æ¯”è¾ƒ<code>å½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­çš„åŒä¸€ä¸ªå†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒ</code>ï¼Œå¦‚æœ<code>ä¸åŒåˆ™æ›¿æ¢</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cm>/***********************************************************************
</span><span class=cm>* remapProtocolRef
</span><span class=cm>* Fix up a protocol ref, in case the protocol referenced has been reallocated.
</span><span class=cm>* Locking: runtimeLock must be read- or write-locked by the caller
</span><span class=cm>**********************************************************************/</span>
<span class=k>static</span> <span class=n>size_t</span> <span class=n>UnfixedProtocolReferences</span><span class=p>;</span>
<span class=k>static</span> <span class=kt>void</span> <span class=nf>remapProtocolRef</span><span class=p>(</span><span class=n>protocol_t</span> <span class=o>**</span><span class=n>protoref</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
    <span class=c1>//è·å–åè®®åˆ—è¡¨ä¸­ç»Ÿä¸€å†…å­˜åœ°å€çš„åè®®
</span><span class=c1></span>    <span class=n>protocol_t</span> <span class=o>*</span><span class=n>newproto</span> <span class=o>=</span> <span class=n>remapProtocol</span><span class=p>((</span><span class=n>protocol_ref_t</span><span class=p>)</span><span class=o>*</span><span class=n>protoref</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>protoref</span> <span class=o>!=</span> <span class=n>newproto</span><span class=p>)</span> <span class=p>{</span><span class=c1>//å¦‚æœå½“å‰åè®® ä¸ åŒä¸€å†…å­˜åœ°å€åè®®ä¸åŒï¼Œåˆ™æ›¿æ¢
</span><span class=c1></span>        <span class=o>*</span><span class=n>protoref</span> <span class=o>=</span> <span class=n>newproto</span><span class=p>;</span>
        <span class=n>UnfixedProtocolReferences</span><span class=o>++</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li></ul><h5 id=åˆ†ç±»å¤„ç†><a href=#åˆ†ç±»å¤„ç† class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>åˆ†ç±»å¤„ç†</h5><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Discover categories. Only do this after the initial category
</span><span class=c1>// attachment has been done. For categories present at startup,
</span><span class=c1>// discovery is deferred until the first load_images call after
</span><span class=c1>// the call to _dyld_objc_notify_register completes. rdar://problem/53119145
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>didInitialAttachCategories</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>load_categories_nolock</span><span class=p>(</span><span class=n>hi</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>é€šè¿‡æ³¨é‡Šå¯çŸ¥ï¼šéœ€è¦åœ¨åˆ†ç±»åˆå§‹åŒ–å¹¶å°†æ•°æ®åŠ è½½åˆ°ç±»åæ‰æ‰§è¡Œï¼Œå¯¹äºè¿è¡Œæ—¶å‡ºç°çš„åˆ†ç±»ï¼Œå°†åˆ†ç±»çš„å‘ç°æ¨è¿Ÿåˆ°å¯¹<code>_dyld_objc_notify_register</code>çš„è°ƒç”¨å®Œæˆåçš„<code>ç¬¬ä¸€ä¸ªload_images</code>è°ƒç”¨ä¸ºæ­¢</p><h5 id=ç±»çš„åŠ è½½å¤„ç†><a href=#ç±»çš„åŠ è½½å¤„ç† class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»çš„åŠ è½½å¤„ç†</h5><p>é¦–å…ˆï¼Œè‹¹æœå®˜æ–¹å¯¹äºéæ‡’åŠ è½½ç±»çš„å®šä¹‰æ˜¯</p><blockquote><p>NonlazyClass is all about a class implementing or not a +load method.</p></blockquote><p>å³å®ç°<code>+load</code>æ–¹æ³•çš„ç±»æ˜¯éæ‡’åŠ è½½ç±»ï¼Œå¦åˆ™å°±æ˜¯æ‡’åŠ è½½ç±»</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œçš„ç±»æ­£æ˜¯<code>éæ‡’åŠ è½½ç±»</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Realize non-lazy classes (for +load methods and static instances) 
</span><span class=c1>// å®ç°éæ‡’åŠ è½½çš„ç±»ï¼Œå¯¹äºloadæ–¹æ³•å’Œé™æ€å®ä¾‹å˜é‡
</span><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=n>EACH_HEADER</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>//é€šè¿‡_getObjc2NonlazyClassListè·å–Mach-Oçš„é™æ€æ®µ__objc_nlclslistéæ‡’åŠ è½½ç±»è¡¨
</span><span class=c1></span>    <span class=n>classref_t</span> <span class=k>const</span> <span class=o>*</span><span class=n>classlist</span> <span class=o>=</span> 
        <span class=n>_getObjc2NonlazyClassList</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>count</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=n>remapClass</span><span class=p>(</span><span class=n>classlist</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        
        <span class=cm>/** ä¸ºæ¢ç´¢è‡ªå·±å®šä¹‰çš„ç±»ï¼Œè¾…åŠ©ä»£ç 
</span><span class=cm>         const char *mangledName  = cls-&gt;mangledName();
</span><span class=cm>         const char *PersonName = &#34;Person&#34;;
</span><span class=cm>
</span><span class=cm>         if (strcmp(mangledName, PersonName) == 0) {
</span><span class=cm>             auto kc_ro = (const class_ro_t *)cls-&gt;data();
</span><span class=cm>             printf(&#34;_getObjc2NonlazyClassList: è¿™ä¸ªæ˜¯æˆ‘è¦ç ”ç©¶çš„ %s \n&#34;, PersonName);
</span><span class=cm>         }
</span><span class=cm>         **/</span>
      
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>

        <span class=n>addClassTableEntry</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=c1>//æ’å…¥è¡¨ï¼Œä½†æ˜¯å‰é¢å·²ç»æ’å…¥è¿‡äº†ï¼Œæ‰€ä»¥ä¸ä¼šé‡æ–°æ’å…¥
</span><span class=c1></span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isSwiftStable</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>swiftMetadataInitializer</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;Swift class %s with a metadata initializer &#34;</span>
                            <span class=s>&#34;is not allowed to be non-lazy&#34;</span><span class=p>,</span>
                            <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
            <span class=p>}</span>
            <span class=c1>// fixme also disallow relocatable classes
</span><span class=c1></span>            <span class=c1>// We can&#39;t disallow all Swift classes because of
</span><span class=c1></span>            <span class=c1>// classes like Swift.__EmptyArrayStorage
</span><span class=c1></span>        <span class=p>}</span>
        <span class=c1>//å®ç°å½“å‰çš„ç±»ï¼Œå› ä¸ºå‰é¢readClassè¯»å–åˆ°å†…å­˜çš„ä»…ä»…åªæœ‰åœ°å€+åç§°ï¼Œç±»çš„dataæ•°æ®å¹¶æ²¡æœ‰åŠ è½½å‡ºæ¥
</span><span class=c1></span>        <span class=c1>//å®ç°æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»(å®ä¾‹åŒ–ç±»å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚rw)
</span><span class=c1></span>        <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>nil</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>éæ‡’åŠ è½½ç±»çš„åŠ è½½æµç¨‹ï¼š</p><ul><li><code>_getObjc2NonlazyClassList</code>è·å–Mach-Oçš„é™æ€æ®µ<code>__objc_nlclslist</code>éæ‡’åŠ è½½ç±»è¡¨</li><li><code>addClassTableEntry</code>å†åŠ è½½ä¸€éâ€”â€”å¦‚æœå·²æ·»åŠ å°±ä¸ä¼šæ·»åŠ è¿›å»ï¼Œç¡®ä¿æ•´ä¸ªç»“æ„éƒ½è¢«æ·»åŠ </li><li><code>realizeClassWithoutSwift</code>å®ç°å½“å‰çš„ç±»ï¼ŒåŠ è½½ç±»çš„<code>data</code>æ•°æ®ï¼Œåœ¨<strong>ç±»çš„é‡æ˜ å°„</strong>ä¸­<code>readClass</code>åªåŠ è½½<code>åœ°å€+ç±»å</code></li></ul><h5 id=æ²¡æœ‰è¢«å¤„ç†çš„ç±»ä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±»><a href=#æ²¡æœ‰è¢«å¤„ç†çš„ç±»ä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±»</h5><p>ä¸»è¦æ˜¯å®ç°æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–è¢«ä¾µçŠ¯çš„ç±»</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// Realize newly-resolved future classes, in case CF manipulates them
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>resolvedFutureClasses</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>resolvedFutureClassCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Class</span> <span class=n>cls</span> <span class=o>=</span> <span class=n>resolvedFutureClasses</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isSwiftStable</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;Swift class is not allowed to be future&#34;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=c1>//å®ç°ç±»
</span><span class=c1></span>        <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>nil</span><span class=p>);</span>
        <span class=n>cls</span><span class=o>-&gt;</span><span class=n>setInstancesRequireRawIsaRecursively</span><span class=p>(</span><span class=nb>false</span><span class=cm>/*inherited*/</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>free</span><span class=p>(</span><span class=n>resolvedFutureClasses</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>ts</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=s>&#34;IMAGE TIMES: realize future classes&#34;</span><span class=p>);</span>

<span class=k>if</span> <span class=p>(</span><span class=n>DebugNonFragileIvars</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>//å®ç°æ‰€æœ‰ç±»
</span><span class=c1></span>    <span class=n>realizeAllClasses</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><h3 id=readclass><a href=#readclass class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>readClass</h3><p>åœ¨æ‰§è¡Œ<code>readClass</code>ä¹‹å‰ï¼Œ<code>cls</code>åªæ˜¯ä¸€ä¸ªåœ°å€ï¼Œè€Œç»è¿‡è¯¥å‡½æ•°ï¼Œ<code>cls</code>åˆ™æˆä¸ºäº†ä¸€ä¸ªç±»çš„åç§°ï¼Œé‚£ä¹ˆ <code>realClass</code> å…·ä½“æ˜¯åšäº†ä»€ä¹ˆ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>Class</span> <span class=nf>readClass</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>headerIsBundle</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>headerIsPreoptimized</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>mangledName</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>mangledName</span><span class=p>();</span>
    <span class=c1>// å½“å‰ç±»çš„çˆ¶ç±»ä¸­å­˜åœ¨ä¸¢å¤±çš„ weak-linked ç±»
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>missingWeakSuperclass</span><span class=p>(</span><span class=n>cls</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// No superclass (probably weak-linked). 
</span><span class=c1></span>        <span class=c1>// Disavow any knowledge of this subclass.
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>PrintConnecting</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>_objc_inform</span><span class=p>(</span><span class=s>&#34;CLASS: IGNORING class &#39;%s&#39; with &#34;</span>
                         <span class=s>&#34;missing weak-linked superclass&#34;</span><span class=p>,</span> 
                         <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=n>addRemappedClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>nil</span><span class=p>);</span>
        <span class=n>cls</span><span class=o>-&gt;</span><span class=n>superclass</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>nil</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=n>cls</span><span class=o>-&gt;</span><span class=n>fixupBackwardDeployingStableSwift</span><span class=p>();</span>

    <span class=n>Class</span> <span class=n>replacing</span> <span class=o>=</span> <span class=n>nil</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Class</span> <span class=n>newCls</span> <span class=o>=</span> <span class=n>popFutureNamedClass</span><span class=p>(</span><span class=n>mangledName</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// This name was previously allocated as a future class.
</span><span class=c1></span>        <span class=c1>// Copy objc_class to future class&#39;s struct.
</span><span class=c1></span>        <span class=c1>// Preserve future&#39;s rw data block.
</span><span class=c1></span>        
        <span class=k>if</span> <span class=p>(</span><span class=n>newCls</span><span class=o>-&gt;</span><span class=n>isAnySwift</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;Can&#39;t complete future class request for &#39;%s&#39; &#34;</span>
                        <span class=s>&#34;because the real class is too big.&#34;</span><span class=p>,</span> 
                        <span class=n>cls</span><span class=o>-&gt;</span><span class=n>nameForLogging</span><span class=p>());</span>
        <span class=p>}</span>
        
        <span class=n>class_rw_t</span> <span class=o>*</span><span class=n>rw</span> <span class=o>=</span> <span class=n>newCls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>();</span>
        <span class=k>const</span> <span class=n>class_ro_t</span> <span class=o>*</span><span class=n>old_ro</span> <span class=o>=</span> <span class=n>rw</span><span class=o>-&gt;</span><span class=n>ro</span><span class=p>();</span>
        <span class=n>memcpy</span><span class=p>(</span><span class=n>newCls</span><span class=p>,</span> <span class=n>cls</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>objc_class</span><span class=p>));</span>
        <span class=n>rw</span><span class=o>-&gt;</span><span class=n>set_ro</span><span class=p>((</span><span class=n>class_ro_t</span> <span class=o>*</span><span class=p>)</span><span class=n>newCls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>());</span>
        <span class=n>newCls</span><span class=o>-&gt;</span><span class=n>setData</span><span class=p>(</span><span class=n>rw</span><span class=p>);</span>
        <span class=n>freeIfMutable</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>old_ro</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
        <span class=n>free</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>old_ro</span><span class=p>);</span>
        
        <span class=n>addRemappedClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>newCls</span><span class=p>);</span>
        
        <span class=n>replacing</span> <span class=o>=</span> <span class=n>cls</span><span class=p>;</span>
        <span class=n>cls</span> <span class=o>=</span> <span class=n>newCls</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=k>if</span> <span class=p>(</span><span class=n>headerIsPreoptimized</span>  <span class=o>&amp;&amp;</span>  <span class=o>!</span><span class=n>replacing</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// class list built in shared cache
</span><span class=c1></span>        <span class=c1>// fixme strict assert doesn&#39;t work because of duplicates
</span><span class=c1></span>        <span class=c1>// ASSERT(cls == getClass(name));
</span><span class=c1></span>        <span class=n>ASSERT</span><span class=p>(</span><span class=n>getClassExceptSomeSwift</span><span class=p>(</span><span class=n>mangledName</span><span class=p>));</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>addNamedClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>mangledName</span><span class=p>,</span> <span class=n>replacing</span><span class=p>);</span>
        <span class=n>addClassTableEntry</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// for future reference: shared cache never contains MH_BUNDLEs
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>headerIsBundle</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|=</span> <span class=n>RO_FROM_BUNDLE</span><span class=p>;</span>
        <span class=n>cls</span><span class=o>-&gt;</span><span class=n>ISA</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|=</span> <span class=n>RO_FROM_BUNDLE</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=k>return</span> <span class=n>cls</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><ul><li><p>å½“å‰ç±»çš„çˆ¶ç±»ä¸­å­˜åœ¨ä¸¢å¤±çš„ <code>weak-linked</code> ç±»ï¼Œåˆ™è¿”å› <code>nil</code></p></li><li><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šè¿›å…¥<code>popFutureNamedClass(mangledName)</code>åˆ¤æ–­ï¼Œè¿™æ˜¯ä¸“é—¨é’ˆå¯¹æœªæ¥çš„å¾…å¤„ç†çš„ç±»çš„ç‰¹æ®Šæ“ä½œ</p></li><li><p><code>addNamedClass</code>ï¼šå°†å½“å‰ç±»æ·»åŠ åˆ°å·²åˆ›å»ºçš„<code>gdb_objc_realized_classes</code>å“ˆå¸Œè¡¨ï¼ˆå­˜å‚¨ç±»ï¼‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>addNamedClass</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=n>Class</span> <span class=n>replacing</span> <span class=o>=</span> <span class=n>nil</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
    <span class=n>Class</span> <span class=n>old</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>old</span> <span class=o>=</span> <span class=n>getClassExceptSomeSwift</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>  <span class=o>&amp;&amp;</span>  <span class=n>old</span> <span class=o>!=</span> <span class=n>replacing</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>inform_duplicate</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>old</span><span class=p>,</span> <span class=n>cls</span><span class=p>);</span>
  
        <span class=c1>// getMaybeUnrealizedNonMetaClass uses name lookups.
</span><span class=c1></span>        <span class=c1>// Classes not found by name lookup must be in the
</span><span class=c1></span>        <span class=c1>// secondary meta-&gt;nonmeta table.
</span><span class=c1></span>        <span class=n>addNonMetaClass</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>NXMapInsert</span><span class=p>(</span><span class=n>gdb_objc_realized_classes</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>cls</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>RO_META</span><span class=p>));</span>
  
    <span class=c1>// wrong: constructed classes are already realized when they get here
</span><span class=c1></span>    <span class=c1>// ASSERT(!cls-&gt;isRealized());
</span><span class=c1></span><span class=p>}</span>
</code></pre></div></li><li><p><code>addClassTableEntry</code>ï¼šå½“å‰ç±»å·²ç»åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦æ·»åŠ åˆ°<code>allocatedClasses</code>å“ˆå¸Œè¡¨ï¼ˆruntime_initå‡½æ•°ä¸­åˆå§‹åŒ–ï¼‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span>
<span class=nf>addClassTableEntry</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>addMeta</span> <span class=o>=</span> <span class=nb>true</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
  
    <span class=c1>// This class is allowed to be a known class via the shared cache or via
</span><span class=c1></span>    <span class=c1>// data segments, but it is not allowed to be in the dynamic table already.
</span><span class=c1></span>    <span class=k>auto</span> <span class=o>&amp;</span><span class=n>set</span> <span class=o>=</span> <span class=n>objc</span><span class=o>::</span><span class=n>allocatedClasses</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
  
    <span class=n>ASSERT</span><span class=p>(</span><span class=n>set</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>cls</span><span class=p>)</span> <span class=o>==</span> <span class=n>set</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
  
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isKnownClass</span><span class=p>(</span><span class=n>cls</span><span class=p>))</span>
        <span class=n>set</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>addMeta</span><span class=p>)</span>
        <span class=n>addClassTableEntry</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>ISA</span><span class=p>(),</span> <span class=nb>false</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div></li></ul><p>é€šè¿‡ <code>readClass</code> å‡½æ•°ï¼Œå°† Mach-O ä¸­çš„ç±»è¯»å–åˆ°å†…å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯æ’å…¥ç›¸åº”çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯åªä¿å­˜ä¸¤ä¸ªä¿¡æ¯ï¼šåœ°å€å’Œåè¯ï¼Œå¹¶æ²¡æœ‰è¯»å–å¹¶åŠ è½½<code>data</code>æ•°æ®</p><h3 id=realizeclasswithoutswift><a href=#realizeclasswithoutswift class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>realizeClassWithoutSwift</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯ç±»åŠ è½½<code>data</code>æ•°æ®çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œä¸»è¦åŒ…å«å‡ ä¸ªæ“ä½œï¼š</p><ul><li>è¯»å–<code>data</code>æ•°æ®ï¼Œè®¾ç½®<code>roã€rw</code></li><li>é€’å½’è°ƒç”¨<code>realizeClassWithoutSwift</code>å®Œå–„<code>ç±»çš„ç»§æ‰¿é“¾</code></li><li>è°ƒç”¨<code>methodizeClass</code>ï¼Œå®Œå–„ç±»ä¿¡æ¯ï¼ˆæ–¹æ³•ã€åˆ†ç±»çš„æ–¹æ³•ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰</li></ul><h4 id=è¯»å–dataæ•°æ®><a href=#è¯»å–dataæ•°æ® class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>è¯»å–dataæ•°æ®</h4><p>è¯»å–ç±»çš„<code>data</code>æ•°æ®ï¼Œå¹¶å¼ºè½¬ä¸º<code>ro</code>ï¼Œç„¶ååˆå§‹åŒ–<code>rw</code>ï¼Œå°†<code>ro</code>æ‹·è´ä¸€ä»½åˆ°<code>rw</code>ä¸­çš„<code>ro</code></p><blockquote><p>å…³äº <code>ro</code> å’Œ <code>rw</code> ç»“æ„ï¼Œå¯ä»¥åœ¨<a href=../Class-structure>ã€iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„ç»“æ„åˆ†æã€</a>æŸ¥çœ‹</p></blockquote><ul><li><code>ro</code>è¡¨ç¤ºreadOnlyï¼Œæ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†å†…å­˜</li><li><code>rw</code>è¡¨ç¤º<code>readWrite</code>ï¼Œç”±äºå…¶åŠ¨æ€æ€§ï¼Œå¯èƒ½ä¼šå¾€ç±»ä¸­æ·»åŠ å±æ€§ã€æ–¹æ³•ã€æ·»åŠ åè®®</li></ul><blockquote><p>åœ¨<strong>WWDC 2020</strong>ä¸­å¯¹å†…å­˜ä¼˜åŒ–çš„è¯´æ˜ï¼š<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2020%2F10163%2F" target=_blank rel=noopener>Advancements in the Objective-C runtime - WWDC 2020 - Videos - Apple Developer</a></p><p>ç”±äº <code>rw</code> æ˜¯å­˜å‚¨è¿è¡Œæ—¶äº§ç”Ÿçš„æ•°æ®ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç±»éƒ½ä¼šåœ¨è¿è¡Œæ—¶ä¿®æ”¹ã€‚å› æ­¤ï¼Œåœ¨<code>class_rw_t</code> åŠ å…¥ <code>class_rw_ext_t</code>ç»“æ„ï¼Œå½“éœ€è¦æ—¶ï¼Œæ‰ä¼šåˆ†é…å†…å­˜</p><p>æ‰€ä»¥ï¼Œ<code>rw</code>å±äº<code>dirty memory</code>ï¼Œ<code>ro</code>å±äº<code>clean memory</code></p></blockquote><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// fixme verify class is not in an un-dlopened part of the shared cache?
</span><span class=c1>// ro -- clean memoryï¼Œåœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†å†…å­˜
</span><span class=c1></span><span class=k>auto</span> <span class=n>ro</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=n>class_ro_t</span> <span class=o>*</span><span class=p>)</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>();</span> <span class=c1>//è¯»å–ç±»ç»“æ„çš„bitså±æ€§
</span><span class=c1></span><span class=k>auto</span> <span class=n>isMeta</span> <span class=o>=</span> <span class=n>ro</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>RO_META</span><span class=p>;</span> <span class=c1>//åˆ¤æ–­å…ƒç±»
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>ro</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>RO_FUTURE</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// This was a future class. rw data is already allocated.
</span><span class=c1></span>    <span class=n>rw</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>();</span> <span class=c1>//dirty memory è¿›è¡Œèµ‹å€¼
</span><span class=c1></span>    <span class=n>ro</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>ro</span><span class=p>();</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=n>isMeta</span><span class=p>);</span>
    <span class=n>cls</span><span class=o>-&gt;</span><span class=n>changeInfo</span><span class=p>(</span><span class=n>RW_REALIZED</span><span class=o>|</span><span class=n>RW_REALIZING</span><span class=p>,</span> <span class=n>RW_FUTURE</span><span class=p>);</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span> 
    <span class=c1>// æ­¤æ—¶å°†æ•°æ®è¯»å–è¿›æ¥äº†ï¼Œä¹Ÿèµ‹å€¼å®Œæ¯•äº†
</span><span class=c1></span>    <span class=c1>// Normal class. Allocate writeable class data.
</span><span class=c1></span>    <span class=n>rw</span> <span class=o>=</span> <span class=n>objc</span><span class=o>::</span><span class=n>zalloc</span><span class=o>&lt;</span><span class=n>class_rw_t</span><span class=o>&gt;</span><span class=p>();</span> <span class=c1>// ç”³è¯·å¼€è¾Ÿzalloc -- rw
</span><span class=c1></span>    <span class=n>rw</span><span class=o>-&gt;</span><span class=n>set_ro</span><span class=p>(</span><span class=n>ro</span><span class=p>);</span><span class=c1>// rwä¸­çš„roè®¾ç½®ä¸ºä¸´æ—¶å˜é‡ro
</span><span class=c1></span>    <span class=n>rw</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>=</span> <span class=n>RW_REALIZED</span><span class=o>|</span><span class=n>RW_REALIZING</span><span class=o>|</span><span class=n>isMeta</span><span class=p>;</span>
    <span class=n>cls</span><span class=o>-&gt;</span><span class=n>setData</span><span class=p>(</span><span class=n>rw</span><span class=p>);</span><span class=c1>// å°†clsçš„dataèµ‹å€¼ä¸ºrwå½¢å¼
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><h4 id=é€’å½’è°ƒç”¨realizeclasswithoutswift><a href=#é€’å½’è°ƒç”¨realizeclasswithoutswift class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>é€’å½’è°ƒç”¨realizeClassWithoutSwift</h4><p>é€’å½’è°ƒç”¨<code>realizeClassWithoutSwift</code>å®Œå–„ç±»çš„ç»§æ‰¿é“¾ï¼Œå¹¶å¤„ç†å½“å‰ç±»ã€çˆ¶ç±»ã€å…ƒç±»</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>)</span> <span class=k>return</span> <span class=n>nil</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>())</span> <span class=k>return</span> <span class=n>cls</span><span class=p>;</span>
<span class=p>...</span>
<span class=n>supercls</span> <span class=o>=</span> <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>remapClass</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>superclass</span><span class=p>));</span>
<span class=n>metacls</span> <span class=o>=</span> <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>remapClass</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>ISA</span><span class=p>()));</span>
<span class=p>...</span>
<span class=c1>// Update superclass and metaclass in case of remapping
</span><span class=c1></span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>superclass</span> <span class=o>=</span> <span class=n>supercls</span><span class=p>;</span>
<span class=n>cls</span><span class=o>-&gt;</span><span class=n>initClassIsa</span><span class=p>(</span><span class=n>metacls</span><span class=p>);</span>
<span class=p>...</span>
<span class=c1>// Connect this class to its superclass&#39;s subclass lists
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>supercls</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>addSubclass</span><span class=p>(</span><span class=n>supercls</span><span class=p>,</span> <span class=n>cls</span><span class=p>);</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>addRootClass</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><ul><li><p><code>realizeClassWithoutSwift</code>é€’å½’è°ƒç”¨ï¼Œå½“ isa æ‰¾åˆ°æ ¹å…ƒç±»ä¹‹åï¼Œæ ¹å…ƒç±»çš„ isa æ˜¯æŒ‡å‘è‡ªå·±ï¼Œå¹¶ä¸ä¼šè¿”å› nil</p><ul><li>å¦‚æœç±»ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› nil</li><li>å¦‚æœç±»å·²ç»å®ç°ï¼Œåˆ™ç›´æ¥è¿”å›</li></ul></li><li><p>å¦‚æœæœ‰çˆ¶ç±»ï¼Œè°ƒç”¨<code>addSubclass</code>å°†å½“å‰ç±»æ·»åŠ ä¸ºçˆ¶ç±»çš„å­ç±»</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>addSubclass</span><span class=p>(</span><span class=n>Class</span> <span class=n>supercls</span><span class=p>,</span> <span class=n>Class</span> <span class=n>subcls</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
  
    <span class=k>if</span> <span class=p>(</span><span class=n>supercls</span>  <span class=o>&amp;&amp;</span>  <span class=n>subcls</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>supercls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>());</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>subcls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>());</span>
  
        <span class=n>objc_debug_realized_class_generation_count</span><span class=o>++</span><span class=p>;</span>
          
        <span class=n>subcls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>nextSiblingClass</span> <span class=o>=</span> <span class=n>supercls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>firstSubclass</span><span class=p>;</span>
        <span class=n>supercls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>firstSubclass</span> <span class=o>=</span> <span class=n>subcls</span><span class=p>;</span>
          
        <span class=p>...</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li></ul><h4 id=è°ƒç”¨methodizeclass><a href=#è°ƒç”¨methodizeclass class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>è°ƒç”¨methodizeClass</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> <span class=nf>methodizeClass</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>Class</span> <span class=n>previously</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>

    <span class=kt>bool</span> <span class=n>isMeta</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>isMetaClass</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>rw</span> <span class=o>=</span> <span class=n>cls</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>();</span> <span class=c1>// åˆå§‹åŒ–ä¸€ä¸ªrw
</span><span class=c1></span>    <span class=k>auto</span> <span class=n>ro</span> <span class=o>=</span> <span class=n>rw</span><span class=o>-&gt;</span><span class=n>ro</span><span class=p>();</span>
    <span class=k>auto</span> <span class=n>rwe</span> <span class=o>=</span> <span class=n>rw</span><span class=o>-&gt;</span><span class=n>ext</span><span class=p>();</span>
    
    <span class=p>...</span>

    <span class=c1>// Install methods and properties that the class implements itself.
</span><span class=c1></span>    <span class=c1>// æ·»åŠ æ–¹æ³•
</span><span class=c1></span>    <span class=n>method_list_t</span> <span class=o>*</span><span class=n>list</span> <span class=o>=</span> <span class=n>ro</span><span class=o>-&gt;</span><span class=n>baseMethods</span><span class=p>();</span><span class=c1>//è·å–roçš„baseMethods
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>list</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>prepareMethodLists</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>list</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>YES</span><span class=p>,</span> <span class=n>isBundleClass</span><span class=p>(</span><span class=n>cls</span><span class=p>));</span><span class=c1>//methodsè¿›è¡Œæ’åº
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>rwe</span><span class=p>)</span> <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>methods</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=o>&amp;</span><span class=n>list</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span><span class=c1>//å¯¹rweè¿›è¡Œå¤„ç†
</span><span class=c1></span>    <span class=p>}</span>
    <span class=c1>// åŠ å…¥å±æ€§
</span><span class=c1></span>    <span class=n>property_list_t</span> <span class=o>*</span><span class=n>proplist</span> <span class=o>=</span> <span class=n>ro</span><span class=o>-&gt;</span><span class=n>baseProperties</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rwe</span> <span class=o>&amp;&amp;</span> <span class=n>proplist</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>properties</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=o>&amp;</span><span class=n>proplist</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// åŠ å…¥åè®®
</span><span class=c1></span>    <span class=n>protocol_list_t</span> <span class=o>*</span><span class=n>protolist</span> <span class=o>=</span> <span class=n>ro</span><span class=o>-&gt;</span><span class=n>baseProtocols</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>rwe</span> <span class=o>&amp;&amp;</span> <span class=n>protolist</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>rwe</span><span class=o>-&gt;</span><span class=n>protocols</span><span class=p>.</span><span class=n>attachLists</span><span class=p>(</span><span class=o>&amp;</span><span class=n>protolist</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Root classes get bonus method implementations if they don&#39;t have 
</span><span class=c1></span>    <span class=c1>// them already. These apply before category replacements.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isRootMetaclass</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// root metaclass
</span><span class=c1></span>        <span class=n>addMethod</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=err>@</span><span class=n>selector</span><span class=p>(</span><span class=n>initialize</span><span class=p>),</span> <span class=p>(</span><span class=n>IMP</span><span class=p>)</span><span class=o>&amp;</span><span class=n>objc_noop_imp</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=n>NO</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Attach categories.
</span><span class=c1></span>    <span class=c1>// åŠ å…¥åˆ†ç±»ä¸­çš„æ–¹æ³•
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>previously</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isMeta</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>objc</span><span class=o>::</span><span class=n>unattachedCategories</span><span class=p>.</span><span class=n>attachToClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>previously</span><span class=p>,</span>
                                                     <span class=n>ATTACH_METACLASS</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// When a class relocates, categories with class methods
</span><span class=c1></span>            <span class=c1>// may be registered on the class itself rather than on
</span><span class=c1></span>            <span class=c1>// the metaclass. Tell attachToClass to look for those.
</span><span class=c1></span>            <span class=n>objc</span><span class=o>::</span><span class=n>unattachedCategories</span><span class=p>.</span><span class=n>attachToClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>previously</span><span class=p>,</span>
                                                     <span class=n>ATTACH_CLASS_AND_METACLASS</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>objc</span><span class=o>::</span><span class=n>unattachedCategories</span><span class=p>.</span><span class=n>attachToClass</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>cls</span><span class=p>,</span>
                                             <span class=n>isMeta</span> <span class=o>?</span> <span class=nl>ATTACH_METACLASS</span> <span class=p>:</span> <span class=n>ATTACH_CLASS</span><span class=p>);</span>
    <span class=p>....</span>
<span class=p>}</span>
</code></pre></div><p>æ ¹æ®æºç ï¼Œ<code>methodizeClass</code>ä¸»è¦æ˜¯ä»<code>ro</code>ä¸­è¯»å–<code>æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨</code>èµ‹å€¼ç»™<code>rw</code></p><p>ä¸‹é¢ä»¥æ·»åŠ æ–¹æ³•åˆ—è¡¨ä¸ºä¾‹</p><ul><li>è·å– <code>ro</code> çš„ <code>baseMethodList</code>ï¼Œå³æ–¹æ³•åˆ—è¡¨</li><li>è°ƒç”¨<code>prepareMethodLists</code>å¯¹æ–¹æ³•åˆ—è¡¨è¿›è¡Œæ’åº</li><li>è°ƒç”¨<code>rwe</code>ä¸­<code>methods</code>çš„<code>attachLists</code>æ’å…¥æ–¹æ³•</li></ul><p><strong>æ–¹æ³•æ’åº</strong></p><blockquote><p>åœ¨æ…¢é€ŸæŸ¥æ‰¾æµç¨‹ä¸­ï¼Œæ–¹æ³•çš„æŸ¥æ‰¾æ˜¯æ ¹æ®äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œå³<code>SEL-IMP</code>å­˜å‚¨æ˜¯æœ‰åºçš„</p><p>å…·ä½“æŸ¥æ‰¾è¿‡ç¨‹å¯åœ¨<a href=../message>ã€iOSåº•å±‚åŸç†æ¢ç´¢-æ¶ˆæ¯æŸ¥æ‰¾ã€</a>æŸ¥çœ‹</p></blockquote><p><code>prepareMethodLists</code>æ­£æ˜¯å°†ä» <code>ro</code> ä¸­è¯»å–åˆ°çš„æ–¹æ³•åˆ—è¡¨è¿›è¡Œæ’åºï¼Œæ’åºçš„å…³é”®å‡½æ•°æ˜¯<code>fixupMethodList</code>ï¼Œæ ¹æ®å‡½æ•°å®ç°ï¼Œä¸éš¾å‘ç°æ’åºçš„ä¾æ®ï¼š<code>selector address</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span> 
<span class=nf>prepareMethodLists</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>method_list_t</span> <span class=o>**</span><span class=n>addedLists</span><span class=p>,</span> <span class=kt>int</span> <span class=n>addedCount</span><span class=p>,</span>
                   <span class=kt>bool</span> <span class=n>baseMethods</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>methodsFromBundle</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>

    <span class=c1>// Add method lists to array.
</span><span class=c1></span>    <span class=c1>// Reallocate un-fixed method lists.
</span><span class=c1></span>    <span class=c1>// The new methods are PREPENDED to the method list array.
</span><span class=c1></span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>addedCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>method_list_t</span> <span class=o>*</span><span class=n>mlist</span> <span class=o>=</span> <span class=n>addedLists</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>mlist</span><span class=p>);</span>

        <span class=c1>// Fixup selectors if necessary
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isFixedUp</span><span class=p>())</span> <span class=p>{</span>
            <span class=n>fixupMethodList</span><span class=p>(</span><span class=n>mlist</span><span class=p>,</span> <span class=n>methodsFromBundle</span><span class=p>,</span> <span class=nb>true</span><span class=cm>/*sort*/</span><span class=p>);</span><span class=c1>//æ’åº
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>
    
    <span class=p>...</span>
<span class=p>}</span>

<span class=k>static</span> <span class=kt>void</span> 
<span class=nf>fixupMethodList</span><span class=p>(</span><span class=n>method_list_t</span> <span class=o>*</span><span class=n>mlist</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>bundleCopy</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>sort</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>runtimeLock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>
    <span class=n>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isFixedUp</span><span class=p>());</span>

    <span class=c1>// fixme lock less in attachMethodLists ?
</span><span class=c1></span>    <span class=c1>// dyld3 may have already uniqued, but not sorted, the list
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>isUniqued</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>mutex_locker_t</span> <span class=n>lock</span><span class=p>(</span><span class=n>selLock</span><span class=p>);</span>
    
        <span class=c1>// Unique selectors in list.
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>meth</span> <span class=p>:</span> <span class=o>*</span><span class=n>mlist</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span> <span class=o>=</span> <span class=n>sel_cname</span><span class=p>(</span><span class=n>meth</span><span class=p>.</span><span class=n>name</span><span class=p>);</span>
            <span class=n>meth</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>sel_registerNameNoLock</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>bundleCopy</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// Sort by selector address.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>sort</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>method_t</span><span class=o>::</span><span class=n>SortBySELAddress</span> <span class=n>sorter</span><span class=p>;</span>
        <span class=n>std</span><span class=o>::</span><span class=n>stable_sort</span><span class=p>(</span><span class=n>mlist</span><span class=o>-&gt;</span><span class=n>begin</span><span class=p>(),</span> <span class=n>mlist</span><span class=o>-&gt;</span><span class=n>end</span><span class=p>(),</span> <span class=n>sorter</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=c1>// Mark method list as uniqued and sorted
</span><span class=c1></span>    <span class=n>mlist</span><span class=o>-&gt;</span><span class=n>setFixedUp</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p><strong>attachLists</strong></p><p>æ–¹æ³•ã€å±æ€§ã€åè®®éƒ½æ˜¯ç›´æ¥é€šè¿‡<code>attachLists</code>æ’å…¥çš„ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸‰è€…çš„æ•°æ®ç»“æ„éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯äºŒç»´æ•°ç»„</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>struct</span> <span class=nc>method_list_t</span> <span class=o>:</span> <span class=n>entsize_list_tt</span><span class=o>&lt;</span><span class=n>method_t</span><span class=p>,</span> <span class=n>method_list_t</span><span class=p>,</span> <span class=mh>0x3</span><span class=o>&gt;</span> 

<span class=k>struct</span> <span class=nc>property_list_t</span> <span class=o>:</span> <span class=n>entsize_list_tt</span><span class=o>&lt;</span><span class=n>property_t</span><span class=p>,</span> <span class=n>property_list_t</span><span class=p>,</span> <span class=mi>0</span><span class=o>&gt;</span> 

<span class=k>struct</span> <span class=nc>protocol_list_t</span> <span class=p>{</span>
    <span class=c1>// count is pointer-sized by accident.
</span><span class=c1></span>    <span class=n>uintptr_t</span> <span class=n>count</span><span class=p>;</span>
    <span class=n>protocol_ref_t</span> <span class=n>list</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// variable-size
</span><span class=c1></span>
    <span class=n>size_t</span> <span class=nf>byteSize</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=k>this</span><span class=p>)</span> <span class=o>+</span> <span class=n>count</span><span class=o>*</span><span class=k>sizeof</span><span class=p>(</span><span class=n>list</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
    <span class=p>}</span>

    <span class=n>protocol_list_t</span> <span class=o>*</span><span class=nf>duplicate</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>protocol_list_t</span> <span class=o>*</span><span class=p>)</span><span class=n>memdup</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>byteSize</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p>å†æ¥çœ‹ä¸€ä¸‹å…·ä½“æ’å…¥æ“ä½œ</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>attachLists</span><span class=p>(</span><span class=n>List</span><span class=o>*</span> <span class=k>const</span> <span class=o>*</span> <span class=n>addedLists</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>addedCount</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>addedCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>hasArray</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// many lists -&gt; many lists
</span><span class=c1></span>        <span class=c1>//è®¡ç®—æ•°ç»„ä¸­æ—§listsçš„å¤§å°
</span><span class=c1></span>        <span class=kt>uint32_t</span> <span class=n>oldCount</span> <span class=o>=</span> <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>count</span><span class=p>;</span>
        <span class=c1>//è®¡ç®—æ–°çš„å®¹é‡å¤§å° = æ—§æ•°æ®å¤§å°+æ–°æ•°æ®å¤§å°
</span><span class=c1></span>        <span class=kt>uint32_t</span> <span class=n>newCount</span> <span class=o>=</span> <span class=n>oldCount</span> <span class=o>+</span> <span class=n>addedCount</span><span class=p>;</span>
        <span class=c1>//æ ¹æ®æ–°çš„å®¹é‡å¤§å°ï¼Œå¼€è¾Ÿä¸€ä¸ªæ•°ç»„ï¼Œç±»å‹æ˜¯ array_tï¼Œé€šè¿‡array()è·å–
</span><span class=c1></span>        <span class=n>setArray</span><span class=p>((</span><span class=n>array_t</span> <span class=o>*</span><span class=p>)</span><span class=n>realloc</span><span class=p>(</span><span class=n>array</span><span class=p>(),</span> <span class=n>array_t</span><span class=o>::</span><span class=n>byteSize</span><span class=p>(</span><span class=n>newCount</span><span class=p>)));</span>
        <span class=c1>//è®¾ç½®æ•°ç»„å¤§å°
</span><span class=c1></span>        <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>count</span> <span class=o>=</span> <span class=n>newCount</span><span class=p>;</span>
        <span class=c1>//æ—§çš„æ•°æ®ä» addedCount æ•°ç»„ä¸‹æ ‡å¼€å§‹ å­˜æ”¾æ—§çš„listsï¼Œå¤§å°ä¸º æ—§æ•°æ®å¤§å° * å•ä¸ªæ—§listå¤§å°
</span><span class=c1></span>        <span class=n>memmove</span><span class=p>(</span><span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span> <span class=o>+</span> <span class=n>addedCount</span><span class=p>,</span> <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>,</span> 
                <span class=n>oldCount</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>[</span><span class=mi>0</span><span class=p>]));</span>
        <span class=c1>//æ–°æ•°æ®ä»æ•°ç»„ é¦–ä½ç½®å¼€å§‹å­˜å‚¨ï¼Œå­˜æ”¾æ–°çš„listsï¼Œå¤§å°ä¸º æ–°æ•°æ®å¤§å° * å•ä¸ªlistå¤§å°
</span><span class=c1></span>        <span class=n>memcpy</span><span class=p>(</span>
               <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>,</span> <span class=n>addedLists</span><span class=p>,</span> 
               <span class=n>addedCount</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>[</span><span class=mi>0</span><span class=p>]));</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>list</span>  <span class=o>&amp;&amp;</span>  <span class=n>addedCount</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 0 lists -&gt; 1 list
</span><span class=c1></span>        <span class=n>list</span> <span class=o>=</span> <span class=n>addedLists</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span><span class=c1>//å°†liståŠ å…¥mlistsçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶çš„listæ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„
</span><span class=c1></span>    <span class=p>}</span> 
    <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 1 list -&gt; many lists æœ‰äº†ä¸€ä¸ªlistï¼Œæœ‰å¾€é‡ŒåŠ å¾ˆå¤šlist
</span><span class=c1></span>        <span class=c1>//è·å–æ—§çš„list
</span><span class=c1></span>        <span class=n>List</span><span class=o>*</span> <span class=n>oldList</span> <span class=o>=</span> <span class=n>list</span><span class=p>;</span>
        <span class=kt>uint32_t</span> <span class=n>oldCount</span> <span class=o>=</span> <span class=n>oldList</span> <span class=o>?</span> <span class=mi>1</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
        <span class=c1>//è®¡ç®—å®¹é‡å’Œ = æ—§listä¸ªæ•°+æ–°listsçš„ä¸ªæ•°
</span><span class=c1></span>        <span class=kt>uint32_t</span> <span class=n>newCount</span> <span class=o>=</span> <span class=n>oldCount</span> <span class=o>+</span> <span class=n>addedCount</span><span class=p>;</span>
        <span class=c1>//å¼€è¾Ÿä¸€ä¸ªå®¹é‡å’Œå¤§å°çš„é›†åˆï¼Œç±»å‹æ˜¯ array_tï¼Œå³åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ”¾åˆ°arrayä¸­ï¼Œé€šè¿‡array()è·å–
</span><span class=c1></span>        <span class=n>setArray</span><span class=p>((</span><span class=n>array_t</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>array_t</span><span class=o>::</span><span class=n>byteSize</span><span class=p>(</span><span class=n>newCount</span><span class=p>)));</span>
        <span class=c1>//è®¾ç½®æ•°ç»„çš„å¤§å°
</span><span class=c1></span>        <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>count</span> <span class=o>=</span> <span class=n>newCount</span><span class=p>;</span>
        <span class=c1>//åˆ¤æ–­oldæ˜¯å¦å­˜åœ¨ï¼Œoldè‚¯å®šæ˜¯å­˜åœ¨çš„ï¼Œå°†æ—§çš„listæ”¾å…¥åˆ°æ•°ç»„çš„æœ«å°¾
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>oldList</span><span class=p>)</span> <span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>[</span><span class=n>addedCount</span><span class=p>]</span> <span class=o>=</span> <span class=n>oldList</span><span class=p>;</span>
        <span class=c1>// memcpyï¼ˆå¼€å§‹ä½ç½®ï¼Œæ”¾ä»€ä¹ˆï¼Œæ”¾å¤šå¤§ï¼‰ æ˜¯å†…å­˜å¹³ç§»ï¼Œä»æ•°ç»„èµ·å§‹ä½ç½®å­˜å…¥æ–°çš„list
</span><span class=c1></span>        <span class=c1>//å…¶ä¸­array()-&gt;lists è¡¨ç¤ºé¦–ä½å…ƒç´ ä½ç½®
</span><span class=c1></span>        <span class=n>memcpy</span><span class=p>(</span><span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>,</span> <span class=n>addedLists</span><span class=p>,</span> 
               <span class=n>addedCount</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>array</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>lists</span><span class=p>[</span><span class=mi>0</span><span class=p>]));</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>ä¸éš¾çœ‹å‡ºï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><ul><li>ï¼ˆå¤šå¯¹å¤šï¼‰ï¼šå¦‚æœå½“å‰è°ƒç”¨<code>attachLists</code>çš„<code>list_array_tt</code>äºŒç»´æ•°ç»„ä¸­æœ‰å¤šä¸ªä¸€ç»´æ•°ç»„<ul><li>è®¡ç®—åŸæ¥çš„å®¹é‡ï¼Œå³<code>oldCount</code></li><li>è®¡ç®—æ–°çš„å®¹é‡ = <code>oldCount</code> + <code>addedCount</code></li><li><code>realloc</code>å¯¹å®¹å™¨è¿›è¡Œé‡æ–°åˆ†é…å¤§å°</li><li>é€šè¿‡<code>memmove</code>å°†åŸæ¥çš„æ•°æ®ç§»åŠ¨è‡³å®¹å™¨çš„æœ«å°¾</li><li>å°†æ–°çš„æ•°æ®<code>memcpy</code>æ‹·è´åˆ°å®¹å™¨çš„èµ·å§‹ä½ç½®</li></ul></li><li>ï¼ˆé›¶å¤šä¸€ï¼‰ï¼šå¦‚æœè°ƒç”¨<code>attachLists</code>çš„<code>list_array_tt</code>äºŒç»´æ•°ç»„ä¸ºç©ºä¸”æ–°å¢å¤§å°æ•°ç›®ä¸º 1<ul><li>ç›´æ¥èµ‹å€¼<code>attachLists</code>çš„ç¬¬ä¸€ä¸ª<code>list</code></li></ul></li><li>ï¼ˆä¸€å¯¹å¤šï¼‰ï¼šå¦‚æœå½“å‰è°ƒç”¨<code>attachLists</code>çš„<code>list_array_tt</code>äºŒç»´æ•°ç»„åªæœ‰ä¸€ä¸ªä¸€ç»´æ•°ç»„<ul><li>è·å–æ—§çš„list</li><li>è®¡ç®—æ–°çš„å®¹é‡ = <code>oldCount</code> + <code>addedCount</code></li><li><code>malloc</code>å¼€è¾Ÿæ–°çš„å†…å­˜ï¼Œå¤§å°ä¸ºæ–°çš„å®¹é‡å’Œ</li><li>ç›´æ¥å°†<code>æ—§lists</code>èµ‹å€¼åˆ°<code>æ–°array()</code>æœ€åä¸€ä¸ªä½ç½®</li><li>æŠŠæ–°çš„æ•°æ®<code>memcpy</code>æ‹·è´åˆ°å®¹å™¨çš„èµ·å§‹ä½ç½®</li></ul></li></ul><blockquote><p><code>memmove</code>å’Œ<code>memcpy</code>çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li>åœ¨ä¸çŸ¥é“éœ€è¦å¹³ç§»çš„å†…å­˜å¤§å°æ—¶ï¼Œéœ€è¦<code>memmove</code>è¿›è¡Œå†…å­˜å¹³ç§»ï¼Œä¿è¯å®‰å…¨</li><li><code>memcpy</code>ä»åŸå†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®å¼€å§‹æ‹·è´è‹¥å¹²ä¸ªå­—èŠ‚åˆ°ç›®æ ‡å†…å­˜åœ°å€ä¸­ï¼Œé€Ÿåº¦å¿«</li></ul></blockquote><p><strong>å…³äº <code>rwe</code> çš„è¯´æ˜</strong></p><p>é¦–å…ˆï¼Œåœ¨<code>realizeClassWithoutSwift</code>ä¸­é€šè¿‡<code>rw->set_ro(ro)</code>ä¸º <code>rwe</code> çš„ <code>ro</code>èµ‹å€¼ï¼Œå› æ­¤ <code>rwe</code> æ˜¯å·²ç»å­˜åœ¨çš„</p><p>æ‰€ä»¥ï¼Œåœ¨æ‰§è¡Œ<code>attachLists</code>æ—¶</p><ul><li>æ­¤æ—¶çš„ <code>rwe</code> çš„ <code>methods</code> æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ <code>0 å¯¹ 1</code> æµç¨‹</li><li>å½“<code>åŠ å…¥ä¸€ä¸ªåˆ†ç±»</code>æ—¶ï¼Œæ­¤æ—¶ <code>rwe</code> ä¸­çš„ <code>methods</code> åªæœ‰ä¸€ä¸ª <code>list</code>ï¼Œä¹Ÿå°±æ˜¯ <code>1 å¯¹å¤š</code> æµç¨‹</li><li>å†<code>åŠ å…¥ä¸€ä¸ªåˆ†ç±»</code>æ—¶ï¼Œæ­¤æ—¶ <code>rwe</code> ä¸­çš„ <code>methods</code> æœ‰ä¸¤ä¸ª <code>list</code>ï¼Œä¹Ÿå°±æ˜¯ <code>å¤šå¯¹å¤š</code> æµç¨‹</li></ul><h4 id=æ‡’åŠ è½½ç±»><a href=#æ‡’åŠ è½½ç±» class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ‡’åŠ è½½ç±»</h4><p>ä¸Šé¢çš„åŠ è½½è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯éæ‡’åŠ è½½çš„ç±»ï¼Œé‚£ä¹ˆå¯¹äºæ‡’åŠ è½½å‘¢ï¼Œä¹Ÿå°±æ˜¯<code>+load</code>æ²¡æœ‰å®ç°çš„ç±»</p><p>æ—¢ç„¶æ˜¯æ‡’åŠ è½½ï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰ä¼šåŠ å…¥åˆ°å†…å­˜ä¸­ï¼Œè€Œè°ƒç”¨æ‡’åŠ è½½ç±»ï¼Œä¹Ÿå°±æ˜¯å‘å…¶å‘ç”Ÿæ¶ˆæ¯ï¼Œå›é¡¾ä¹‹å‰<code>lookUpImpOrForward</code>å‡½æ•°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>IMP</span> <span class=nf>lookUpImpOrForward</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>SEL</span> <span class=n>sel</span><span class=p>,</span> <span class=n>id</span> <span class=n>inst</span><span class=p>,</span> 
                       <span class=kt>bool</span> <span class=n>initialize</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>cache</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>resolver</span><span class=p>)</span>
<span class=p>{</span>
    <span class=p>...</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>cls</span> <span class=o>=</span> <span class=n>realizeClassMaybeSwiftAndLeaveLocked</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>runtimeLock</span><span class=p>);</span>
        <span class=c1>// runtimeLock may have been dropped but is now locked again
</span><span class=c1></span>    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>}</span>

<span class=k>static</span> <span class=n>Class</span>
<span class=nf>realizeClassMaybeSwiftAndLeaveLocked</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>mutex_t</span><span class=o>&amp;</span> <span class=n>lock</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>realizeClassMaybeSwiftMaybeRelock</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>lock</span><span class=p>,</span> <span class=nb>true</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>static</span> <span class=n>Class</span>
<span class=nf>realizeClassMaybeSwiftMaybeRelock</span><span class=p>(</span><span class=n>Class</span> <span class=n>cls</span><span class=p>,</span> <span class=n>mutex_t</span><span class=o>&amp;</span> <span class=n>lock</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>leaveLocked</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>lock</span><span class=p>.</span><span class=n>assertLocked</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isSwiftStable_ButAllowLegacyForNow</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// Non-Swift class. Realize it now with the lock still held.
</span><span class=c1></span>        <span class=c1>// fixme wrong in the future for objc subclasses of swift classes
</span><span class=c1></span>        <span class=n>realizeClassWithoutSwift</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>nil</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>leaveLocked</span><span class=p>)</span> <span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Swift class. We need to drop locks and call the Swift
</span><span class=c1></span>        <span class=c1>// runtime to initialize it.
</span><span class=c1></span>        <span class=n>lock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
        <span class=n>cls</span> <span class=o>=</span> <span class=n>realizeSwiftClass</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
        <span class=n>ASSERT</span><span class=p>(</span><span class=n>cls</span><span class=o>-&gt;</span><span class=n>isRealized</span><span class=p>());</span>    <span class=c1>// callback must have provoked realization
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>leaveLocked</span><span class=p>)</span> <span class=n>lock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>cls</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>å¯¹äºæ‡’åŠ è½½ç±»ï¼Œä¼šåœ¨é¦–æ¬¡å‘é€æ¶ˆæ¯æ—¶ï¼Œæ•´ä¸ªå‡½æ•°è°ƒç”¨æ ˆä¸ºï¼š<code>lookUpImpOrForward</code> -> <code>realizeClassMaybeSwiftAndLeaveLocked</code> -> <code>realizeClassMaybeSwiftMaybeRelock</code> -> <code>realizeClassWithoutSwift</code></p><p>æ²¡é”™ï¼Œæœ€ç»ˆä¹Ÿæ˜¯ä¼šæ¥åˆ°<code>realizeClassWithoutSwift</code>è¿›è¡Œç±»çš„åŠ è½½</p><h3 id=æ€»ç»“><a href=#æ€»ç»“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ€»ç»“</h3><p><strong>éæ‡’åŠ è½½ç±»</strong></p><p>ä» <strong>dyld åŠ è½½</strong>åˆ°**_objc_init()**ï¼Œå®Œå–„äº†ç±»åŠ è½½çš„å‰æœŸå‡†å¤‡å·¥ä½œï¼Œè€Œè¿›å…¥ <code>realizeClassWithoutSwift</code> æ‰å»è¿›è¡Œç±»çš„åŠ è½½</p><p>åœ¨<code>_read_images</code>å‡½æ•°ä¸­ï¼Œä¸¤ä¸ªå…³é”®å‡½æ•°<code>readClass</code>å’Œ<code>realizeClassWithoutSwift</code></p><ul><li><code>readClass</code>ï¼šè¯»å–ç±»ï¼Œå°†ç±»çš„åœ°å€ä¸åç§°ï¼Œè¿›è¡Œé‡æ˜ å°„</li><li><code>realizeClassWithoutSwift</code>ï¼šå®Œå–„ç±»ä¿¡æ¯ï¼Œå°†ç±»çš„æ–¹æ³•ã€å±æ€§ã€åè®®ç­‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­<ul><li><code>methodizeClass</code>ï¼šå¯¹ç±»çš„æ–¹æ³•åˆ—è¡¨æ’åºï¼Œå¹¶åŠ è½½åˆ°å†…å­˜</li><li><code>attachCategories</code>ï¼šåˆ†ç±»çš„æ•°æ®åŠ è½½ï¼Œå†åç»­ç¯‡ç« ä¸­åˆ†æ</li></ul></li></ul><p><strong>æ‡’åŠ è½½ç±»</strong></p><p>ç±»çš„åŠ è½½æ¨è¿Ÿåˆ°ç¬¬ä¸€æ¬¡å‘ç”Ÿæ¶ˆæ¯çš„æ—¶å€™ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨<code>realizeClassWithoutSwift</code></p></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>