<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„ç»“æ„åˆ†æ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-isaç»“æ„&æŒ‡å‘åˆ†æã€ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼š æœ¬æ–‡å°†å¯¹ç±»çš„â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/Class-structure/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-09-14T16:28:45+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/Class-structure/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„ç»“æ„åˆ†æ","description":"åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-isaç»“æ„\u0026æŒ‡å‘åˆ†æã€ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼š æœ¬æ–‡å°†å¯¹ç±»çš„â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„ç»“æ„åˆ†æ"><meta property="og:description" content="åœ¨ã€iOSåº•å±‚åŸç†æ¢ç´¢-isaç»“æ„&æŒ‡å‘åˆ†æã€ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼š æœ¬æ–‡å°†å¯¹ç±»çš„â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/Class-structure/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-ç±»çš„ç»“æ„åˆ†æ</h1><div class=post-meta><time datetime=2020-09-14T16:28:45+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-09-14</time></div><div class="post-body e-content"><p>åœ¨ã€<a href=../isa>iOSåº•å±‚åŸç†æ¢ç´¢-isaç»“æ„&æŒ‡å‘åˆ†æ</a>ã€ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼š</p><p>æœ¬æ–‡å°†å¯¹ç±»çš„ç»“æ„è¿›ä¸€æ­¥çš„åˆ†æï¼ŒåŒæ ·çš„ï¼Œå…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li><code>objc_class</code> ä¸ <code>objc_object</code> æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li><li>æˆå‘˜å˜é‡å’Œå±æ€§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•çš„å½’å±é—®é¢˜ï¼Ÿ</li></ul><h3 id=ç±»çš„æœ¬è´¨><a href=#ç±»çš„æœ¬è´¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»çš„æœ¬è´¨</h3><p><strong>ç±»çš„æœ¬è´¨æ˜¯ objc_class ç±»å‹çš„ç»“æ„ä½“ï¼Œobjc_class ç»§æ‰¿ä¸ objc_object</strong></p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ï¼š<strong>NSObjectçš„å®šä¹‰</strong></p><div class=highlight><pre class=chroma><code class=language-Objective-C data-lang=Objective-C><span class=k>typedef</span> <span class=k>struct</span> <span class=n>objc_class</span> <span class=o>*</span><span class=kt>Class</span><span class=p>;</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=n>objc_object</span> <span class=o>*</span><span class=kt>id</span><span class=p>;</span>

<span class=k>@interface</span> <span class=nc>NSObject</span> <span class=o>&lt;</span><span class=n>NSObject</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=kt>Class</span> <span class=n>isa</span>  <span class=n>OBJC_ISA_AVAILABILITY</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><code>objc_class</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objc data-lang=objc><span class=k>struct</span> <span class=nl>objc_class</span> <span class=p>:</span> <span class=n>objc_object</span> <span class=p>{</span>
    <span class=c1>// Class ISA;
</span><span class=c1></span>    <span class=kt>Class</span> <span class=n>superclass</span><span class=p>;</span>
    <span class=n>cache_t</span> <span class=n>cache</span><span class=p>;</span>             <span class=c1>// formerly cache pointer and vtable
</span><span class=c1></span>    <span class=n>class_data_bits_t</span> <span class=n>bits</span><span class=p>;</span>    <span class=c1>// class_rw_t * plus custom rr/alloc flags
</span><span class=c1></span>  	
    <span class=n>class_rw_t</span> <span class=o>*</span><span class=nf>data</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>bits</span><span class=p>.</span><span class=n>data</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=p>...</span>
<span class=p>};</span>
</code></pre></div><p><code>objc_object</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objc data-lang=objc><span class=k>struct</span> <span class=n>objc_object</span> <span class=p>{</span>
  <span class=nl>private</span><span class=p>:</span>
      <span class=n>isa_t</span> <span class=n>isa</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>ä»”ç»†æ¯”è¾ƒ <code>NSObject</code> å’Œ <code>objc_object</code>ï¼Œä¸¤è€…éå¸¸çš„ç›¸ä¼¼ï¼Œå¯ä»¥æ€»ç»“ä¸ºï¼š</p><ul><li><code>NSObject</code>æ˜¯ <code>objc_object</code> çš„ä»¿å†™ï¼Œå’Œ <code>objc_object</code>å®šä¹‰æ˜¯ä¸€æ ·çš„ï¼Œåœ¨åº•å±‚ä¼šè¢«ç¼–è¯‘æˆ <code>objc_object</code></li><li>æ‰€ä»¥ï¼Œ<code>NSObjectç±»</code>æ˜¯ Objective-C çš„ <code>objc_object</code></li></ul><h3 id=ç±»çš„ç»“æ„><a href=#ç±»çš„ç»“æ„ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»çš„ç»“æ„</h3><p>ä» <code>objc_class</code> ä¸­å®šä¹‰ï¼Œç»“æ„ä½“æœ‰ 4 ä¸ªæˆå‘˜å˜é‡ï¼š<code>isaã€superclassã€cacheã€bits</code></p><p><strong>Class ISA</strong></p><p>è¿™æ˜¯ç»§æ‰¿äº <code>objc_object</code> è€Œæ¥çš„ï¼ŒæŒ‡å‘çš„æ˜¯å½“å‰çš„ç±»ï¼Œå  8 å­—èŠ‚</p><p><strong>Class superclass</strong></p><p>çˆ¶ç±»ï¼Œsuperclassæ˜¯ <code>Class</code> ç±»å‹ï¼Œå  8 å­—èŠ‚</p><p><strong>cache_t cache</strong></p><p><code>cache_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-C++ data-lang=C++><span class=k>struct</span> <span class=nc>cache_t</span> <span class=p>{</span>
<span class=cp>#if CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_OUTLINED
</span><span class=cp></span>    <span class=n>explicit_atomic</span><span class=o>&lt;</span><span class=k>struct</span> <span class=nc>bucket_t</span> <span class=o>*&gt;</span> <span class=n>_buckets</span><span class=p>;</span>
    <span class=n>explicit_atomic</span><span class=o>&lt;</span><span class=n>mask_t</span><span class=o>&gt;</span> <span class=n>_mask</span><span class=p>;</span>
<span class=cp>#elif CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_HIGH_16
</span><span class=cp></span>    <span class=n>explicit_atomic</span><span class=o>&lt;</span><span class=n>uintptr_t</span><span class=o>&gt;</span> <span class=n>_maskAndBuckets</span><span class=p>;</span>
    <span class=n>mask_t</span> <span class=n>_mask_unused</span><span class=p>;</span>
    
<span class=cp>#if __LP64__
</span><span class=cp></span>    <span class=kt>uint16_t</span> <span class=n>_flags</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>    <span class=kt>uint16_t</span> <span class=n>_occupied</span><span class=p>;</span>
</code></pre></div><p>æ­£å¦‚æ‰€è§çš„ï¼Œcache_t æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå†…å­˜é•¿åº¦ç”±æ‰€æœ‰å…ƒç´ å†³å®šï¼š</p><ul><li><code>_buckets</code> | <code>_maskAndBuckets</code>ï¼š<code>bucket_t*</code>æ˜¯ç»“æ„ä½“æŒ‡é’ˆï¼Œ<code>uintptr_t</code>ä¹Ÿæ˜¯æŒ‡é’ˆï¼Œ8 å­—èŠ‚</li><li><code>_mask</code> | <code>_mask_unused</code>ï¼š<code>mask_t</code>æ˜¯ <code>int</code> ç±»å‹ï¼Œå  4 ä¸ªå­—èŠ‚</li><li><code>_flags</code>ï¼š<code>uint16_t</code>ç±»å‹ï¼Œuint16_tæ˜¯ <code>unsigned short</code> çš„åˆ«åï¼Œå  2ä¸ªå­—èŠ‚</li><li><code>_occupied</code>ï¼š<code>uint16_t</code>ç±»å‹ï¼Œuint16_tæ˜¯ <code>unsigned short</code> çš„åˆ«åï¼Œå  2ä¸ªå­—èŠ‚</li></ul><p>å› æ­¤ï¼Œ<code>cache_t</code> å ç”¨ 16 å­—èŠ‚</p><blockquote><p>å…³äº <code>cache_t</code>ä¼šåœ¨åç»­è¿›è¡Œè¯¦ç»†å±•å¼€è¯´æ˜</p></blockquote><p><strong>class_data_bits_t bits</strong></p><p><code>class_data_bits_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>struct</span> <span class=n>class_data_bits_t</span> <span class=p>{</span>
    <span class=n>friend</span> <span class=n>objc_class</span><span class=p>;</span>
  
    <span class=c1>// Values are the FAST_ flags above.
</span><span class=c1></span>    <span class=n>uintptr_t</span> <span class=n>bits</span><span class=p>;</span>
<span class=nl>private</span><span class=p>:</span>
  <span class=kt>bool</span> <span class=n>getBit</span><span class=p>(</span><span class=n>uintptr_t</span> <span class=n>bit</span><span class=p>)</span> <span class=k>const</span>
  <span class=p>{</span>
      <span class=k>return</span> <span class=n>bits</span> <span class=o>&amp;</span> <span class=n>bit</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=nl>public</span><span class=p>:</span>

  <span class=n>class_rw_t</span><span class=o>*</span> <span class=n>data</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
      <span class=k>return</span> <span class=p>(</span><span class=n>class_rw_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>bits</span> <span class=o>&amp;</span> <span class=n>FAST_DATA_MASK</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div><p><code>class_rw_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>struct</span> <span class=n>class_rw_t</span> <span class=p>{</span>
    <span class=c1>// Be warned that Symbolication knows the layout of this structure.
</span><span class=c1></span>    <span class=n>uint32_t</span> <span class=n>flags</span><span class=p>;</span>
    <span class=n>uint16_t</span> <span class=n>witness</span><span class=p>;</span>
<span class=cp>#if SUPPORT_INDEXED_ISA
</span><span class=cp></span>    <span class=n>uint16_t</span> <span class=n>index</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>
    <span class=n>explicit_atomic</span><span class=o>&lt;</span><span class=n>uintptr_t</span><span class=o>&gt;</span> <span class=n>ro_or_rw_ext</span><span class=p>;</span>

    <span class=kt>Class</span> <span class=n>firstSubclass</span><span class=p>;</span>
    <span class=kt>Class</span> <span class=n>nextSiblingClass</span><span class=p>;</span>

<span class=nl>private</span><span class=p>:</span>
    <span class=n>using</span> <span class=n>ro_or_rw_ext_t</span> <span class=o>=</span> <span class=n>objc</span><span class=o>::</span><span class=n>PointerUnion</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>class_ro_t</span> <span class=o>*</span><span class=p>,</span> <span class=n>class_rw_ext_t</span> <span class=o>*&gt;</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><code>class_rw_ext_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>struct</span> <span class=n>class_rw_ext_t</span> <span class=p>{</span>
    <span class=k>const</span> <span class=n>class_ro_t</span> <span class=o>*</span><span class=n>ro</span><span class=p>;</span>
    <span class=n>method_array_t</span> <span class=n>methods</span><span class=p>;</span>
    <span class=n>property_array_t</span> <span class=n>properties</span><span class=p>;</span>
    <span class=n>protocol_array_t</span> <span class=n>protocols</span><span class=p>;</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>demangledName</span><span class=p>;</span>
    <span class=n>uint32_t</span> <span class=n>version</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div><p><code>class_ro_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>struct</span> <span class=n>class_ro_t</span> <span class=p>{</span>
    <span class=n>uint32_t</span> <span class=n>flags</span><span class=p>;</span>
    <span class=n>uint32_t</span> <span class=n>instanceStart</span><span class=p>;</span>
    <span class=n>uint32_t</span> <span class=n>instanceSize</span><span class=p>;</span>
<span class=cp>#ifdef __LP64__
</span><span class=cp></span>    <span class=n>uint32_t</span> <span class=n>reserved</span><span class=p>;</span>
<span class=cp>#endif
</span><span class=cp></span>
    <span class=k>const</span> <span class=n>uint8_t</span> <span class=o>*</span> <span class=n>ivarLayout</span><span class=p>;</span>
    
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>name</span><span class=p>;</span>
    <span class=n>method_list_t</span> <span class=o>*</span> <span class=n>baseMethodList</span><span class=p>;</span>
    <span class=n>protocol_list_t</span> <span class=o>*</span> <span class=n>baseProtocols</span><span class=p>;</span>
    <span class=k>const</span> <span class=n>ivar_list_t</span> <span class=o>*</span> <span class=n>ivars</span><span class=p>;</span>

    <span class=k>const</span> <span class=n>uint8_t</span> <span class=o>*</span> <span class=n>weakIvarLayout</span><span class=p>;</span>
    <span class=n>property_list_t</span> <span class=o>*</span><span class=n>baseProperties</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p><img src=https://w-md.imzsy.design/image-20200916164750486.png alt=image-20200916164750486></p><p>åœ¨ objc_class ç»“æ„ä½“ä¸­çš„æ³¨é‡Šå†™åˆ° <code>class_data_bits_t</code>ç›¸å½“äº <code>class_rw_t</code>æŒ‡é’ˆåŠ ä¸Š <code>rr/alloc</code> çš„æ ‡å¿—ã€‚</p><p>åŒæ—¶ï¼Œä¹Ÿå‘å¤–é¢æä¾›äº†ä¾¿æ·æ–¹æ³•ç”¨äºè¿”å›å…¶ä¸­çš„ <code>class_rw_t *</code> æŒ‡é’ˆ</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=n>class_rw_t</span> <span class=o>*</span><span class=nf>data</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>bits</span><span class=p>.</span><span class=n>data</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><h3 id=ç±»çš„å±æ€§æ–¹æ³•åè®®><a href=#ç±»çš„å±æ€§æ–¹æ³•åè®® class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ç±»çš„å±æ€§ã€æ–¹æ³•ã€åè®®</h3><p>Objc ç±»çš„å±æ€§ã€æ–¹æ³•ã€ä»¥åŠéµå¾ªçš„åè®®éƒ½æ”¾åœ¨ class_rw_t ä¸­ï¼Œclass_ro_tæ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼Œå­˜å‚¨ç”±ç¼–è¯‘å™¨å†³å®šçš„å±æ€§ã€æ–¹æ³•å’Œéµå®ˆçš„åè®®ã€‚<code>rw-readwrite, ro-readonly</code></p><p><strong>åœ¨ç¼–è¯‘æœŸ</strong></p><p>ç±»çš„ç»“æ„ä¸­çš„ <code>class_data_bits_t *data</code> æŒ‡å‘çš„æ˜¯ä¸€ä¸ª <code>class_ro_t *</code>æŒ‡é’ˆ</p><p><strong>åœ¨è¿è¡Œæ—¶</strong></p><p>è°ƒç”¨ <code>realizeClassWithoutSwift</code> æ–¹æ³•ï¼Œä¼šåšä¸€ä¸‹ 3 ä»¶äº‹æƒ…ï¼š</p><ol><li>ä»<code>class_data_bits_t</code>è°ƒç”¨ data æ–¹æ³•ï¼Œå°†ç»“æœä» <code>class_rw_t</code> å¼ºåˆ¶è½¬æ¢ä¸º <code>class_ro_t</code> æŒ‡é’ˆ</li><li>åˆå§‹åŒ–ä¸€ä¸ª class_rw_t ç»“æ„ä½“</li><li>è®¾ç½®ç»“æ„ä½“ ro çš„å€¼ä»¥åŠ flag</li></ol><p>æœ€åï¼Œè°ƒç”¨ methodizeClass æ–¹æ³•ï¼Œå°†ç±»ä¸­çš„å±æ€§ã€åè®®ã€æ–¹æ³•éƒ½åŠ è½½è¿›æ¥ã€‚</p><h4 id=æŸ¥çœ‹å±æ€§æ–¹æ³•çš„åˆ†å¸ƒ><a href=#æŸ¥çœ‹å±æ€§æ–¹æ³•çš„åˆ†å¸ƒ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æŸ¥çœ‹å±æ€§ã€æ–¹æ³•çš„åˆ†å¸ƒ</h4><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>Person</span> : <span class=nc>NSObject</span>
<span class=p>{</span>
    <span class=n>NSString</span> <span class=o>*</span><span class=n>nickName</span><span class=p>;</span>
<span class=p>}</span>
<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>

<span class=p>+</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>walk</span><span class=p>;</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>run</span><span class=p>;</span>
<span class=k>@end</span>

<span class=k>@implementation</span> <span class=nc>Person</span>
<span class=p>+</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>walk</span> <span class=p>{};</span>
<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>run</span> <span class=p>{};</span>
<span class=k>@end</span>
</code></pre></div><p>ä¸Šé¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œ<code>isa</code>ä¸<code>bits</code>çš„å†…å­˜åç§»ä¸º 32 ä½ï¼Œå³<code>bits</code>çš„åœ°å€æ˜¯<code>ç±»çš„å†…å­˜é¦–åœ°å€</code>+<code>isaã€superclassã€cache çš„å†…å­˜é•¿åº¦</code></p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span><span class=o>/</span><span class=n>x</span> <span class=no>Person</span><span class=o>.</span><span class=n>class</span>
<span class=p>(</span><span class=no>Class</span><span class=p>)</span> <span class=vg>$1</span> <span class=o>=</span> <span class=mh>0x0000000100003228</span> <span class=no>Person</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=p>(</span><span class=n>class_data_bits_t</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0000000100003248</span>
<span class=p>(</span><span class=n>class_data_bits_t</span> <span class=o>*</span><span class=p>)</span> <span class=vg>$2</span> <span class=o>=</span> <span class=mh>0x0000000100003248</span>
</code></pre></div><p>æ ¹æ®<code>data()</code>æ–¹æ³•ï¼Œè·å– <code>class_rw_t</code></p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$2</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>()</span>
<span class=p>(</span><span class=n>class_rw_t</span> <span class=o>*</span><span class=p>)</span> <span class=vg>$4</span> <span class=o>=</span> <span class=mh>0x0000000101c46110</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=o>*</span><span class=vg>$4</span>
<span class=p>(</span><span class=n>class_rw_t</span><span class=p>)</span> <span class=vg>$5</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>flags</span> <span class=o>=</span> <span class=mi>2148007936</span>
  <span class=n>witness</span> <span class=o>=</span> <span class=mi>1</span>
  <span class=n>ro_or_rw_ext</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>std</span><span class=o>::</span><span class=n>__1</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>unsigned</span> <span class=n>long</span><span class=o>&gt;</span> <span class=o>=</span> <span class=mi>4294979784</span>
  <span class=p>}</span>
  <span class=n>firstSubclass</span> <span class=o>=</span> <span class=kp>nil</span>
  <span class=n>nextSiblingClass</span> <span class=o>=</span> <span class=no>NSUUID</span>
<span class=p>}</span>
</code></pre></div><blockquote><p>781 çš„æºç å’Œä¹‹å‰çš„æºç ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œå¹¶ä¸èƒ½ç›´æ¥è¯»å–åˆ° methodsã€propertiesã€protocols</p></blockquote><p><strong>ç±»çš„å±æ€§</strong></p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$5</span><span class=o>.</span><span class=n>properties</span><span class=p>()</span>
<span class=p>(</span><span class=n>const</span> <span class=n>property_array_t</span><span class=p>)</span> <span class=vg>$13</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>list_array_tt</span><span class=o>&lt;</span><span class=n>property_t</span><span class=p>,</span> <span class=n>property_list_t</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
     <span class=o>=</span> <span class=p>{</span>
      <span class=n>list</span> <span class=o>=</span> <span class=mh>0x00000001000031c0</span>
      <span class=n>arrayAndFlag</span> <span class=o>=</span> <span class=mi>4294980032</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$13</span><span class=o>.</span><span class=n>list</span>
<span class=p>(</span><span class=n>property_list_t</span> <span class=o>*</span><span class=n>const</span><span class=p>)</span> <span class=vg>$14</span> <span class=o>=</span> <span class=mh>0x00000001000031c0</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=o>*</span><span class=vg>$14</span>
<span class=p>(</span><span class=n>property_list_t</span><span class=p>)</span> <span class=vg>$15</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>entsize_list_tt</span><span class=o>&lt;</span><span class=n>property_t</span><span class=p>,</span> <span class=n>property_list_t</span><span class=p>,</span> <span class=mi>0</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>entsizeAndFlags</span> <span class=o>=</span> <span class=mi>16</span>
    <span class=n>count</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=n>first</span> <span class=o>=</span> <span class=p>(</span><span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=n>attributes</span> <span class=o>=</span> <span class=s2>&#34;T@</span><span class=se>\&#34;</span><span class=s2>NSString</span><span class=se>\&#34;</span><span class=s2>,C,N,V_name&#34;</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$15</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=p>(</span><span class=n>property_t</span><span class=p>)</span> <span class=vg>$16</span> <span class=o>=</span> <span class=p>(</span><span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=n>attributes</span> <span class=o>=</span> <span class=s2>&#34;T@</span><span class=se>\&#34;</span><span class=s2>NSString</span><span class=se>\&#34;</span><span class=s2>,C,N,V_name&#34;</span><span class=p>)</span>
</code></pre></div><p>é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œå°±å¯ä»¥æ‹¿åˆ°æ‰€æƒ³è¦ <code>property_t</code> å±æ€§åˆ—è¡¨ï¼Œå…¶ä¸­ count æ˜¯æŒ‡æ€»å…±çš„å±æ€§æ•°é‡ã€‚</p><p>ä¹‹å‰ï¼Œåˆ†æäº†æˆå‘˜å˜é‡å­˜å‚¨åœ¨ <code>class_ro_t</code> ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæ¥æ‰“å°ä¸€ä¸‹çœ‹çœ‹</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$5</span><span class=o>.</span><span class=n>ro</span><span class=p>()</span>
<span class=p>(</span><span class=n>const</span> <span class=n>class_ro_t</span> <span class=o>*</span><span class=p>)</span> <span class=vg>$18</span> <span class=o>=</span> <span class=mh>0x00000001000030c8</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=o>*</span><span class=vg>$18</span>
<span class=p>(</span><span class=n>const</span> <span class=n>class_ro_t</span><span class=p>)</span> <span class=vg>$19</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>flags</span> <span class=o>=</span> <span class=mi>388</span>
  <span class=n>instanceStart</span> <span class=o>=</span> <span class=mi>8</span>
  <span class=n>instanceSize</span> <span class=o>=</span> <span class=mi>24</span>
  <span class=n>reserved</span> <span class=o>=</span> <span class=mi>0</span>
  <span class=n>ivarLayout</span> <span class=o>=</span> <span class=mh>0x0000000100001e6f</span> <span class=s2>&#34;</span><span class=se>\x02</span><span class=s2>&#34;</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=mh>0x0000000100001e68</span> <span class=s2>&#34;Person&#34;</span>
  <span class=n>baseMethodList</span> <span class=o>=</span> <span class=mh>0x0000000100003110</span>
  <span class=n>baseProtocols</span> <span class=o>=</span> <span class=mh>0x0000000000000000</span>
  <span class=n>ivars</span> <span class=o>=</span> <span class=mh>0x0000000100003178</span>
  <span class=n>weakIvarLayout</span> <span class=o>=</span> <span class=mh>0x0000000000000000</span>
  <span class=n>baseProperties</span> <span class=o>=</span> <span class=mh>0x00000001000031c0</span>
  <span class=n>_swiftMetadataInitializer_NEVER_USE</span> <span class=o>=</span> <span class=p>{}</span>
<span class=p>}</span>
</code></pre></div><p>æ¥ç€ï¼Œæ‰“å° <code>ivars</code></p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$19</span><span class=o>.</span><span class=n>ivars</span>
<span class=p>(</span><span class=n>const</span> <span class=n>ivar_list_t</span> <span class=o>*</span><span class=n>const</span><span class=p>)</span> <span class=vg>$20</span> <span class=o>=</span> <span class=mh>0x0000000100003178</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=o>*</span><span class=vg>$20</span>
<span class=p>(</span><span class=n>const</span> <span class=n>ivar_list_t</span><span class=p>)</span> <span class=vg>$21</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>entsize_list_tt</span><span class=o>&lt;</span><span class=n>ivar_t</span><span class=p>,</span> <span class=n>ivar_list_t</span><span class=p>,</span> <span class=mi>0</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>entsizeAndFlags</span> <span class=o>=</span> <span class=mi>32</span>
    <span class=n>count</span> <span class=o>=</span> <span class=mi>2</span>
    <span class=n>first</span> <span class=o>=</span> <span class=p>{</span>
      <span class=n>offset</span> <span class=o>=</span> <span class=mh>0x00000001000031f0</span>
      <span class=nb>name</span> <span class=o>=</span> <span class=mh>0x0000000100001e76</span> <span class=s2>&#34;nickName&#34;</span>
      <span class=n>type</span> <span class=o>=</span> <span class=mh>0x0000000100001ebe</span> <span class=s2>&#34;@</span><span class=se>\&#34;</span><span class=s2>NSString</span><span class=se>\&#34;</span><span class=s2>&#34;</span>
      <span class=n>alignment_raw</span> <span class=o>=</span> <span class=mi>3</span>
      <span class=n>size</span> <span class=o>=</span> <span class=mi>8</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>åŒæ ·çš„ï¼Œè¾“å‡ºæ¯ä¸€ä¸ª<code>ivar_list</code>çš„æ¯ä¸€ä¸ªå…ƒç´ </p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$21</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=p>(</span><span class=n>ivar_t</span><span class=p>)</span> <span class=vg>$22</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>offset</span> <span class=o>=</span> <span class=mh>0x00000001000031f0</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=mh>0x0000000100001e76</span> <span class=s2>&#34;nickName&#34;</span>
  <span class=n>type</span> <span class=o>=</span> <span class=mh>0x0000000100001ebe</span> <span class=s2>&#34;@</span><span class=se>\&#34;</span><span class=s2>NSString</span><span class=se>\&#34;</span><span class=s2>&#34;</span>
  <span class=n>alignment_raw</span> <span class=o>=</span> <span class=mi>3</span>
  <span class=n>size</span> <span class=o>=</span> <span class=mi>8</span>
<span class=p>}</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$21</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=p>(</span><span class=n>ivar_t</span><span class=p>)</span> <span class=vg>$23</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>offset</span> <span class=o>=</span> <span class=mh>0x00000001000031f8</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=mh>0x0000000100001e7f</span> <span class=s2>&#34;_name&#34;</span>
  <span class=n>type</span> <span class=o>=</span> <span class=mh>0x0000000100001ebe</span> <span class=s2>&#34;@</span><span class=se>\&#34;</span><span class=s2>NSString</span><span class=se>\&#34;</span><span class=s2>&#34;</span>
  <span class=n>alignment_raw</span> <span class=o>=</span> <span class=mi>3</span>
  <span class=n>size</span> <span class=o>=</span> <span class=mi>8</span>
<span class=p>}</span>
</code></pre></div><p>é™¤äº†æˆå‘˜å˜é‡ nickName ä¹‹å¤–ï¼Œç¼–è¯‘å™¨ä¼šåœ¨åº•å±‚è‡ªåŠ¨å°†å±æ€§ç”Ÿæˆä¸€ä¸ªæˆå‘˜å˜é‡ï¼ˆå‰ç¼€_+å±æ€§åï¼‰</p><p><strong>ç±»çš„æ–¹æ³•</strong></p><p>æŸ¥çœ‹æºç ï¼Œå…³äº <code>class_rw_t</code> éƒ¨åˆ†ï¼ŒçŸ¥é“é€šè¿‡<code>methods()ã€properties()ã€protocols()</code>åˆ†åˆ«è·å–æ–¹æ³•ã€å±æ€§ã€åè®®</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$5</span><span class=o>.</span><span class=n>methods</span><span class=p>()</span>
<span class=p>(</span><span class=n>const</span> <span class=n>method_array_t</span><span class=p>)</span> <span class=vg>$6</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>list_array_tt</span><span class=o>&lt;</span><span class=n>method_t</span><span class=p>,</span> <span class=n>method_list_t</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
     <span class=o>=</span> <span class=p>{</span>
      <span class=n>list</span> <span class=o>=</span> <span class=mh>0x0000000100003110</span>
      <span class=n>arrayAndFlag</span> <span class=o>=</span> <span class=mi>4294979856</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$6</span><span class=o>.</span><span class=n>list</span>
<span class=p>(</span><span class=n>method_list_t</span> <span class=o>*</span><span class=n>const</span><span class=p>)</span> <span class=vg>$7</span> <span class=o>=</span> <span class=mh>0x0000000100003110</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$7</span>
<span class=p>(</span><span class=n>method_list_t</span> <span class=o>*</span><span class=n>const</span><span class=p>)</span> <span class=vg>$7</span> <span class=o>=</span> <span class=mh>0x0000000100003110</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=o>*</span><span class=vg>$7</span>
<span class=p>(</span><span class=n>method_list_t</span><span class=p>)</span> <span class=vg>$8</span> <span class=o>=</span> <span class=p>{</span>
  <span class=n>entsize_list_tt</span><span class=o>&lt;</span><span class=n>method_t</span><span class=p>,</span> <span class=n>method_list_t</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>entsizeAndFlags</span> <span class=o>=</span> <span class=mi>26</span>
    <span class=n>count</span> <span class=o>=</span> <span class=mi>4</span>
    <span class=n>first</span> <span class=o>=</span> <span class=p>{</span>
      <span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;.cxx_destruct&#34;</span>
      <span class=n>types</span> <span class=o>=</span> <span class=mh>0x0000000100001eb6</span> <span class=s2>&#34;v16@0:8&#34;</span>
      <span class=n>imp</span> <span class=o>=</span> <span class=mh>0x0000000100001970</span> <span class=p>(</span><span class=no>ObjcTest</span><span class=sb>`-[Person .cxx_destruct] at main.m:29)
</span><span class=sb>    }
</span><span class=sb>  }
</span><span class=sb>}
</span></code></pre></div><p>é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œå°±å¯ä»¥æ‹¿åˆ°æ‰€æƒ³è¦ <code>method_list</code> æ–¹æ³•åˆ—è¡¨ï¼Œå…¶ä¸­ count æ˜¯æŒ‡æ€»å…±çš„æ–¹æ³•æ•°é‡ï¼Œåˆ†åˆ«æ‰“å°ä¸€ä¸‹</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$8</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=p>(</span><span class=n>method_t</span><span class=p>)</span> <span class=vg>$9</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;.cxx_destruct&#34;</span>
  <span class=n>types</span> <span class=o>=</span> <span class=mh>0x0000000100001eb6</span> <span class=s2>&#34;v16@0:8&#34;</span>
  <span class=n>imp</span> <span class=o>=</span> <span class=mh>0x0000000100001970</span> <span class=p>(</span><span class=no>ObjcTest</span><span class=sb>`-[Person .cxx_destruct] at main.m:29)
</span><span class=sb>}
</span><span class=sb>(lldb) p $8.get(1)
</span><span class=sb>(method_t) $10 = {
</span><span class=sb>  name = &#34;name&#34;
</span><span class=sb>  types = 0x0000000100001eca &#34;@16@0:8&#34;
</span><span class=sb>  imp = 0x0000000100001910 (ObjcTest`</span><span class=o>-[</span><span class=no>Person</span> <span class=nb>name</span><span class=o>]</span> <span class=n>at</span> <span class=n>main</span><span class=o>.</span><span class=n>m</span><span class=p>:</span><span class=mi>16</span><span class=p>)</span>
<span class=p>}</span>
<span class=p>(</span><span class=n>lldb</span><span class=p>)</span> <span class=nb>p</span> <span class=vg>$8</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
<span class=p>(</span><span class=n>method_t</span><span class=p>)</span> <span class=vg>$11</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nb>name</span> <span class=o>=</span> <span class=s2>&#34;setName:&#34;</span>
  <span class=n>types</span> <span class=o>=</span> <span class=mh>0x0000000100001ed2</span> <span class=s2>&#34;v24@0:8@16&#34;</span>
  <span class=n>imp</span> <span class=o>=</span> <span class=mh>0x0000000100001940</span> <span class=p>(</span><span class=no>ObjcTest</span><span class=sb>`-[Person setName:] at main.m:16)
</span><span class=sb>}
</span><span class=sb>(lldb) p $8.get(3)
</span><span class=sb>(method_t) $12 = {
</span><span class=sb>  name = &#34;run&#34;
</span><span class=sb>  types = 0x0000000100001eb6 &#34;v16@0:8&#34;
</span><span class=sb>  imp = 0x0000000100001900 (ObjcTest`</span><span class=o>-[</span><span class=no>Person</span> <span class=n>run</span><span class=o>]</span> <span class=n>at</span> <span class=n>main</span><span class=o>.</span><span class=n>m</span><span class=p>:</span><span class=mi>31</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>æ–¹æ³•<code>method_t</code>çš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-objectivec data-lang=objectivec><span class=k>struct</span> <span class=n>method_t</span> <span class=p>{</span>
    <span class=kt>SEL</span> <span class=n>name</span><span class=p>;</span>
    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>types</span><span class=p>;</span>
    <span class=kt>IMP</span> <span class=n>imp</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nl>SortBySELAddress</span> <span class=p>:</span>
        <span class=n>public</span> <span class=n>std</span><span class=o>::</span><span class=n>binary_function</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span><span class=p>,</span>
                                    <span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span><span class=p>,</span> <span class=kt>bool</span><span class=o>&gt;</span>
    <span class=p>{</span>
        <span class=kt>bool</span> <span class=n>operator</span><span class=p>()</span> <span class=p>(</span><span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span> <span class=n>lhs</span><span class=p>,</span>
                         <span class=k>const</span> <span class=n>method_t</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span>
        <span class=p>{</span> <span class=k>return</span> <span class=n>lhs</span><span class=p>.</span><span class=n>name</span> <span class=o>&lt;</span> <span class=n>rhs</span><span class=p>.</span><span class=n>name</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>};</span>
<span class=p>};</span>
</code></pre></div><p>é‡Œé¢åŒ…å«3ä¸ªæˆå‘˜å˜é‡ã€‚</p><ul><li>SELæ˜¯æ–¹æ³•çš„åå­—name</li><li>typesæ˜¯Type Encodingç±»å‹ç¼–ç ï¼Œç±»å‹å¯å‚è€ƒ<a href=https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html target=_blank rel=noopener>Type Encoding</a>ï¼Œåœ¨æ­¤ä¸ç»†è¯´</li><li>IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯å‡½æ•°çš„å…·ä½“å®ç°</li></ul><blockquote><p>åœ¨runtimeä¸­æ¶ˆæ¯ä¼ é€’å’Œè½¬å‘çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ‰¾åˆ°IMPï¼Œå¹¶æ‰§è¡Œå‡½æ•°</p></blockquote><p>ç³»ç»Ÿåœ¨åº•å±‚ä¼šæ·»åŠ  c++çš„<code>.cxx_destruct</code>æ–¹æ³•ï¼ŒåŒæ—¶ç¼–è¯‘å™¨è¿˜ä¸ºå±æ€§ç”Ÿæˆäº†ä¸€ä¸ª <code>setter</code> æ–¹æ³•å’Œ <code>getter</code> æ–¹æ³•ï¼Œç°åœ¨ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šPersonçš„ç±»æ–¹æ³• walk å»å“ªé‡Œäº†ï¼Ÿ</p><p>åœ¨ä¸Šé¢ï¼Œå·²ç»æœ‰ä»‹ç»å…³äºç±»å’Œå…ƒç±»çš„æ¦‚å¿µï¼Œé‚£ä¹ˆå¯¹äºç±»æ–¹æ³•çš„å½’å±ï¼š<strong><code>ç±»æ–¹æ³•</code>å¯ä»¥ç†è§£æˆ<code>å…ƒç±»</code>çš„<code>å®ä¾‹æ–¹æ³•</code></strong>ï¼Œå› æ­¤ï¼Œç±»æ–¹æ³•å­˜å‚¨<code>å…ƒç±»</code>ä¸­</p><h3 id=æ€»ç»“><a href=#æ€»ç»“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ€»ç»“</h3><ul><li>æˆå‘˜å˜é‡å­˜æ”¾åœ¨<code>ivar</code></li><li>å±æ€§å­˜æ”¾åœ¨<code>property</code>ï¼ŒåŒæ—¶ä¹Ÿä¼šå­˜ä¸€ä»½åœ¨<code>ivar</code>ï¼Œå¹¶ç”Ÿæˆ<code>setter</code>ã€<code>getter</code>æ–¹æ³•</li><li>å®ä¾‹æ–¹æ³•å­˜æ”¾åœ¨<code>ç±»</code>é‡Œé¢<code>methods</code></li><li>ç±»æ–¹æ³•å­˜æ”¾åœ¨<code>å…ƒç±»</code>é‡Œé¢<code>methods</code></li></ul><blockquote><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href=https://github.com/draveness/analyze/blob/master/contents/objc/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%20ObjC%20%E4%B8%AD%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%93%E6%9E%84.md#%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90-objc-%E4%B8%AD%E6%96%B9%E6%B3%95%E7%9A%84%E7%BB%93%E6%9E%84 target=_blank rel=noopener>æ·±å…¥è§£æ ObjC ä¸­æ–¹æ³•çš„ç»“æ„</a></p></blockquote></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>