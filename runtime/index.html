<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=theme-color content="#fff"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>iOSåº•å±‚åŸç†æ¢ç´¢-å…³è”å¯¹è±¡ | Dev - jw</title><link rel=stylesheet href=../css/meme.min.ae509b8259cb6c090411be6371211f6bb00631055ec9b68a994f27bb5f5f5f76.css><script src=../js/meme.min.3a56ecbb4ec7b23a805fc0116d4dac9095813dfd877cd8379675a8bdac538ffe.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="Dev - jw"><meta name=description content="åˆ†ç±»æœ‰ä¸€ä¸ªå±€é™ï¼šæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„å½¢å¼å»å®ç° æœ¬æ–‡å°†å¯¹å…³è”å¯¹è±¡è¿›â€¦â€¦"><link rel="shortcut icon" href=../favicon.ico type=image/x-icon><link rel=mask-icon href=../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Dev - jw"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Dev - jw"><meta name=msapplication-starturl content="../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../icons/mstile-150x150.png"><link rel=manifest href=../manifest.json><link rel=canonical href=https://dev.hjw.best/runtime/><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","datePublished":"2020-10-20T14:35:29+08:00","dateModified":"2021-03-31T15:42:56+08:00","url":"https://dev.hjw.best/runtime/","name":"iOSåº•å±‚åŸç†æ¢ç´¢-å…³è”å¯¹è±¡","description":"åˆ†ç±»æœ‰ä¸€ä¸ªå±€é™ï¼šæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„å½¢å¼å»å®ç° æœ¬æ–‡å°†å¯¹å…³è”å¯¹è±¡è¿›â€¦â€¦","image":"https://dev.hjw.best/favicon.ico","license":"Copyright","publisher":{"@type":"Organization","name":"Dev - jw","logo":{"@type":"ImageObject","url":"https://dev.hjw.best/favicon.ico"},"url":"https://dev.hjw.best/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://dev.hjw.best/"}}</script><meta name=twitter:card content="summary"><meta property="og:title" content="iOSåº•å±‚åŸç†æ¢ç´¢-å…³è”å¯¹è±¡"><meta property="og:description" content="åˆ†ç±»æœ‰ä¸€ä¸ªå±€é™ï¼šæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„å½¢å¼å»å®ç° æœ¬æ–‡å°†å¯¹å…³è”å¯¹è±¡è¿›â€¦â€¦"><meta property="og:url" content="https://dev.hjw.best/runtime/"><meta property="og:site_name" content="Dev - jw"><meta property="og:locale" content="zh"><meta property="og:image" content="https://dev.hjw.best/favicon.ico"><meta property="og:type" content="website"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Lato:wght@700&text=reuixiy&display=swap"></noscript><meta name=baidu-site-verification content="5nzYjT6RG7"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../ class=brand>Dev - jw</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=../about><span class=menu-item-name>å…³äº</span></a></li><li class=menu-item><a id=theme-switcher href=#><span class="icon theme-icon-light">ğŸŒ</span><span class="icon theme-icon-dark">ğŸŒ™</span></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label><label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=default data-type=posts data-toc-num=true><h1 class="post-title p-name">iOSåº•å±‚åŸç†æ¢ç´¢-å…³è”å¯¹è±¡</h1><div class=post-meta><time datetime=2020-10-20T14:35:29+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2020-10-20</time></div><div class="post-body e-content"><blockquote><p>åˆ†ç±»æœ‰ä¸€ä¸ªå±€é™ï¼šæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„å½¢å¼å»å®ç°</p></blockquote><p>æœ¬æ–‡å°†å¯¹å…³è”å¯¹è±¡è¿›è¡Œè§£æï¼ŒåŒ…æ‹¬ä¸¤æ–¹é¢çš„å†…å®¹ï¼š</p><ul><li>ä½¿ç”¨å…³è”å¯¹è±¡ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ å±æ€§</li><li>å…³è”å¯¹è±¡åœ¨åº•å±‚çš„å®ç°</li></ul><h3 id=å±æ€§><a href=#å±æ€§ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å±æ€§</h3><p>å½“æˆ‘ä»¬åœ¨ç±»ä¸­å£°æ˜ä¸€ä¸ªå±æ€§æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆ<strong>å®ä¾‹å˜é‡</strong>å’Œ <code>setterã€getter</code> æ–¹æ³•</p><p>å½“å­˜åœ¨éå¸¸å¤šçš„å±æ€§æ—¶ï¼Œç¼–è¯‘å™¨çš„å·¥ä½œé‡å²‚ä¸æ˜¯éå¸¸å¤§ï¼Œæ˜¾ç„¶ä¸æ˜¯è¿™æ ·çš„</p><p>è‹¹æœåœ¨åº•å±‚é‡‡ç”¨<strong>é€šç”¨åŸåˆ™</strong>çš„è®¾è®¡æ¨¡å¼ï¼Œä¸ºæ‰€æœ‰çš„å±æ€§æä¾›äº†åŒä¸€ä¸ªå…¥å£</p><ul><li><code>setter</code>æ–¹æ³•æ ¹æ®ä¿®é¥°ç¬¦ä¸åŒè°ƒç”¨ä¸åŒæ–¹æ³•ï¼Œä½†æ˜¯æœ€åéƒ½ä¼šè°ƒç”¨`reallySetProperty``</li><li><code>getter</code>æ–¹æ³•ä¼šè°ƒç”¨<code>objc_getProperty</code></li></ul><p><code>reallySetProperty</code>å®ç°ï¼Œåœ¨å†…éƒ¨æ˜¯é€šè¿‡<code>self+å†…å­˜åç§»é‡</code>å¾—åˆ°<code>slot</code>ï¼Œå¹¶æ ¹æ®ä¸åŒçš„ä¿®é¥°ç¬¦å°† <code>newValue</code>èµ‹å€¼ç»™ <code>slot</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>reallySetProperty</span><span class=p>(</span><span class=n>id</span> <span class=n>self</span><span class=p>,</span> <span class=n>SEL</span> <span class=n>_cmd</span><span class=p>,</span> <span class=n>id</span> <span class=n>newValue</span><span class=p>,</span> <span class=n>ptrdiff_t</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>atomic</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>copy</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>mutableCopy</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>offset</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>object_setClass</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>newValue</span><span class=p>);</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>id</span> <span class=n>oldValue</span><span class=p>;</span>
    <span class=n>id</span> <span class=o>*</span><span class=n>slot</span> <span class=o>=</span> <span class=p>(</span><span class=n>id</span><span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>self</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>newValue</span> <span class=o>=</span> <span class=p>[</span><span class=n>newValue</span> <span class=nl>copyWithZone</span><span class=p>:</span><span class=n>nil</span><span class=p>];</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>mutableCopy</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>newValue</span> <span class=o>=</span> <span class=p>[</span><span class=n>newValue</span> <span class=nl>mutableCopyWithZone</span><span class=p>:</span><span class=n>nil</span><span class=p>];</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>slot</span> <span class=o>==</span> <span class=n>newValue</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
        <span class=n>newValue</span> <span class=o>=</span> <span class=n>objc_retain</span><span class=p>(</span><span class=n>newValue</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>atomic</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>oldValue</span> <span class=o>=</span> <span class=o>*</span><span class=n>slot</span><span class=p>;</span>
        <span class=o>*</span><span class=n>slot</span> <span class=o>=</span> <span class=n>newValue</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=n>spinlock_t</span><span class=o>&amp;</span> <span class=n>slotlock</span> <span class=o>=</span> <span class=n>PropertyLocks</span><span class=p>[</span><span class=n>slot</span><span class=p>];</span>
        <span class=n>slotlock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
        <span class=n>oldValue</span> <span class=o>=</span> <span class=o>*</span><span class=n>slot</span><span class=p>;</span>
        <span class=o>*</span><span class=n>slot</span> <span class=o>=</span> <span class=n>newValue</span><span class=p>;</span>        
        <span class=n>slotlock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=n>objc_release</span><span class=p>(</span><span class=n>oldValue</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p><code>objc_getProperty</code>å®ç°ï¼Œæ ¹æ®<code>self+å†…å­˜åç§»é‡</code>å¾—åˆ°<code>slot</code>â€”â€”å³<code>value</code>ï¼Œå¹¶å°† <code>value</code> è¿”å›</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>id</span> <span class=nf>objc_getProperty</span><span class=p>(</span><span class=n>id</span> <span class=n>self</span><span class=p>,</span> <span class=n>SEL</span> <span class=n>_cmd</span><span class=p>,</span> <span class=n>ptrdiff_t</span> <span class=n>offset</span><span class=p>,</span> <span class=n>BOOL</span> <span class=n>atomic</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>offset</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>object_getClass</span><span class=p>(</span><span class=n>self</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// Retain release world
</span><span class=c1></span>    <span class=n>id</span> <span class=o>*</span><span class=n>slot</span> <span class=o>=</span> <span class=p>(</span><span class=n>id</span><span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>self</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>atomic</span><span class=p>)</span> <span class=k>return</span> <span class=o>*</span><span class=n>slot</span><span class=p>;</span>
        
    <span class=c1>// Atomic retain release world
</span><span class=c1></span>    <span class=n>spinlock_t</span><span class=o>&amp;</span> <span class=n>slotlock</span> <span class=o>=</span> <span class=n>PropertyLocks</span><span class=p>[</span><span class=n>slot</span><span class=p>];</span>
    <span class=n>slotlock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span>
    <span class=n>id</span> <span class=n>value</span> <span class=o>=</span> <span class=n>objc_retain</span><span class=p>(</span><span class=o>*</span><span class=n>slot</span><span class=p>);</span>
    <span class=n>slotlock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span>
    
    <span class=c1>// for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.
</span><span class=c1></span>    <span class=k>return</span> <span class=n>objc_autoreleaseReturnValue</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>è‡³äºå“ªé‡Œè°ƒç”¨<code>reallySetProperty</code></p><p>é€šè¿‡å †æ ˆå¯ä»¥å‘ç°<code>objc_setProperty_nonatomic_copy</code>ä¼šè°ƒç”¨ï¼Œæ­¤æ—¶çš„ä¿®é¥°ç¬¦ä¸º<code>nonatomicï¼Œcopy</code></p><p>è€Œ<code>objc_setProperty_nonatomic_copy</code>è°ƒç”¨åˆ™æ˜¯åœ¨<code>llvm</code>ä¸­</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=c1>// å£°æ˜
</span><span class=c1></span><span class=n>llvm</span><span class=o>::</span><span class=n>FunctionCallee</span> <span class=n>GetOptimizedPropertySetFunction</span><span class=p>(</span><span class=kt>bool</span> <span class=n>atomic</span><span class=p>,</span>
                                                     <span class=kt>bool</span> <span class=n>copy</span><span class=p>)</span> <span class=k>override</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>ObjCTypes</span><span class=p>.</span><span class=n>getOptimizedSetPropertyFn</span><span class=p>(</span><span class=n>atomic</span><span class=p>,</span> <span class=n>copy</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>llvm</span><span class=o>::</span><span class=n>FunctionCallee</span> <span class=n>getOptimizedSetPropertyFn</span><span class=p>(</span><span class=kt>bool</span> <span class=n>atomic</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>CodeGen</span><span class=o>::</span><span class=n>CodeGenTypes</span> <span class=o>&amp;</span><span class=n>Types</span> <span class=o>=</span> <span class=n>CGM</span><span class=p>.</span><span class=n>getTypes</span><span class=p>();</span>
  <span class=n>ASTContext</span> <span class=o>&amp;</span><span class=n>Ctx</span> <span class=o>=</span> <span class=n>CGM</span><span class=p>.</span><span class=n>getContext</span><span class=p>();</span>
  
  <span class=n>SmallVector</span><span class=o>&lt;</span><span class=n>CanQualType</span><span class=p>,</span><span class=mi>4</span><span class=o>&gt;</span> <span class=n>Params</span><span class=p>;</span>
  <span class=n>CanQualType</span> <span class=n>IdType</span> <span class=o>=</span> <span class=n>Ctx</span><span class=p>.</span><span class=n>getCanonicalParamType</span><span class=p>(</span><span class=n>Ctx</span><span class=p>.</span><span class=n>getObjCIdType</span><span class=p>());</span>
  <span class=n>CanQualType</span> <span class=n>SelType</span> <span class=o>=</span> <span class=n>Ctx</span><span class=p>.</span><span class=n>getCanonicalParamType</span><span class=p>(</span><span class=n>Ctx</span><span class=p>.</span><span class=n>getObjCSelType</span><span class=p>());</span>
  <span class=n>Params</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>IdType</span><span class=p>);</span>
  <span class=n>Params</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>SelType</span><span class=p>);</span>
  <span class=n>Params</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>IdType</span><span class=p>);</span>
  <span class=n>Params</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>Ctx</span><span class=p>.</span><span class=n>getPointerDiffType</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getCanonicalTypeUnqualified</span><span class=p>());</span>
  <span class=n>llvm</span><span class=o>::</span><span class=n>FunctionType</span> <span class=o>*</span><span class=n>FTy</span> <span class=o>=</span>
      <span class=n>Types</span><span class=p>.</span><span class=n>GetFunctionType</span><span class=p>(</span>
        <span class=n>Types</span><span class=p>.</span><span class=n>arrangeBuiltinFunctionDeclaration</span><span class=p>(</span><span class=n>Ctx</span><span class=p>.</span><span class=n>VoidTy</span><span class=p>,</span> <span class=n>Params</span><span class=p>));</span>
  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>atomic</span> <span class=o>&amp;&amp;</span> <span class=n>copy</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s>&#34;objc_setProperty_atomic_copy&#34;</span><span class=p>;</span>
  <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>atomic</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>copy</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s>&#34;objc_setProperty_atomic&#34;</span><span class=p>;</span>
  <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=o>!</span><span class=n>atomic</span> <span class=o>&amp;&amp;</span> <span class=n>copy</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s>&#34;objc_setProperty_nonatomic_copy&#34;</span><span class=p>;</span>
  <span class=k>else</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s>&#34;objc_setProperty_nonatomic&#34;</span><span class=p>;</span>

  <span class=k>return</span> <span class=n>CGM</span><span class=p>.</span><span class=n>CreateRuntimeFunction</span><span class=p>(</span><span class=n>FTy</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// è°ƒç”¨
</span><span class=c1></span><span class=n>llvm</span><span class=o>::</span><span class=n>FunctionCallee</span> <span class=n>setOptimizedPropertyFn</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
<span class=n>llvm</span><span class=o>::</span><span class=n>FunctionCallee</span> <span class=n>setPropertyFn</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
<span class=k>if</span> <span class=p>(</span><span class=n>UseOptimizedSetter</span><span class=p>(</span><span class=n>CGM</span><span class=p>))</span> <span class=p>{</span>
  <span class=c1>// 10.8 and iOS 6.0 code and GC is off
</span><span class=c1></span>  <span class=n>setOptimizedPropertyFn</span> <span class=o>=</span>
      <span class=n>CGM</span><span class=p>.</span><span class=n>getObjCRuntime</span><span class=p>().</span><span class=n>GetOptimizedPropertySetFunction</span><span class=p>(</span>
          <span class=n>strategy</span><span class=p>.</span><span class=n>isAtomic</span><span class=p>(),</span> <span class=n>strategy</span><span class=p>.</span><span class=n>isCopy</span><span class=p>());</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>setOptimizedPropertyFn</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>CGM</span><span class=p>.</span><span class=n>ErrorUnsupported</span><span class=p>(</span><span class=n>propImpl</span><span class=p>,</span> <span class=s>&#34;Obj-C optimized setter - NYI&#34;</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
<span class=k>else</span> <span class=p>{</span>
  <span class=n>setPropertyFn</span> <span class=o>=</span> <span class=n>CGM</span><span class=p>.</span><span class=n>getObjCRuntime</span><span class=p>().</span><span class=n>GetPropertySetFunction</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>setPropertyFn</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>CGM</span><span class=p>.</span><span class=n>ErrorUnsupported</span><span class=p>(</span><span class=n>propImpl</span><span class=p>,</span> <span class=s>&#34;Obj-C setter requiring atomic copy&#34;</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 id=å…³è”å¯¹è±¡çš„åº”ç”¨><a href=#å…³è”å¯¹è±¡çš„åº”ç”¨ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å…³è”å¯¹è±¡çš„åº”ç”¨</h3><p><strong>å…³è”å¯¹è±¡çš„ä½¿ç”¨</strong>ç›¸ä¿¡å·²ç»æˆä¸ºæ¯ä¸ª iOS å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯éœ€è¦å¯¹å…¶ä»‹ç»</p><h4 id=property><a href=#property class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>@property</h4><p><code>@property</code>å¯ä»¥è¯´æ˜¯ä¸€ä¸ª Objective-C ç¼–ç¨‹ä¸­çš„ã€å®ã€ï¼Œå®ƒæœ‰<a href=https://zh.wikipedia.org/zh/%E5%85%83%E7%BC%96%E7%A8%8B target=_blank rel=noopener>å…ƒç¼–ç¨‹</a>çš„æ€æƒ³</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>Person</span> : <span class=nc>NSObject</span>

<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>strong</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>

<span class=k>@end</span>
</code></pre></div><p>åœ¨ç±»ä¸­å£°æ˜ä¸€ä¸ª<code>name</code>å±æ€§æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åšä¸‰ä»¶äº‹ï¼š</p><ul><li>ç”Ÿæˆå®ä¾‹å˜é‡<code>_name</code></li><li>ç”Ÿæˆ <code>getter</code> æ–¹æ³• <code>- (NSString *)name</code></li><li>ç”Ÿæˆ <code>setter</code> æ–¹æ³• <code>- (void)setName:</code></li></ul><p>æ—¢ç„¶åœ¨ç±»ä¸­ä½¿ç”¨<code>@property</code>å£°æ˜ä¸€ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨åˆ†ç±»ä¸­ä¸ºä»€ä¹ˆä¸å¯ä»¥</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=k>@interface</span> <span class=nc>NSObject</span> <span class=nl>(Test)</span>

<span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>strong</span><span class=p>)</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>test_name</span><span class=p>;</span>

<span class=k>@end</span>
 
<span class=k>@implementation</span> <span class=nc>NSObject</span> <span class=nl>(Test)</span>

<span class=k>@end</span>
</code></pre></div><p>ç¼–è¯‘ï¼Œå°±æŠ¥è¿™æ ·çš„è­¦å‘Šï¼š<code>test_name</code>å±æ€§çš„å­˜å–æ–¹æ³•éœ€è¦æ‰‹åŠ¨å»å®ç°ï¼Œæˆ–è€…ä½¿ç”¨<code>@dynamic</code>åœ¨è¿è¡Œæ—¶å®ç°è¿™äº›æ–¹æ³•</p><pre><code>Property 'test_name' requires method 'setTest_name:' to be defined - use @dynamic or provide a method implementation in this category

Property 'test_name' requires method 'test_name' to be defined - use @dynamic or provide a method implementation in this category
</code></pre><p>è¿™ä¹Ÿæ„å‘³ç€ï¼Œåˆ†ç±»ä¸­çš„<code>@property</code>å¹¶æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆå®ä¾‹å˜é‡ä»¥åŠå­˜å–æ–¹æ³•ï¼Œè€Œéœ€è¦æ‰‹åŠ¨å®ç°</p><h4 id=ä½¿ç”¨å…³è”å¯¹è±¡><a href=#ä½¿ç”¨å…³è”å¯¹è±¡ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>ä½¿ç”¨å…³è”å¯¹è±¡</h4><p>ä¸‹é¢æ˜¯é€šè¿‡ Objcè¿è¡Œæ—¶æä¾›çš„å…³è”å¯¹è±¡ API åœ¨åˆ†ç±»ä¸­å®ç°ä¸€ä¸ªä¼ªå±æ€§</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=cp>#import &#34;NSObject+Test.h&#34;
</span><span class=cp>#import &lt;objc/runtime.h&gt;
</span><span class=cp></span>
<span class=k>@implementation</span> <span class=nc>NSObject</span> <span class=nl>(Test)</span>

<span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>setTest_name:</span><span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nv>test_name</span> <span class=p>{</span>
    <span class=n>objc_setAssociatedObject</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=k>@selector</span><span class=p>(</span><span class=n>test_name</span><span class=p>),</span> <span class=n>test_name</span><span class=p>,</span> <span class=n>OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=p>);</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=nf>test_name</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>objc_getAssociatedObject</span><span class=p>(</span><span class=nb>self</span><span class=p>,</span> <span class=n>_cmd</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>@end</span>
</code></pre></div><blockquote><p>è¿™é‡Œçš„<code>_cmd</code>æŒ‡ä»£å½“å‰æ–¹æ³•çš„é€‰æ‹©å­ï¼Œä¹Ÿå°±æ˜¯<code>@seletor(test_name)</code></p></blockquote><p>ä½¿ç”¨<code>objc_getAssociatedObject</code>å’Œ<code>objc_setAssociatedObject</code>æ¥æ¨¡æ‹Ÿã€å±æ€§ã€çš„å­˜å–æ–¹æ³•ï¼Œè€Œä½¿ç”¨å…³è”å¯¹è±¡æ¨¡æ‹Ÿå®ä¾‹å˜é‡</p><p>è§£é‡Šä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸ºä»€ä¹ˆå‘æ–¹æ³•ä¸­ä¼ å…¥<code>@selector(test_name)</code></li><li><code>OBJC_ASSOCIATION_RETAIN_NONATOMIC</code>æ˜¯å¹²ä»€ä¹ˆçš„</li></ul><p>å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå…ˆçœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŸå‹</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>OBJC_EXPORT</span> <span class=kt>void</span>
<span class=nf>objc_setAssociatedObject</span><span class=p>(</span><span class=n>id</span> <span class=n>_Nonnull</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span> <span class=n>_Nonnull</span> <span class=n>key</span><span class=p>,</span>
                         <span class=n>id</span> <span class=n>_Nullable</span> <span class=n>value</span><span class=p>,</span> <span class=n>objc_AssociationPolicy</span> <span class=n>policy</span><span class=p>)</span>
    <span class=n>OBJC_AVAILABLE</span><span class=p>(</span><span class=mf>10.6</span><span class=p>,</span> <span class=mf>3.1</span><span class=p>,</span> <span class=mf>9.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>);</span>

<span class=n>OBJC_EXPORT</span> <span class=n>id</span> <span class=n>_Nullable</span>
<span class=nf>objc_getAssociatedObject</span><span class=p>(</span><span class=n>id</span> <span class=n>_Nonnull</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span> <span class=n>_Nonnull</span> <span class=n>key</span><span class=p>)</span>
    <span class=n>OBJC_AVAILABLE</span><span class=p>(</span><span class=mf>10.6</span><span class=p>,</span> <span class=mf>3.1</span><span class=p>,</span> <span class=mf>9.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>);</span>
</code></pre></div><p><code>@selector(test_name)</code>ä¹Ÿå°±æ˜¯å‚æ•°ä¸­çš„<code>key</code>ï¼Œå…¶å®å¯ä»¥ä½¿ç”¨é™æ€æŒ‡é’ˆ<code>static void *</code>ç±»å‹çš„å‚æ•°æ¥ä»£æ›¿</p><blockquote><p>è¿™é‡Œæ¨èä½¿ç”¨<code>@selector(test_name)</code>ä½œä¸º <code>key</code>ä¼ å…¥ï¼Œå› ä¸ºè¿™ç§æ–¹å¼çœç•¥äº†å£°æ˜å‚æ•°çš„ä»£ç ï¼Œå¹¶ä¸”èƒ½å¾ˆå¥½åœ°ä¿æŠ¤ <code>key</code> çš„å”¯ä¸€æ€§</p></blockquote><p><code>OBJC_ASSOCIATION_RETAIN_NONATOMIC</code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¥çœ‹ä¸€ä¸‹å®ƒçš„å®šä¹‰</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=nf>OBJC_ENUM</span><span class=p>(</span><span class=n>uintptr_t</span><span class=p>,</span> <span class=n>objc_AssociationPolicy</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>OBJC_ASSOCIATION_ASSIGN</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>           <span class=cm>/**&lt; Specifies a weak reference to the associated object. */</span>
    <span class=n>OBJC_ASSOCIATION_RETAIN_NONATOMIC</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=cm>/**&lt; Specifies a strong reference to the associated object. 
</span><span class=cm>                                            *   The association is not made atomically. */</span>
    <span class=n>OBJC_ASSOCIATION_COPY_NONATOMIC</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span>   <span class=cm>/**&lt; Specifies that the associated object is copied. 
</span><span class=cm>                                            *   The association is not made atomically. */</span>
    <span class=n>OBJC_ASSOCIATION_RETAIN</span> <span class=o>=</span> <span class=mo>01401</span><span class=p>,</span>       <span class=cm>/**&lt; Specifies a strong reference to the associated object.
</span><span class=cm>                                            *   The association is made atomically. */</span>
    <span class=n>OBJC_ASSOCIATION_COPY</span> <span class=o>=</span> <span class=mo>01403</span>          <span class=cm>/**&lt; Specifies that the associated object is copied.
</span><span class=cm>                                            *   The association is made atomically. */</span>
<span class=p>};</span>
</code></pre></div><p>ä»å®šä¹‰çš„æ³¨é‡Šä¸­ï¼Œä¸éš¾çœ‹å‡ºï¼šä¸åŒçš„<code>objc_AssociationPolicy</code>å¯¹åº”äº†ä¸åŒçš„å±æ€§ä¿®é¥°ç¬¦ç­–ç•¥</p><div class=table-container><table><thead><tr><th>objc_AssociationPolicy</th><th>modifier</th></tr></thead><tbody><tr><td>OBJC_ASSOCIATION_ASSIGN</td><td>assign</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td><td>nonatomic, strong</td></tr><tr><td>OBJC_ASSOCIATION_COPY_NONATOMIC</td><td>nonatomic, copy</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN</td><td>atomic, strong</td></tr><tr><td>OBJC_ASSOCIATION_COPY</td><td>atomic, copy</td></tr></tbody></table></div><p>æˆ‘ä»¬åœ¨ä»£ç ä¸­å®ç°çš„å±æ€§<code>test_name</code>å°±ç›¸å½“äºä½¿ç”¨äº†ä¿®é¥°ç¬¦ <code>nonatomic</code> å’Œ <code>strong</code></p><h4 id=æ€»ç»“><a href=#æ€»ç»“ class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ€»ç»“</h4><p><code>@property</code>å…¶å®æœ‰å…ƒç¼–ç¨‹çš„æ€æƒ³ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆ<strong>å®ä¾‹å˜é‡ä»¥åŠå­˜å–æ–¹æ³•</strong>ï¼Œè€Œè¿™ä¸‰è€…æ„æˆå±æ€§è¿™ç±»ä¼¼äºè¯­æ³•ç³–çš„æ¦‚å¿µï¼Œæä¾›äº†æ›´ä¾¿åˆ©çš„<strong>ç‚¹è¯­æ³•</strong>æ¥è®¿é—®å±æ€§ï¼š</p><pre><code>self.property &lt;=&gt; [self property]
self.property = value &lt;=&gt; [self setProperty:value]
</code></pre><p>åœ¨åˆ†ç±»ä¸­ï¼Œå› ä¸ºç±»çš„ç¤ºä¾‹å˜é‡çš„å¸ƒå±€å·²ç»å›ºå®šï¼Œä½¿ç”¨<code>@property</code><strong>æ— æ³•å‘å›ºå®šçš„å¸ƒå±€ä¸­æ·»åŠ æ–°çš„å®ä¾‹å˜é‡</strong></p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä½¿ç”¨å…³è”å¯¹è±¡ä»¥åŠä¸¤ä¸ªæ–¹æ³•æ¥æ¨¡æ‹Ÿæ„æˆå±æ€§çš„ä¸‰ä¸ªè¦ç´ </strong></p><h3 id=å…³è”å¯¹è±¡çš„åº•å±‚å®ç°><a href=#å…³è”å¯¹è±¡çš„åº•å±‚å®ç° class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>å…³è”å¯¹è±¡çš„åº•å±‚å®ç°</h3><p>åœ¨è¿è¡Œæ—¶æä¾›å…³è”å¯¹è±¡çš„ API æœ‰ä»¥ä¸‹ï¼š</p><ul><li><p><strong>objc_setAssociatedObject</strong>ï¼šä½¿ç”¨ç»™å®šçš„é”®å’Œå…³è”ç­–ç•¥ä¸ºç»™å®šçš„å¯¹è±¡è®¾ç½®å…³è”çš„å€¼</p></li><li><p><strong>objc_getAssociatedObject</strong>ï¼šè¿”å›ä¸ç»™å®šé”®çš„ç»™å®šå¯¹è±¡å…³è”çš„å€¼</p></li><li><p><strong>objc_removeAssociatedObjects</strong>ï¼šåˆ é™¤ç»™å®šå¯¹è±¡çš„æ‰€æœ‰å…³è”</p></li></ul><h4 id=objc_setassociatedobject><a href=#objc_setassociatedobject class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>objc_setAssociatedObject</h4><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>objc_setAssociatedObject</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>,</span> <span class=n>id</span> <span class=n>value</span><span class=p>,</span> <span class=n>objc_AssociationPolicy</span> <span class=n>policy</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>SetAssocHook</span><span class=p>.</span><span class=n>get</span><span class=p>()(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>policy</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼šé‡‡ç”¨<strong>æ¥å£æ¨¡å¼</strong>çš„è®¾è®¡æ¨¡å¼ï¼Œèµ·åˆ°å¯¹å¤–çš„æ¥å£ä¿æŒä¸å˜ï¼Œå†…éƒ¨é€»è¾‘çš„å˜åŒ–ä¸å½±å“å¤–éƒ¨çš„è°ƒç”¨çš„ä½œç”¨</p><ul><li><p><code>SetAssocHook</code>æ˜¯ä¸€ä¸ªå°è£…äº†å‡½æ•°æŒ‡é’ˆçš„å¯¹è±¡ï¼Œæºç å®šä¹‰ä¸ºï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=n>ChainedHookFunction</span><span class=o>&lt;</span><span class=n>objc_hook_setAssociatedObject</span><span class=o>&gt;</span> <span class=n>SetAssocHook</span><span class=p>{</span><span class=n>_base_objc_setAssociatedObject</span><span class=p>};</span>
</code></pre></div></li><li><p><code>ChainedHookFunction</code>æ˜¯ç”¨äºçº¿ç¨‹å®‰å…¨çš„é“¾å¼é’©å­å‡½æ•°çš„å­˜å‚¨</p><ul><li>é€šè¿‡ <code>get()</code> è¿”å›è°ƒç”¨çš„å€¼</li><li>é€šè¿‡ <code>set()</code> æ³¨å…¥ä¸€ä¸ªæ–°å‡½æ•°ï¼Œå¹¶è¿”å›æ—§å‡½æ•°ï¼Œç¡®åˆ‡åœ°è¯´ï¼Œ<code>set()</code>å°†æ—§å€¼å†™å…¥è°ƒç”¨æ–¹æä¾›çš„å˜é‡</li><li><code>get()</code> å’Œ <code>set()</code>ä½¿ç”¨é€‚å½“çš„æ …æ ä½¿å¾—åœ¨æ–°å€¼è°ƒç”¨å‰å®‰å…¨åœ°å†™å…¥å˜é‡</li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>Fn</span><span class=o>&gt;</span>
<span class=k>class</span> <span class=nc>ChainedHookFunction</span> <span class=p>{</span>
    <span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>Fn</span><span class=o>&gt;</span> <span class=n>hook</span><span class=p>{</span><span class=n>nil</span><span class=p>};</span>
  
<span class=k>public</span><span class=o>:</span>
    <span class=n>ChainedHookFunction</span><span class=p>(</span><span class=n>Fn</span> <span class=n>f</span><span class=p>)</span> <span class=o>:</span> <span class=n>hook</span><span class=p>{</span><span class=n>f</span><span class=p>}</span> <span class=p>{</span> <span class=p>};</span>
  
    <span class=n>Fn</span> <span class=nf>get</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>hook</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_acquire</span><span class=p>);</span>
    <span class=p>}</span>
  
    <span class=kt>void</span> <span class=nf>set</span><span class=p>(</span><span class=n>Fn</span> <span class=n>newValue</span><span class=p>,</span> <span class=n>Fn</span> <span class=o>*</span><span class=n>oldVariable</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>Fn</span> <span class=n>oldValue</span> <span class=o>=</span> <span class=n>hook</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>memory_order_relaxed</span><span class=p>);</span>
        <span class=k>do</span> <span class=p>{</span>
            <span class=o>*</span><span class=n>oldVariable</span> <span class=o>=</span> <span class=n>oldValue</span><span class=p>;</span>
        <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>hook</span><span class=p>.</span><span class=n>compare_exchange_weak</span><span class=p>(</span><span class=n>oldValue</span><span class=p>,</span> <span class=n>newValue</span><span class=p>,</span>
                                             <span class=n>std</span><span class=o>::</span><span class=n>memory_order_release</span><span class=p>,</span>
                                             <span class=n>std</span><span class=o>::</span><span class=n>memory_order_relaxed</span><span class=p>));</span>
    <span class=p>}</span>
<span class=p>};</span>
</code></pre></div></li></ul><p>å› æ­¤ï¼Œ<code>SetAssocHook.get()</code>è¿”å›çš„æ˜¯ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆ<code>_base_objc_setAssociatedObject</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>SetAssocHook</span><span class=p>.</span><span class=n>get</span><span class=p>()(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>policy</span><span class=p>)</span> <span class=o>&lt;==&gt;</span> <span class=n>base_objc_setAssociatedObject</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>policy</span><span class=p>)</span>
</code></pre></div><p>åº•å±‚çœŸæ­£è°ƒç”¨çš„æ˜¯<code>_base_objc_setAssociatedObject</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>static</span> <span class=kt>void</span>
<span class=nf>_base_objc_setAssociatedObject</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>,</span> <span class=n>id</span> <span class=n>value</span><span class=p>,</span> <span class=n>objc_AssociationPolicy</span> <span class=n>policy</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>_object_set_associative_reference</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>policy</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p><code>_object_set_associative_reference</code>æ‰æ˜¯çœŸæ­£å®ç°å…³è”å¯¹è±¡å­˜å‚¨çš„å‡½æ•°</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>_object_set_associative_reference</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>,</span> <span class=n>id</span> <span class=n>value</span><span class=p>,</span> <span class=n>uintptr_t</span> <span class=n>policy</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// This code used to work when nil was passed for object and key. Some code
</span><span class=c1></span>    <span class=c1>// probably relies on that to not crash. Check and handle it explicitly.
</span><span class=c1></span>    <span class=c1>// rdar://problem/44094390
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>object</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>value</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>object</span><span class=o>-&gt;</span><span class=n>getIsa</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>forbidsAssociatedObjects</span><span class=p>())</span>
        <span class=n>_objc_fatal</span><span class=p>(</span><span class=s>&#34;objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects&#34;</span><span class=p>,</span> <span class=n>object</span><span class=p>,</span> <span class=n>object_getClassName</span><span class=p>(</span><span class=n>object</span><span class=p>));</span>
    <span class=c1>//objectå°è£…æˆä¸€ä¸ªæ•°ç»„ç»“æ„ç±»å‹ï¼Œç±»å‹ä¸ºDisguisedPtr
</span><span class=c1></span>    <span class=n>DisguisedPtr</span><span class=o>&lt;</span><span class=n>objc_object</span><span class=o>&gt;</span> <span class=n>disguised</span><span class=p>{(</span><span class=n>objc_object</span> <span class=o>*</span><span class=p>)</span><span class=n>object</span><span class=p>};</span><span class=c1>//ç›¸å½“äºåŒ…è£…äº†ä¸€ä¸‹ å¯¹è±¡object,ä¾¿äºä½¿ç”¨
</span><span class=c1></span>    <span class=c1>// åŒ…è£…ä¸€ä¸‹ policy - value
</span><span class=c1></span>    <span class=n>ObjcAssociation</span> <span class=n>association</span><span class=p>{</span><span class=n>policy</span><span class=p>,</span> <span class=n>value</span><span class=p>};</span>

    <span class=c1>// retain the new value (if any) outside the lock.
</span><span class=c1></span>    <span class=n>association</span><span class=p>.</span><span class=n>acquireValue</span><span class=p>();</span><span class=c1>//æ ¹æ®ç­–ç•¥ç±»å‹è¿›è¡Œå¤„ç†
</span><span class=c1></span>    <span class=c1>//å±€éƒ¨ä½œç”¨åŸŸç©ºé—´
</span><span class=c1></span>    <span class=p>{</span>
        <span class=c1>//åˆå§‹åŒ–managerå˜é‡ï¼Œç›¸å½“äºè‡ªåŠ¨è°ƒç”¨AssociationsManagerçš„ææ„å‡½æ•°è¿›è¡Œåˆå§‹åŒ–
</span><span class=c1></span>        <span class=n>AssociationsManager</span> <span class=n>manager</span><span class=p>;</span><span class=c1>//å¹¶ä¸æ˜¯å…¨åœºå”¯ä¸€ï¼Œæ„é€ å‡½æ•°ä¸­åŠ é”åªæ˜¯ä¸ºäº†é¿å…é‡å¤åˆ›å»ºï¼Œåœ¨è¿™é‡Œæ˜¯å¯ä»¥åˆå§‹åŒ–å¤šä¸ªAssociationsManagerå˜é‡çš„
</span><span class=c1></span>    
        <span class=n>AssociationsHashMap</span> <span class=o>&amp;</span><span class=n>associations</span><span class=p>(</span><span class=n>manager</span><span class=p>.</span><span class=n>get</span><span class=p>());</span><span class=c1>//AssociationsHashMap å…¨åœºå”¯ä¸€
</span><span class=c1></span>
        <span class=k>if</span> <span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>auto</span> <span class=n>refs_result</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>try_emplace</span><span class=p>(</span><span class=n>disguised</span><span class=p>,</span> <span class=n>ObjectAssociationMap</span><span class=p>{});</span><span class=c1>//è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªç±»å¯¹
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>refs_result</span><span class=p>.</span><span class=n>second</span><span class=p>)</span> <span class=p>{</span><span class=c1>//åˆ¤æ–­ç¬¬äºŒä¸ªå­˜ä¸å­˜åœ¨ï¼Œå³boolå€¼æ˜¯å¦ä¸ºtrue
</span><span class=c1></span>                <span class=cm>/* it&#39;s the first association we make ç¬¬ä¸€æ¬¡å»ºç«‹å…³è”*/</span>
                <span class=n>object</span><span class=o>-&gt;</span><span class=n>setHasAssociatedObjects</span><span class=p>();</span><span class=c1>//nonpointerIsa ï¼Œæ ‡è®°ä½true
</span><span class=c1></span>            <span class=p>}</span>

            <span class=cm>/* establish or replace the association å»ºç«‹æˆ–è€…æ›¿æ¢å…³è”*/</span>
            <span class=k>auto</span> <span class=o>&amp;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>refs_result</span><span class=p>.</span><span class=n>first</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span> <span class=c1>//å¾—åˆ°ä¸€ä¸ªç©ºçš„æ¡¶å­ï¼Œæ‰¾åˆ°å¼•ç”¨å¯¹è±¡ç±»å‹,å³ç¬¬ä¸€ä¸ªå…ƒç´ çš„secondå€¼
</span><span class=c1></span>            <span class=k>auto</span> <span class=n>result</span> <span class=o>=</span> <span class=n>refs</span><span class=p>.</span><span class=n>try_emplace</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>association</span><span class=p>));</span><span class=c1>//æŸ¥æ‰¾å½“å‰çš„keyæ˜¯å¦æœ‰associationå…³è”å¯¹è±¡
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=n>second</span><span class=p>)</span> <span class=p>{</span><span class=c1>//å¦‚æœç»“æœä¸å­˜åœ¨
</span><span class=c1></span>                <span class=n>association</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>first</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span><span class=c1>//å¦‚æœä¼ çš„æ˜¯ç©ºå€¼ï¼Œåˆ™ç§»é™¤å…³è”ï¼Œç›¸å½“äºç§»é™¤
</span><span class=c1></span>            <span class=k>auto</span> <span class=n>refs_it</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>disguised</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>refs_it</span> <span class=o>!=</span> <span class=n>associations</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
                <span class=k>auto</span> <span class=o>&amp;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>refs_it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
                <span class=k>auto</span> <span class=n>it</span> <span class=o>=</span> <span class=n>refs</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>refs</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
                    <span class=n>association</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>);</span>
                    <span class=n>refs</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>it</span><span class=p>);</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>refs</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>associations</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>refs_it</span><span class=p>);</span>

                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// release the old value (outside of the lock).
</span><span class=c1></span>    <span class=n>association</span><span class=p>.</span><span class=n>releaseHeldValue</span><span class=p>();</span><span class=c1>//é‡Šæ”¾
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p>é¦–å…ˆï¼Œæ³¨æ„å…¶ä¸­çš„å‡ ä¸ªç±»å’Œæ•°æ®ç»“æ„ï¼Œå› ä¸ºåœ¨å…·ä½“åˆ†æè¿™ä¸ªæ–¹æ³•çš„å®ç°ä¹‹å‰ï¼Œéœ€è¦äº†è§£å…¶ä¸­å®ƒä»¬çš„ä½œç”¨ï¼š</p><ul><li><p><strong>AssociationsManager</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>class</span> <span class=nc>AssociationsManager</span> <span class=p>{</span>
    <span class=k>using</span> <span class=n>Storage</span> <span class=o>=</span> <span class=n>ExplicitInitDenseMap</span><span class=o>&lt;</span><span class=n>DisguisedPtr</span><span class=o>&lt;</span><span class=n>objc_object</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>ObjectAssociationMap</span><span class=o>&gt;</span><span class=p>;</span>
    <span class=k>static</span> <span class=n>Storage</span> <span class=n>_mapStorage</span><span class=p>;</span>
  
<span class=k>public</span><span class=o>:</span>
    <span class=n>AssociationsManager</span><span class=p>()</span>   <span class=p>{</span> <span class=n>AssociationsManagerLock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span> <span class=p>}</span>
    <span class=o>~</span><span class=n>AssociationsManager</span><span class=p>()</span>  <span class=p>{</span> <span class=n>AssociationsManagerLock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span> <span class=p>}</span>
  
    <span class=n>AssociationsHashMap</span> <span class=o>&amp;</span><span class=n>get</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>_mapStorage</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
    <span class=p>}</span>
  
    <span class=k>static</span> <span class=kt>void</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>_mapStorage</span><span class=p>.</span><span class=n>init</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>};</span>
</code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªç®¡ç†ç±»ï¼Œç»´æŠ¤ç€<code>spinlock_t</code>å’Œ<code>AssociationsManager</code>å•ä¾‹ï¼Œè°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–æ—¶ï¼Œä¼šåŠ é”ï¼Œåœ¨ææ„æ—¶ä¼šè§£é”ï¼Œè€Œ <code>get</code>æ–¹æ³•ç”¨äºè·å–å…¨å±€çš„<code>AssociationsManager</code>å•ä¾‹</p><p>ä¹Ÿå°±æ˜¯è¯´ <code>AssociationsManager</code> é€šè¿‡æŒæœ‰ä¸€ä¸ª<a href=https://en.wikipedia.org/wiki/Spinlock target=_blank rel=noopener>è‡ªæ—‹é”</a> <code>spinlock_t</code> ä¿è¯å¯¹ <code>AssociationsHashMap</code> çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³<strong>æ¯æ¬¡åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹ AssociationsHashMap è¿›è¡Œæ“ä½œ</strong></p></li><li><p><strong>AssociationsHashMap</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=n>DenseMap</span><span class=o>&lt;</span><span class=n>DisguisedPtr</span><span class=o>&lt;</span><span class=n>objc_object</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>ObjectAssociationMap</span><span class=o>&gt;</span> <span class=n>AssociationsHashMap</span><span class=p>;</span>
  
<span class=k>template</span> <span class=o>&lt;</span><span class=k>typename</span> <span class=n>T</span><span class=o>&gt;</span>
<span class=k>class</span> <span class=nc>DisguisedPtr</span> <span class=p>{</span>
    <span class=n>uintptr_t</span> <span class=n>value</span><span class=p>;</span>
  
    <span class=k>static</span> <span class=n>uintptr_t</span> <span class=nf>disguise</span><span class=p>(</span><span class=n>T</span><span class=o>*</span> <span class=n>ptr</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=o>-</span><span class=p>(</span><span class=n>uintptr_t</span><span class=p>)</span><span class=n>ptr</span><span class=p>;</span>
    <span class=p>}</span>
      <span class=c1>// ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p><code>DisguisedPtr&lt;T></code>æ˜¯æŒ‡é’ˆä¼ªè£…æ¨¡æ¿ç±»ï¼Œé€šè¿‡è¿ç®—ä½¿æŒ‡é’ˆéšè—äºç³»ç»Ÿå·¥å…·(å¦‚<code>leaks</code>å·¥å…·)ï¼ŒåŒæ—¶ä¿æŒæŒ‡é’ˆçš„èƒ½åŠ›ï¼Œå…¶ä½œç”¨æ˜¯é€šè¿‡è®¡ç®—æŠŠä¿å­˜çš„ <code>T</code> ç±»å‹çš„æŒ‡é’ˆéšè—èµ·æ¥ï¼Œå®ç°æŒ‡é’ˆåˆ°æ•´æ•°çš„æ˜ å°„</p><p><code>DisguisedPtr&lt;objc_object></code>å°±æ˜¯å°† <code>objc_object</code>ç±»å‹çš„æŒ‡é’ˆè¿›è¡Œ<strong>ä½è¿ç®—</strong>ã€Œä¼ªè£…ã€ä½œä¸º<code>key</code>ï¼Œ</p><p><code>AssociationsHashMap</code>ç”¨äºå­˜å‚¨<code>DisguisedPtr&lt;objc_object></code>åˆ°<code>ObjectAssociationMap</code>çš„æ˜ å°„</p></li><li><p><strong>ObjectAssociationMap</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>typedef</span> <span class=n>DenseMap</span><span class=o>&lt;</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=n>ObjcAssociation</span><span class=o>&gt;</span> <span class=n>ObjectAssociationMap</span><span class=p>;</span>
</code></pre></div><p><code>ObjectAssociationMap</code>ç”¨äºå­˜å‚¨<code>const void *</code>åˆ°<code>ObjcAssociation</code>çš„æ˜ å°„</p></li><li><p><strong>ObjcAssociation</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>class</span> <span class=nc>ObjcAssociation</span> <span class=p>{</span>
    <span class=n>uintptr_t</span> <span class=n>_policy</span><span class=p>;</span>
    <span class=n>id</span> <span class=n>_value</span><span class=p>;</span>
<span class=k>public</span><span class=o>:</span>
    <span class=n>ObjcAssociation</span><span class=p>(</span><span class=n>uintptr_t</span> <span class=n>policy</span><span class=p>,</span> <span class=n>id</span> <span class=n>value</span><span class=p>)</span> <span class=o>:</span> <span class=n>_policy</span><span class=p>(</span><span class=n>policy</span><span class=p>),</span> <span class=n>_value</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=p>{}</span>
    <span class=c1>// ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p><code>ObjcAssociation</code> å°±æ˜¯çœŸæ­£çš„å…³è”å¯¹è±¡çš„ç±»ï¼Œä¸Šé¢çš„æ‰€æœ‰æ•°æ®ç»“æ„åªæ˜¯ä¸ºäº†æ›´å¥½çš„å­˜å‚¨å®ƒ</p></li></ul><p><strong>å­˜å‚¨</strong></p><p>è¿™é‡Œä¸¾ä¸€ä¸ªç®€å•åˆ—å­ï¼Œè¯´æ˜å…³è”å¯¹è±¡åœ¨å†…å­˜ä¸­ä»¥ä»€ä¹ˆå½¢å¼å­˜å‚¨</p><div class=highlight><pre class=chroma><code class=language-objective-c data-lang=objective-c><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
    <span class=k>@autoreleasepool</span> <span class=p>{</span>
        <span class=n>Person</span> <span class=o>*</span><span class=n>obj</span> <span class=o>=</span> <span class=p>[</span><span class=n>Person</span> <span class=n>new</span><span class=p>];</span>
        <span class=n>objc_setAssociatedObject</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=k>@selector</span><span class=p>(</span><span class=n>hello</span><span class=p>),</span> <span class=s>@&#34;Hello&#34;</span><span class=p>,</span> <span class=n>OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>è¿™é‡Œçš„å…³è”å¯¹è±¡ <code>ObjcAssociation(OBJC_ASSOCIATION_RETAIN_NONATOMIC, @"Hello")</code>åœ¨å†…å­˜æ˜¯è¿™æ ·å­˜å‚¨çš„ï¼š</p><p><img src=https://w-md.imzsy.design/image-20201211153708852.png alt=image-20201211153708852></p><p>ç°åœ¨æ¥å¯¹<code>_object_set_associative_reference</code>è¿›è¡Œåˆ†æ</p><ol><li><p><code>ObjcAssociation association{policy, value}</code>åˆ›å»ºä¸´æ—¶çš„<code>ObjcAssociation</code>å¯¹è±¡ï¼ˆç”¨äºæŒæœ‰åŸæœ‰çš„å…³è”å¯¹è±¡ï¼Œæ–¹ä¾¿åœ¨æ–¹æ³•è°ƒç”¨çš„æœ€åé‡Šæ”¾å€¼ï¼‰</p></li><li><p>è°ƒç”¨<code>acquireValue</code>å¯¹<code>new_value</code>è¿›è¡Œ <code>retain</code> æˆ– <code>copy</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>acquireValue</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>_value</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>switch</span> <span class=p>(</span><span class=n>_policy</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>OBJC_ASSOCIATION_SETTER_RETAIN</span><span class=p>:</span>
            <span class=n>_value</span> <span class=o>=</span> <span class=n>objc_retain</span><span class=p>(</span><span class=n>_value</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=nl>OBJC_ASSOCIATION_SETTER_COPY</span><span class=p>:</span>
            <span class=n>_value</span> <span class=o>=</span> <span class=p>((</span><span class=n>id</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>))</span><span class=n>objc_msgSend</span><span class=p>)(</span><span class=n>_value</span><span class=p>,</span> <span class=err>@</span><span class=n>selector</span><span class=p>(</span><span class=n>copy</span><span class=p>));</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li><li><p>åˆå§‹åŒ–ä¸€ä¸ª<code>AssociationsManager</code>ï¼Œå¹¶è·å–å”¯ä¸€çš„ä¿å­˜å…³è”å¯¹è±¡çš„å“ˆå¸Œè¡¨<code>AssociationsHashMap</code></p></li><li><p>å…ˆä½¿ç”¨ <code>disguised</code> ä½œä¸º <code>key</code>ï¼Œå¯»æ‰¾å¯¹åº”çš„<code>ObjectAssociationMap</code>ï¼Œå¹¶ä¼šä¼ å…¥ä¸€ä¸ªç©ºçš„<code>ObjectAssociationMap</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>auto</span> <span class=n>refs_result</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>try_emplace</span><span class=p>(</span><span class=n>disguised</span><span class=p>,</span> <span class=n>ObjectAssociationMap</span><span class=p>{});</span>
</code></pre></div><ul><li>å¦‚æœæ‰¾åˆ°ï¼Œä¼šå°†æ‰¾åˆ°çš„<code>ObjectAssociationMap</code>è¿›è¡Œè£…é…ä¸ºç±»å¯¹ï¼Œè¿”å›å€¼çš„ <code>second = flase</code></li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°† <code>disguised</code> ä½œä¸º <code>key</code>ï¼Œä¼ å…¥çš„ç©º<code>ObjectAssociationMap</code>åšä¸ºå€¼ï¼Œæ’å…¥åˆ°<code>AssociationsHashMap</code>ï¼Œå¹¶è£…é…ä¸ºç±»å¯¹ï¼Œè¿”å›å€¼çš„ <code>second = true</code></li></ul></li><li><p>å¦‚æœè¿”å›çš„<code>refs_result.second</code>ä¸º<code>true</code>ï¼Œä¼šè°ƒç”¨<code>setHasAssociatedObjects</code>â€”â€”å¯¹äº<code>nonpointerIsa</code>æ›´æ–°<code>isa</code>çš„<code>has_assoc</code>ä¸º<code>true</code>ï¼Œè¡¨æ˜å½“å‰å¯¹è±¡å«æœ‰<strong>å…³è”å¯¹è±¡</strong></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kr>inline</span> <span class=kt>void</span>
<span class=n>objc_object</span><span class=o>::</span><span class=n>setHasAssociatedObjects</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isTaggedPointer</span><span class=p>())</span> <span class=k>return</span><span class=p>;</span>
   
 <span class=nl>retry</span><span class=p>:</span>
    <span class=n>isa_t</span> <span class=n>oldisa</span> <span class=o>=</span> <span class=n>LoadExclusive</span><span class=p>(</span><span class=o>&amp;</span><span class=n>isa</span><span class=p>.</span><span class=n>bits</span><span class=p>);</span>
    <span class=n>isa_t</span> <span class=n>newisa</span> <span class=o>=</span> <span class=n>oldisa</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>newisa</span><span class=p>.</span><span class=n>nonpointer</span>  <span class=o>||</span>  <span class=n>newisa</span><span class=p>.</span><span class=n>has_assoc</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ClearExclusive</span><span class=p>(</span><span class=o>&amp;</span><span class=n>isa</span><span class=p>.</span><span class=n>bits</span><span class=p>);</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>newisa</span><span class=p>.</span><span class=n>has_assoc</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>StoreExclusive</span><span class=p>(</span><span class=o>&amp;</span><span class=n>isa</span><span class=p>.</span><span class=n>bits</span><span class=p>,</span> <span class=n>oldisa</span><span class=p>.</span><span class=n>bits</span><span class=p>,</span> <span class=n>newisa</span><span class=p>.</span><span class=n>bits</span><span class=p>))</span> <span class=k>goto</span> <span class=n>retry</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></li><li><p>å†æ ¹æ®ä¼ å…¥çš„<code>key</code>ï¼Œå¯»æ‰¾ç›¸åº”çš„<code>ObjectAssociation</code>ï¼Œå¹¶å°†ä¸´æ—¶çš„<code>ObjcAssociation</code>å¯¹è±¡ä¼ å…¥</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>auto</span> <span class=o>&amp;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>refs_result</span><span class=p>.</span><span class=n>first</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span> <span class=c1>// ç›¸å½“äºè·å–ObjectAssociationMap
</span><span class=c1></span><span class=k>auto</span> <span class=n>result</span> <span class=o>=</span> <span class=n>refs</span><span class=p>.</span><span class=n>try_emplace</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>association</span><span class=p>));</span> <span class=c1>// æŸ¥æ‰¾ObjectAssociation
</span></code></pre></div><p>è¿™é‡Œå’Œä¸Šé¢æŸ¥æ‰¾<code>ObjectAssociationMap</code>ç±»ä¼¼</p><ul><li>å¦‚æœæ‰¾åˆ°ï¼Œåˆ™è¿”å›çš„ç±»å¯¹<code>second</code>ä¸º<code>true</code>ï¼Œéœ€è¦å°†è¿›è¡Œæ›¿æ¢<code>association.swap(result.first->second)</code></li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šå°†<code>ObjcAssociation</code>æ’å…¥åˆ°<code>ObjectAssociationMap</code>ä¸­</li></ul></li><li><p>æœ€åè°ƒç”¨<code>releaseHeldValue</code>ï¼Œå°†é‡Šæ”¾å…³è”å¯¹è±¡çš„å€¼</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>releaseHeldValue</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>_value</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_policy</span> <span class=o>&amp;</span> <span class=n>OBJC_ASSOCIATION_SETTER_RETAIN</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>objc_release</span><span class=p>(</span><span class=n>_value</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li></ol><p>åˆ°è¿™é‡Œï¼Œä¼ å…¥ <code>value</code> æœ‰å€¼çš„å®ç°å°±ç»“æŸäº†</p><p><strong>value==nil</strong></p><p>å¦‚æœä¼ å…¥çš„ <code>value == nil</code>ï¼Œå°±è¯´æ˜éœ€è¦åˆ é™¤å¯¹åº” <code>key</code> çš„å…³è”å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯èµ° <code>else</code> æµç¨‹</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=k>auto</span> <span class=n>refs_it</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>disguised</span><span class=p>);</span> <span class=c1>// è·å–ObjectAssociationMap
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>refs_it</span> <span class=o>!=</span> <span class=n>associations</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>auto</span> <span class=o>&amp;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>refs_it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
    <span class=k>auto</span> <span class=n>it</span> <span class=o>=</span> <span class=n>refs</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>key</span><span class=p>);</span> <span class=c1>// è·å–ObjectAssociation
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>refs</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>association</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>);</span>
        <span class=n>refs</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>it</span><span class=p>);</span> <span class=c1>// æ“¦é™¤ObjectAssociation
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>refs</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// ObjectAssociationMapä¸ºç©º
</span><span class=c1></span>            <span class=n>associations</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>refs_it</span><span class=p>);</span> <span class=c1>// æ“¦é™¤ObjectAssociationMapc
</span><span class=c1></span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>è¯¥æµç¨‹ä¸­ï¼Œä¸å‰é¢çš„å”¯ä¸€ä¸åŒçš„å°±æ˜¯ï¼Œéœ€è¦è°ƒç”¨ <code>erase</code> å‡½æ•°ï¼Œæ“¦é™¤ <code>ObjectAssociationMap</code> ä¸­ <code>key</code> å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœ<code>ObjectAssociationMap</code>ä¸ºç©ºäº†ï¼Œè¿˜éœ€è¦ä»å°†å…¶ä» <code>AssociationHashMap</code> ä¸­æ“¦é™¤</p><h4 id=objc_getassociatedobject><a href=#objc_getassociatedobject class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>objc_getAssociatedObject</h4><p>æ—¢ç„¶å·²ç»å¯¹<code>objc_setAssociatedObject</code>çš„å®ç°æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œé‚£ä¹ˆå¯¹äº<code>objc_getAssociatedObject</code>å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†</p><p><code>objc_setAssociatedObject</code>æ–¹æ³•çš„åº•å±‚çœŸæ­£å®ç°æ˜¯<code>_object_get_associative_reference</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>id</span>
<span class=nf>objc_getAssociatedObject</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>_object_get_associative_reference</span><span class=p>(</span><span class=n>object</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>è€Œ<code>_object_get_associative_reference</code>ç›¸å¯¹æ¥è¯´ï¼Œå®ç°æ›´ç®€å•ä¸€ç‚¹</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=n>id</span>
<span class=nf>_object_get_associative_reference</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>key</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>ObjcAssociation</span> <span class=n>association</span><span class=p>{};</span><span class=c1>//åˆ›å»ºç©ºçš„å…³è”å¯¹è±¡
</span><span class=c1></span>
    <span class=p>{</span>
        <span class=n>AssociationsManager</span> <span class=n>manager</span><span class=p>;</span><span class=c1>//åˆ›å»ºä¸€ä¸ªAssociationsManagerç®¡ç†ç±»
</span><span class=c1></span>        <span class=n>AssociationsHashMap</span> <span class=o>&amp;</span><span class=n>associations</span><span class=p>(</span><span class=n>manager</span><span class=p>.</span><span class=n>get</span><span class=p>());</span><span class=c1>//è·å–å…¨å±€å”¯ä¸€çš„é™æ€å“ˆå¸Œmap
</span><span class=c1></span>        <span class=n>AssociationsHashMap</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>find</span><span class=p>((</span><span class=n>objc_object</span> <span class=o>*</span><span class=p>)</span><span class=n>object</span><span class=p>);</span><span class=c1>//æ‰¾åˆ°è¿­ä»£å™¨ï¼Œå³è·å–buckets
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=n>associations</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span><span class=c1>//å¦‚æœè¿™ä¸ªè¿­ä»£æŸ¥è¯¢å™¨ä¸æ˜¯æœ€åä¸€ä¸ª è·å–
</span><span class=c1></span>            <span class=n>ObjectAssociationMap</span> <span class=o>&amp;</span><span class=n>refs</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span> <span class=c1>//æ‰¾åˆ°ObjectAssociationMapçš„è¿­ä»£æŸ¥è¯¢å™¨è·å–ä¸€ä¸ªç»è¿‡å±æ€§ä¿®é¥°ç¬¦ä¿®é¥°çš„value
</span><span class=c1></span>            <span class=n>ObjectAssociationMap</span><span class=o>::</span><span class=n>iterator</span> <span class=n>j</span> <span class=o>=</span> <span class=n>refs</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=c1>//æ ¹æ®keyæŸ¥æ‰¾ObjectAssociationMapï¼Œå³è·å–bucket
</span><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=o>!=</span> <span class=n>refs</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>association</span> <span class=o>=</span> <span class=n>j</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span><span class=c1>//è·å–ObjcAssociation
</span><span class=c1></span>                <span class=n>association</span><span class=p>.</span><span class=n>retainReturnedValue</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>association</span><span class=p>.</span><span class=n>autoreleaseReturnedValue</span><span class=p>();</span><span class=c1>//è¿”å›value
</span><span class=c1></span><span class=p>}</span>
</code></pre></div><p><strong>å¯»æ‰¾å…³è”å¯¹è±¡çš„é€»è¾‘</strong></p><ul><li><p>åˆ›å»ºç©ºçš„å…³è”å¯¹è±¡ï¼Œ<code>AssociationsManager</code>ç®¡ç†ç±»</p></li><li><p>è·å–é™æ€å“ˆå¸Œè¡¨ <code>AssociationsHashMap</code></p></li><li><p>ä»¥<code>object</code>ä¸º<code>key</code>æŸ¥æ‰¾<code>ObjectAssociationMap</code></p></li><li><p>ä»¥<code>void *key</code>ä¸º<code>key</code>æŸ¥æ‰¾<code>ObjectAssociation</code></p></li><li><p>å†æ‰¾åˆ°<code>ObjectAssociation</code>åï¼Œè°ƒç”¨<code>retainReturnedValue</code>ï¼Œæ ¹æ®<code>policy</code>æ˜¯å¦éœ€è¦<code>retain</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>retainReturnedValue</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>_value</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_policy</span> <span class=o>&amp;</span> <span class=n>OBJC_ASSOCIATION_GETTER_RETAIN</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>objc_retain</span><span class=p>(</span><span class=n>_value</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></li><li><p>æœ€åè¿”å›å…³è”å¯¹è±¡çš„å€¼ï¼Œä¼šè°ƒç”¨ä¸€æ¬¡<code>autoreleaseReturnedValue</code>ï¼Œæ ¹æ®<code>policy</code>æ˜¯å¦éœ€è¦<code>autorelease</code></p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kr>inline</span> <span class=n>id</span> <span class=nf>autoreleaseReturnedValue</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>slowpath</span><span class=p>(</span><span class=n>_value</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>_policy</span> <span class=o>&amp;</span> <span class=n>OBJC_ASSOCIATION_GETTER_AUTORELEASE</span><span class=p>)))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>objc_autorelease</span><span class=p>(</span><span class=n>_value</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>_value</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></li></ul><h4 id=objc_removeassociatedobjects><a href=#objc_removeassociatedobjects class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>objc_removeAssociatedObjects</h4><p>å…³äº<code>objc_removeAssociatedObjects</code>æ–¹æ³•ï¼Œå…¶å®ç°ä¹Ÿç›¸å¯¹ç®€å•</p><p>ä¸ºäº†åŠ é€Ÿç§»é™¤å¯¹è±¡çš„å…³è”å¯¹è±¡çš„é€Ÿåº¦ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ ‡è®°ä½ <code>has_assoc</code> æ¥é¿å…ä¸å¿…è¦çš„æ–¹æ³•è°ƒç”¨</p><p>åœ¨ç¡®è®¤äº†å¯¹è±¡å’Œå…³è”å¯¹è±¡çš„å­˜åœ¨ä¹‹åï¼Œæ‰ä¼šè°ƒç”¨ <code>_object_remove_assocations</code> æ–¹æ³•ç§»é™¤å¯¹è±¡ä¸Šæ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼š</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span> <span class=nf>objc_removeAssociatedObjects</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>)</span> 
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>object</span> <span class=o>&amp;&amp;</span> <span class=n>object</span><span class=o>-&gt;</span><span class=n>hasAssociatedObjects</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>_object_remove_assocations</span><span class=p>(</span><span class=n>object</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p><code>_object_remove_assocations</code>å®ç°ä¹Ÿæ¯”è¾ƒç®€å•</p><ul><li>å°†å¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…³è”å¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ªè¿­ä»£å™¨ä¸­</li><li>ç„¶åå¯¹æ‰€æœ‰çš„<code>ObjcAssociation</code>è°ƒç”¨<code>releaseHeldValue</code>æ–¹æ³•ï¼Œ<code>release</code>é‡Šæ”¾ä¸éœ€è¦çš„å€¼</li></ul><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=kt>void</span>
<span class=nf>_object_remove_assocations</span><span class=p>(</span><span class=n>id</span> <span class=n>object</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>ObjectAssociationMap</span> <span class=n>refs</span><span class=p>{};</span><span class=c1>//åˆ›å»ºç©ºçš„å…³è”å¯¹è±¡é›†åˆ
</span><span class=c1></span>
    <span class=p>{</span>
        <span class=n>AssociationsManager</span> <span class=n>manager</span><span class=p>;</span><span class=c1>//åˆ›å»ºä¸€ä¸ªAssociationsManagerç®¡ç†ç±»
</span><span class=c1></span>        <span class=n>AssociationsHashMap</span> <span class=o>&amp;</span><span class=n>associations</span><span class=p>(</span><span class=n>manager</span><span class=p>.</span><span class=n>get</span><span class=p>());</span><span class=c1>//è·å–å…¨å±€å”¯ä¸€çš„é™æ€å“ˆå¸Œmap
</span><span class=c1></span>        <span class=n>AssociationsHashMap</span><span class=o>::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>associations</span><span class=p>.</span><span class=n>find</span><span class=p>((</span><span class=n>objc_object</span> <span class=o>*</span><span class=p>)</span><span class=n>object</span><span class=p>);</span><span class=c1>//æ‰¾åˆ°è¿­ä»£å™¨ï¼Œå³è·å–buckets
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=n>associations</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span><span class=c1>//å¦‚æœè¿™ä¸ªè¿­ä»£æŸ¥è¯¢å™¨ä¸æ˜¯æœ€åä¸€ä¸ª è·å–
</span><span class=c1></span>            <span class=n>refs</span><span class=p>.</span><span class=n>swap</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>);</span><span class=c1>//è·å–ObjcAssociation
</span><span class=c1></span>            <span class=n>associations</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=c1>//åˆ é™¤
</span><span class=c1></span>        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// release everything (outside of the lock).
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=o>&amp;</span><span class=nl>i</span><span class=p>:</span> <span class=n>refs</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>i</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>releaseHeldValue</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 id=æ€»ç»“-1><a href=#æ€»ç»“-1 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>æ€»ç»“</h3><p><strong>å¯¹äºåº”ç”¨</strong></p><blockquote><p>åˆ†ç±»ä¸­å¯¹å±æ€§çš„å®ç°å…¶å®åªæ˜¯å®ç°äº†ä¸€ä¸ªçœ‹èµ·æ¥åƒå±æ€§çš„æ¥å£è€Œå·²</p></blockquote><p>åˆ†ç±»ä¸­æ‰‹åŠ¨å®ç° <code>setterã€getter</code>ï¼Œé€šå¸¸éœ€è¦å€ŸåŠ©<strong>å…³è”å¯¹è±¡</strong></p><p><strong>å¯¹äºå®ç°</strong></p><p>å…³è”å¯¹è±¡æ˜¯æ€ä¹ˆå®ç°å¹¶ä¸”ç®¡ç†çš„ï¼š</p><ul><li>å…³è”å¯¹è±¡æœ¬è´¨æ˜¯ <code>ObjectAssociation</code> å¯¹è±¡</li><li>å…³è”å¯¹è±¡ç”± <code>AssociationsManager</code> ç®¡ç†å¹¶åœ¨ <code>AssociationsHashMap</code> å­˜å‚¨</li><li>å¯¹è±¡çš„æŒ‡é’ˆä»¥åŠå…¶å¯¹åº” <code>ObjectAssociationMap</code> ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨ <code>AssociationsHashMap</code> ä¸­</li><li><code>ObjectAssociationMap</code> åˆ™æ˜¯ç”¨äºå­˜å‚¨å…³è”å¯¹è±¡çš„æ•°æ®ç»“æ„</li><li>å¯¹äº<code>nonpointerIsa</code>, æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ ‡è®°ä½ <code>has_assoc</code> æŒ‡ç¤ºå¯¹è±¡æ˜¯å¦å«æœ‰å…³è”å¯¹è±¡</li></ul><p>æ•´ä¸ªç»“æ„å›¾ä¸ºï¼š</p><p><img src=https://w-md.imzsy.design/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png alt=å…³è”å¯¹è±¡æ•°æ®ç»“æ„></p></div></article><div class=post-tags><a href=../tags/ios/ rel=tag class=post-tags-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon tag-icon"><path d="M0 252.118V48C0 21.49 21.49.0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882.0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>iOS</a></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>Â©&nbsp;2019â€“2021&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;Dev - jw</div></div></footer></div><script>'serviceWorker'in navigator&&window.addEventListener('load',function(){navigator.serviceWorker.register('/sw.js')})</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},options:{renderActions:{addMenu:[0,'','']}},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){var a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script><script>let mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'default'};mermaid.initialize(mermaidConfig)</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script><script>mediumZoom(document.querySelectorAll('div.post-body img'),{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>